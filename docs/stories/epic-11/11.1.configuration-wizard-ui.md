# Story 11.1: Configuration Wizard UI

## Status
Done

## Story
**As a** trader,
**I want** a configuration wizard that shows impact analysis before I change parameters,
**so that** I don't accidentally degrade system performance.

## Acceptance Criteria
1. Configuration page: categorized sections (Volume Thresholds, Risk Limits, Cause Factors, Pattern Confidence)
2. Parameter inputs: sliders with numeric input, current vs proposed values
3. Impact analysis panel: automatically calculates impact when values change
4. Analysis metrics: "~8 more signals qualify", "Estimated win rate: 68% (↓ from 72%)"
5. Validation: prevents invalid values (e.g., spring volume >1.0x makes no sense)
6. William's recommendation: AI-generated advice on proposed changes
7. Actions: Cancel, Save & Backtest (runs simulation), Apply Immediately
8. Component: `ConfigurationWizard.tsx`
9. API: GET /api/config, PUT /api/config, POST /api/config/analyze-impact
10. Confirmation dialog: "This will relax volume validation - are you sure?"

## Tasks / Subtasks

- [ ] Design and implement configuration data model (AC: 1, 9)
  - [ ] Create Pydantic model `SystemConfiguration` in `backend/src/models/config.py`
  - [ ] Define configuration sections: VolumeThresholds, RiskLimits, CauseFactors, PatternConfidence
  - [ ] Add field validation rules (e.g., spring_volume_min between 0.5-1.0)
  - [ ] Create migration for `system_configuration` table in database
  - [ ] Add version field for optimistic locking
  - [ ] Generate TypeScript types using pydantic-to-typescript
  - [ ] Document configuration schema with inline comments

- [ ] Implement backend configuration repository and service (AC: 9)
  - [ ] Create `ConfigurationRepository` in `backend/src/repositories/config_repository.py`
  - [ ] Implement `get_current_config()` method
  - [ ] Implement `update_config(config: SystemConfiguration, version: int)` with optimistic locking
  - [ ] Create `ConfigurationService` in `backend/src/services/config_service.py`
  - [ ] Add configuration validation business logic
  - [ ] Write unit tests for repository and service layers

- [ ] Create GET /api/v1/config endpoint (AC: 9)
  - [ ] Add route in `backend/src/api/routes/config.py`
  - [ ] Return current system configuration with all parameter sections
  - [ ] Include metadata: last_modified_at, version, modified_by
  - [ ] Add endpoint to FastAPI app in `backend/src/api/main.py`
  - [ ] Write integration test for GET endpoint
  - [ ] Document endpoint in OpenAPI schema

- [ ] Create PUT /api/v1/config endpoint (AC: 9, 10)
  - [ ] Add PUT route in `backend/src/api/routes/config.py`
  - [ ] Accept SystemConfiguration payload with version
  - [ ] Validate all configuration parameters
  - [ ] Apply optimistic locking (409 Conflict if version mismatch)
  - [ ] Log configuration changes to audit trail
  - [ ] Return updated configuration with new version
  - [ ] Write integration test for PUT endpoint with conflict scenarios

- [ ] Implement impact analysis algorithm (AC: 3, 4)
  - [ ] Create `ImpactAnalysisService` in `backend/src/services/impact_analysis_service.py`
  - [ ] Implement `analyze_config_impact(current: Config, proposed: Config)` method
  - [ ] Query historical patterns from last 90 days
  - [ ] Re-evaluate patterns against proposed thresholds
  - [ ] Calculate delta metrics: signal_count_change, estimated_win_rate_change, risk_impact
  - [ ] Create Pydantic model `ImpactAnalysisResult` in `backend/src/models/config.py`
  - [ ] Add confidence bounds to estimates (optimistic/pessimistic scenarios)
  - [ ] Write unit tests with mock pattern data

- [ ] Create POST /api/v1/config/analyze-impact endpoint (AC: 3, 4, 9)
  - [ ] Add POST route in `backend/src/api/routes/config.py`
  - [ ] Accept proposed configuration as payload
  - [ ] Call ImpactAnalysisService.analyze_config_impact()
  - [ ] Return ImpactAnalysisResult with formatted metrics
  - [ ] Handle async execution if analysis takes >2 seconds
  - [ ] Write integration test with sample configuration changes
  - [ ] Document endpoint in OpenAPI schema

- [ ] Create ConfigurationWizard Vue component (AC: 1, 2, 8)
  - [ ] Create `frontend/src/components/configuration/ConfigurationWizard.vue`
  - [ ] Implement component structure with PrimeVue TabView for sections
  - [ ] Add Volume Thresholds section (spring_volume_min, sos_volume_min, etc.)
  - [ ] Add Risk Limits section (max_risk_per_trade, max_campaign_risk, max_portfolio_heat)
  - [ ] Add Cause Factors section (min_cause_factor, max_cause_factor)
  - [ ] Add Pattern Confidence section (min_spring_confidence, min_sos_confidence, etc.)
  - [ ] Use PrimeVue Slider components with linked InputNumber for each parameter
  - [ ] Display current value vs proposed value side-by-side
  - [ ] Implement local state management for proposed changes
  - [ ] Add form validation with error messages

- [ ] Implement parameter input controls (AC: 2)
  - [ ] Create reusable `ParameterInput.vue` component
  - [ ] Integrate PrimeVue Slider with min/max bounds
  - [ ] Add synchronized InputNumber for precise entry
  - [ ] Display current value as disabled field or badge
  - [ ] Show proposed value in editable input
  - [ ] Add visual indicator when value differs from current (e.g., yellow highlight)
  - [ ] Implement debounced value updates (300ms delay)
  - [ ] Add unit tests for ParameterInput component

- [ ] Create ImpactAnalysisPanel component (AC: 3, 4)
  - [ ] Create `frontend/src/components/configuration/ImpactAnalysisPanel.vue`
  - [ ] Design panel layout with card-based metric display
  - [ ] Show signal count delta: "~8 more signals qualify" or "~5 fewer signals"
  - [ ] Display estimated win rate with delta indicator: "68% (↓ from 72%)"
  - [ ] Add visual indicators (up/down arrows, color coding: green=better, red=worse)
  - [ ] Show confidence range: "Win rate: 68% (±3%)"
  - [ ] Display loading state during impact calculation
  - [ ] Handle empty state when no changes detected
  - [ ] Add error handling for failed impact analysis

- [ ] Implement real-time impact analysis updates (AC: 3)
  - [ ] Create composable `useImpactAnalysis.ts` in `frontend/src/composables/`
  - [ ] Watch for configuration changes with debouncing (1 second)
  - [ ] Call POST /api/v1/config/analyze-impact when changes detected
  - [ ] Update ImpactAnalysisPanel reactively with results
  - [ ] Handle loading/error states
  - [ ] Prevent multiple concurrent analysis requests
  - [ ] Cache analysis results for identical configurations

- [ ] Implement configuration validation (AC: 5)
  - [ ] Add frontend validation rules matching backend Pydantic model
  - [ ] Validate spring_volume_min is between 0.5-1.0x
  - [ ] Validate risk percentages sum constraints
  - [ ] Validate min < max for all range parameters
  - [ ] **[WYCKOFF]** Add validation warning if `min_cause_factor < 2.0`: "Wyckoff methodology requires minimum 2:1 cause-to-effect ratio for reliable projections"
  - [ ] **[WYCKOFF]** Add validation error if `spring_volume_min > 1.0x`: "Spring patterns require volume BELOW average (< 1.0x) per Wyckoff principles"
  - [ ] **[WYCKOFF]** Add validation error if `sos_volume_min < 1.5x`: "Sign of Strength requires volume expansion (≥ 1.5x) to confirm demand"
  - [ ] Show inline validation errors on parameter inputs
  - [ ] Disable "Apply" button when validation fails
  - [ ] Add helper tooltips explaining valid ranges and Wyckoff methodology
  - [ ] Write unit tests for validation logic including Wyckoff-specific validations

- [ ] Implement William's recommendation feature (AC: 6)
  - [ ] Create `RecommendationService` in `backend/src/services/recommendation_service.py`
  - [ ] Analyze proposed changes and generate contextual advice
  - [ ] Use rule-based system for MVP (not actual AI)
  - [ ] Example rules: "Lowering spring volume may increase false positives"
  - [ ] Return recommendation severity: INFO, WARNING, CAUTION
  - [ ] Add recommendations to ImpactAnalysisResult model
  - [ ] Display recommendations in ImpactAnalysisPanel with appropriate styling
  - [ ] Add icon indicators for recommendation severity

- [ ] Implement action buttons and workflows (AC: 7)
  - [ ] Add "Cancel" button - revert to current configuration
  - [ ] Add "Apply Immediately" button - save without backtest
  - [ ] Add "Save & Backtest" button - trigger backtest preview (Story 11.2 integration)
  - [ ] Implement confirmation dialog before applying changes
  - [ ] Show loading state during save operation
  - [ ] Handle save success with success toast notification
  - [ ] Handle save failure with error notification
  - [ ] Refresh current config after successful save

- [ ] Create confirmation dialog component (AC: 10)
  - [ ] Create `frontend/src/components/configuration/ConfirmationDialog.vue`
  - [ ] Display specific warning message based on change type
  - [ ] Example: "This will relax volume validation - are you sure?"
  - [ ] Show impact summary in dialog
  - [ ] Add "Yes, Apply Changes" and "Cancel" buttons
  - [ ] Integrate with PrimeVue Dialog component
  - [ ] Add severity-based styling (warning vs. caution)

- [ ] Implement configuration persistence and versioning (AC: 9)
  - [ ] Create database migration for `system_configuration` table
  - [ ] Add fields: id, version, configuration_json, applied_at, applied_by
  - [ ] Store historical configurations for audit trail
  - [ ] Link to audit_trail table for configuration change events
  - [ ] Test optimistic locking with concurrent update scenarios

- [ ] Create API client methods for configuration (AC: 9)
  - [ ] Add `getConfiguration()` method to `frontend/src/services/api.ts`
  - [ ] Add `updateConfiguration(config, version)` method
  - [ ] Add `analyzeConfigImpact(proposedConfig)` method
  - [ ] Handle API errors with user-friendly messages
  - [ ] Add request timeout (5 seconds for impact analysis)

- [ ] Add configuration wizard to navigation and routing
  - [ ] Create route `/settings/configuration` in `frontend/src/router/index.ts`
  - [ ] Add navigation link in settings menu
  - [ ] Add breadcrumb navigation
  - [ ] Implement route guard to prevent navigation with unsaved changes
  - [ ] Add page title and metadata

- [ ] Write integration tests for configuration workflow
  - [ ] Test full configuration update workflow end-to-end
  - [ ] Test optimistic locking conflict resolution
  - [ ] Test impact analysis with various parameter changes
  - [ ] Test validation error handling
  - [ ] Test recommendation generation
  - [ ] Test confirmation dialog flow

- [ ] Write component tests for frontend
  - [ ] Test ConfigurationWizard component with Vitest
  - [ ] Test ParameterInput component value binding
  - [ ] Test ImpactAnalysisPanel metric display
  - [ ] Test form validation behavior
  - [ ] Test action button interactions
  - [ ] Mock API calls with test fixtures

## Dev Notes

### Architecture Context

**Tech Stack:**
[Source: docs/architecture/3-tech-stack.md]
- **Frontend:** Vue 3 (3.4+) with TypeScript (5.3+), PrimeVue (3.50+), Pinia (2.1+), Vite (5.0+)
- **Backend:** Python (3.11+), FastAPI (0.109+), Pydantic (2.5+), SQLAlchemy (2.0+)
- **Database:** PostgreSQL (15+)
- **State Management:** Pinia stores
- **Type Generation:** pydantic-to-typescript (1.0+) - Python models are source of truth
- **API Client:** Axios, big.js for decimal handling
- **Testing:** Vitest (frontend unit tests), pytest (backend unit tests)

**Project Structure:**
[Source: docs/architecture/10-unified-project-structure.md]

Frontend structure:
```
frontend/src/
├── components/
│   └── configuration/           # New for this story
│       ├── ConfigurationWizard.vue
│       ├── ParameterInput.vue
│       ├── ImpactAnalysisPanel.vue
│       └── ConfirmationDialog.vue
├── composables/
│   └── useImpactAnalysis.ts     # New for this story
├── services/
│   └── api.ts                   # Update with config methods
├── types/                       # Auto-generated from Pydantic
│   ├── SystemConfiguration.ts   # Generated
│   └── ImpactAnalysisResult.ts  # Generated
└── views/
    └── SettingsView.vue         # Update to include config wizard
```

Backend structure:
```
backend/src/
├── api/routes/
│   └── config.py                # New: Configuration endpoints
├── models/
│   └── config.py                # New: Pydantic models
├── repositories/
│   └── config_repository.py     # New: Data access
├── services/
│   ├── config_service.py        # New: Business logic
│   ├── impact_analysis_service.py  # New: Impact calculation
│   └── recommendation_service.py   # New: Recommendation generation
└── tests/
    └── integration/
        └── test_config_api.py   # New: API tests
```

**Data Models:**
[Source: docs/architecture/4-data-models.md]

This story creates new Pydantic models for system configuration. Key principles:
- All models defined in `backend/src/models/` (Python Pydantic)
- TypeScript interfaces auto-generated via pydantic-to-typescript
- Use `Decimal` type for numerical precision (volume ratios, risk percentages)
- All timestamps must be UTC with timezone awareness

Example Configuration Model Structure:
```python
from pydantic import BaseModel, Field
from decimal import Decimal

class VolumeThresholds(BaseModel):
    spring_volume_min: Decimal = Field(0.7, ge=0.5, le=1.0, description="Minimum volume ratio for Spring detection")
    sos_volume_min: Decimal = Field(2.0, ge=1.5, le=3.0, description="Minimum volume ratio for SOS detection")
    # ... other volume thresholds

class RiskLimits(BaseModel):
    max_risk_per_trade: Decimal = Field(2.0, ge=1.0, le=3.0, description="Max risk per trade (%)")
    max_campaign_risk: Decimal = Field(5.0, ge=3.0, le=7.0, description="Max campaign risk (%)")
    max_portfolio_heat: Decimal = Field(10.0, ge=5.0, le=15.0, description="Max portfolio heat (%)")

class SystemConfiguration(BaseModel):
    id: UUID
    version: int  # For optimistic locking
    volume_thresholds: VolumeThresholds
    risk_limits: RiskLimits
    cause_factors: CauseFactors
    pattern_confidence: PatternConfidence
    modified_at: datetime
    modified_by: str
```

**API Specification:**
[Source: docs/architecture/5-api-specification.md]

Base URL: `http://localhost:8000/api/v1`

New endpoints for this story:
- `GET /api/v1/config` - Retrieve current system configuration
- `PUT /api/v1/config` - Update configuration with optimistic locking
- `POST /api/v1/config/analyze-impact` - Analyze impact of proposed changes

Standard response format:
```json
{
  "data": {...},
  "metadata": {...}
}
```

Error format:
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message",
    "details": {...},
    "timestamp": "2024-03-13T13:00:00Z",
    "request_id": "uuid"
  }
}
```

**Database Schema:**
[Source: docs/architecture/9-database-schema.md]

New table for this story:
```sql
CREATE TABLE system_configuration (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    version INT NOT NULL DEFAULT 1,
    configuration_json JSONB NOT NULL,
    applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    applied_by VARCHAR(100),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for version-based queries
CREATE INDEX idx_config_version ON system_configuration(version DESC);
```

Audit trail integration:
- All configuration changes must be logged to `audit_trail` table
- Include old and new configuration in metadata field

**Frontend Components:**
[Source: docs/architecture/6-components.md#62-frontend-components]

Component architecture principles:
- Use Vue 3 Composition API with `<script setup lang="ts">`
- PrimeVue components for UI consistency
- Pinia stores for state management
- Composables for reusable logic (e.g., `useImpactAnalysis`)
- API client from `frontend/src/services/api.ts`

PrimeVue components to use:
- `TabView` - For configuration sections
- `Slider` - For parameter inputs
- `InputNumber` - For precise numeric entry
- `Card` - For impact analysis panel
- `Dialog` - For confirmation dialog
- `Button` - For actions
- `Message` - For validation errors and recommendations

**Coding Standards:**
[Source: docs/architecture/15-coding-standards.md]

Critical rules:
- ✅ Define types in `backend/src/models/` (Pydantic), auto-generate TypeScript
- ✅ Use `apiClient` from `frontend/src/services/api.ts` for API calls
- ✅ Access env vars via `import.meta.env` (frontend)
- ✅ Use `Decimal` (Python) and `Big` (TypeScript) for financial calculations
- ❌ DON'T manually create TypeScript types
- ❌ DON'T use `float` or `number` for prices/percentages

Naming conventions:
- Python classes: PascalCase (e.g., `SystemConfiguration`)
- Python functions: snake_case (e.g., `analyze_config_impact()`)
- Vue components: PascalCase (e.g., `ConfigurationWizard.vue`)
- Vue composables: camelCase with 'use' prefix (e.g., `useImpactAnalysis.ts`)
- API routes: kebab-case (e.g., `/api/v1/config`)
- Database tables: snake_case (e.g., `system_configuration`)

**Previous Story Context:**

Story 10.10 completed frontend deployment pipeline. Key learnings:
- Vue 3 project structure established in `frontend/src/`
- PrimeVue UI library integrated and configured
- API client service available in `frontend/src/services/api.ts`
- Environment variables configured with `import.meta.env` pattern
- Vite build pipeline optimized for production
- Component testing setup with Vitest

Frontend components from Stories 10.1-10.9 provide reference patterns:
- Dashboard components use PrimeVue DataTable, Card, Chart
- WebSocket integration for real-time updates (Story 10.9)
- Form patterns with validation
- Loading and error state handling

**Impact Analysis Algorithm Details:**

The impact analysis must:
1. Query all patterns detected in last 90 days from `patterns` table
2. Re-evaluate each pattern against proposed configuration thresholds
3. Determine which patterns would still qualify vs. be rejected
4. Calculate delta: `proposed_signal_count - current_signal_count`
5. Estimate win rate based on historical pattern performance
6. Flag risk impacts (e.g., if max_portfolio_heat reduced)

Performance consideration:
- For 90 days of 1-day bars across 10 symbols = ~900 patterns to evaluate
- Target response time: <2 seconds
- Use database indexes on `patterns.detection_time`
- Consider caching if performance becomes an issue

**Configuration Validation Rules:**

Volume thresholds:
- `spring_volume_min`: 0.5x to 1.0x (below 1.0x required by Wyckoff methodology)
- `sos_volume_min`: 1.5x to 3.0x
- `utad_volume_max`: 0.3x to 0.7x

Risk limits:
- `max_risk_per_trade`: 1.0% to 3.0%
- `max_campaign_risk`: 3.0% to 7.0%
- `max_portfolio_heat`: 5.0% to 15.0%
- Constraint: `max_risk_per_trade < max_campaign_risk < max_portfolio_heat`

Cause factors:
- `min_cause_factor`: 2.0 to 2.5
- `max_cause_factor`: 2.5 to 3.0
- Constraint: `min_cause_factor < max_cause_factor`

Pattern confidence:
- All pattern confidence thresholds: 70 to 95

**Optimistic Locking Implementation:**

To prevent concurrent configuration updates:
1. GET returns current config with version number
2. PUT requires version in payload
3. Backend checks: `WHERE version = provided_version`
4. If mismatch, return 409 Conflict error
5. Frontend handles conflict by refetching and asking user to retry

**Recommendation Rules (MVP):**

Rule-based system (not AI) for William's recommendations:

- If `spring_volume_min` decreased → WARNING: "Lowering spring volume threshold may increase false positives"
- If `max_risk_per_trade` increased → CAUTION: "Increasing risk per trade requires discipline"
- If `min_spring_confidence` decreased → WARNING: "Lower confidence signals have higher failure rates"
- If `max_portfolio_heat` increased → CAUTION: "Higher portfolio heat increases drawdown risk"
- If multiple thresholds relaxed → WARNING: "Multiple relaxed thresholds compound risk"
- If thresholds tightened → INFO: "Stricter criteria will reduce signal quantity but may improve quality"

### Testing

**Test File Locations:**
[Source: docs/architecture/12-testing-strategy.md]

Backend tests:
- Unit tests: `backend/tests/unit/services/test_config_service.py`
- Unit tests: `backend/tests/unit/services/test_impact_analysis_service.py`
- Integration tests: `backend/tests/integration/test_config_api.py`

Frontend tests:
- Component tests: `frontend/tests/components/configuration/ConfigurationWizard.spec.ts`
- Component tests: `frontend/tests/components/configuration/ParameterInput.spec.ts`
- Component tests: `frontend/tests/components/configuration/ImpactAnalysisPanel.spec.ts`
- Composable tests: `frontend/tests/composables/useImpactAnalysis.spec.ts`

**Testing Frameworks:**
- Backend: pytest (8.0+) with pytest-asyncio for async tests
- Frontend: Vitest (1.2+) with Vue Testing Library
- Mocking: pytest-mock (backend), vi.mock (frontend)

**Test Requirements:**

Backend unit tests:
1. ConfigurationService validation logic
2. ImpactAnalysisService calculation accuracy
3. RecommendationService rule evaluation
4. Optimistic locking conflict scenarios

Backend integration tests:
1. GET /api/v1/config returns current configuration
2. PUT /api/v1/config updates with valid payload
3. PUT /api/v1/config returns 409 on version conflict
4. PUT /api/v1/config returns 422 on validation error
5. POST /api/v1/config/analyze-impact returns correct metrics
6. Configuration changes logged to audit_trail

Frontend component tests:
1. ConfigurationWizard renders all sections
2. ParameterInput syncs slider and input number
3. ParameterInput validates bounds
4. ImpactAnalysisPanel displays metrics correctly
5. ConfirmationDialog shows appropriate warnings
6. Form validation prevents invalid submissions

End-to-end workflow test:
1. Load current configuration
2. Modify parameters
3. View impact analysis
4. Save configuration
5. Verify configuration persisted

**Test Data Fixtures:**

Create test fixtures for:
- Sample SystemConfiguration with all sections
- Historical pattern data for impact analysis (90 days, 10 symbols)
- Various configuration change scenarios (relaxed, tightened, mixed)
- Expected impact analysis results for each scenario

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results

### Review Date: 2025-12-09

### Reviewed By: Quinn (Test Architect)

### Executive Summary

Story 11.1 Configuration Wizard UI implementation is **substantially complete** with excellent Wyckoff methodology compliance, comprehensive test coverage (63 tests), and solid layered architecture. However, **TWO CRITICAL blocking issues** were identified and **FIXED DURING REVIEW**. Implementation demonstrates strong software engineering practices but requires attention to several security and type safety concerns before production deployment.

**Overall Quality Score: 72/100** (CONCERNS gate due to remaining HIGH severity issues)

---

### Code Quality Assessment

#### Strengths:
1. **Excellent Architecture**: Clean separation of concerns (models → repositories → services → API routes → Vue components)
2. **Wyckoff Methodology Compliance**: All validators correctly enforce spring volume < 1.0x, SOS ≥ 1.5x, cause factor ≥ 2.0
3. **Comprehensive Testing**: 63 backend tests (53 unit + 10 integration) with good coverage
4. **Proper Async Patterns**: Correct async/await usage throughout backend and frontend
5. **Optimistic Locking**: Well-implemented version-based concurrency control
6. **Real-time Impact Analysis**: Debounced (1s) with caching for responsive UX
7. **Recommendation Engine**: 20+ Wyckoff-aware rules with severity levels

#### Critical Issues Found and FIXED:
- ✅ **CRITICAL-1 FIXED**: Missing `put` method in `frontend/src/services/api.ts` - Added at line 99-101
- ✅ **CRITICAL-2 FIXED**: Hard-coded timestamp `"2025-12-09T13:10:00Z"` in `backend/src/api/routes/config.py:229` - Replaced with `datetime.utcnow().isoformat() + "Z"`

#### Remaining HIGH Severity Issues:
1. **Patterns Table Missing** (BLOCKING for runtime): `ImpactAnalysisService` queries non-existent `patterns` table - will fail at runtime
2. **Missing Audit Trail Logging**: Configuration changes not logged (TODO at config_service.py:93)
3. **No Authentication/Authorization**: All config endpoints lack role-based access control
4. **TypeScript Type Mismatches**: Decimal strings from API vs number types in components

---

### Refactoring Performed

#### File: `frontend/src/services/api.ts`
- **Change**: Added missing `put` method to apiClient object (lines 99-101)
- **Why**: `updateConfiguration()` function at line 323 calls `apiClient.put()` which didn't exist, causing runtime error
- **How**: Added method signature matching existing `post`, `patch`, `delete` patterns

#### File: `backend/src/api/routes/config.py`
- **Change 1**: Added `from datetime import datetime` import (line 7)
- **Change 2**: Replaced hard-coded timestamp with dynamic generation (line 229)
- **Why**: Hard-coded `"2025-12-09T13:10:00Z"` violated API contract and prevented accurate audit trails
- **How**: Changed to `datetime.utcnow().isoformat() + "Z"` for actual calculation time

---

### Compliance Check

- **Coding Standards**: ✓ PASS - PEP 8 compliance, proper naming conventions, good docstrings
- **Project Structure**: ✓ PASS - Follows unified structure (models, repositories, services, routes, components)
- **Testing Strategy**: ✓ PASS - Appropriate test levels (unit for services, integration for APIs)
- **All ACs Met**: ✗ **7/10 IMPLEMENTED** (see traceability matrix below)

---

### Requirements Traceability Matrix

| AC # | Requirement | Backend Implementation | Frontend Implementation | Test Coverage | Status |
|------|-------------|----------------------|------------------------|---------------|---------|
| AC1 | Configuration page categorized sections | N/A (frontend) | ConfigurationWizard.vue TabView | ❌ No frontend tests | ⚠️ **PARTIAL** |
| AC2 | Parameter inputs with sliders | N/A (frontend) | ParameterInput.vue with Slider+InputNumber | ❌ No component tests | ⚠️ **PARTIAL** |
| AC3 | Impact analysis auto-calculation | ImpactAnalysisService | useImpactAnalysis composable (1s debounce) | ✅ 18 unit tests | ✅ **COMPLETE** |
| AC4 | Analysis metrics display | ImpactAnalysisResult model | ImpactAnalysisPanel.vue | ✅ Integration tests | ⚠️ **PARTIAL** |
| AC5 | Validation prevents invalid values | ✅ Pydantic validators (spring<1.0, SOS≥1.5, cause≥2.0) | Frontend validation matches | ✅ 13 validation tests | ✅ **COMPLETE** |
| AC6 | William's recommendation | ✅ RecommendationService (20 rules) | Displayed in ImpactAnalysisPanel | ✅ 20 recommendation tests | ✅ **COMPLETE** |
| AC7 | Actions (Cancel, Save, Apply) | PUT /api/v1/config | ConfigurationWizard buttons | ✅ Integration tests | ⚠️ **PARTIAL** (no Save & Backtest) |
| AC8 | ConfigurationWizard component | N/A (frontend) | ✅ ConfigurationWizard.vue exists | ❌ No component tests | ⚠️ **PARTIAL** |
| AC9 | API endpoints (GET/PUT/POST) | ✅ All 3 endpoints implemented | ✅ API client methods | ✅ 10 integration tests | ✅ **COMPLETE** |
| AC10 | Confirmation dialog | N/A (frontend) | ✅ ConfirmationDialog.vue | ❌ No component tests | ⚠️ **PARTIAL** |

**Summary**: 4 COMPLETE, 6 PARTIAL (missing frontend tests), 0 NOT IMPLEMENTED

---

### Test Architecture Assessment

#### Test Inventory:
- **Unit Tests - Config Service**: 15 tests (validation, updates, Wyckoff validators)
- **Unit Tests - Impact Analysis**: 18 tests (pattern qualification, win rate calculation, metrics)
- **Unit Tests - Recommendation Service**: 20 tests (all 20+ recommendation rules covered)
- **Integration Tests - Config API**: 10 tests (GET/PUT/POST endpoints, workflows, conflicts)
- **Frontend Tests**: ❌ **ZERO tests** for Vue components

#### Test Quality:
- **Clear Arrange-Act-Assert**: ✅ Excellent structure in all backend tests
- **Good Assertions**: ✅ Specific assertions with meaningful error messages
- **Edge Cases**: ✅ Boundary values tested (spring=1.0, SOS=1.5, risk hierarchy)
- **Mock Usage**: ✅ Appropriate mocking of database sessions and repositories
- **Given-When-Then**: ⚠️ **IMPLICIT** (tests follow pattern but not documented)

#### Test Gaps:
1. **CRITICAL**: No frontend component tests (ConfigurationWizard, ParameterInput, ImpactAnalysisPanel, ConfirmationDialog)
2. **HIGH**: No concurrency tests for optimistic locking (two simultaneous PUTs)
3. **MEDIUM**: No tests for impact analysis with actual patterns table data
4. **MEDIUM**: No accessibility tests (ARIA labels, keyboard navigation)
5. **LOW**: No performance tests (impact analysis with 900+ patterns)

---

### Security Review

#### Strengths:
- ✅ SQL Injection Protection: All queries use parameterized `text()` statements
- ✅ Input Validation: Pydantic validates all configuration parameters with Wyckoff rules
- ✅ Optimistic Locking: Prevents unauthorized concurrent modifications (409 conflicts)

#### Critical Security Issues:
1. **Missing Authentication** (HIGH): No `@requires_auth` or role checks on config endpoints
   - Any authenticated user can read/modify system-wide configuration
   - Recommendation: Add `Depends(require_role("configuration_admin"))` to PUT endpoint

2. **Missing Rate Limiting** (MEDIUM): POST /analyze-impact has no throttling
   - Each request queries 90 days of patterns (~900 records)
   - Risk: DOS attack via concurrent analysis requests
   - Recommendation: Add `@limiter.limit("10/minute")` using slowapi

3. **No CSRF Protection** (LOW): Frontend doesn't include CSRF tokens
   - Mitigated by same-origin policy and token-based auth (if implemented)

---

### Performance Considerations

#### Backend Performance:
- **Impact Analysis Query**: Queries 90 days of patterns - needs `patterns(detection_time DESC)` index
- **Configuration History**: Manual JSON parsing in Python - O(n) per row
- **Repository Layer**: Raw SQL with manual parameter binding - acceptable for MVP

#### Frontend Performance Issues:
1. **Inefficient Change Detection** (MEDIUM): `hasChanges` computed uses `JSON.stringify()` on every render
2. **Watch Pattern** (LOW): `() => ({ ...proposedConfig })` creates new object per render
3. **Unbounded Cache** (MEDIUM): `useImpactAnalysis` cache never evicts, potential memory leak

---

### Non-Functional Requirements Validation

#### NFR: Security
- **Status**: ⚠️ **CONCERNS**
- **Issues**: Missing authentication (HIGH), missing rate limiting (MEDIUM), no audit logging (HIGH)
- **Notes**: SQL injection protected, input validation excellent

#### NFR: Performance
- **Status**: ⚠️ **CONCERNS**
- **Issues**: Missing patterns table indexes, unbounded cache, inefficient JSON comparisons
- **Notes**: Target <2s for impact analysis may be at risk with 900+ patterns

#### NFR: Reliability
- **Status**: ✓ **PASS**
- **Issues**: None critical
- **Notes**: Optimistic locking handles concurrency, error handling comprehensive

#### NFR: Maintainability
- **Status**: ✓ **PASS**
- **Issues**: Raw SQL in repository (MEDIUM - prefer ORM)
- **Notes**: Excellent code structure, clear separation of concerns, good documentation

---

### Wyckoff Methodology Compliance: EXCELLENT

#### Validated Rules:
✅ **Spring Volume**: Enforced < 1.0x (lines 53-61 in models/config.py)
✅ **SOS Volume**: Enforced ≥ 1.5x (lines 63-71)
✅ **Cause-Effect Ratio**: Enforced ≥ 2.0 (lines 132-148)
✅ **Risk Hierarchy**: per_trade < campaign < portfolio_heat (lines 96-110)

#### Recommendation Engine Coverage:
- Spring volume relaxation → WARNING (lines 84-95 in recommendation_service.py)
- SOS volume reduction → WARNING with Wyckoff explanation
- Cause factor < 2.0 → WARNING referencing 2:1 ratio requirement
- Risk increases → CAUTION with discipline reminders
- Multiple relaxed thresholds → WARNING about compounding risk
- Tightened criteria → INFO about quality vs quantity trade-off

**Assessment**: Implementation demonstrates deep understanding of Wyckoff principles with proper validation at model, service, and recommendation layers.

---

### Files Modified During Review

**Frontend**:
1. `frontend/src/services/api.ts` (Added `put` method at lines 99-101)

**Backend**:
2. `backend/src/api/routes/config.py` (Added datetime import line 7, fixed timestamp line 229)

**Action Required**: Developer must update File List in story with these two files.

---

### Improvements Checklist

#### Critical (Must Fix Before Production):
- [ ] **Create patterns table migration** with schema: id, symbol, pattern_type, detection_time, volume_ratio, confidence_score, cause_factor, metadata
- [ ] **Add patterns(detection_time DESC) index** for performance
- [ ] **Implement audit trail logging** in `ConfigurationService.update_configuration()` (line 93)
- [ ] **Add authentication checks** to all /config endpoints with role-based access control
- [ ] **Fix TypeScript type mismatches** between API Decimal strings and component number types

#### High Priority (Should Fix Before Release):
- [ ] **Add rate limiting** to POST /analyze-impact endpoint (slowapi with 10/minute)
- [ ] **Create frontend component tests** (ConfigurationWizard, ParameterInput, ImpactAnalysisPanel, ConfirmationDialog)
- [ ] **Add concurrency tests** for optimistic locking (simultaneous PUT requests)
- [ ] **Fix unbounded cache** in useImpactAnalysis.ts (implement LRU or disable)
- [ ] **Add cleanup handlers** in ConfigurationWizard (onBeforeUnmount to clear debounce)

#### Medium Priority (Technical Debt):
- [ ] Add unique constraint on `system_configuration.version` column
- [ ] Add defensive error handling in `ImpactAnalysisService._pattern_qualifies()`
- [ ] Optimize `hasChanges` computed to avoid JSON.stringify
- [ ] Add ARIA labels and accessibility attributes to all form controls
- [ ] Add Decimal precision validators (quantize to specific decimal places)

---

### Gate Status

**Gate**: ⚠️ **CONCERNS** → [docs/qa/gates/11.1-configuration-wizard-ui.yml](../../qa/gates/11.1-configuration-wizard-ui.yml)

**Status Reason**: Two CRITICAL issues were fixed during review, but FOUR remaining HIGH severity issues prevent PASS gate:
1. Patterns table doesn't exist (runtime blocker)
2. Missing audit trail logging (compliance requirement)
3. No authentication on config endpoints (security risk)
4. Zero frontend component tests (quality risk)

**Quality Score**: 72/100
- Base: 100
- Subtract 20 for 1 CRITICAL issue remaining (patterns table)
- Subtract 8 for 4 HIGH severity issues (audit, auth, types, tests)

**Risk Profile**: HIGH for patterns table dependency, MEDIUM for security/auth

---

### Recommended Status

✗ **Changes Required** - Address critical and high priority issues above before marking Done.

**Estimated Remediation Time**: 6-8 hours
- Patterns table migration + indexes: 2 hours
- Audit trail integration: 1 hour
- Authentication/authorization: 2 hours
- Frontend component tests: 3 hours

**Story Owner Decides Final Status**

---

### Additional Notes

1. **Excellent Foundation**: Despite issues, the implementation demonstrates professional-grade architecture
2. **Test-Driven Approach**: Backend has exemplary test coverage; frontend needs equivalent rigor
3. **Wyckoff Expertise**: Developers clearly understand methodology - validators are spot-on
4. **Performance Risk**: Impact analysis may struggle with >1000 patterns without database optimization
5. **Security Mindset**: Input validation excellent, but missing defense-in-depth (auth, rate limiting)

**Recommendation**: This story represents significant value but is NOT production-ready. Prioritize the 4 HIGH severity issues for next sprint iteration.
