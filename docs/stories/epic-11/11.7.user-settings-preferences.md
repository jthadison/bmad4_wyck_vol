# Story 11.7: User Settings & Preferences

## Status
Done

## Story
**As a** trader,
**I want** a settings page to customize my experience,
**so that** the UI works the way I prefer.

## Acceptance Criteria
1. Settings categories: Appearance, Notifications, Trading, Account
2. Appearance: theme (dark/light), font size, color scheme
3. Notifications: configure channels, filters, quiet hours
4. Trading: default timeframe, watchlist symbols, alert thresholds
5. Account: email, password change, API key generation
6. Persistence: settings saved to user profile in database
7. Import/export: backup settings as JSON file
8. Component: `SettingsPage.tsx`
9. API: GET /api/user/settings, PUT /api/user/settings
10. Validation: settings schema validated before save

## Tasks / Subtasks

- [ ] **Task 1: Backend - User Settings Data Models** (AC: 1, 2, 3, 4, 5, 10)
  - [ ] Subtask 1.1: Create `UserSettings` Pydantic model in `backend/src/models/user_settings.py`
  - [ ] Subtask 1.2: Create `AppearanceSettings` model with fields: theme ("light" | "dark"), font_size ("small" | "medium" | "large"), color_scheme (str)
  - [ ] Subtask 1.3: Create `NotificationSettings` model referencing NotificationPreferences from Story 11.6
  - [ ] Subtask 1.4: Create `TradingSettings` model with fields: default_timeframe, watchlist_symbols (List[str]), alert_thresholds (Dict)
  - [ ] Subtask 1.5: Create `AccountSettings` model with fields: email, phone_number, timezone, api_keys (List)
  - [ ] Subtask 1.6: Create `APIKey` model with fields: id, name, key_hash, created_at, last_used_at, expires_at, scopes (List[str])
  - [ ] Subtask 1.7: Add validation: theme enum, font_size enum, default_timeframe matches valid timeframes, email format, timezone validation
  - [ ] Subtask 1.8: Create `UserSettingsExport` model for JSON export with metadata (version, exported_at, schema_version)
  - [ ] Subtask 1.9: Unit test models with Pydantic validation (pytest)

- [ ] **Task 2: Backend - User Settings Database Schema** (AC: 6)
  - [ ] Subtask 2.1: Create `users` table with fields: id, username, email, password_hash, created_at, updated_at, last_login_at
  - [ ] Subtask 2.2: Create `user_settings` table with fields: user_id (FK to users), settings (JSONB), version, updated_at
  - [ ] Subtask 2.3: Create `api_keys` table with fields: id, user_id (FK), name, key_hash, scopes (JSONB), created_at, last_used_at, expires_at, revoked_at
  - [ ] Subtask 2.4: Add indexes: idx_user_settings_user_id (user_id), idx_api_keys_user_id (user_id), idx_api_keys_key_hash (key_hash)
  - [ ] Subtask 2.5: Create Alembic migration for user and settings tables
  - [ ] Subtask 2.6: Create `UserRepository` in `backend/src/repositories/user_repository.py`
  - [ ] Subtask 2.7: Implement methods: get_user(user_id), get_settings(user_id), update_settings(user_id, settings), get_api_keys(user_id), create_api_key(user_id, name, scopes), revoke_api_key(key_id)
  - [ ] Subtask 2.8: Unit test repository with in-memory database (pytest + SQLAlchemy async)

- [ ] **Task 3: Backend - Password Management** (AC: 5)
  - [ ] Subtask 3.1: Create `PasswordService` in `backend/src/auth/password_service.py`
  - [ ] Subtask 3.2: Use `bcrypt` library for password hashing (min 12 rounds)
  - [ ] Subtask 3.3: Implement `hash_password(password: str)` method
  - [ ] Subtask 3.4: Implement `verify_password(password: str, password_hash: str)` method
  - [ ] Subtask 3.5: Implement `validate_password_strength(password: str)` - min 12 chars, complexity requirements
  - [ ] Subtask 3.6: Create `ChangePasswordRequest` model with fields: current_password, new_password, new_password_confirm
  - [ ] Subtask 3.7: Unit test password hashing and verification (pytest)

- [ ] **Task 4: Backend - API Key Management Service** (AC: 5)
  - [ ] Subtask 4.1: Create `APIKeyService` in `backend/src/auth/api_key_service.py`
  - [ ] Subtask 4.2: Implement `generate_api_key()` - generate random 32-byte key, encode as base64
  - [ ] Subtask 4.3: Implement `hash_api_key(key: str)` - SHA256 hash for storage
  - [ ] Subtask 4.4: Implement `verify_api_key(key: str, key_hash: str)` - compare hash
  - [ ] Subtask 4.5: Implement `create_api_key(user_id, name, scopes, expires_days=90)` - generate, hash, store
  - [ ] Subtask 4.6: Implement `revoke_api_key(key_id)` - set revoked_at timestamp
  - [ ] Subtask 4.7: Implement `validate_api_key(key: str)` - verify hash, check expiration, check revocation
  - [ ] Subtask 4.8: API key format: "bmad_" prefix + base64 encoded (e.g., "bmad_a1b2c3d4e5f6...")
  - [ ] Subtask 4.9: Scopes: "read", "write", "admin" (for Phase 2 API authentication)
  - [ ] Subtask 4.10: Unit test API key generation, hashing, validation (pytest)

- [ ] **Task 5: Backend - Settings Service** (AC: 6, 7, 10)
  - [ ] Subtask 5.1: Create `SettingsService` in `backend/src/settings/service.py`
  - [ ] Subtask 5.2: Implement `get_user_settings(user_id)` - fetch from repository, return UserSettings
  - [ ] Subtask 5.3: Implement `update_user_settings(user_id, settings)` - validate, merge with existing, save
  - [ ] Subtask 5.4: Implement partial updates: only update provided fields, preserve others
  - [ ] Subtask 5.5: Implement `export_settings(user_id)` - return UserSettingsExport with metadata
  - [ ] Subtask 5.6: Implement `import_settings(user_id, settings_json)` - validate schema version, import settings
  - [ ] Subtask 5.7: Schema versioning: current version = 1, handle migrations for future versions
  - [ ] Subtask 5.8: Default settings: provide sensible defaults for new users (dark theme, medium font, 85% confidence threshold)
  - [ ] Subtask 5.9: Unit test with mock repository (pytest with pytest-mock)
  - [ ] Subtask 5.10: Integration test with database (pytest)

- [ ] **Task 6: Backend - Settings API Endpoints** (AC: 9)
  - [ ] Subtask 6.1: Create `GET /api/v1/user/settings` route in `backend/src/api/routes/user.py`
  - [ ] Subtask 6.2: Return full UserSettings object with all categories (appearance, notifications, trading, account)
  - [ ] Subtask 6.3: Exclude sensitive fields from response (password_hash, api key hashes)
  - [ ] Subtask 6.4: Create `PUT /api/v1/user/settings` route for full settings update
  - [ ] Subtask 6.5: Create `PATCH /api/v1/user/settings` route for partial settings update
  - [ ] Subtask 6.6: Validate settings schema with Pydantic before save
  - [ ] Subtask 6.7: Return updated settings in response
  - [ ] Subtask 6.8: Create `GET /api/v1/user/settings/export` route to download settings as JSON
  - [ ] Subtask 6.9: Create `POST /api/v1/user/settings/import` route to upload settings JSON
  - [ ] Subtask 6.10: Unit test endpoints with mock service layer (pytest)
  - [ ] Subtask 6.11: Integration test with database (pytest)

- [ ] **Task 7: Backend - Account Management API Endpoints** (AC: 5)
  - [ ] Subtask 7.1: Create `POST /api/v1/user/change-password` route in `backend/src/api/routes/user.py`
  - [ ] Subtask 7.2: Verify current password before allowing change
  - [ ] Subtask 7.3: Validate new password strength (min 12 chars, complexity)
  - [ ] Subtask 7.4: Hash and store new password
  - [ ] Subtask 7.5: Create `GET /api/v1/user/api-keys` route to list user's API keys
  - [ ] Subtask 7.6: Return list with masked keys (show only last 4 chars: "bmad_...abc1")
  - [ ] Subtask 7.7: Create `POST /api/v1/user/api-keys` route to generate new API key
  - [ ] Subtask 7.8: Request body: name, scopes, expires_days (optional, default 90)
  - [ ] Subtask 7.9: Return full API key ONCE in response (only time it's shown in full)
  - [ ] Subtask 7.10: Create `DELETE /api/v1/user/api-keys/{key_id}` route to revoke API key
  - [ ] Subtask 7.11: Unit test endpoints with mock service layer (pytest)

- [ ] **Task 8: Backend - Type Generation** (AC: 8)
  - [ ] Subtask 8.1: Run `pydantic-to-typescript` to generate TypeScript types
  - [ ] Subtask 8.2: Verify generated types in `frontend/src/types/`: UserSettings.ts, AppearanceSettings.ts, NotificationSettings.ts, TradingSettings.ts, AccountSettings.ts, APIKey.ts
  - [ ] Subtask 8.3: Update FastAPI OpenAPI schema with settings endpoints

- [ ] **Task 9: Frontend - Settings Store** (AC: 6, 9)
  - [ ] Subtask 9.1: Create Pinia store `useSettingsStore.ts` in `frontend/src/stores/`
  - [ ] Subtask 9.2: Define store state: settings (UserSettings | null), isLoading, error, hasUnsavedChanges
  - [ ] Subtask 9.3: Define store actions: fetchSettings(), updateSettings(settings), exportSettings(), importSettings(file), changePassword(oldPass, newPass), fetchAPIKeys(), createAPIKey(name, scopes), revokeAPIKey(keyId)
  - [ ] Subtask 9.4: Define store getters: appearanceSettings, notificationSettings, tradingSettings, accountSettings
  - [ ] Subtask 9.5: Implement optimistic updates: update local state immediately, rollback on error
  - [ ] Subtask 9.6: Track unsaved changes with hasUnsavedChanges flag
  - [ ] Subtask 9.7: Unit test store with mock API responses (Vitest)

- [ ] **Task 10: Frontend - Settings Page Layout** (AC: 1, 8)
  - [ ] Subtask 10.1: Create `SettingsPage.vue` component in `frontend/src/views/` (NOTE: Epic AC8 says .tsx but project uses Vue)
  - [ ] Subtask 10.2: Import UserSettings types from `frontend/src/types/`
  - [ ] Subtask 10.3: Use PrimeVue TabView component for category tabs: Appearance, Notifications, Trading, Account
  - [ ] Subtask 10.4: Each tab displays relevant settings section
  - [ ] Subtask 10.5: Global save button at bottom of page (saves all changes across tabs)
  - [ ] Subtask 10.6: "Discard Changes" button to reset to last saved state
  - [ ] Subtask 10.7: Loading state while fetching settings
  - [ ] Subtask 10.8: Success/error toast notifications after save
  - [ ] Subtask 10.9: Unsaved changes warning: prompt user before navigating away
  - [ ] Subtask 10.10: Component test for settings page layout (Vitest + Vue Testing Library)

- [ ] **Task 11: Frontend - Appearance Settings UI** (AC: 2)
  - [ ] Subtask 11.1: Create `AppearanceSettings.vue` component in `frontend/src/components/settings/`
  - [ ] Subtask 11.2: Theme selector: PrimeVue SelectButton with Light/Dark options
  - [ ] Subtask 11.3: Font size selector: PrimeVue SelectButton with Small/Medium/Large options
  - [ ] Subtask 11.4: Color scheme selector: PrimeVue Dropdown with predefined color schemes
  - [ ] Subtask 11.5: Live preview: apply theme changes immediately to show effect
  - [ ] Subtask 11.6: Theme implementation: use PrimeVue theming system (presets: Lara Light, Lara Dark)
  - [ ] Subtask 11.7: Font size implementation: CSS variables (--font-size-base: 14px/16px/18px)
  - [ ] Subtask 11.8: Bind settings to store with v-model
  - [ ] Subtask 11.9: Component test for appearance settings (Vitest)

- [ ] **Task 12: Frontend - Notification Settings UI** (AC: 3)
  - [ ] Subtask 12.1: Create `NotificationSettingsPanel.vue` component in `frontend/src/components/settings/`
  - [ ] Subtask 12.2: Reuse NotificationPreferences component from Story 11.6
  - [ ] Subtask 12.3: Integrate with settings store (useSettingsStore) instead of standalone store
  - [ ] Subtask 12.4: Display: channel toggles, confidence threshold slider, quiet hours pickers
  - [ ] Subtask 12.5: All notification settings from Story 11.6 accessible here
  - [ ] Subtask 12.6: Component test for notification settings panel (Vitest)

- [ ] **Task 13: Frontend - Trading Settings UI** (AC: 4)
  - [ ] Subtask 13.1: Create `TradingSettings.vue` component in `frontend/src/components/settings/`
  - [ ] Subtask 13.2: Default timeframe selector: PrimeVue Dropdown with options (1m, 5m, 15m, 1h, 1d)
  - [ ] Subtask 13.3: Watchlist symbols: PrimeVue Chips component for adding/removing symbols
  - [ ] Subtask 13.4: Symbol validation: check valid ticker format (uppercase, 1-5 chars)
  - [ ] Subtask 13.5: Alert thresholds: InputNumber components for min confidence, min R-multiple
  - [ ] Subtask 13.6: Range validation: confidence 70-95%, R-multiple 2.0-10.0
  - [ ] Subtask 13.7: Help text: tooltips explaining each setting
  - [ ] Subtask 13.8: Bind settings to store with v-model
  - [ ] Subtask 13.9: Component test for trading settings (Vitest)

- [ ] **Task 14: Frontend - Account Settings UI** (AC: 5)
  - [ ] Subtask 14.1: Create `AccountSettings.vue` component in `frontend/src/components/settings/`
  - [ ] Subtask 14.2: Section 1: Email/Phone - display current email, editable phone number
  - [ ] Subtask 14.3: Section 2: Password Change - form with current password, new password, confirm password inputs
  - [ ] Subtask 14.4: Password strength indicator: visual indicator (weak/medium/strong)
  - [ ] Subtask 14.5: Password visibility toggle: show/hide password text
  - [ ] Subtask 14.6: "Change Password" button triggers password change action
  - [ ] Subtask 14.7: Section 3: API Keys - list of API keys with name, created date, last used, actions
  - [ ] Subtask 14.8: "Generate New API Key" button opens dialog
  - [ ] Subtask 14.9: Component test for account settings (Vitest)

- [ ] **Task 15: Frontend - API Key Management UI** (AC: 5)
  - [ ] Subtask 15.1: Create `APIKeyManager.vue` component in `frontend/src/components/settings/`
  - [ ] Subtask 15.2: Display API keys in PrimeVue DataTable: name, key (masked), created date, last used, expires, actions
  - [ ] Subtask 15.3: Masked key format: "bmad_...abc1" (show last 4 chars only)
  - [ ] Subtask 15.4: Action column: "Revoke" button with confirmation dialog
  - [ ] Subtask 15.5: "Generate New Key" button opens dialog with name input and scopes checkboxes
  - [ ] Subtask 15.6: After generation, display full key ONCE in a dialog with copy button
  - [ ] Subtask 15.7: Warning message: "This is the only time you'll see this key. Copy it now!"
  - [ ] Subtask 15.8: Copy to clipboard functionality with success toast
  - [ ] Subtask 15.9: Empty state: "No API keys generated" when list is empty
  - [ ] Subtask 15.10: Component test for API key manager (Vitest)

- [ ] **Task 16: Frontend - Import/Export Settings UI** (AC: 7)
  - [ ] Subtask 16.1: Create `ImportExportSettings.vue` component in `frontend/src/components/settings/`
  - [ ] Subtask 16.2: "Export Settings" button triggers download of settings JSON file
  - [ ] Subtask 16.3: Filename format: "bmad-settings-{username}-{date}.json"
  - [ ] Subtask 16.4: Use browser File API to trigger download
  - [ ] Subtask 16.5: "Import Settings" button opens file picker
  - [ ] Subtask 16.6: Validate JSON format before import (check schema version)
  - [ ] Subtask 16.7: Show preview of settings to be imported in dialog
  - [ ] Subtask 16.8: Confirmation: "This will overwrite your current settings. Continue?"
  - [ ] Subtask 16.9: Success toast: "Settings imported successfully"
  - [ ] Subtask 16.10: Error handling: invalid file format, schema version mismatch
  - [ ] Subtask 16.11: Component test for import/export (Vitest)

- [ ] **Task 17: Frontend - Theme Persistence and Application** (AC: 2, 6)
  - [ ] Subtask 17.1: Create `useTheme.ts` composable in `frontend/src/composables/`
  - [ ] Subtask 17.2: Implement `applyTheme(theme: "light" | "dark")` - switch PrimeVue theme
  - [ ] Subtask 17.3: Implement `applyFontSize(size: "small" | "medium" | "large")` - set CSS variable
  - [ ] Subtask 17.4: Load theme from settings store on app initialization
  - [ ] Subtask 17.5: Apply theme in `App.vue` main component
  - [ ] Subtask 17.6: Watch settings store for theme changes, apply immediately
  - [ ] Subtask 17.7: Persist theme to localStorage for faster initial load (avoid flash)
  - [ ] Subtask 17.8: System preference detection: detect OS dark mode if user has no saved preference

- [ ] **Task 18: Frontend - Settings Validation and Error Handling** (AC: 10)
  - [ ] Subtask 18.1: Create `useSettingsValidation.ts` composable in `frontend/src/composables/`
  - [ ] Subtask 18.2: Implement field-level validation: email format, phone format, password strength, symbol format
  - [ ] Subtask 18.3: Display validation errors inline with PrimeVue Message component
  - [ ] Subtask 18.4: Disable save button if validation errors exist
  - [ ] Subtask 18.5: Handle API validation errors: map backend error codes to user-friendly messages
  - [ ] Subtask 18.6: Display API errors with PrimeVue Toast (error severity)
  - [ ] Subtask 18.7: Retry logic for transient errors (network failures)
  - [ ] Subtask 18.8: Unit test validation logic (Vitest)

- [ ] **Task 19: Integration Testing** (AC: All)
  - [ ] Subtask 19.1: E2E test: Open settings page → verify all tabs render (Playwright)
  - [ ] Subtask 19.2: E2E test: Change theme to dark → verify applied immediately (Playwright)
  - [ ] Subtask 19.3: E2E test: Change font size → verify CSS updated (Playwright)
  - [ ] Subtask 19.4: E2E test: Update notification settings → save → verify persisted (Playwright)
  - [ ] Subtask 19.5: E2E test: Update trading settings (watchlist) → save → reload page → verify persisted (Playwright)
  - [ ] Subtask 19.6: E2E test: Change password → verify success toast (Playwright, use test user)
  - [ ] Subtask 19.7: E2E test: Generate API key → copy key → verify masked in list (Playwright)
  - [ ] Subtask 19.8: E2E test: Revoke API key → verify removed from list (Playwright)
  - [ ] Subtask 19.9: E2E test: Export settings → verify JSON file downloaded (Playwright)
  - [ ] Subtask 19.10: E2E test: Import settings → verify settings updated (Playwright)
  - [ ] Subtask 19.11: E2E test: Navigate away with unsaved changes → verify warning prompt (Playwright)
  - [ ] Subtask 19.12: Backend integration test: Full settings CRUD cycle with database (pytest)

## Dev Notes

### Previous Story Insights
Story 11.6 (Notification & Alert System) established the NotificationPreferences data model and UI component which Story 11.7 will integrate into the unified settings page. The notification settings will be a sub-section of the overall user settings, accessible via the Settings page.

### Epic Context
This story is part of Epic 11 (Configuration & Analytics) which delivers FR29 and FR30 UI components. Story 11.7 implements a comprehensive settings and preferences system that gives traders full control over their experience, including appearance customization, notification configuration, trading defaults, and account management.

### Data Models

**User Settings Models:**
[Source: Architecture design based on AC requirements and following patterns from docs/architecture/4-data-models.md]

```python
# backend/src/models/user_settings.py

from decimal import Decimal
from datetime import datetime
from typing import Dict, List, Optional, Literal
from pydantic import BaseModel, Field, EmailStr, validator
from uuid import UUID

class AppearanceSettings(BaseModel):
    """Appearance customization settings"""
    theme: Literal["light", "dark"] = "dark"
    font_size: Literal["small", "medium", "large"] = "medium"
    color_scheme: str = "default"  # Color scheme name: "default", "blue", "green"

    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }

class TradingSettings(BaseModel):
    """Trading-specific preferences"""
    default_timeframe: Literal["1m", "5m", "15m", "1h", "1d"] = "1d"
    watchlist_symbols: List[str] = Field(default_factory=list)
    min_confidence_alert: int = Field(default=85, ge=70, le=95)
    min_r_multiple_alert: Decimal = Field(default=Decimal("2.0"), ge=Decimal("2.0"), le=Decimal("10.0"))

    @validator('watchlist_symbols')
    def validate_symbols(cls, v):
        """Validate ticker symbol format"""
        for symbol in v:
            if not symbol.isupper() or not (1 <= len(symbol) <= 5):
                raise ValueError(f"Invalid symbol format: {symbol}")
        return v

    class Config:
        json_encoders = {
            Decimal: str,
            datetime: lambda v: v.isoformat()
        }

class APIKey(BaseModel):
    """API key for programmatic access"""
    id: UUID
    name: str = Field(..., max_length=100)
    key_masked: str  # Only last 4 chars visible: "bmad_...abc1"
    scopes: List[str]  # ["read", "write", "admin"]
    created_at: datetime
    last_used_at: Optional[datetime] = None
    expires_at: datetime
    revoked_at: Optional[datetime] = None

    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }

class AccountSettings(BaseModel):
    """Account management settings"""
    email: EmailStr
    phone_number: Optional[str] = None  # E.164 format: +1234567890
    timezone: str = "America/New_York"
    api_keys: List[APIKey] = Field(default_factory=list)

    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }

class UserSettings(BaseModel):
    """Complete user settings object"""
    user_id: UUID
    appearance: AppearanceSettings
    notifications: 'NotificationPreferences'  # From Story 11.6
    trading: TradingSettings
    account: AccountSettings
    version: int = 1  # Schema version for migrations
    updated_at: datetime

    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }

# For import/export functionality
class UserSettingsExport(BaseModel):
    """Settings export format with metadata"""
    schema_version: int = 1
    exported_at: datetime
    username: str
    settings: UserSettings

    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }

# Password change request
class ChangePasswordRequest(BaseModel):
    """Request to change user password"""
    current_password: str = Field(..., min_length=12)
    new_password: str = Field(..., min_length=12)
    new_password_confirm: str = Field(..., min_length=12)

    @validator('new_password_confirm')
    def passwords_match(cls, v, values):
        if 'new_password' in values and v != values['new_password']:
            raise ValueError('Passwords do not match')
        return v

# API key generation request
class CreateAPIKeyRequest(BaseModel):
    """Request to create new API key"""
    name: str = Field(..., min_length=1, max_length=100)
    scopes: List[Literal["read", "write", "admin"]] = ["read"]
    expires_days: int = Field(default=90, ge=1, le=365)

class CreateAPIKeyResponse(BaseModel):
    """Response with full API key (only shown once)"""
    id: UUID
    name: str
    api_key: str  # Full key: "bmad_a1b2c3d4e5f6..." - ONLY TIME IT'S SHOWN
    expires_at: datetime
    warning: str = "This is the only time you'll see this key. Copy it now!"

    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }
```

**TypeScript Types (Auto-generated):**
[Source: docs/architecture/3-tech-stack.md - pydantic-to-typescript]

After running `pydantic-to-typescript`, types will be available at:
- `frontend/src/types/UserSettings.ts`
- `frontend/src/types/AppearanceSettings.ts`
- `frontend/src/types/TradingSettings.ts`
- `frontend/src/types/AccountSettings.ts`
- `frontend/src/types/APIKey.ts`
- `frontend/src/types/CreateAPIKeyRequest.ts`
- `frontend/src/types/CreateAPIKeyResponse.ts`

### API Specifications

**Settings Endpoints:**
[Source: docs/architecture/5-api-specification.md - following standard conventions]

```
GET /api/v1/user/settings
Response: 200 OK
{
  "user_id": "uuid",
  "appearance": {
    "theme": "dark",
    "font_size": "medium",
    "color_scheme": "default"
  },
  "notifications": {
    // NotificationPreferences object from Story 11.6
  },
  "trading": {
    "default_timeframe": "1d",
    "watchlist_symbols": ["AAPL", "MSFT", "TSLA"],
    "min_confidence_alert": 85,
    "min_r_multiple_alert": "2.0"
  },
  "account": {
    "email": "trader@example.com",
    "phone_number": "+12345678901",
    "timezone": "America/New_York",
    "api_keys": [
      {
        "id": "uuid",
        "name": "My Trading Bot",
        "key_masked": "bmad_...abc1",
        "scopes": ["read", "write"],
        "created_at": "2024-03-13T13:00:00Z",
        "last_used_at": "2024-03-14T08:30:00Z",
        "expires_at": "2024-06-11T13:00:00Z",
        "revoked_at": null
      }
    ]
  },
  "version": 1,
  "updated_at": "2024-03-13T13:00:00Z"
}

Error Responses:
- 404 Not Found: User not found
- 500 Internal Server Error: Database error
```

```
PUT /api/v1/user/settings
Request Body: UserSettings (full update)

Response: 200 OK
{
  "success": true,
  "settings": UserSettings
}

Error Responses:
- 400 Bad Request: Invalid settings format
- 422 Unprocessable Entity: Validation failed (invalid timeframe, symbol format, etc.)
```

```
PATCH /api/v1/user/settings
Request Body: Partial<UserSettings> (only fields to update)

Response: 200 OK
{
  "success": true,
  "settings": UserSettings
}

Error Responses:
- 400 Bad Request: Invalid settings format
- 422 Unprocessable Entity: Validation failed
```

```
GET /api/v1/user/settings/export
Response: 200 OK
Content-Type: application/json
Content-Disposition: attachment; filename="bmad-settings-{username}-{date}.json"

{
  "schema_version": 1,
  "exported_at": "2024-03-13T13:00:00Z",
  "username": "trader123",
  "settings": UserSettings
}
```

```
POST /api/v1/user/settings/import
Request Body: UserSettingsExport (multipart/form-data file upload)

Response: 200 OK
{
  "success": true,
  "settings": UserSettings,
  "message": "Settings imported successfully"
}

Error Responses:
- 400 Bad Request: Invalid file format
- 422 Unprocessable Entity: Schema version mismatch or validation failed
```

**Password Management Endpoints:**

```
POST /api/v1/user/change-password
Request Body: ChangePasswordRequest

Response: 200 OK
{
  "success": true,
  "message": "Password changed successfully"
}

Error Responses:
- 400 Bad Request: Current password incorrect
- 422 Unprocessable Entity: New password doesn't meet strength requirements
```

**API Key Management Endpoints:**

```
GET /api/v1/user/api-keys
Response: 200 OK
{
  "api_keys": [
    {
      "id": "uuid",
      "name": "My Trading Bot",
      "key_masked": "bmad_...abc1",
      "scopes": ["read", "write"],
      "created_at": "2024-03-13T13:00:00Z",
      "last_used_at": "2024-03-14T08:30:00Z",
      "expires_at": "2024-06-11T13:00:00Z",
      "revoked_at": null
    }
  ]
}
```

```
POST /api/v1/user/api-keys
Request Body: CreateAPIKeyRequest

Response: 201 Created
{
  "id": "uuid",
  "name": "My Trading Bot",
  "api_key": "bmad_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",
  "expires_at": "2024-06-11T13:00:00Z",
  "warning": "This is the only time you'll see this key. Copy it now!"
}

Error Responses:
- 422 Unprocessable Entity: Invalid name or scopes
```

```
DELETE /api/v1/user/api-keys/{key_id}
Response: 200 OK
{
  "success": true,
  "message": "API key revoked successfully"
}

Error Responses:
- 404 Not Found: API key not found
```

### Component Specifications

**Backend Components:**
[Source: docs/architecture/6-components.md]

**Settings Service** (`backend/src/settings/service.py`):
- NEW service for user settings management
- Responsibilities: fetch, update, validate settings, import/export, default settings
- Technology: FastAPI, Pydantic validation, SQLAlchemy async

**Password Service** (`backend/src/auth/password_service.py`):
- NEW service for password management
- Technology: bcrypt for hashing (min 12 rounds), password strength validation

**API Key Service** (`backend/src/auth/api_key_service.py`):
- NEW service for API key management
- Technology: Python secrets module for key generation, SHA256 for hashing, base64 encoding
- Key format: "bmad_" prefix + 32 bytes base64 encoded

**User Repository** (`backend/src/repositories/user_repository.py`):
- NEW repository for user data access
- Technology: SQLAlchemy async, PostgreSQL

**Frontend Components:**
[Source: docs/architecture/6-components.md#6.2]

**SettingsPage.vue**:
- New view location: `frontend/src/views/SettingsPage.vue`
- Responsibilities: settings page layout, tab navigation, save/discard actions, unsaved changes warning
- Technology: Vue 3 Composition API, PrimeVue (TabView, Button, Toast)

**AppearanceSettings.vue**:
- New component location: `frontend/src/components/settings/AppearanceSettings.vue`
- Responsibilities: theme, font size, color scheme configuration with live preview
- Technology: Vue 3 Composition API, PrimeVue (SelectButton, Dropdown)

**NotificationSettingsPanel.vue**:
- New component location: `frontend/src/components/settings/NotificationSettingsPanel.vue`
- Responsibilities: integrate NotificationPreferences component from Story 11.6 into settings
- Technology: Vue 3 Composition API, reuse components from Story 11.6

**TradingSettings.vue**:
- New component location: `frontend/src/components/settings/TradingSettings.vue`
- Responsibilities: default timeframe, watchlist, alert thresholds configuration
- Technology: Vue 3 Composition API, PrimeVue (Dropdown, Chips, InputNumber)

**AccountSettings.vue**:
- New component location: `frontend/src/components/settings/AccountSettings.vue`
- Responsibilities: email, phone, password change, API key management
- Technology: Vue 3 Composition API, PrimeVue (InputText, Password, Button)

**APIKeyManager.vue**:
- New component location: `frontend/src/components/settings/APIKeyManager.vue`
- Responsibilities: list, generate, revoke API keys
- Technology: Vue 3 Composition API, PrimeVue (DataTable, Dialog, Button)

**ImportExportSettings.vue**:
- New component location: `frontend/src/components/settings/ImportExportSettings.vue`
- Responsibilities: export settings JSON, import settings from file
- Technology: Vue 3 Composition API, browser File API

**Pinia Store - useSettingsStore**:
- New store location: `frontend/src/stores/settingsStore.ts`
- State: settings, isLoading, error, hasUnsavedChanges
- Actions: fetchSettings(), updateSettings(), exportSettings(), importSettings(), changePassword(), fetchAPIKeys(), createAPIKey(), revokeAPIKey()
- Getters: appearanceSettings, notificationSettings, tradingSettings, accountSettings

**Composables:**
- `useTheme.ts` - Theme application and persistence
- `useSettingsValidation.ts` - Field-level validation logic

### File Locations

**Backend Files to Create/Modify:**
[Source: docs/architecture/10-unified-project-structure.md]

```
backend/
├── src/
│   ├── api/
│   │   └── routes/
│   │       └── user.py                   # CREATE: User and settings API routes
│   ├── models/
│   │   └── user_settings.py              # CREATE: UserSettings, AppearanceSettings, TradingSettings, AccountSettings, APIKey models
│   ├── repositories/
│   │   └── user_repository.py            # CREATE: UserRepository for database operations
│   ├── settings/
│   │   └── service.py                    # CREATE: SettingsService for settings management
│   ├── auth/
│   │   ├── password_service.py           # CREATE: Password hashing and validation
│   │   └── api_key_service.py            # CREATE: API key generation and management
│   └── api/
│       └── main.py                       # MODIFY: Add user routes
├── alembic/
│   └── versions/
│       └── {timestamp}_add_user_settings.py  # CREATE: Migration for users, user_settings, api_keys tables
├── tests/
│   ├── unit/
│   │   ├── test_settings_service.py      # CREATE: Unit tests for settings service
│   │   ├── test_password_service.py      # CREATE: Unit tests for password service
│   │   └── test_api_key_service.py       # CREATE: Unit tests for API key service
│   └── integration/
│       └── test_settings_api.py          # CREATE: Integration tests with database
```

**Frontend Files to Create/Modify:**
[Source: docs/architecture/10-unified-project-structure.md]

```
frontend/
├── src/
│   ├── views/
│   │   └── SettingsPage.vue              # CREATE: Settings page layout
│   ├── components/
│   │   └── settings/
│   │       ├── AppearanceSettings.vue    # CREATE: Appearance settings UI
│   │       ├── NotificationSettingsPanel.vue # CREATE: Notification settings integration
│   │       ├── TradingSettings.vue       # CREATE: Trading settings UI
│   │       ├── AccountSettings.vue       # CREATE: Account settings UI
│   │       ├── APIKeyManager.vue         # CREATE: API key management UI
│   │       └── ImportExportSettings.vue  # CREATE: Import/export UI
│   ├── composables/
│   │   ├── useTheme.ts                   # CREATE: Theme application helper
│   │   └── useSettingsValidation.ts      # CREATE: Settings validation helper
│   ├── stores/
│   │   └── settingsStore.ts              # CREATE: Pinia store for settings state
│   ├── types/                            # AUTO-GENERATED: TypeScript types from Pydantic
│   │   ├── UserSettings.ts
│   │   ├── AppearanceSettings.ts
│   │   ├── TradingSettings.ts
│   │   ├── AccountSettings.ts
│   │   ├── APIKey.ts
│   │   ├── CreateAPIKeyRequest.ts
│   │   └── CreateAPIKeyResponse.ts
│   ├── services/
│   │   └── api.ts                        # EXISTING: Use for REST API calls
│   └── App.vue                           # MODIFY: Apply theme on initialization
├── tests/
│   └── components/
│       ├── SettingsPage.spec.ts          # CREATE: Component tests
│       ├── AppearanceSettings.spec.ts    # CREATE: Appearance settings tests
│       ├── TradingSettings.spec.ts       # CREATE: Trading settings tests
│       ├── AccountSettings.spec.ts       # CREATE: Account settings tests
│       └── APIKeyManager.spec.ts         # CREATE: API key manager tests
```

**E2E Tests:**
```
tests/
└── e2e/
    └── user-settings.spec.ts             # CREATE: Playwright E2E tests
```

### Technical Constraints

**Password Security:**
[Source: docs/architecture/14-security-and-performance.md#14.1]

- Password hashing: bcrypt with min 12 rounds (cost factor)
- Password requirements: min 12 characters, must include uppercase, lowercase, digit, special char
- Password strength validation before accepting
- Current password verification required before change
- Password hash never returned in API responses

**API Key Security:**

- API key format: "bmad_" prefix + 32 bytes random data encoded as base64
- Storage: SHA256 hash only (never store plaintext key)
- Display: masked format "bmad_...abc1" (show last 4 chars only)
- Full key shown only once on creation
- Expiration: default 90 days, max 365 days
- Revocation: soft delete with revoked_at timestamp
- Scopes: "read", "write", "admin" (for Phase 2 API authentication)

**Settings Persistence:**
[Source: docs/architecture/9-database-schema.md]

- Settings stored as JSONB in PostgreSQL for flexibility
- Schema versioning: track version number for future migrations
- Default settings: provide sensible defaults for new users
- Partial updates: support updating individual settings sections
- Optimistic updates in frontend: update immediately, rollback on error

**Theme Implementation:**
[Source: docs/architecture/3-tech-stack.md - PrimeVue theming]

- PrimeVue theme presets: Lara Light, Lara Dark
- Theme switching via PrimeVue theme service
- CSS variables for font size: --font-size-base (14px/16px/18px)
- Persistence: save to localStorage for faster initial load (avoid flash)
- System preference detection: detect OS dark mode if no saved preference

**Import/Export Format:**

- JSON format with schema version for forward/backward compatibility
- Metadata: schema_version, exported_at, username
- Validation: check schema version on import, show warning if mismatch
- Preview: show settings to be imported before confirmation
- Error handling: invalid JSON, missing fields, validation errors

### Security and Error Handling

**Error Handling:**
[Source: docs/architecture/16-error-handling-strategy.md]

Follow standard error format for API responses:

```json
{
  "error": {
    "code": "SETTINGS_UPDATE_FAILED",
    "message": "Failed to update user settings",
    "details": {
      "field": "trading.watchlist_symbols",
      "error": "Invalid symbol format: abc"
    },
    "timestamp": "2024-03-13T13:05:00Z",
    "request_id": "uuid"
  }
}
```

**Validation Error Codes:**

- `INVALID_THEME`: Theme must be "light" or "dark"
- `INVALID_FONT_SIZE`: Font size must be "small", "medium", or "large"
- `INVALID_TIMEFRAME`: Timeframe must be one of: 1m, 5m, 15m, 1h, 1d
- `INVALID_SYMBOL_FORMAT`: Symbol must be uppercase, 1-5 characters
- `INVALID_EMAIL_FORMAT`: Email format is invalid
- `INVALID_PHONE_FORMAT`: Phone must be in E.164 format (+1234567890)
- `PASSWORD_TOO_WEAK`: Password doesn't meet strength requirements
- `PASSWORDS_DONT_MATCH`: New password and confirmation don't match
- `CURRENT_PASSWORD_INCORRECT`: Current password is incorrect
- `API_KEY_EXPIRED`: API key has expired
- `API_KEY_REVOKED`: API key has been revoked
- `SCHEMA_VERSION_MISMATCH`: Settings import schema version doesn't match

**Frontend Error Handling:**

- Field-level validation with inline error messages (PrimeVue Message component)
- Form-level validation before save (disable save button if errors)
- API error mapping: map backend error codes to user-friendly messages
- Toast notifications for success/error feedback
- Retry logic for transient network errors
- Unsaved changes warning before navigation

**Logging:**
[Source: docs/architecture/17-monitoring-and-observability.md]

Use structured logging (structlog) for settings operations:

```python
logger.info(
    "Settings updated",
    extra={
        "user_id": str(user_id),
        "updated_fields": ["appearance.theme", "trading.watchlist_symbols"],
        "correlation_id": correlation_id
    }
)

logger.info(
    "API key generated",
    extra={
        "user_id": str(user_id),
        "key_id": str(key_id),
        "key_name": name,
        "scopes": scopes,
        "expires_at": expires_at.isoformat(),
        "correlation_id": correlation_id
    }
)
```

**PII Protection:**

- Email addresses and phone numbers are sensitive PII
- Mask in logs: use***@example.com, +1234***8901
- API keys: never log plaintext keys, log key_id only
- Passwords: never log plaintext or hashed passwords
- GDPR compliance: support data export (settings export) and deletion

### Testing

**Backend Testing:**
[Source: docs/architecture/12-testing-strategy.md]

- **Unit Tests (pytest)**: Test settings service (get, update, import, export), password service (hash, verify, strength), API key service (generate, hash, validate)
- **Integration Tests (pytest)**: Test full flow (create user → update settings → fetch settings), password change flow, API key generation and revocation
- **Validation Tests (pytest)**: Test Pydantic model validation (invalid theme, invalid symbol format, password strength)
- **Mock External Services**: Use pytest-mock for repository mocks

**Frontend Testing:**
[Source: docs/architecture/12-testing-strategy.md]

- **Component Tests (Vitest + Vue Testing Library)**: Test SettingsPage.vue rendering, tab switching, save/discard actions
- **Component Tests**: Test individual settings components (appearance, trading, account)
- **Store Tests (Vitest)**: Test useSettingsStore actions and state updates
- **Validation Tests (Vitest)**: Test useSettingsValidation composable logic

**E2E Testing:**
[Source: docs/architecture/12-testing-strategy.md]

- **Playwright Tests**: Full user flow - open settings → change theme → save → reload → verify persisted
- Test all tabs: appearance, notifications, trading, account
- Test password change flow (use test user)
- Test API key generation, copy, revocation
- Test import/export flow
- Test unsaved changes warning
- Test validation errors display

### Testing Standards

**Test File Locations:**
[Source: docs/architecture/12-testing-strategy.md]

- Backend unit tests: `backend/tests/unit/test_settings_service.py`, `backend/tests/unit/test_password_service.py`, `backend/tests/unit/test_api_key_service.py`
- Backend integration tests: `backend/tests/integration/test_settings_api.py`
- Frontend component tests: `frontend/tests/components/SettingsPage.spec.ts`, `frontend/tests/components/AppearanceSettings.spec.ts`, etc.
- E2E tests: `tests/e2e/user-settings.spec.ts` (Playwright)

**Testing Frameworks:**
[Source: docs/architecture/3-tech-stack.md]

- Backend: pytest 8.0+ with pytest-mock, factory-boy for fixtures, async test support
- Frontend: Vitest 1.2+ for component tests, Vue Testing Library integration
- E2E: Playwright 1.41+

**Test Coverage Requirements:**

- Unit tests: 80% coverage minimum for services (settings, password, API key)
- Integration tests: Cover happy path (settings CRUD) and error scenarios (validation failures, database errors)
- E2E tests: Cover complete user journey across all settings tabs

**Mock Data Requirements:**

- Factory for User with default settings
- Factory for UserSettings with various configurations
- Factory for APIKey with different states (active, expired, revoked)
- Mock bcrypt hashing for fast password tests
- Mock API key generation for deterministic tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft created with comprehensive technical details from PRD and Architecture docs | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes List
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results
_To be populated by QA agent during testing_
