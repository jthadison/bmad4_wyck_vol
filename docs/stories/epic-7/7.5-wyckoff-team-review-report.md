# Story 7.5 Wyckoff Team Review Report

**Date**: 2025-11-18
**Reviewers**: William (Wyckoff Mentor), Victoria (Volume Specialist), Rachel (Risk Manager)
**Story**: 7.5 - Correlated Risk Limits (Stocks Only)
**Review Status**: CONDITIONAL APPROVAL

---

## Executive Summary

The Wyckoff specialist team has reviewed Story 7.5 (Correlated Risk Limits) for alignment with authentic Wyckoff methodology. The story has a **solid foundation** but requires **critical modifications** before implementation.

### Overall Wyckoff Alignment Score: 6.5/10

**Approval Status**: **CONDITIONAL** - Approve for implementation only after addressing critical gaps below.

---

## Critical Issues Requiring Resolution

### 1. CRITICAL: Missing Campaign-Level Correlation Integration

**Issue**: Story 7.5 calculates correlation at the **position level**, not the **campaign level**.

**Wyckoff Problem**:
- Wyckoff methodology manages **campaigns**, not individual positions
- A campaign may have 3 scaling positions (Spring entry, LPS add #1, LPS add #2)
- Current Story 7.5 would count these as 3 separate correlation risks
- **This is incorrect** - it's ONE campaign with position scaling

**Example Failure Case**:
```
Scenario: AAPL Accumulation Campaign with 3 positions (3% total risk)
Story 7.5 Current Behavior:
  - Position 1: 1% risk (Spring entry)
  - Position 2: 1% risk (LPS add)
  - Position 3: 1% risk (LPS add)
  - Total Tech Sector: 3%

New Opportunity: MSFT Spring setup (2% risk)
Story 7.5 Calculation: 3% + 2% = 5% tech sector → ALLOWED

WYCKOFF-CORRECT ANALYSIS:
  - AAPL: 1 campaign in tech sector
  - MSFT: 2nd campaign in tech sector
  - Real correlation risk: 2 campaigns in same sector

The issue: Story 7.5 doesn't distinguish between:
  - Campaign scaling (adding to existing campaign) ← NOT new correlation
  - New campaign (independent accumulation cycle) ← IS new correlation
```

**Required Fix**:

Story 7.5 **MUST** integrate with Story 7.4 (Campaign Risk Tracking) to:
1. Calculate correlation at **campaign level**, not position level
2. Recognize that scaling into an existing campaign does NOT increase sector correlation
3. Track **number of campaigns per sector** (not just total risk %)

**New Acceptance Criteria to Add**:

```
AC: 11. Campaign-level correlation: Calculate correlated risk per CAMPAIGN (not per position)
  - Integration: Use Campaign model from Story 7.4
  - Campaign scaling: Adding positions to existing campaign does NOT increase sector correlation count
  - New campaigns: Opening a new campaign in same sector DOES increase correlation

AC: 12. Campaign count limits per sector:
  - Maximum 3 simultaneous campaigns per sector
  - Rationale: Prevents over-fragmentation of sector exposure across too many independent campaigns
  - Example: 3 tech campaigns (AAPL, MSFT, GOOGL) = acceptable diversification
  - Example: 6 tech campaigns = excessive - forces true sector diversification

AC: 13. Campaign vs Position distinction:
  - validate_correlated_risk() must receive campaign_id parameter
  - Group positions by campaign_id before calculating sector correlation
  - Return correlation metrics per campaign, not per position
```

**Implementation Impact**:

**File Changes Required**:
```python
# backend/src/risk_management/correlation.py

# OLD (position-based):
def calculate_correlated_risk(
    correlation_key: str,
    correlation_type: str,
    open_positions: list[Position],
    sector_mappings: dict[str, SectorMapping]
) -> Decimal:
    # Sums position_risk_pct for all positions in sector
    pass

# NEW (campaign-based):
def calculate_correlated_risk(
    correlation_key: str,
    correlation_type: str,
    open_campaigns: list[Campaign],  # ← Changed from positions to campaigns
    sector_mappings: dict[str, SectorMapping]
) -> Decimal:
    """
    Calculate sector correlation at CAMPAIGN level.

    A campaign may have multiple positions (scaling), but counts as
    ONE correlated risk unit.

    Returns: Total risk % across all campaigns in this sector
    """
    sector_campaigns = [
        c for c in open_campaigns
        if get_sector(c.symbol, sector_mappings) == correlation_key
    ]

    # Sum campaign-level risk (not position-level)
    total_risk = sum(campaign.total_campaign_risk for campaign in sector_campaigns)

    return total_risk

def validate_sector_campaign_count(
    sector: str,
    open_campaigns: list[Campaign],
    max_campaigns: int = 3
) -> tuple[bool, str | None]:
    """
    NEW FUNCTION: Validate campaign count per sector.

    Prevents over-fragmentation of sector exposure.
    Max 3 simultaneous campaigns per sector.
    """
    sector_campaigns = [c for c in open_campaigns if c.sector == sector]

    if len(sector_campaigns) >= max_campaigns:
        return False, f"Max {max_campaigns} campaigns per sector (current: {len(sector_campaigns)})"

    return True, None
```

**Data Model Changes**:
```python
# backend/src/models/risk.py

class CorrelatedRisk(BaseModel):
    correlation_type: str
    correlation_key: str
    total_risk: Decimal
    campaign_count: int  # ← NEW: Track number of campaigns (not just positions)
    position_count: int  # ← Keep for reporting
    campaign_breakdown: dict[str, Decimal]  # ← NEW: Campaign ID → risk mapping
    risk_breakdown: dict[str, Decimal]  # ← Keep for position-level detail
    limit: Decimal
    utilization_pct: Decimal
```

---

### 2. CRITICAL: Asset Class Correlation Limit Too Restrictive

**Issue**: Story 7.5 applies the **same 6% limit** to asset class correlation as sector correlation.

**Wyckoff Problem**:
- AAPL (Technology, Phase D) and XOM (Energy, Phase C) are **independent campaigns**
- They have different structural levels, different accumulation cycles, different professional operators
- **They should NOT be treated as correlated** just because both are stocks
- A 6% asset class limit could block a valid Energy sector campaign just because you already hold 6% in Technology

**Example Failure Case**:
```
Current Holdings:
  - AAPL (Tech): 2% risk
  - MSFT (Tech): 2% risk
  - GOOGL (Tech): 2% risk
  Total Tech Sector: 6%
  Total Stock Asset Class: 6%

New Opportunity: XOM (Energy) Spring setup, 1% risk

Story 7.5 Current Behavior:
  - Sector correlation check: XOM is Energy, not Tech → PASS ✅
  - Asset class correlation check: 6% stocks + 1% = 7% → FAIL ❌

Result: XOM rejected despite being a completely different sector/campaign

WYCKOFF VERDICT: This is wrong. XOM and AAPL are independent campaigns.
```

**Required Fix**:

Differentiate correlation limits by level:
- **Sector correlation**: 6% (strictest) ← Keep as-is
- **Asset class correlation**: 15% (looser) ← NEW
- **Geography correlation**: 20% or optional (loosest) ← NEW

**Rationale**:
- **Sector = Tight Control**: Sectors rotate together, distribution risk is real
- **Asset Class = Moderate Control**: Prevents over-concentration in stocks vs. futures, but allows cross-sector diversification
- **Geography = Light Control**: Wyckoff methodology doesn't address macro geographic risk - this is optional

**New Acceptance Criteria to Add**:

```
AC: 14. Tiered correlation limits by specificity:
  - Sector correlation: 6.0% max (unchanged)
  - Asset class correlation: 15.0% max (NEW - allows diversification across sectors within same asset class)
  - Geography correlation: 20.0% max or optional (NEW - loose macro risk control)

AC: 15. Correlation limit hierarchy validation:
  - Sector is most restrictive (6%)
  - Asset class is less restrictive (15%)
  - Geography is least restrictive (20%)
  - Validation checks ALL levels, but uses appropriate limit per level
```

**Implementation Impact**:

```python
# backend/src/models/risk.py

class CorrelationConfig(BaseModel):
    # OLD: Single limit for all correlation types
    # max_correlated_risk: Decimal = Decimal("6.0")

    # NEW: Tiered limits by correlation specificity
    max_sector_correlation: Decimal = Field(
        Decimal("6.0"),
        description="Most restrictive - sectors rotate together"
    )
    max_asset_class_correlation: Decimal = Field(
        Decimal("15.0"),
        description="Moderate - allows cross-sector diversification"
    )
    max_geography_correlation: Decimal | None = Field(
        None,  # Optional
        description="Least restrictive - macro geographic risk (optional)"
    )

    enforcement_mode: Literal["strict", "permissive"] = "strict"
    sector_mappings: dict[str, SectorMapping] = Field(default_factory=dict)

# backend/src/risk_management/correlation.py

def validate_correlated_risk(
    new_campaign: Campaign,
    open_campaigns: list[Campaign],
    config: CorrelationConfig
) -> tuple[bool, str | None, list[str]]:
    """
    Validate correlation at all levels with tiered limits.
    """
    warnings = []

    # Check sector correlation (6% limit)
    sector_risk = calculate_correlated_risk("sector", new_campaign.sector, open_campaigns, config)
    if sector_risk > config.max_sector_correlation:
        if config.enforcement_mode == "strict":
            return False, f"Sector correlation limit exceeded: {sector_risk}% (limit: 6%)", []
        else:
            warnings.append(f"Sector correlation warning: {sector_risk}%")

    # Check asset class correlation (15% limit)
    asset_class_risk = calculate_correlated_risk("asset_class", new_campaign.asset_class, open_campaigns, config)
    if asset_class_risk > config.max_asset_class_correlation:
        if config.enforcement_mode == "strict":
            return False, f"Asset class correlation limit exceeded: {asset_class_risk}% (limit: 15%)", []
        else:
            warnings.append(f"Asset class correlation warning: {asset_class_risk}%")

    # Check geography correlation (20% limit, optional)
    if config.max_geography_correlation is not None:
        geo_risk = calculate_correlated_risk("geography", new_campaign.geography, open_campaigns, config)
        if geo_risk > config.max_geography_correlation:
            if config.enforcement_mode == "strict":
                return False, f"Geography correlation limit exceeded: {geo_risk}% (limit: 20%)", []
            else:
                warnings.append(f"Geography correlation warning: {geo_risk}%")

    return True, None, warnings
```

**Configuration File Update**:

```yaml
# backend/config/sector_mappings.yaml

version: 1
last_updated: "2025-11-18"

correlation_limits:
  sector: 6.0        # Strictest - sectors rotate together
  asset_class: 15.0  # Moderate - allows cross-sector diversification
  geography: 20.0    # Loosest - optional macro risk control

mappings:
  # ... (rest of mappings unchanged)
```

---

## Recommended Enhancements (Backlog for Future Stories)

### Enhancement 1: Volume-Divergence Correlation Adjustment

**From Victoria (Volume Specialist)**

**Concept**: Reduce effective correlation when volume patterns diverge between positions in same sector.

**Wyckoff Justification**:
- If AAPL shows stopping volume (accumulation) while MSFT shows distribution volume, they are in **different campaign phases** despite same sector
- Volume behavior reveals true professional activity
- **Volume divergence = lower actual correlation** than sector classification suggests

**Implementation**:

```python
def calculate_volume_divergence_factor(
    campaign_a: Campaign,
    campaign_b: Campaign,
    lookback_bars: int = 20
) -> Decimal:
    """
    Calculate volume pattern correlation between two campaigns.

    Returns:
        1.0 = Volume patterns highly correlated (move together)
        0.5 = Moderate divergence
        0.0 = Complete divergence (independent campaigns)

    Use case:
        If AAPL and MSFT show volume divergence factor of 0.3,
        their effective correlation = sector_risk × 0.3
    """
    # Compare volume patterns over last 20 bars
    # Calculate correlation coefficient of volume sequences
    # Return 0.0-1.0 factor
    pass

def calculate_adjusted_sector_correlation(
    sector: str,
    open_campaigns: list[Campaign],
    config: CorrelationConfig
) -> Decimal:
    """
    Calculate sector correlation adjusted for volume divergence.

    Instead of simply summing campaign risks, weight by volume correlation:
        effective_correlation = sum(campaign_risk × volume_factor)
    """
    sector_campaigns = [c for c in open_campaigns if c.sector == sector]

    # If only 1 campaign, no divergence adjustment needed
    if len(sector_campaigns) <= 1:
        return sum(c.total_campaign_risk for c in sector_campaigns)

    # Calculate volume divergence between campaigns
    adjusted_risk = Decimal("0.0")
    for campaign in sector_campaigns:
        # Calculate average volume divergence from other sector campaigns
        divergence_factors = [
            calculate_volume_divergence_factor(campaign, other_campaign)
            for other_campaign in sector_campaigns
            if other_campaign != campaign
        ]
        avg_divergence = sum(divergence_factors) / len(divergence_factors)

        # Weight campaign risk by divergence (lower divergence = higher correlation)
        adjusted_risk += campaign.total_campaign_risk × avg_divergence

    return adjusted_risk
```

**Backlog Story**: 7.5.1 - Volume-Divergence Correlation Adjustment

---

### Enhancement 2: Phase-Weighted Correlation Risk

**From Rachel (Risk Manager)**

**Concept**: Positions in early Wyckoff phases have lower correlation risk than late phases.

**Wyckoff Justification**:
- **Phase A/B (Accumulation)**: Positions are building, not correlated distribution risk
- **Phase C (Testing)**: Moderate risk, campaigns may still fail independently
- **Phase D/E (Markup)**: High correlation risk - will distribute together when sector rotates

**Implementation**:

```python
# Phase-based correlation weight multipliers
PHASE_CORRELATION_WEIGHTS = {
    "A": Decimal("0.3"),  # Accumulation - minimal correlation
    "B": Decimal("0.5"),  # Preliminary Support - low correlation
    "C": Decimal("0.7"),  # Testing - moderate correlation
    "D": Decimal("1.0"),  # Sign of Strength - full correlation
    "E": Decimal("1.0"),  # Markup - full correlation (distribution risk)
}

def calculate_phase_weighted_correlation(
    sector: str,
    open_campaigns: list[Campaign],
    config: CorrelationConfig
) -> Decimal:
    """
    Calculate sector correlation weighted by Wyckoff phase.

    Early phase campaigns contribute less to correlation risk because
    they're less likely to distribute simultaneously.
    """
    sector_campaigns = [c for c in open_campaigns if c.sector == sector]

    weighted_risk = sum(
        campaign.total_campaign_risk × PHASE_CORRELATION_WEIGHTS[campaign.current_phase]
        for campaign in sector_campaigns
    )

    return weighted_risk

# Example:
# 3 tech campaigns:
#   - AAPL (Phase E): 2% × 1.0 = 2.0% effective correlation
#   - MSFT (Phase D): 2% × 1.0 = 2.0% effective correlation
#   - GOOGL (Phase B): 2% × 0.5 = 1.0% effective correlation
# Total weighted correlation: 5.0% (vs. 6% unweighted)
```

**Backlog Story**: 7.5.2 - Phase-Weighted Correlation Risk

---

### Enhancement 3: Climactic Volume Correlation Alert

**From Victoria (Volume Specialist)**

**Concept**: Increase correlation enforcement during sector-wide climactic volume events.

**Wyckoff Justification**:
- Sector-wide climactic volume = sector-wide professional activity
- **This is TRUE correlation** - all positions in sector will move together
- Temporarily tighten correlation limits when climax detected

**Implementation**:

```python
def detect_sector_climactic_volume(
    sector: str,
    campaigns: list[Campaign],
    threshold: float = 0.7
) -> bool:
    """
    Detect sector-wide climactic volume event.

    Returns True if >70% of campaigns in sector show climactic volume
    on same bar (within 1 bar tolerance).

    Climactic volume indicators:
    - Volume > 2× average volume
    - Wide spread on high volume
    - Reversal characteristics
    """
    sector_campaigns = [c for c in campaigns if c.sector == sector]

    if len(sector_campaigns) < 2:
        return False

    climactic_count = sum(
        1 for campaign in sector_campaigns
        if campaign.last_bar_is_climactic()
    )

    return (climactic_count / len(sector_campaigns)) >= threshold

def get_dynamic_sector_limit(
    sector: str,
    campaigns: list[Campaign],
    config: CorrelationConfig
) -> Decimal:
    """
    Dynamically adjust sector correlation limit based on market conditions.

    Normal conditions: 6% limit
    Climactic volume detected: 4% limit (tighter enforcement)
    """
    if detect_sector_climactic_volume(sector, campaigns):
        # Tighten limit during sector-wide climax
        return config.max_sector_correlation × Decimal("0.67")  # 6% → 4%

    return config.max_sector_correlation
```

**Backlog Story**: 7.5.3 - Climactic Volume Correlation Alerts

---

## Story 7.5 Strengths (Keep As-Is)

### ✅ 1. 6% Sector Correlation Limit is Appropriate

**Wyckoff Alignment**: Strong

- Prevents over-concentration in single sector (60% of 10% portfolio heat)
- Forces diversification across multiple sector campaigns
- Allows 2-3 full campaigns per sector (3% each or 2% each)
- Protects against sector-wide distribution risk

**Recommendation**: Keep 6% sector limit unchanged.

---

### ✅ 2. Override Mechanism (AC: 10) is Essential

**Wyckoff Alignment**: Strong

The user override mechanism is **critical** for Wyckoff methodology:
- Wyckoff emphasizes **chart reading and discretion** over mechanical rules
- A perfect Spring setup should not be rejected by mechanical correlation limits
- Override allows skilled analysts to take valid setups when justified
- **Audit trail** maintains discipline and prevents abuse

**Current AC: 10**:
```
AC: 10. User override: manual approval can bypass correlation limit (logged)
  - Function: override_correlation_limit(signal_id, approver, reason)
  - Audit trail: event_type="CORRELATION_OVERRIDE" with full context
  - Structlog warning-level logging for all overrides
```

**Recommendation**: Keep AC: 10 as-is. This is excellent design.

---

### ✅ 3. Multi-Level Correlation Concept is Sound

**Wyckoff Alignment**: Strong (with tier adjustments from Critical Issue #2)

Checking correlation at multiple levels (sector, asset class, geography) is **good risk management**:
- **Sector**: Most important for Wyckoff (sectors rotate together)
- **Asset class**: Prevents over-concentration in stocks vs. futures
- **Geography**: Optional macro risk control

**Recommendation**: Keep multi-level approach, but implement tiered limits (6%, 15%, 20%).

---

### ✅ 4. Strict Mode with Override is Best Enforcement Approach

**Wyckoff Alignment**: Good (7/10)

**Current AC: 6**:
```
AC: 6. Warning vs rejection: configurable (strict mode rejects, permissive mode warns)
```

**Team Assessment**:
- **Strict mode alone**: Too mechanical, Wyckoff would reject this
- **Permissive mode alone**: Too loose, warnings can be ignored
- **Strict + Override (current design)**: **Best balance**
  - Default: Strict enforcement protects discipline
  - Override: Preserves discretion for valid setups
  - Audit trail: Maintains accountability

**Recommendation**: Default to strict mode, ensure override process is streamlined and well-documented.

---

### ✅ 5. Decimal Precision and Data Models

**Wyckoff Alignment**: Strong (technical excellence)

Story 7.5 correctly uses:
- `Decimal` type for all risk calculations (NFR20 compliance)
- Pydantic models with proper validation
- JSON encoders for Decimal serialization
- 8 decimal places for precision

**Recommendation**: Keep all technical implementation details as specified.

---

## Updated Acceptance Criteria

### New ACs to Add:

```
AC: 11. Campaign-level correlation tracking:
  - Calculate correlated risk per CAMPAIGN (not per position)
  - Integration: Use Campaign model from Story 7.4
  - Campaign scaling: Adding positions to existing campaign does NOT increase sector correlation
  - New campaigns: Opening new campaign in same sector DOES increase correlation

AC: 12. Campaign count limits per sector:
  - Maximum 3 simultaneous campaigns per sector
  - Prevents over-fragmentation of sector exposure
  - Validation: validate_sector_campaign_count(sector, campaigns, max=3)

AC: 13. Campaign vs Position distinction in correlation calculation:
  - Group positions by campaign_id before calculating sector correlation
  - Return correlation metrics per campaign, not per position
  - CorrelatedRisk model includes campaign_count field

AC: 14. Tiered correlation limits by specificity:
  - Sector correlation: 6.0% max (strictest)
  - Asset class correlation: 15.0% max (moderate)
  - Geography correlation: 20.0% max or optional (loosest)

AC: 15. Correlation limit hierarchy validation:
  - Validate ALL correlation levels independently
  - Use appropriate limit per level (6% sector, 15% asset class, 20% geography)
  - Strict mode: reject if ANY level exceeds its limit
  - Permissive mode: warn if ANY level exceeds its limit
```

### Modified ACs:

```
AC: 1. Maximum correlated risk:
  - OLD: 6.0% (FR18)
  - NEW: 6.0% for sector, 15.0% for asset class, 20.0% for geography (FR18)

AC: 4. Function signatures:
  - OLD: calculate_correlated_risk(sector, open_positions) -> float
  - NEW: calculate_correlated_risk(correlation_key, correlation_type, open_campaigns) -> Decimal

AC: 5. Rejection logic:
  - OLD: if sector_risk + new_position_risk > 6%, reject or warn
  - NEW: if sector_risk + new_campaign_risk > limit_for_level, reject or warn
    - Sector limit: 6%
    - Asset class limit: 15%
    - Geography limit: 20%
```

---

## Updated Tasks/Subtasks

### New Tasks to Add:

```
- [ ] Integrate Campaign model from Story 7.4 (AC: 11)
  - [ ] Import Campaign model from backend/src/models/campaign.py
  - [ ] Update correlation.py to accept open_campaigns instead of open_positions
  - [ ] Group positions by campaign_id before calculating correlation
  - [ ] Use campaign.total_campaign_risk instead of summing position_risk_pct

- [ ] Implement campaign count validation (AC: 12)
  - [ ] Create validate_sector_campaign_count() function
  - [ ] Signature: validate_sector_campaign_count(sector: str, campaigns: list[Campaign], max_campaigns: int = 3) -> tuple[bool, str | None]
  - [ ] Return False if sector already has 3+ campaigns
  - [ ] Integrate into validate_correlated_risk() validation pipeline

- [ ] Update CorrelatedRisk model for campaign tracking (AC: 13)
  - [ ] Add campaign_count: int field to CorrelatedRisk model
  - [ ] Add campaign_breakdown: dict[str, Decimal] field (campaign_id → risk)
  - [ ] Keep position_count and risk_breakdown for detailed reporting
  - [ ] Update build_correlation_report() to populate campaign fields

- [ ] Implement tiered correlation limits (AC: 14, 15)
  - [ ] Update CorrelationConfig model with three separate limit fields
  - [ ] max_sector_correlation: Decimal = Decimal("6.0")
  - [ ] max_asset_class_correlation: Decimal = Decimal("15.0")
  - [ ] max_geography_correlation: Decimal | None = None (optional)
  - [ ] Update validate_correlated_risk() to check each level with appropriate limit
  - [ ] Update sector_mappings.yaml to include correlation_limits section

- [ ] Update unit tests for campaign-based correlation (AC: 11, 12, 13)
  - [ ] Test case: 3 positions in same campaign (scaling) = 1 campaign correlation
  - [ ] Test case: 3 positions in different campaigns = 3 campaign correlation
  - [ ] Test case: 4th campaign in sector rejected when max_campaigns=3
  - [ ] Test case: Campaign scaling does NOT increase sector correlation count
  - [ ] Update test fixtures to use Campaign model instead of Position model

- [ ] Update unit tests for tiered correlation limits (AC: 14, 15)
  - [ ] Test case: 6% sector correlation rejected, but <15% asset class allowed
  - [ ] Test case: Cross-sector positions pass sector check, fail asset class check at 15.1%
  - [ ] Test case: Geography correlation optional (None = no validation)
  - [ ] Test case: Strict mode checks ALL levels, rejects if ANY exceeds limit
  - [ ] Test case: Permissive mode returns warnings for ALL levels exceeding limits
```

### Modified Tasks:

```
- [ ] Implement calculate_correlated_risk function (AC: 2, 4, 11)
  - [ ] UPDATED Signature: calculate_correlated_risk(correlation_key: str, correlation_type: str, open_campaigns: list[Campaign], sector_mappings: dict[str, SectorMapping]) -> Decimal
  - [ ] UPDATED: Filter campaigns (not positions) by matching correlation_key
  - [ ] UPDATED: Calculate sum of campaign.total_campaign_risk (not position_risk_pct)
  - [ ] Group positions by campaign_id first, then sum campaign-level risk
  - [ ] Return correlated risk as Decimal percentage

- [ ] Implement correlated risk validation (AC: 5, 6, 14, 15)
  - [ ] UPDATED Signature: validate_correlated_risk(new_campaign: Campaign, open_campaigns: list[Campaign], config: CorrelationConfig) -> tuple[bool, str | None, list[str]]
  - [ ] UPDATED: Check sector correlation against 6.0% limit
  - [ ] NEW: Check asset class correlation against 15.0% limit
  - [ ] NEW: Check geography correlation against 20.0% limit (if configured)
  - [ ] Strict mode: Return False if ANY level exceeds its specific limit
  - [ ] Permissive mode: Return warnings for ALL levels exceeding limits
```

---

## Data Model Changes

### Updated Models:

```python
# backend/src/models/risk.py

from decimal import Decimal
from typing import Literal
from pydantic import BaseModel, Field

# SectorMapping - NO CHANGES (keep as-is)
class SectorMapping(BaseModel):
    symbol: str = Field(..., max_length=20)
    sector: str = Field(..., description="Sector classification")
    asset_class: str = Field(..., description="stocks, futures, crypto, forex")
    geography: str | None = Field(None, description="US, EU, ASIA, etc.")

    class Config:
        frozen = True

# CorrelationConfig - UPDATED with tiered limits
class CorrelationConfig(BaseModel):
    # CHANGED: Separate limits per correlation level
    max_sector_correlation: Decimal = Field(
        Decimal("6.0"),
        decimal_places=2,
        max_digits=4,
        description="Maximum sector correlation percentage (strictest)"
    )
    max_asset_class_correlation: Decimal = Field(
        Decimal("15.0"),
        decimal_places=2,
        max_digits=4,
        description="Maximum asset class correlation percentage (moderate)"
    )
    max_geography_correlation: Decimal | None = Field(
        None,
        decimal_places=2,
        max_digits=4,
        description="Maximum geography correlation percentage (optional)"
    )
    max_campaigns_per_sector: int = Field(
        3,
        ge=1,
        description="Maximum number of simultaneous campaigns per sector"
    )
    enforcement_mode: Literal["strict", "permissive"] = Field(
        "strict",
        description="strict=reject, permissive=warn"
    )
    sector_mappings: dict[str, SectorMapping] = Field(
        default_factory=dict,
        description="Symbol -> SectorMapping lookup"
    )

    class Config:
        json_encoders = {Decimal: str}

# CorrelatedRisk - UPDATED with campaign tracking
class CorrelatedRisk(BaseModel):
    correlation_type: str = Field(..., description="sector, asset_class, geography")
    correlation_key: str = Field(..., description="e.g., Technology, stock, US")
    total_risk: Decimal = Field(..., decimal_places=4, max_digits=6)

    # NEW: Campaign-level tracking
    campaign_count: int = Field(..., ge=0, description="Number of campaigns in this correlation group")
    campaign_breakdown: dict[str, Decimal] = Field(
        default_factory=dict,
        description="Campaign ID -> risk_pct mapping"
    )

    # KEEP: Position-level detail for reporting
    position_count: int = Field(..., ge=0, description="Total positions across all campaigns")
    risk_breakdown: dict[str, Decimal] = Field(
        default_factory=dict,
        description="Symbol -> risk_pct mapping (position-level detail)"
    )

    limit: Decimal = Field(..., decimal_places=2, max_digits=4, description="Limit for this correlation type")
    utilization_pct: Decimal = Field(
        ...,
        decimal_places=2,
        max_digits=6,
        description="(total_risk / limit) * 100"
    )

    class Config:
        json_encoders = {Decimal: str}
```

---

## Configuration File Changes

```yaml
# backend/config/sector_mappings.yaml

version: 1
last_updated: "2025-11-18"

# NEW: Tiered correlation limits
correlation_limits:
  sector: 6.0              # Strictest - sectors rotate together
  asset_class: 15.0        # Moderate - allows cross-sector diversification
  geography: 20.0          # Loosest - optional macro risk control
  max_campaigns_per_sector: 3  # Campaign count limit

# Enforcement mode: strict (reject) or permissive (warn)
enforcement_mode: strict

mappings:
  # Technology
  AAPL: {sector: "Technology", asset_class: "stock", geography: "US"}
  MSFT: {sector: "Technology", asset_class: "stock", geography: "US"}
  GOOGL: {sector: "Technology", asset_class: "stock", geography: "US"}
  NVDA: {sector: "Technology", asset_class: "stock", geography: "US"}
  META: {sector: "Technology", asset_class: "stock", geography: "US"}

  # Healthcare
  JNJ: {sector: "Healthcare", asset_class: "stock", geography: "US"}
  UNH: {sector: "Healthcare", asset_class: "stock", geography: "US"}
  PFE: {sector: "Healthcare", asset_class: "stock", geography: "US"}

  # Finance
  JPM: {sector: "Finance", asset_class: "stock", geography: "US"}
  BAC: {sector: "Finance", asset_class: "stock", geography: "US"}
  GS: {sector: "Finance", asset_class: "stock", geography: "US"}

  # Energy
  XOM: {sector: "Energy", asset_class: "stock", geography: "US"}
  CVX: {sector: "Energy", asset_class: "stock", geography: "US"}

  # Consumer
  AMZN: {sector: "Consumer", asset_class: "stock", geography: "US"}
  WMT: {sector: "Consumer", asset_class: "stock", geography: "US"}

  # Add more symbols as needed...
```

---

## Integration Points

### Story 7.4 Integration (Campaign Risk Tracking)

**Critical Dependency**: Story 7.5 MUST integrate with Story 7.4's Campaign model.

**Required Imports**:
```python
# backend/src/risk_management/correlation.py

from models.campaign import Campaign  # From Story 7.4
from repositories.campaign_repository import get_open_campaigns  # From Story 7.4
```

**Campaign Model Fields Required** (from Story 7.4):
```python
class Campaign(BaseModel):
    campaign_id: UUID
    symbol: str
    sector: str  # From sector_mappings
    asset_class: str  # From sector_mappings
    geography: str | None  # From sector_mappings
    current_phase: str  # A, B, C, D, E
    total_campaign_risk: Decimal  # Sum of all positions in this campaign
    positions: list[Position]  # All positions belonging to this campaign
```

**Integration Pattern**:
```python
# Instead of:
open_positions = await position_repository.get_open_positions()
sector_risk = calculate_correlated_risk("Technology", "sector", open_positions, mappings)

# Use:
open_campaigns = await campaign_repository.get_open_campaigns()
sector_risk = calculate_correlated_risk("Technology", "sector", open_campaigns, mappings)
```

---

## Testing Updates

### Critical Test Cases to Add:

```python
# backend/tests/unit/risk_management/test_correlation.py

def test_campaign_scaling_does_not_increase_correlation():
    """
    CRITICAL: Adding positions to existing campaign should NOT increase
    sector correlation count.
    """
    # Setup: AAPL campaign with 1 position (1% risk)
    aapl_campaign = Campaign(
        campaign_id=uuid4(),
        symbol="AAPL",
        sector="Technology",
        total_campaign_risk=Decimal("1.0"),
        positions=[position_1]
    )

    # Action: Add 2nd position to AAPL campaign (now 2% total risk)
    aapl_campaign.positions.append(position_2)
    aapl_campaign.total_campaign_risk = Decimal("2.0")

    # Assert: Sector correlation increased from 1% → 2%, but campaign count still 1
    sector_risk = calculate_correlated_risk("Technology", "sector", [aapl_campaign], mappings)
    assert sector_risk == Decimal("2.0")

    correlated_risk = build_correlation_report([aapl_campaign], mappings, config)
    tech_correlation = correlated_risk["sector"][0]
    assert tech_correlation.campaign_count == 1  # Still 1 campaign
    assert tech_correlation.position_count == 2  # Now 2 positions

def test_new_campaign_increases_correlation_count():
    """
    Opening a new campaign in same sector SHOULD increase correlation count.
    """
    aapl_campaign = Campaign(symbol="AAPL", sector="Technology", total_campaign_risk=Decimal("2.0"))
    msft_campaign = Campaign(symbol="MSFT", sector="Technology", total_campaign_risk=Decimal("2.0"))

    sector_risk = calculate_correlated_risk("Technology", "sector", [aapl_campaign, msft_campaign], mappings)
    assert sector_risk == Decimal("4.0")

    correlated_risk = build_correlation_report([aapl_campaign, msft_campaign], mappings, config)
    tech_correlation = correlated_risk["sector"][0]
    assert tech_correlation.campaign_count == 2  # 2 campaigns

def test_max_campaigns_per_sector_enforced():
    """
    AC: 12 - Max 3 campaigns per sector
    """
    campaigns = [
        Campaign(symbol="AAPL", sector="Technology", total_campaign_risk=Decimal("2.0")),
        Campaign(symbol="MSFT", sector="Technology", total_campaign_risk=Decimal("2.0")),
        Campaign(symbol="GOOGL", sector="Technology", total_campaign_risk=Decimal("1.5")),
    ]

    # 4th campaign should be rejected
    new_campaign = Campaign(symbol="NVDA", sector="Technology", total_campaign_risk=Decimal("1.0"))

    is_valid, reason = validate_sector_campaign_count("Technology", campaigns, max_campaigns=3)
    assert not is_valid
    assert "Max 3 campaigns per sector" in reason

def test_tiered_correlation_limits():
    """
    AC: 14 - Sector 6%, Asset Class 15%, Geography 20%
    """
    campaigns = [
        Campaign(symbol="AAPL", sector="Technology", asset_class="stock", geography="US", total_campaign_risk=Decimal("3.0")),
        Campaign(symbol="MSFT", sector="Technology", asset_class="stock", geography="US", total_campaign_risk=Decimal("3.0")),
        Campaign(symbol="XOM", sector="Energy", asset_class="stock", geography="US", total_campaign_risk=Decimal("3.0")),
        Campaign(symbol="JPM", sector="Finance", asset_class="stock", geography="US", total_campaign_risk=Decimal("3.0")),
    ]

    # Sector correlation: Tech=6%, Energy=3%, Finance=3% → All pass 6% limit ✅
    # Asset class correlation: Stock=12% → Pass 15% limit ✅
    # Geography correlation: US=12% → Pass 20% limit ✅

    new_campaign = Campaign(symbol="CVX", sector="Energy", asset_class="stock", geography="US", total_campaign_risk=Decimal("1.0"))

    is_valid, reason, warnings = validate_correlated_risk(new_campaign, campaigns, config)

    # Should pass all checks:
    # - Sector: Energy 3%+1%=4% < 6% ✅
    # - Asset class: Stock 12%+1%=13% < 15% ✅
    # - Geography: US 12%+1%=13% < 20% ✅
    assert is_valid
    assert reason is None

def test_asset_class_limit_allows_cross_sector_diversification():
    """
    CRITICAL: 6% tech sector + 6% healthcare sector should be allowed
    despite both being stocks (asset class limit is 15%).
    """
    campaigns = [
        Campaign(symbol="AAPL", sector="Technology", asset_class="stock", total_campaign_risk=Decimal("3.0")),
        Campaign(symbol="MSFT", sector="Technology", asset_class="stock", total_campaign_risk=Decimal("3.0")),
    ]

    # New healthcare campaign
    new_campaign = Campaign(symbol="JNJ", sector="Healthcare", asset_class="stock", total_campaign_risk=Decimal("2.0"))

    is_valid, reason, warnings = validate_correlated_risk(new_campaign, campaigns, config)

    # Should PASS:
    # - Sector: Healthcare 2% < 6% ✅
    # - Asset class: Stock 6%+2%=8% < 15% ✅
    assert is_valid
    assert reason is None

    # This test would FAIL with old design (single 6% limit for all levels)
```

---

## Future Story Backlog

### Story 7.5.1: Volume-Divergence Correlation Adjustment
**Priority**: Medium
**Epic**: 7 (Risk Management)
**Description**: Reduce effective correlation when volume patterns diverge between campaigns in same sector.

**Acceptance Criteria**:
1. Calculate volume pattern correlation coefficient between campaigns (20-bar lookback)
2. Divergence factor: 0.0 (completely divergent) to 1.0 (highly correlated)
3. Adjusted correlation = sector_risk × avg_divergence_factor
4. Example: AAPL shows stopping volume, MSFT shows distribution → divergence=0.3 → lower effective correlation

---

### Story 7.5.2: Phase-Weighted Correlation Risk
**Priority**: Medium
**Epic**: 7 (Risk Management)
**Description**: Weight campaign correlation by Wyckoff phase (early phases have lower correlation risk).

**Acceptance Criteria**:
1. Phase correlation weights: A=0.3, B=0.5, C=0.7, D=1.0, E=1.0
2. Weighted correlation = sum(campaign_risk × phase_weight)
3. Rationale: Phase A/B positions are accumulating, low distribution risk
4. Phase D/E positions have high correlation (will distribute together)

---

### Story 7.5.3: Climactic Volume Correlation Alerts
**Priority**: Low
**Epic**: 7 (Risk Management)
**Description**: Dynamically tighten correlation limits during sector-wide climactic volume.

**Acceptance Criteria**:
1. Detect sector-wide climax: >70% of campaigns show climactic volume same bar
2. Dynamic limit adjustment: Normal 6% → Climax 4%
3. Alert logged: "Sector climax detected - correlation limit tightened"
4. Limit returns to 6% after climax resolves (no climax for 5+ bars)

---

## Summary of Changes for Bob

### Critical (Must Implement Before Story 7.5 Completion):

1. **Campaign-Level Correlation Tracking**
   - Integrate Story 7.4 Campaign model
   - Calculate correlation per campaign, not per position
   - Add campaign_count limits (max 3 per sector)
   - New AC: 11, 12, 13

2. **Tiered Correlation Limits**
   - Sector: 6% (keep as-is)
   - Asset class: 15% (NEW)
   - Geography: 20% or optional (NEW)
   - Updated AC: 1, 14, 15

3. **Data Model Updates**
   - CorrelationConfig: Add three separate limit fields
   - CorrelatedRisk: Add campaign_count and campaign_breakdown fields
   - sector_mappings.yaml: Add correlation_limits section

4. **Function Signature Changes**
   - calculate_correlated_risk(): Accept campaigns instead of positions
   - validate_correlated_risk(): Accept new_campaign instead of new_position
   - Updated AC: 4, 5

5. **Test Updates**
   - Add campaign-based correlation tests
   - Add tiered limit tests
   - Add campaign count limit tests

### Recommended (Backlog for Future Stories):

1. Story 7.5.1: Volume-divergence correlation adjustment
2. Story 7.5.2: Phase-weighted correlation risk
3. Story 7.5.3: Climactic volume correlation alerts

### Keep As-Is (Already Wyckoff-Aligned):

1. 6% sector correlation limit
2. Override mechanism (AC: 10)
3. Strict enforcement mode with override
4. Decimal precision and data models
5. Audit trail logging

---

## Final Wyckoff Team Verdict

**Approval Status**: **CONDITIONAL APPROVAL**

Story 7.5 will be **Wyckoff-compliant** after implementing:
1. Campaign-level correlation tracking (Critical Issue #1)
2. Tiered correlation limits (Critical Issue #2)

**Post-Implementation Wyckoff Alignment Score**: **8.5/10**

---

**Report Prepared By**:
- William (Wyckoff Mentor)
- Victoria (Volume Specialist)
- Rachel (Risk/Position Manager)

**Date**: 2025-11-18
**For**: Bob (Scrum Master)
