# Story 7.5: Correlated Risk Limits

## Status
Done
**STOCKS ONLY** - Forex adaptation in Story 7.5-FX

**Asset-Class Note:**
- **This story (7.5)**: Stock sector correlation (Technology, Financials, Healthcare) - 6% max per sector, 15% max per asset class
- **Story 7.5-FX**: Forex currency correlation (USD, EUR, GBP exposure) - 6% max per currency, 8% max directional
- See: [Story 7.5-FX: Forex Currency Correlation](7.5-FX.forex-currency-correlation-risk-limits.md)

**Current Status:** Ready for Review
- **Wyckoff Alignment**: 8.5/10 (post-implementation - critical changes completed)
- **Test Coverage**: 44/44 tests passing (30 unit, 14 integration)
- **Code Quality**: Passes ruff + mypy --strict with 0 issues
- **Implementation Complete**: Campaign-level correlation tracking, tiered limits (6%/15%/20%), campaign count limits (max 3 per sector)

## Story
**As a** stock trader following Wyckoff methodology,
**I want** to limit sector correlation risk at the **campaign level** (not position level),
**so that** sector concentration doesn't create unintended risk exposure while allowing proper campaign scaling (FR18).

**Note**: For forex trading, see Story 7.5-FX which implements currency correlation tracking (fundamentally different from stock sector correlation).

**Wyckoff Context**: Wyckoff methodology manages **campaigns** (accumulation cycles), not individual positions. A campaign may scale into multiple positions (e.g., Spring entry → LPS add #1 → LPS add #2), but this is ONE correlated risk unit, not three separate risks.

## Acceptance Criteria

### Core Correlation Limits (UPDATED per Wyckoff Review)
1. **Tiered correlation limits** (FR18):
   - Sector correlation: 6.0% max (strictest - sectors rotate together)
   - Asset class correlation: 15.0% max (moderate - allows cross-sector diversification)
   - Geography correlation: 20.0% max or optional (loosest - macro risk control)

### Campaign-Level Correlation (NEW - CRITICAL per Wyckoff Review)
11. **Campaign-level correlation tracking**:
    - Calculate correlated risk per CAMPAIGN (not per position)
    - Integration: Use Campaign model from Story 7.4
    - Campaign scaling: Adding positions to existing campaign does NOT increase sector correlation count
    - New campaigns: Opening a new campaign in same sector DOES increase correlation

12. **Campaign count limits per sector**:
    - Maximum 3 simultaneous campaigns per sector
    - Prevents over-fragmentation of sector exposure
    - Validation: `validate_sector_campaign_count(sector, campaigns, max=3)`

13. **Campaign vs Position distinction**:
    - Group positions by campaign_id before calculating sector correlation
    - Return correlation metrics per campaign, not per position
    - CorrelatedRisk model includes campaign_count field

### Original Criteria (MODIFIED per Wyckoff Review)
2. Correlation detection: campaigns in same sector (e.g., AAPL campaign + MSFT campaign = 2 Technology campaigns)
3. Sector mapping: loaded from configuration (symbol → sector mapping)
4. **Function signature (UPDATED)**: `calculate_correlated_risk(correlation_key: str, correlation_type: str, open_campaigns: list[Campaign], sector_mappings: dict) -> Decimal`
5. **Rejection logic (UPDATED)**:
   - Sector: if sector_risk + new_campaign_risk > 6%, reject or warn
   - Asset class: if asset_class_risk + new_campaign_risk > 15%, reject or warn
   - Geography: if geo_risk + new_campaign_risk > 20%, reject or warn
6. Warning vs rejection: configurable (strict mode rejects, permissive mode warns)
7. Multi-level correlation: sector (6%), asset class (15%), geography (20%)
8. Unit test: 3 tech campaigns correctly accumulate as correlated
9. Integration test: 4th tech campaign rejected when sector correlation >6%
10. User override: manual approval can bypass correlation limit (logged)

### Hierarchy Validation (NEW per Wyckoff Review)
14. **Tiered correlation limits by specificity**:
    - Sector correlation: 6.0% max (strictest)
    - Asset class correlation: 15.0% max (moderate)
    - Geography correlation: 20.0% max or optional (loosest)

15. **Correlation limit hierarchy validation**:
    - Validate ALL correlation levels independently
    - Use appropriate limit per level (6% sector, 15% asset class, 20% geography)
    - Strict mode: reject if ANY level exceeds its limit
    - Permissive mode: warn if ANY level exceeds its limit

## Tasks / Subtasks

### NEW: Campaign Integration Tasks (AC: 11, 12, 13)

- [ ] Integrate Campaign model from Story 7.4 (AC: 11)
  - [ ] Import Campaign model from `backend/src/models/campaign.py`
  - [ ] Update correlation.py to accept `open_campaigns: list[Campaign]` instead of `open_positions`
  - [ ] Group positions by campaign_id before calculating correlation
  - [ ] Use `campaign.total_campaign_risk` instead of summing `position_risk_pct`
  - [ ] Verify Campaign model has required fields: campaign_id, symbol, sector, asset_class, geography, total_campaign_risk

- [ ] Implement campaign count validation (AC: 12)
  - [ ] Create `validate_sector_campaign_count()` function in correlation.py
  - [ ] Signature: `validate_sector_campaign_count(sector: str, campaigns: list[Campaign], max_campaigns: int = 3) -> tuple[bool, str | None]`
  - [ ] Return False if sector already has 3+ campaigns
  - [ ] Integrate into `validate_correlated_risk()` validation pipeline

- [ ] Update CorrelatedRisk model for campaign tracking (AC: 13)
  - [ ] Add `campaign_count: int` field to CorrelatedRisk model
  - [ ] Add `campaign_breakdown: dict[str, Decimal]` field (campaign_id → risk mapping)
  - [ ] Keep `position_count` and `risk_breakdown` for detailed reporting
  - [ ] Update `build_correlation_report()` to populate campaign fields

### UPDATED: Data Model Tasks (AC: 1, 3, 6, 14)

- [ ] Create CorrelationConfig and CorrelatedRisk Pydantic models (AC: 1, 3, 6, 14)
  - [ ] Define `SectorMapping` dataclass in `backend/src/models/risk.py` (create if needed)
  - [ ] Fields: `symbol: str`, `sector: str`, `asset_class: str`, `geography: str | None`
  - [ ] Define `CorrelationConfig` dataclass in `backend/src/models/risk.py`
  - [ ] **UPDATED Fields**: `max_sector_correlation: Decimal` (6.0%), `max_asset_class_correlation: Decimal` (15.0%), `max_geography_correlation: Decimal | None` (20.0% or None), `max_campaigns_per_sector: int` (default 3), `enforcement_mode: Literal["strict", "permissive"]`, `sector_mappings: dict[str, SectorMapping]`
  - [ ] Define `CorrelatedRisk` dataclass in `backend/src/models/risk.py`
  - [ ] **UPDATED Fields**: `correlation_type: str`, `correlation_key: str`, `total_risk: Decimal`, `campaign_count: int` (NEW), `campaign_breakdown: dict[str, Decimal]` (NEW), `position_count: int`, `risk_breakdown: dict[str, Decimal]`, `limit: Decimal`, `utilization_pct: Decimal`
  - [ ] Use Decimal type for all risk percentage calculations (NFR20 compliance)
  - [ ] Add Pydantic field validators for tiered limits
  - [ ] Add JSON encoders for Decimal serialization

- [ ] Create sector mapping configuration file (AC: 3, 14)
  - [ ] Create YAML config file: `backend/config/sector_mappings.yaml`
  - [ ] **NEW**: Add `correlation_limits` section with tiered limits (sector: 6.0, asset_class: 15.0, geography: 20.0, max_campaigns_per_sector: 3)
  - [ ] Include common stock symbols with sector classifications
  - [ ] Example structure: `AAPL: {sector: "Technology", asset_class: "stock", geography: "US"}`
  - [ ] Include at least 50+ common symbols across major sectors
  - [ ] Major sectors: Technology, Healthcare, Finance, Energy, Consumer, Industrial, Materials, Utilities
  - [ ] Add JSON schema validation in config loader (NFR17 compliance)
  - [ ] Document sector mapping maintenance process in comments

- [ ] Implement sector mapping loader in ConfigService (AC: 3)
  - [ ] Update `backend/src/config.py` to load sector_mappings.yaml
  - [ ] Create `load_sector_mappings() -> dict[str, SectorMapping]` function
  - [ ] Validate YAML structure against JSON schema on load
  - [ ] Cache loaded mappings in memory (reload on config change signal)
  - [ ] Provide default mapping for unknown symbols: `{"sector": "Unknown", "asset_class": "stock", "geography": None}`
  - [ ] Log warning when symbol not found in mapping configuration

- [ ] Implement calculate_correlated_risk function (AC: 2, 4, 11) **UPDATED**
  - [ ] Create function in `backend/src/risk_management/correlation.py` (new file)
  - [ ] **UPDATED Signature**: `calculate_correlated_risk(correlation_key: str, correlation_type: str, open_campaigns: list[Campaign], sector_mappings: dict[str, SectorMapping]) -> Decimal`
  - [ ] correlation_type: "sector", "asset_class", or "geography"
  - [ ] **UPDATED**: Filter campaigns (not positions) by matching correlation_key
  - [ ] **UPDATED**: Calculate sum of `campaign.total_campaign_risk` (not position_risk_pct)
  - [ ] Group positions by campaign_id first, then sum campaign-level risk
  - [ ] Use Decimal arithmetic with 8 decimal places (consistent with position sizing)
  - [ ] Return correlated risk as percentage (e.g., Decimal("4.5") for 4.5%)
  - [ ] Handle unknown symbols gracefully (treat as separate correlation group)

- [ ] Implement multi-level correlation calculation (AC: 7)
  - [ ] Create `calculate_all_correlations(open_positions: list[Position], sector_mappings: dict[str, SectorMapping]) -> dict[str, list[CorrelatedRisk]]`
  - [ ] Calculate correlations at three levels: sector, asset_class, geography
  - [ ] Return dictionary keyed by correlation_type with list of CorrelatedRisk objects
  - [ ] Example: `{"sector": [CorrelatedRisk(Technology, 4.5%), ...], "asset_class": [...], "geography": [...]}`
  - [ ] Include utilization_pct calculation: (total_risk / limit) × 100

- [ ] Implement correlated risk validation (AC: 5, 6, 14, 15) **UPDATED**
  - [ ] **UPDATED Signature**: `validate_correlated_risk(new_campaign: Campaign, open_campaigns: list[Campaign], config: CorrelationConfig) -> tuple[bool, str | None, list[str]]`
  - [ ] Return tuple: (is_valid, rejection_reason, warnings)
  - [ ] Calculate projected risk for each correlation level (sector, asset_class, geography)
  - [ ] **UPDATED**: Check sector correlation against 6.0% limit
  - [ ] **NEW**: Check asset class correlation against 15.0% limit
  - [ ] **NEW**: Check geography correlation against 20.0% limit (if configured)
  - [ ] **Strict mode behavior**: Return (False, "Correlated risk limit exceeded...") if ANY level exceeds its specific limit
  - [ ] **Permissive mode behavior**: Return (True, None, [warning_message]) if ANY level exceeds its specific limit
  - [ ] Warning message format: "Correlated risk warning: {sector} sector at {risk}% (limit: {limit}%)"
  - [ ] Use Decimal comparison operators to prevent floating point errors

- [ ] Implement user override mechanism (AC: 10)
  - [ ] Create `override_correlation_limit(signal_id: UUID, approver: str, reason: str) -> bool`
  - [ ] Log override to audit_trail table with full context
  - [ ] Audit fields: event_type="CORRELATION_OVERRIDE", entity_id=signal_id, actor=approver, metadata={reason, original_rejection}
  - [ ] Return True to allow signal approval to proceed
  - [ ] Add structlog logging with warning level for all overrides

- [ ] Build CorrelatedRisk report generation (AC: 4)
  - [ ] Create `build_correlation_report(open_positions: list[Position], sector_mappings: dict[str, SectorMapping], config: CorrelationConfig) -> dict[str, list[CorrelatedRisk]]`
  - [ ] Use calculate_all_correlations internally
  - [ ] Sort results by total_risk descending (highest risk correlations first)
  - [ ] Include only correlation groups with risk >0% (filter out empty groups)
  - [ ] Calculate utilization_pct for proximity warnings

- [ ] Add correlation proximity warnings
  - [ ] Create `check_correlation_proximity_warnings(correlations: dict[str, list[CorrelatedRisk]]) -> list[str]`
  - [ ] Return warning if any correlation ≥80% of limit (4.8% for 6% limit)
  - [ ] Warning format: "Correlation proximity alert: {sector} sector at {risk}% (80% of limit)"
  - [ ] Integrate warning check into correlation validation flow
  - [ ] Log warnings using structlog with context: correlation_type, correlation_key, total_risk, threshold

- [ ] Write unit tests for correlation calculation (AC: 8, 11) **UPDATED**
  - [ ] Create test file: `backend/tests/unit/risk_management/test_correlation.py`
  - [ ] Test case: empty campaigns list returns 0% correlated risk
  - [ ] Test case: single tech campaign returns that campaign's total_risk
  - [ ] **UPDATED**: Test case: 3 tech campaigns (AAPL 1.5%, MSFT 1.5%, GOOGL 1.5%) = 4.5% total
  - [ ] **NEW**: Test case: Campaign scaling - 3 positions in same AAPL campaign = 1 campaign correlation (not 3)
  - [ ] **NEW**: Test case: 3 positions in different campaigns = 3 campaign correlation
  - [ ] Test case: multi-sector campaigns only sum same-sector risk
  - [ ] Test case: unknown symbol treated as separate correlation group
  - [ ] **UPDATED**: Test case: multi-level correlation (sector 6% vs asset_class 15%) returns different limits
  - [ ] Verify Decimal precision maintained (no floating point drift)
  - [ ] Use pytest fixtures for Campaign and SectorMapping test data

- [ ] Write unit tests for correlation validation (AC: 5, 9, 12, 14, 15) **UPDATED**
  - [ ] Test case: 4.5% current + 1.0% new = 5.5% sector → passes in both modes
  - [ ] Test case: 5.5% current + 0.6% new = 6.1% sector → strict mode fails, permissive mode warns
  - [ ] Test case: exactly 6.0% sector correlated risk → passes (boundary condition)
  - [ ] Test case: 6.0001% sector correlated risk → strict fails, permissive warns (boundary)
  - [ ] **UPDATED**: Test case: 4th tech campaign when 3 existing = 6.1% → strict mode rejects
  - [ ] **NEW**: Test case: Max campaigns per sector - 4th campaign rejected when max=3
  - [ ] **NEW**: Test case: Campaign scaling does NOT increase sector correlation count
  - [ ] **NEW**: Test case: 6% tech sector + 6% healthcare sector = 12% stocks → passes asset class limit (15%)
  - [ ] **NEW**: Test case: Cross-sector positions pass sector check (6%), fail asset class check at 15.1%
  - [ ] **NEW**: Test case: Geography correlation optional (None = no validation)
  - [ ] **NEW**: Test case: Tiered limits - sector 6%, asset class 15%, geography 20%
  - [ ] Test case: permissive mode returns warnings list with proper format
  - [ ] Verify rejection reason message is clear and actionable
  - [ ] **UPDATED**: Test multi-level correlation (campaign passes sector 6% but fails asset_class 15%)

- [ ] Write unit tests for override mechanism (AC: 10)
  - [ ] Test case: override_correlation_limit creates audit trail entry
  - [ ] Test case: override logs to structlog with warning level
  - [ ] Test case: override includes approver, reason, signal_id in audit metadata
  - [ ] Verify audit_trail entry is immutable (no UPDATE/DELETE)
  - [ ] Test that override returns True to allow signal approval

- [ ] Write integration test for sector limit enforcement (AC: 9, 11) **UPDATED**
  - [ ] Create test: `backend/tests/integration/risk_management/test_correlation_limit.py`
  - [ ] **UPDATED Setup**: Create mock portfolio with 3 tech campaigns totaling 5.5% risk
  - [ ] **UPDATED**: Attempt to add 4th tech campaign with 0.6% risk (total 6.1%)
  - [ ] Verify strict mode rejects with proper error code and message
  - [ ] Verify permissive mode allows with warning
  - [ ] Verify CorrelatedRisk report reflects correct campaign_count and campaign_breakdown
  - [ ] Test that override mechanism bypasses rejection in strict mode
  - [ ] **NEW**: Test campaign scaling - adding positions to existing campaign doesn't trigger rejection

- [ ] Write integration test for tiered correlation limits (AC: 14, 15) **NEW**
  - [ ] Test case: campaign passes sector limit (6%) but fails asset_class limit (15%)
  - [ ] Test case: campaign passes both sector and asset_class but fails geography (20%)
  - [ ] Test case: 6% tech + 6% healthcare = 12% stocks → passes asset class 15% limit
  - [ ] Test case: 6% tech + 6% healthcare + 4% energy = 16% stocks → fails asset class 15% limit
  - [ ] Verify validation checks ALL correlation levels (not just first)
  - [ ] Verify strictest failure wins (if any level fails in strict mode, reject)
  - [ ] Test that each level uses its appropriate limit (6%, 15%, 20%)

- [ ] Write integration test for campaign count limits (AC: 12) **NEW**
  - [ ] Test case: 3 tech campaigns allowed (AAPL, MSFT, GOOGL)
  - [ ] Test case: 4th tech campaign rejected (NVDA) when max_campaigns_per_sector=3
  - [ ] Test case: Campaign with multiple positions counts as 1 campaign
  - [ ] Verify error message specifies campaign count limit exceeded

## Dev Notes

### CRITICAL: Wyckoff Team Review Changes

**Review Report**: See [7.5-wyckoff-team-review-report.md](7.5-wyckoff-team-review-report.md) for full details.

**Critical Issue #1 - Campaign-Level Correlation** (MUST IMPLEMENT):
- Original design: Position-level correlation (WRONG for Wyckoff)
- **Required fix**: Campaign-level correlation tracking
- **Integration**: Story 7.4 Campaign model is a CRITICAL DEPENDENCY
- **Key distinction**: Campaign scaling (Spring → LPS add #1 → LPS add #2) = ONE correlation risk, not three
- **Campaign count limit**: Max 3 simultaneous campaigns per sector

**Critical Issue #2 - Tiered Correlation Limits** (MUST IMPLEMENT):
- Original design: Single 6% limit for all correlation types (TOO RESTRICTIVE)
- **Required fix**: Tiered limits by specificity
  - Sector: 6% (strictest - sectors rotate together)
  - Asset class: 15% (moderate - allows cross-sector diversification)
  - Geography: 20% or optional (loosest - macro risk control)
- **Rationale**: AAPL (Tech) and XOM (Energy) are independent campaigns, should NOT be blocked by asset class limit

**Post-Implementation Wyckoff Alignment**: 8.5/10 (up from 6.5/10)

### Previous Story Insights

**From Story 7.4 (Campaign Risk Tracking):**
- Campaign model tracks accumulation cycles with position scaling
- Campaign fields required: campaign_id, symbol, sector, asset_class, geography, total_campaign_risk, positions
- Repository: `campaign_repository.get_open_campaigns()` provides campaign data
- **CRITICAL DEPENDENCY**: Story 7.5 MUST integrate Campaign model

**From Story 7.3 (Portfolio Heat Tracking):**
- Established pattern of using Decimal type for all risk calculations with 8 decimal places
- Created Pydantic models in `backend/src/models/portfolio.py` with JSON encoders for Decimal
- Used structlog for risk-related logging with detailed context
- Implemented proximity warnings at 80% capacity threshold
- Repository pattern: `backend/src/repositories/position_repository.py` provides `get_open_positions()`
- Validation functions return tuple[bool, str | None] for pass/fail with optional reason

**Key Learnings:**
- All risk calculations MUST use Decimal to prevent floating point errors (NFR20)
- Validation functions should be pure (no side effects) for easy testing
- Proximity warnings should trigger at 80% of limit for early alerting
- Error messages must be actionable and include current values + limits
- **NEW**: Campaign-based correlation prevents false positives from position scaling

### Data Models

**Decimal Precision Requirements** [Source: architecture/15-coding-standards.md#Critical-Fullstack-Rules]
- MUST use Python `Decimal` type for all financial calculations
- NEVER use `float` for prices or percentages
- All risk percentages must use Decimal to prevent rounding errors

**Position Risk Model** [Source: Story 7.2/7.3 Context]
From previous stories, Position objects have:
```python
class Position(BaseModel):
    symbol: str
    position_risk_pct: Decimal  # Percentage of account equity at risk
    status: str  # "OPEN", "CLOSED", etc.
    # ... other fields
```

**New Models for Story 7.5 (UPDATED per Wyckoff Review):**

Create in `backend/src/models/risk.py`:

```python
from decimal import Decimal
from typing import Literal
from pydantic import BaseModel, Field

class SectorMapping(BaseModel):
    """Symbol sector/asset class mapping - NO CHANGES from original"""
    symbol: str = Field(..., max_length=20)
    sector: str = Field(..., description="Sector classification")
    asset_class: str = Field(..., description="stocks, futures, crypto, forex")
    geography: str | None = Field(None, description="US, EU, ASIA, etc.")

    class Config:
        frozen = True  # Immutable after loading

class CorrelationConfig(BaseModel):
    """UPDATED: Tiered correlation limits per Wyckoff Review"""
    # CHANGED: Separate limits per correlation level
    max_sector_correlation: Decimal = Field(
        Decimal("6.0"),
        decimal_places=2,
        max_digits=4,
        description="Maximum sector correlation percentage (strictest)"
    )
    max_asset_class_correlation: Decimal = Field(
        Decimal("15.0"),
        decimal_places=2,
        max_digits=4,
        description="Maximum asset class correlation percentage (moderate)"
    )
    max_geography_correlation: Decimal | None = Field(
        None,
        decimal_places=2,
        max_digits=4,
        description="Maximum geography correlation percentage (optional)"
    )
    max_campaigns_per_sector: int = Field(
        3,
        ge=1,
        description="Maximum number of simultaneous campaigns per sector"
    )
    enforcement_mode: Literal["strict", "permissive"] = Field(
        "strict",
        description="strict=reject, permissive=warn"
    )
    sector_mappings: dict[str, SectorMapping] = Field(
        default_factory=dict,
        description="Symbol -> SectorMapping lookup"
    )

    class Config:
        json_encoders = {Decimal: str}

class CorrelatedRisk(BaseModel):
    """UPDATED: Campaign-level correlation tracking per Wyckoff Review"""
    correlation_type: str = Field(..., description="sector, asset_class, geography")
    correlation_key: str = Field(..., description="e.g., Technology, stock, US")
    total_risk: Decimal = Field(..., decimal_places=4, max_digits=6)

    # NEW: Campaign-level tracking
    campaign_count: int = Field(..., ge=0, description="Number of campaigns in this correlation group")
    campaign_breakdown: dict[str, Decimal] = Field(
        default_factory=dict,
        description="Campaign ID -> risk_pct mapping"
    )

    # KEEP: Position-level detail for reporting
    position_count: int = Field(..., ge=0, description="Total positions across all campaigns")
    risk_breakdown: dict[str, Decimal] = Field(
        default_factory=dict,
        description="Symbol -> risk_pct mapping (position-level detail)"
    )

    limit: Decimal = Field(..., decimal_places=2, max_digits=4, description="Limit for this correlation type")
    utilization_pct: Decimal = Field(
        ...,
        decimal_places=2,
        max_digits=6,
        description="(total_risk / limit) * 100"
    )

    class Config:
        json_encoders = {Decimal: str}
```

### Configuration File Structure

**Sector Mapping Configuration (UPDATED per Wyckoff Review)** [Source: Epic 7.5 AC: 3, 14, NFR17]

Create `backend/config/sector_mappings.yaml`:

```yaml
# Symbol sector classifications for correlation risk tracking
# Format: SYMBOL: {sector: "SectorName", asset_class: "stocks|futures|crypto", geography: "US|EU|ASIA|null"}

version: 1
last_updated: "2025-11-18"

# NEW: Tiered correlation limits per Wyckoff Review
correlation_limits:
  sector: 6.0              # Strictest - sectors rotate together
  asset_class: 15.0        # Moderate - allows cross-sector diversification
  geography: 20.0          # Loosest - optional macro risk control
  max_campaigns_per_sector: 3  # Campaign count limit

# Enforcement mode: strict (reject) or permissive (warn)
enforcement_mode: strict

mappings:
  # Technology
  AAPL: {sector: "Technology", asset_class: "stock", geography: "US"}
  MSFT: {sector: "Technology", asset_class: "stock", geography: "US"}
  GOOGL: {sector: "Technology", asset_class: "stock", geography: "US"}
  NVDA: {sector: "Technology", asset_class: "stock", geography: "US"}
  META: {sector: "Technology", asset_class: "stock", geography: "US"}

  # Healthcare
  JNJ: {sector: "Healthcare", asset_class: "stock", geography: "US"}
  UNH: {sector: "Healthcare", asset_class: "stock", geography: "US"}
  PFE: {sector: "Healthcare", asset_class: "stock", geography: "US"}

  # Finance
  JPM: {sector: "Finance", asset_class: "stock", geography: "US"}
  BAC: {sector: "Finance", asset_class: "stock", geography: "US"}
  GS: {sector: "Finance", asset_class: "stock", geography: "US"}

  # Energy
  XOM: {sector: "Energy", asset_class: "stock", geography: "US"}
  CVX: {sector: "Energy", asset_class: "stock", geography: "US"}

  # Consumer
  AMZN: {sector: "Consumer", asset_class: "stock", geography: "US"}
  WMT: {sector: "Consumer", asset_class: "stock", geography: "US"}

  # Add more symbols as needed...
```

JSON Schema for validation (`backend/config/schemas/sector_mappings_schema.json`):
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["version", "mappings"],
  "properties": {
    "version": {"type": "integer"},
    "last_updated": {"type": "string", "format": "date"},
    "mappings": {
      "type": "object",
      "patternProperties": {
        "^[A-Z]{1,10}$": {
          "type": "object",
          "required": ["sector", "asset_class"],
          "properties": {
            "sector": {"type": "string"},
            "asset_class": {"enum": ["stock", "futures", "crypto", "forex"]},
            "geography": {"type": ["string", "null"]}
          }
        }
      }
    }
  }
}
```

### File Locations

**Project Structure Reference** [Source: architecture/10-unified-project-structure.md]

Create/modify these files:
```
backend/
├── src/
│   ├── models/
│   │   └── risk.py                     # NEW: SectorMapping, CorrelationConfig, CorrelatedRisk
│   ├── risk_management/
│   │   ├── service.py                  # MODIFY: Integrate correlation validation
│   │   ├── portfolio.py                # Existing from Story 7.3
│   │   └── correlation.py              # NEW: Correlation calculation functions
│   ├── config.py                       # MODIFY: Add sector_mappings loader
│   └── repositories/
│       └── position_repository.py       # Existing: fetch open positions
├── config/
│   ├── sector_mappings.yaml            # NEW: Symbol → sector configuration
│   └── schemas/
│       └── sector_mappings_schema.json # NEW: YAML validation schema
└── tests/
    ├── unit/risk_management/
    │   └── test_correlation.py         # NEW: Unit tests
    └── integration/risk_management/
        └── test_correlation_limit.py    # NEW: Integration tests
```

### API Specifications

No new API endpoints required for this story (correlation validation is internal to risk management pipeline).

However, correlation data should be exposed via existing portfolio endpoints:

**Enhancement to GET /api/v1/portfolio/heat** [Source: architecture/5-api-specification.md]

Add optional query parameter: `?include_correlations=true`

Enhanced response when `include_correlations=true`:
```json
{
  "total_heat": "8.5",
  "available_capacity": "1.5",
  "position_count": 5,
  "risk_breakdown": {"AAPL": "1.5", "MSFT": "1.5", ...},
  "correlations": {
    "sector": [
      {
        "correlation_type": "sector",
        "correlation_key": "Technology",
        "total_risk": "4.5",
        "position_count": 3,
        "risk_breakdown": {"AAPL": "1.5", "MSFT": "1.5", "GOOGL": "1.5"},
        "limit": "6.0",
        "utilization_pct": "75.0"
      }
    ],
    "asset_class": [...],
    "geography": [...]
  }
}
```

**Error Response Format** [Source: architecture/16-error-handling-strategy.md]
```json
{
  "error": {
    "code": "CORRELATED_RISK_LIMIT_EXCEEDED",
    "message": "Cannot add position: Technology sector correlation would exceed 6% limit",
    "details": {
      "correlation_type": "sector",
      "correlation_key": "Technology",
      "current_risk": "5.5",
      "new_position_risk": "0.6",
      "projected_risk": "6.1",
      "limit": "6.0"
    },
    "timestamp": "2024-03-13T13:00:00Z",
    "request_id": "uuid"
  }
}
```

### Testing Requirements

**Testing Framework** [Source: architecture/12-testing-strategy.md]
- Backend testing: pytest (8.0+)
- Unit tests: `backend/tests/unit/`
- Integration tests: `backend/tests/integration/`
- Use pytest fixtures for mock data
- Parametrized tests for boundary conditions

**Test Coverage Targets** [Source: architecture/12-testing-strategy.md#Backend-Testing]
- All correlation calculation functions must have unit tests
- Boundary condition testing: exactly 6.0%, 6.0001%, multi-level conflicts
- Integration tests validate full validation pipeline

**Decimal Testing Pattern** [Source: NFR20/Story 7.3 context]
```python
from decimal import Decimal

def test_correlation_precision():
    result = calculate_correlated_risk("Technology", "sector", positions, mappings)
    assert isinstance(result, Decimal)
    assert result == Decimal("4.5000")  # Exact match, no floating point drift
```

### Technical Constraints

**Risk Limit Constants (UPDATED per Wyckoff Review)** [Source: Epic 7 PRD, FR18, Wyckoff Review]
- **Sector correlation**: 6.0% max (strictest)
- **Asset class correlation**: 15.0% max (moderate)
- **Geography correlation**: 20.0% max or optional (loosest)
- **Campaign count**: 3 max per sector
- **Warning threshold**: 80% of each limit (sector: 4.8%, asset_class: 12.0%, geography: 16.0%)
- These should be configurable via `backend/config/sector_mappings.yaml`

**Enforcement Modes** (AC: 6, 15)
- **Strict mode**: Reject any campaign that would exceed ANY limit at its specific level
  - Sector > 6% → reject
  - Asset class > 15% → reject
  - Geography > 20% → reject (if enabled)
  - Campaign count > 3 per sector → reject
- **Permissive mode**: Allow campaign but return warnings for any correlation exceeding its limit
- Default: strict mode for production safety

**Multi-Level Correlation Priority** (AC: 7, 14, 15)
When validating, check ALL levels independently:
1. Sector correlation (6% limit - most specific)
2. Asset class correlation (15% limit - medium specificity)
3. Geography correlation (20% limit - least specific, optional)
4. Campaign count per sector (3 max)

If ANY level exceeds its specific limit in strict mode → reject entire campaign

**Campaign vs Position Distinction** (AC: 11, 13)
- **Campaign scaling**: Spring → LPS add #1 → LPS add #2 = ONE correlation risk unit
- **New campaign**: AAPL campaign + MSFT campaign = TWO correlation risk units
- Calculate correlation at campaign level, NOT position level

**Unknown Symbol Handling**
- If symbol not in sector_mappings.yaml → treat as `{"sector": "Unknown", "asset_class": "stock", "geography": None}`
- Unknown symbols do NOT correlate with each other (each treated as separate group)
- Log warning when unknown symbol encountered

### Integration Notes

**CRITICAL DEPENDENCY: Story 7.4 Campaign Risk Tracking**

Story 7.5 **MUST** integrate with Story 7.4's Campaign model per Wyckoff Review.

**Required Imports**:
```python
# backend/src/risk_management/correlation.py
from models.campaign import Campaign  # From Story 7.4
from repositories.campaign_repository import get_open_campaigns  # From Story 7.4
```

**Campaign Model Fields Required** (from Story 7.4):
```python
class Campaign(BaseModel):
    campaign_id: UUID
    symbol: str
    sector: str  # From sector_mappings
    asset_class: str  # From sector_mappings
    geography: str | None  # From sector_mappings
    current_phase: str  # A, B, C, D, E
    total_campaign_risk: Decimal  # Sum of all positions in this campaign
    positions: list[Position]  # All positions belonging to this campaign
```

**Integration Pattern**:
```python
# Instead of (OLD - position-based):
open_positions = await position_repository.get_open_positions()
sector_risk = calculate_correlated_risk("Technology", "sector", open_positions, mappings)

# Use (NEW - campaign-based):
open_campaigns = await campaign_repository.get_open_campaigns()
sector_risk = calculate_correlated_risk("Technology", "sector", open_campaigns, mappings)
```

**Risk Manager Integration** [Source: architecture/8-core-workflows.md, Story 7.8 context]

Correlation validation should integrate into RiskManager validation pipeline (from Story 7.8):
```
Signal Generator → Risk Management → Validation Pipeline:
  1. Pattern risk allocation (Story 7.1)
  2. R-multiple validation (Story 7.6)
  3. Position size calculation (Story 7.2)
  4. Portfolio heat check (Story 7.3)
  5. Campaign risk check (Story 7.4) ← DEPENDENCY
  6. Correlated risk check (Story 7.5) ← THIS STORY (uses campaigns from 7.4)
  → Approve or Reject
```

**Validation Function Signature (UPDATED per Wyckoff Review)**
```python
def validate_correlated_risk(
    new_campaign: Campaign,  # CHANGED from new_position
    open_campaigns: list[Campaign],  # CHANGED from open_positions
    config: CorrelationConfig
) -> tuple[bool, str | None, list[str]]:
    """
    Validate correlated risk at campaign level with tiered limits.

    Returns:
        - is_valid: True if validation passes (or permissive mode warning)
        - rejection_reason: Error message if validation fails (strict mode only)
        - warnings: List of warning messages (permissive mode or proximity alerts)
    """
```

**Repository Dependency (UPDATED)** [Source: Story 7.4, architecture/10-unified-project-structure.md]
Use `backend/src/repositories/campaign_repository.py` (from Story 7.4):
```python
async def get_open_campaigns() -> list[Campaign]:
    """Fetch all active campaigns with their positions"""
```

**Audit Trail Integration** (AC: 10) [Source: architecture/9-database-schema.md]
For user overrides, log to audit_trail table:
```sql
INSERT INTO audit_trail (
    event_type,
    entity_type,
    entity_id,
    timestamp,
    actor,
    action,
    metadata,
    correlation_id
) VALUES (
    'CORRELATION_OVERRIDE',
    'SIGNAL',
    signal_id,
    NOW(),
    approver_name,
    'Manual override of correlation limit',
    '{"reason": "...", "original_rejection": "Technology sector 6.1%", "correlation_type": "sector"}',
    correlation_id
);
```

### Logging and Observability

**Structured Logging** [Source: architecture/3-tech-stack.md - structlog 24.1+]

Log correlation events with context:
```python
import structlog
logger = structlog.get_logger()

logger.info("correlated_risk_calculated",
            correlation_type="sector",
            correlation_key="Technology",
            total_risk=str(total_risk),
            position_count=position_count,
            utilization_pct=str(utilization_pct))

logger.warning("correlated_risk_proximity_warning",
               correlation_type="sector",
               correlation_key="Technology",
               total_risk=str(total_risk),
               threshold="4.8",
               limit="6.0")

logger.error("correlated_risk_limit_exceeded",
             correlation_type="sector",
             correlation_key="Technology",
             current_risk=str(current_risk),
             new_position_risk=str(new_risk),
             projected_risk=str(projected_risk),
             limit="6.0",
             enforcement_mode=config.enforcement_mode)

logger.warning("correlation_limit_override",
               signal_id=str(signal_id),
               approver=approver,
               reason=reason,
               correlation_type="sector",
               correlation_key="Technology",
               original_rejection=rejection_message)
```

### Validation Rules Summary

1. **Correlation Calculation**: Sum all `position_risk_pct` for positions matching correlation criteria (same sector/asset_class/geography)
2. **Multi-Level Check**: Validate against sector AND asset_class AND geography independently
3. **Rejection Logic (Strict Mode)**: If ANY correlation level > 6.0% → reject
4. **Warning Logic (Permissive Mode)**: If ANY correlation level > 6.0% → warn but allow
5. **Proximity Warnings**: Any correlation ≥4.8% (80% of 6%) → proximity warning
6. **Boundary Conditions**:
   - Exactly 6.0% → ALLOWED
   - 6.0001% → Strict: REJECTED, Permissive: WARNED
7. **Decimal Precision**: All calculations use Decimal with 8 decimal places minimum
8. **Override Mechanism**: Manual approval bypasses strict mode rejection with full audit logging

### Dependencies

**Python Libraries** [Source: architecture/3-tech-stack.md]
- Python 3.11+ (async/await support)
- FastAPI 0.109+ (async web framework)
- Pydantic 2.5+ (data validation)
- SQLAlchemy 2.0+ (async ORM for audit_trail)
- pytest 8.0+ (testing)
- structlog 24.1+ (logging)
- PyYAML (for sector_mappings.yaml loading)
- jsonschema (for YAML validation against schema)

**Internal Dependencies (UPDATED per Wyckoff Review)**
- **CRITICAL**: Campaign model from Story 7.4 (campaign-level correlation tracking)
- **CRITICAL**: Campaign repository from Story 7.4 (get_open_campaigns)
- Position model (from position management module)
- CorrelationConfig from config service
- RiskManager integration point (from Story 7.8)

**Story Dependencies**
- **Story 7.4 (Campaign Risk Tracking)**: CRITICAL DEPENDENCY - provides Campaign model and repository

**Configuration Dependencies** (NFR17)
- `backend/config/sector_mappings.yaml` must exist and be valid
- JSON schema validation prevents invalid configuration loading
- Version-controlled YAML files ensure configuration consistency across environments

### Performance Considerations

**Correlation Calculation Performance**
- Typical portfolio: 10-20 open positions
- Correlation calculation: O(n) where n = number of open positions
- Expected performance: <5ms for correlation calculation across all levels
- No caching needed for MVP (recalculate on each validation)
- Future optimization: Cache correlation state, invalidate on position open/close

**Configuration Loading**
- sector_mappings.yaml loaded once at application startup
- Cached in memory for fast lookup during validation
- Reload on SIGHUP or explicit config refresh endpoint (future enhancement)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-18 | 2.0 | **MAJOR UPDATE**: Incorporated Wyckoff team review feedback - campaign-level correlation, tiered limits (6%/15%/20%), campaign count limits | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - No blocking issues encountered during development.

### Completion Notes

**Implementation Summary:**
Successfully implemented campaign-level correlation tracking for stock sector risk management with tiered limits (6%/15%/20%) per Wyckoff team review requirements.

**Key Achievements:**
1. **Campaign-Level Correlation**: Properly tracks correlation at campaign level (not position level) - campaign scaling (Spring → LPS adds) counts as 1 correlation unit
2. **Tiered Limits**: Sector 6%, Asset Class 15%, Geography 20% - all levels validated independently
3. **Campaign Count Limits**: Maximum 3 simultaneous campaigns per sector to prevent over-fragmentation
4. **Test Coverage**: 44/44 tests passing (30 unit, 14 integration)
5. **Code Quality**: Passes ruff + mypy --strict with 0 issues
6. **Decimal Precision**: All risk calculations use Decimal type (NFR20 compliance)

**Critical Design Decisions:**
- Campaign count validation runs BEFORE correlation risk validation (prevents over-fragmentation first)
- utilization_pct quantized to Decimal("0.01") to prevent Pydantic validation errors
- Sector mappings YAML includes 130+ symbols across 8 major sectors for comprehensive coverage

**Testing Highlights:**
- Campaign scaling: 3 positions in 1 AAPL campaign = 1 correlation unit (not 3) ✅
- Tiered limits: 6% Tech + 6% Healthcare = 12% stocks → PASSES 15% asset class limit ✅
- Campaign count: 4th campaign rejected when max=3 ✅
- Boundary conditions: Exactly 6.0% passes, 6.0001% strict rejects ✅
- Enforcement modes: Strict rejects, permissive warns ✅

**Integration Points:**
- Story 7.4 Campaign model: Used CampaignForCorrelation wrapper for correlation metadata
- Position model: Leveraged existing Position model from portfolio module
- Structlog: Comprehensive logging with correlation IDs and context

**Wyckoff Alignment:**
Post-implementation alignment: **8.5/10** (up from 6.5/10 pre-review)
- Campaign-level tracking properly respects Wyckoff accumulation methodology
- Tiered limits allow cross-sector diversification (AAPL + XOM independent campaigns)
- Campaign count limits prevent over-fragmentation while allowing proper scaling

### File List

**Source Files Created:**
- backend/src/models/risk.py (SectorMapping, CorrelationConfig, CorrelatedRisk models)
- backend/src/models/correlation_campaign.py (CampaignForCorrelation model)
- backend/src/risk_management/correlation.py (7 core functions: calculate_correlated_risk, validate_sector_campaign_count, validate_correlated_risk, calculate_all_correlations, build_correlation_report, check_correlation_proximity_warnings, override_correlation_limit)

**Configuration Files Created:**
- backend/config/sector_mappings.yaml (130+ symbol mappings, tiered limits, enforcement mode)
- backend/config/schemas/sector_mappings_schema.json (JSON schema validation)

**Test Files Created:**
- backend/tests/unit/risk_management/test_correlation.py (16 tests - correlation calculation)
- backend/tests/unit/risk_management/test_correlation_validation.py (14 tests - validation logic)
- backend/tests/integration/risk_management/test_correlation_limit.py (14 tests - end-to-end)

## QA Results
_To be filled by QA Agent_
