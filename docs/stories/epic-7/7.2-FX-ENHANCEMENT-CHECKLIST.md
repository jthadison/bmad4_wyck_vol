# Story 7.2-FX: Wyckoff Enhancement Implementation Checklist

**Developer Guide:** Use this checklist to implement Wyckoff enhancements for Story 7.2-FX

**Reference Documents:**
- Full recommendations: [docs/qa/story-7.2-fx-wyckoff-enhancement-recommendations.md](../../qa/story-7.2-fx-wyckoff-enhancement-recommendations.md)
- Quick summary: [docs/qa/story-7.2-fx-enhancement-summary.md](../../qa/story-7.2-fx-enhancement-summary.md)
- Original story: [docs/stories/epic-7/7.2-FX.forex-position-sizing.md](7.2-FX.forex-position-sizing.md)

---

## Pre-Implementation Setup

- [ ] Read full enhancement recommendations document
- [ ] Review Story 7.1 implementation (volume multiplier framework)
- [ ] Understand Wyckoff Law #3 (Effort vs Result)
- [ ] Set up tick volume data source (broker API or data provider)
- [ ] Create feature branch: `feature/story-7.2-fx-wyckoff-enhancements`

---

## Enhancement #1: Pattern-Specific Pip Stops

**Effort:** 4 hours | **Priority:** MUST FIX

### Code Changes:

- [ ] **Add pip stop ranges table** to `backend/src/risk_management/forex_position_sizer.py`:
  ```python
  WYCKOFF_PIP_STOP_RANGES = {
      "SPRING": {
          "EUR/USD": {"min": 20, "max": 50, "typical": 30},
          "GBP/USD": {"min": 30, "max": 70, "typical": 45},
          # ... etc (6 pairs minimum)
      },
      "SOS": { ... },
      "LPS": { ... }
  }
  ```

- [ ] **Implement validation function**:
  ```python
  def validate_wyckoff_stop_pips(
      pattern_type: str,
      symbol: str,
      stop_pips: Decimal
  ) -> tuple[bool, Optional[str]]:
      """Validate stop within structural range for pattern."""
  ```

- [ ] **Add fallback logic** for unlisted pairs (default to conservative ranges)

- [ ] **Update error messages** to include:
  - Pattern type and pair
  - Min/max/typical pip ranges
  - Wyckoff structural stop principle explanation

### Testing:

- [ ] **Unit test:** `test_validate_spring_stop_eur_usd_typical()` - 30 pips → PASS
- [ ] **Unit test:** `test_validate_spring_stop_too_tight()` - 10 pips → FAIL with helpful message
- [ ] **Unit test:** `test_validate_sos_stop_gbp_usd_max()` - 150 pips → PASS (at boundary)

### Documentation:

- [ ] **Update AC 10** in story with pattern-specific ranges
- [ ] **Add Dev Notes section:** "Wyckoff Structural Stops in Forex"
- [ ] **Add reference table:** Pattern × Pair stop ranges

---

## Enhancement #2: Volume-Adjusted Risk (Story 7.1 Integration)

**Effort:** 8 hours | **Priority:** MUST FIX

### Code Changes:

- [ ] **Implement tick volume multiplier**:
  ```python
  def get_forex_volume_multiplier(
      tick_volume: int,
      avg_tick_volume: int
  ) -> Decimal:
      """
      Calculate risk multiplier from tick volume ratio.

      Returns: 0.70x - 1.00x based on 5-tier system from Story 7.1
      """
  ```

- [ ] **Implement session multiplier**:
  ```python
  def get_forex_session_multiplier(
      symbol: str,
      timestamp: datetime
  ) -> Decimal:
      """
      Adjust risk based on trading session.

      London/NY overlap: 1.00x
      Single session: 0.90x
      Asian session: 0.75x
      """
  ```

- [ ] **Implement orchestrator function**:
  ```python
  def calculate_forex_lot_size_with_wyckoff_adjustments(
      account_balance: Decimal,
      pattern_type: str,
      stop_loss_pips: Decimal,
      pip_value_per_lot: Decimal,
      tick_volume: int,
      avg_tick_volume: int,
      signal_timestamp: datetime,
      symbol: str,
      lot_type: str = "mini"
  ) -> tuple[Decimal, dict]:
      """
      Combine pattern risk + volume mult + session mult.

      Returns: (lot_size, adjustment_details)
      """
  ```

- [ ] **Import pattern base risk** from Story 7.1:
  ```python
  PATTERN_BASE_RISK = {
      "SPRING": Decimal("0.5"),
      "SOS": Decimal("0.8"),
      "LPS": Decimal("0.7")
  }
  ```

### Testing:

- [ ] **Unit test:** `test_forex_volume_multiplier_climactic()` - 2.5x volume → 1.00x
- [ ] **Unit test:** `test_forex_volume_multiplier_weak()` - 1.2x volume → 0.70x
- [ ] **Unit test:** `test_forex_volume_multiplier_zero_avg()` - Handle division by zero
- [ ] **Unit test:** `test_session_multiplier_london_ny_overlap()` - 14:00 UTC → 1.00x
- [ ] **Unit test:** `test_session_multiplier_asian()` - 03:00 UTC → 0.75x
- [ ] **Unit test:** `test_combined_wyckoff_calculation()` - Spring + climactic + overlap → full allocation

### Documentation:

- [ ] **Add AC 11** to story: "Integration with Story 7.1 Risk Allocation"
- [ ] **Add Dev Notes section:** "Volume Analysis in Forex (Law #3)"
- [ ] **Add Dev Notes section:** "Session-Based Risk Adjustment"
- [ ] **Update examples** with volume/session context

---

## Enhancement #3: Spread-Adjusted Stops

**Effort:** 2 hours | **Priority:** SHOULD FIX

### Code Changes:

- [ ] **Add spread table**:
  ```python
  TYPICAL_SPREADS = {
      "EUR/USD": Decimal("1.5"),
      "GBP/USD": Decimal("2.0"),
      "USD/JPY": Decimal("1.0"),
      # ... etc (6 pairs minimum)
  }
  ```

- [ ] **Implement spread adjuster**:
  ```python
  def adjust_stop_for_spread(
      structural_stop: Decimal,
      entry_price: Decimal,
      symbol: str,
      direction: str  # "long" or "short"
  ) -> Decimal:
      """
      Widen structural stop by half the spread.

      Long: stop - (spread / 2)
      Short: stop + (spread / 2)
      """
  ```

- [ ] **Update pip calculator**:
  ```python
  def calculate_stop_pips_with_spread(
      entry: Decimal,
      structural_stop: Decimal,
      symbol: str,
      direction: str
  ) -> Decimal:
      """Calculate actual risk pips after spread buffer."""
  ```

### Testing:

- [ ] **Unit test:** `test_spread_adjusted_stop_eur_usd_long()` - 1.5 pip spread → 0.75 buffer
- [ ] **Unit test:** `test_calculate_pips_with_spread()` - 30 structural → ~30.75 after spread

### Documentation:

- [ ] **Update Task 2** in story with spread-adjusted pip calculation
- [ ] **Add Dev Notes section:** "Spread Adjustment for Structural Stops"

---

## Enhancement #4: Enhanced Data Model

**Effort:** 2 hours | **Priority:** SHOULD FIX

### Code Changes:

- [ ] **Add Wyckoff context fields** to `ForexPositionSize` dataclass:
  ```python
  # Wyckoff Context (NEW)
  pattern_type: str = None  # "SPRING", "SOS", "LPS"
  wyckoff_phase: str = None  # "C", "D", "E"
  base_risk_percent: Decimal = None  # 0.5%, 0.7%, 0.8%

  # Volume Analysis (NEW)
  tick_volume: int = None
  avg_tick_volume: int = None
  volume_ratio: Decimal = None
  volume_multiplier: Decimal = None  # 0.70x - 1.00x

  # Session Analysis (NEW)
  signal_timestamp: datetime = None
  trading_session: str = None  # "London/NY Overlap", etc.
  session_multiplier: Decimal = None  # 0.75x - 1.00x

  # Effective Risk (NEW)
  effective_risk_percent: Decimal = None  # After all adjustments

  # R-Multiple (NEW)
  target_price: Optional[Decimal] = None
  r_multiple: Optional[Decimal] = None  # (target - entry) / (entry - stop)

  # Spread Adjustment (NEW)
  broker_spread_pips: Decimal = None
  spread_adjusted_stop: Decimal = None
  ```

- [ ] **Update `__post_init__()`** to calculate R-multiple:
  ```python
  def __post_init__(self):
      # ... existing code ...

      # Calculate R-multiple if target provided
      if self.target_price is not None:
          risk = abs(self.entry_price - self.stop_price)
          reward = abs(self.target_price - self.entry_price)
          if risk > 0:
              self.r_multiple = (reward / risk).quantize(Decimal("0.1"))
  ```

- [ ] **Add `to_dict()` method** for JSON serialization:
  ```python
  def to_dict(self) -> dict:
      """Convert to dictionary with all Wyckoff context."""
  ```

### Testing:

- [ ] **Unit test:** `test_forex_position_size_wyckoff_fields()` - Verify all new fields populate
- [ ] **Unit test:** `test_forex_position_size_to_dict()` - JSON serialization works

### Documentation:

- [ ] **Update AC 8** with enhanced field list
- [ ] **Add field documentation** with Wyckoff rationale for each

---

## Integration Tasks

### Story 7.1 Integration:

- [ ] **Import** `get_volume_risk_multiplier()` framework (if reusable)
- [ ] **Verify** pattern base risk matches Story 7.1 (Spring 0.5%, SOS 0.8%, LPS 0.7%)
- [ ] **Test** combined usage: stocks use Story 7.1, forex uses 7.2-FX with same principles

### Story 7.4 Integration (Campaign Tracking):

- [ ] **Ensure** `ForexPositionSize` can be used in campaign risk calculations
- [ ] **Verify** campaign tracking can aggregate: "3 positions, avg volume 2.3x, total risk 1.8%"

### Signal Model Integration:

- [ ] **Update** `SpringSignal.calculate_position_size()` to use new Wyckoff function
- [ ] **Update** `SOSSignal.calculate_position_size()` similarly
- [ ] **Update** `LPSSignal.calculate_position_size()` similarly

---

## Testing Checklist

### Unit Tests (26 new tests):

**Pattern-Specific Stops (3 tests):**
- [ ] test_validate_spring_stop_eur_usd_typical
- [ ] test_validate_spring_stop_too_tight
- [ ] test_validate_sos_stop_gbp_usd_max

**Volume Multiplier (3 tests):**
- [ ] test_forex_volume_multiplier_climactic
- [ ] test_forex_volume_multiplier_weak
- [ ] test_forex_volume_multiplier_zero_avg

**Session Multiplier (2 tests):**
- [ ] test_session_multiplier_london_ny_overlap
- [ ] test_session_multiplier_asian

**Combined Calculation (2 tests):**
- [ ] test_forex_lot_size_full_wyckoff_spring
- [ ] test_forex_lot_size_reduced_asian

**Spread Adjustment (2 tests):**
- [ ] test_spread_adjusted_stop_eur_usd
- [ ] test_calculate_pips_with_spread

**Data Model (2 tests):**
- [ ] test_forex_position_size_wyckoff_fields
- [ ] test_forex_position_size_to_dict

**Original Tests (from Story 7.2-FX):**
- [ ] All 15+ original tests still passing

### Integration Tests (3 new scenarios):

- [ ] **Scenario 1:** EUR/USD Spring, climactic volume, London/NY overlap → Full allocation
- [ ] **Scenario 2:** GBP/USD SOS, weak volume, Asian session → Reduced allocation
- [ ] **Scenario 3:** EUR/USD Spring, 10 pip stop → Rejected with helpful error

### Code Quality:

- [ ] **Mypy:** `poetry run mypy backend/src/risk_management/forex_position_sizer.py --strict`
- [ ] **Flake8:** `poetry run flake8 backend/src/risk_management/forex_position_sizer.py`
- [ ] **Test coverage:** ≥90% on `forex_position_sizer.py`

---

## Documentation Updates

### Story Document (7.2-FX.forex-position-sizing.md):

- [ ] Add **AC 11:** Integration with Story 7.1 Risk Allocation
- [ ] Update **AC 10:** Pattern-specific validation (not generic 5-200 pips)
- [ ] Update **AC 8:** Enhanced ForexPositionSize fields
- [ ] Update **Task 2:** Spread-adjusted pip calculation
- [ ] Add **Dev Notes sections:**
  - Wyckoff Structural Stops in Forex
  - Volume Analysis in Forex (Law #3)
  - Session-Based Risk Adjustment
  - Spread Adjustment for Structural Stops
- [ ] Update **examples** with Wyckoff context

### Reference Tables (Add to Dev Notes):

- [ ] **WYCKOFF_PIP_STOP_RANGES** - Pattern × Pair stop ranges
- [ ] **TYPICAL_SPREADS** - Broker spreads by pair
- [ ] **Volume/Session Multiplier Examples** - Before/After comparisons

### Code Documentation:

- [ ] **Docstrings** for all 5 new functions (with Wyckoff principle explanations)
- [ ] **Inline comments** explaining Law #3 application
- [ ] **Examples** in docstrings showing typical usage

---

## Validation & Review

### Self-Review:

- [ ] Read through all new code
- [ ] Verify Wyckoff principles correctly applied
- [ ] Check edge cases handled (zero volume, unlisted pairs, etc.)
- [ ] Ensure error messages are helpful and educational

### Wyckoff Team Review:

- [ ] **William (Wyckoff Mentor):** Methodology compliance
- [ ] **Victoria (Volume Specialist):** Volume multiplier logic
- [ ] **Rachel (Risk Manager):** Risk allocation appropriateness

### Code Review Checklist:

- [ ] All 4 enhancements implemented
- [ ] 26+ new unit tests passing
- [ ] 3+ integration scenarios passing
- [ ] Code passes mypy --strict
- [ ] Code passes flake8
- [ ] Test coverage ≥90%
- [ ] Documentation complete
- [ ] Structured logging added for all risk adjustments

---

## Commit Strategy

### Commit Sequence (Logical Groupings):

**Commit 1: Pattern-Specific Pip Stops**
```bash
git add backend/src/risk_management/forex_position_sizer.py
git add backend/tests/unit/risk_management/test_forex_position_sizer.py
git commit -m "feat(7.2-FX): Add pattern-specific pip stop validation

- Add WYCKOFF_PIP_STOP_RANGES table (Spring/SOS/LPS × EUR/USD/GBP/USD/etc.)
- Implement validate_wyckoff_stop_pips() with structural stop logic
- Update error messages with Wyckoff principle explanations
- Add 3 unit tests for stop validation

Wyckoff Principle: Stops must be structural (below support), not arbitrary pips.

Closes: Enhancement #1 from story-7.2-fx-wyckoff-enhancement-recommendations.md"
```

**Commit 2: Volume/Session Multipliers**
```bash
git commit -m "feat(7.2-FX): Integrate Story 7.1 volume multipliers + forex sessions

- Add get_forex_volume_multiplier() for tick volume analysis
- Add get_forex_session_multiplier() for London/NY overlap detection
- Add calculate_forex_lot_size_with_wyckoff_adjustments() orchestrator
- Import pattern base risk from Story 7.1 (Spring 0.5%, SOS 0.8%, LPS 0.7%)
- Add 6 unit tests for volume/session multipliers

Wyckoff Law #3: Effort (volume) must validate Result (price movement).

Closes: Enhancement #2 from story-7.2-fx-wyckoff-enhancement-recommendations.md"
```

**Commit 3: Spread-Adjusted Stops**
```bash
git commit -m "feat(7.2-FX): Add spread-adjusted stop placement

- Add TYPICAL_SPREADS table for major pairs
- Implement adjust_stop_for_spread() with spread buffer logic
- Update calculate_stop_pips_with_spread() for actual risk calculation
- Add 2 unit tests for spread adjustment

Prevents premature stop-outs on structural levels due to broker spreads.

Closes: Enhancement #3 from story-7.2-fx-wyckoff-enhancement-recommendations.md"
```

**Commit 4: Enhanced Data Model**
```bash
git commit -m "feat(7.2-FX): Enhance ForexPositionSize with Wyckoff context

- Add Wyckoff fields: pattern_type, phase, volume_ratio, volume_multiplier
- Add session fields: signal_timestamp, trading_session, session_multiplier
- Add effective_risk_percent (after all adjustments)
- Add r_multiple calculation in __post_init__
- Add to_dict() method for JSON serialization
- Add 2 unit tests for data model

Enables complete audit trail for performance analysis and campaign tracking.

Closes: Enhancement #4 from story-7.2-fx-wyckoff-enhancement-recommendations.md"
```

**Commit 5: Documentation Updates**
```bash
git commit -m "docs(7.2-FX): Update story with Wyckoff enhancements

- Add AC 11: Integration with Story 7.1 Risk Allocation
- Update AC 10: Pattern-specific pip stop validation
- Update AC 8: Enhanced ForexPositionSize fields
- Add Dev Notes: Wyckoff principles in forex position sizing
- Update examples with volume/session context

Full enhancement details in:
docs/qa/story-7.2-fx-wyckoff-enhancement-recommendations.md"
```

**Commit 6: Integration Tests**
```bash
git commit -m "test(7.2-FX): Add integration tests for Wyckoff scenarios

- Scenario 1: Spring + climactic volume + London/NY overlap → full allocation
- Scenario 2: SOS + weak volume + Asian session → reduced allocation
- Scenario 3: Pattern stop validation rejection (too-tight Spring)

All 3 integration scenarios passing.

Story 7.2-FX Wyckoff enhancements complete (Grade: A-)"
```

---

## Definition of Done

### Functional Requirements:

- [ ] All 4 enhancements implemented (pattern stops, volume, spread, data model)
- [ ] AC 11 implemented (Wyckoff integration)
- [ ] Updated AC 10 implemented (pattern-specific validation)
- [ ] Updated AC 8 implemented (enhanced data model)

### Technical Requirements:

- [ ] 26+ unit tests passing
- [ ] 3+ integration tests passing
- [ ] Original 15+ tests still passing
- [ ] Code passes `mypy --strict` (0 errors)
- [ ] Code passes `flake8` (0 errors)
- [ ] Test coverage ≥90% on `forex_position_sizer.py`

### Documentation:

- [ ] Story updated with new ACs and Dev Notes
- [ ] All functions have comprehensive docstrings
- [ ] Examples updated with Wyckoff context
- [ ] Enhancement recommendations documented

### Review:

- [ ] Self-review complete
- [ ] Wyckoff team review: PASS
- [ ] Code review: APPROVED
- [ ] Integration verified with Story 7.1 and Story 7.4

### Deployment:

- [ ] All commits pushed to feature branch
- [ ] Pull request created with enhancement summary
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main

---

## Troubleshooting

### Common Issues:

**Issue:** `mypy` complains about Optional fields in ForexPositionSize
- **Fix:** Use `Optional[Decimal]` for nullable Wyckoff fields, default to `None`

**Issue:** Tick volume data not available from broker
- **Fix:** Use fallback to 1.0x volume multiplier (conservative, full allocation)

**Issue:** Session detection wrong for non-UTC timezones
- **Fix:** Always convert to UTC in `get_forex_session_multiplier()` before hour comparison

**Issue:** Pattern-specific stops rejecting valid setups
- **Fix:** Verify WYCKOFF_PIP_STOP_RANGES matches actual pair volatility
- **Adjust:** Use `typical` value as guideline, `min`/`max` as hard limits

---

## Resources

### Reference Documents:

- Full enhancement recommendations: [docs/qa/story-7.2-fx-wyckoff-enhancement-recommendations.md](../../qa/story-7.2-fx-wyckoff-enhancement-recommendations.md)
- Quick summary: [docs/qa/story-7.2-fx-enhancement-summary.md](../../qa/story-7.2-fx-enhancement-summary.md)
- Story 7.1 implementation: [backend/src/risk_management/risk_allocator.py](../../../backend/src/risk_management/risk_allocator.py)
- Story 7.2 implementation: [backend/src/risk_management/position_calculator.py](../../../backend/src/risk_management/position_calculator.py)

### Wyckoff Methodology Resources:

- Wyckoff Law #3: "Effort (volume) must validate Result (price movement)"
- Structural stop principle: "Place stops where you know you're wrong, not where you hope to be right"
- Campaign thinking: "Scale positions as evidence builds (Spring → SOS → LPS)"

---

**Developer:** [Your Name]
**Started:** [Date]
**Completed:** [Date]
**Grade Target:** A- (92/100)
