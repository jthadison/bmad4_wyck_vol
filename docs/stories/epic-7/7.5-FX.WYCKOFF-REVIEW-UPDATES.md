# Story 7.5-FX: Wyckoff Team Review - Required Updates

**Date:** 2025-11-18
**Reviewers:** Richard (Wyckoff Mentor), Victoria (Volume Specialist), Rachel (Risk Manager)
**Status:** ‚ö†Ô∏è **NEEDS REVISION** before development
**Story File:** `docs/stories/epic-7/7.5-FX.forex-currency-correlation-risk-limits.md`

---

## Executive Summary

The Wyckoff team has identified **critical flaws** in Story 7.5-FX that contradict authentic Wyckoff campaign methodology:

### ‚ùå **REMOVE These Elements:**
1. **8% Directional Limit (AC #5)** - Blocks legitimate multi-campaign position building
2. **Currency Correlation Matrix (AC #7)** - Confuses statistical correlation with campaign correlation
3. **Correlation-Based Warnings** - Misleading signals based on statistical data, not market structure

### ‚úÖ **KEEP These Elements:**
1. **6% Per-Currency Limit (AC #3)** - Mechanically justified (EUR/USD + EUR/GBP both buy EUR)
2. **Rejection Messaging (AC #10)** - Excellent, clear, actionable guidance
3. **Currency Group Detection (AC #8)** - Reasonable concentration tracking

### üîß **ADD These Elements:**
1. **Phase-Weighted Exposure Calculation** - Phase E = 50% risk weight vs Phase C = 100%
2. **Campaign Count Limit** - Max 2-3 concurrent campaigns (replaces directional limit)
3. **Campaign Phase Integration** - Track phase per currency pair, not per currency

---

## Critical Issues Identified

### **Issue #1: 8% Directional Limit Blocks Wyckoff Campaign Execution**

**Problem Statement:**

Wyckoff campaigns require **three-phase position building**:
- Phase C (Test): 1% risk
- Phase D (LPS): 2% risk
- Phase E (SOS): 3% risk
- **Total per campaign: 6% risk**

The 8% directional limit **prevents running two simultaneous campaigns**, which is standard Wyckoff diversification.

**Example Scenario:**
```
Campaign 1 (EUR/USD):
- Phase C: 1% (Spring detected)
- Phase D: 2% (LPS confirmed)
- Phase E: 3% (SOS confirmed)
- TOTAL: 6% long EUR

Campaign 2 (GBP/USD):
- Phase C: 1% (Spring detected)
- Phase D: 2% (LPS confirmed)
- Waiting for Phase E SOS...

Current Story 7.5-FX:
- Total long exposure: 6% EUR + 3% GBP = 9% (EXCEEDS 8% LIMIT)
- Result: REJECT Campaign 2 Phase E addition
- This is WRONG - both campaigns are structurally valid
```

**Wyckoff Perspective (Richard):**

> "Wyckoff's diversification principle means running multiple independent campaigns at different stages. If EUR/USD completes accumulation (Phase E) and GBP/USD completes accumulation (Phase E), you SHOULD be long both. The 8% directional cap treats correlated upward moves as 'risk' when they're actually CONFIRMATION - professional money buying multiple currencies simultaneously is a STRONG signal, not a risk to avoid."

**Victoria's Volume Analysis:**

> "When EUR/USD shows climactic SOS volume AND GBP/USD shows climactic SOS volume on the same day, that's not 'over-leverage' - that's broad professional accumulation completing. The volume tells you institutional money is buying across the board. The 8% cap forces you to IGNORE this volume confirmation and reject valid setups."

---

### **Issue #2: Currency Correlation Matrix Misapplies Statistical Data**

**Problem Statement:**

AC #7 implements a correlation matrix treating EUR/GBP correlation (70%) as "REAL correlation" requiring warnings:

```python
CURRENCY_CORRELATIONS = {
    ("EUR", "GBP"): Decimal("0.70"),  # Positively correlated (European)
    ("AUD", "NZD"): Decimal("0.85"),  # Highly correlated (commodity)
}

# Story 7.5-FX logic:
if EUR exposure = 4% AND adding GBP position:
    warn: "EUR and GBP are 70% correlated - approaching limit"
```

**Why This Fails Wyckoff Methodology:**

Statistical correlation **DOES NOT equal campaign correlation**:

| Situation | EUR/USD Phase | GBP/USD Phase | Statistical Correlation | Campaign Correlation |
|-----------|---------------|---------------|------------------------|---------------------|
| 1 | Phase E (markup) | Phase E (markup) | 70% | HIGH (both confirmed) |
| 2 | Phase E (markup) | Phase A (accumulation) | 70% | NONE (different cycles) |
| 3 | Phase E (markup) | Phase C (test) | 70% | NONE (different risk) |

**The 70% correlation is MEANINGLESS for risk management** because:
1. EUR in Phase E has DIFFERENT risk than GBP in Phase C
2. Volume patterns are independent (EUR climactic volume ‚â† GBP climactic volume)
3. Campaign timing is independent (EUR accumulation complete ‚â† GBP accumulation complete)

**Rachel's Risk Analysis:**

> "The correlation matrix treats EUR exposure and GBP exposure as additive risk because they 'move together 70% of the time.' But that's not how Wyckoff campaigns work. EUR/USD in confirmed markup (Phase E) is LOW RISK. GBP/USD in unconfirmed test (Phase C) is HIGH RISK. Lumping them together because of statistical correlation ignores the structural difference."

---

### **Issue #3: Mechanical Currency Exposure vs Campaign Phase Risk**

**Problem Statement:**

Story 7.5-FX treats ALL EUR exposure as equal risk:

```python
# Current Story 7.5-FX:
EUR/USD Phase E (markup): 2% EUR exposure ‚Üí counted as 2%
EUR/GBP Phase C (test): 2% EUR exposure ‚Üí counted as 2%
EUR/JPY Phase A (accumulation): 2% EUR exposure ‚Üí counted as 2%
TOTAL: 6% EUR exposure (AT LIMIT)
```

**Wyckoff Reality:**

Phase E (confirmed campaign) is **50% lower risk** than Phase C (unconfirmed test):

```python
# Wyckoff Phase-Weighted Exposure:
EUR/USD Phase E: 2% √ó 0.5 (confirmed) = 1% effective risk
EUR/GBP Phase C: 2% √ó 1.0 (unconfirmed) = 2% effective risk
EUR/JPY Phase A: 2% √ó 1.0 (unconfirmed) = 2% effective risk
TOTAL: 5% effective EUR risk (still safe)
```

**Why Phase Matters:**

- **Phase E (Markup):** Professional accumulation complete, campaign validated, SOS confirmed ‚Üí **LOW RISK**
- **Phase C (Test):** Spring/test in progress, campaign unconfirmed ‚Üí **HIGH RISK**
- **Phase A (Accumulation):** Preliminary support forming, no confirmation ‚Üí **HIGH RISK**

---

## Required Acceptance Criteria Changes

### **AC #3: Currency Limit Validation - REVISE (Phase-Weighted)**

**Current (WRONG):**
```python
def validate_currency_limit(
    currency: str,
    current_exposure: Decimal,
    new_exposure_change: Decimal
) -> tuple[bool, Optional[str]]:
    projected_exposure = current_exposure + new_exposure_change
    if abs(projected_exposure) > MAX_CURRENCY_EXPOSURE_PCT:  # 6%
        return False, "REJECTED..."
```

**Updated (WYCKOFF-ALIGNED):**
```python
def validate_currency_limit(
    currency: str,
    current_positions: list[ForexPosition],
    new_position: ForexPosition
) -> tuple[bool, Optional[str]]:
    """
    Validate currency exposure with phase-weighted risk.

    Phase Weighting:
    - Phase E (markup): 0.5x (campaign confirmed, lower risk)
    - Phase D (LPS): 0.75x (campaign progressing, medium risk)
    - Phase C (test): 1.0x (campaign unconfirmed, full risk)
    - Phase A/B: 1.0x (early accumulation, full risk)
    """
    # Calculate phase-weighted exposure
    weighted_exposure = Decimal("0")

    for position in current_positions:
        if currency not in position.symbol.split("/"):
            continue

        # Get position's currency exposure (positive or negative)
        base, quote = position.symbol.split("/")
        if position.direction == "LONG":
            exposure = position.position_risk_pct if base == currency else -position.position_risk_pct
        else:
            exposure = -position.position_risk_pct if base == currency else position.position_risk_pct

        # Apply phase weighting
        phase_weight = get_phase_weight(position.current_phase)
        weighted_exposure += exposure * phase_weight

    # Add new position with phase weighting
    new_phase_weight = get_phase_weight(new_position.current_phase)
    # ... calculate new exposure and apply weighting

    if abs(projected_weighted_exposure) > MAX_CURRENCY_EXPOSURE_PCT:
        return False, f"REJECTED: Phase-weighted {currency} exposure would reach {projected_weighted_exposure:+.1f}%..."

    return True, None

def get_phase_weight(phase: Optional[str]) -> Decimal:
    """Return risk weighting by Wyckoff phase."""
    PHASE_WEIGHTS = {
        "E": Decimal("0.50"),  # Confirmed markup - lowest risk
        "D": Decimal("0.75"),  # LPS confirmed - medium risk
        "C": Decimal("1.00"),  # Test phase - full risk
        "B": Decimal("1.00"),  # Early accumulation - full risk
        "A": Decimal("1.00"),  # Preliminary support - full risk
        None: Decimal("1.00"), # Unknown phase - full risk
    }
    return PHASE_WEIGHTS.get(phase, Decimal("1.00"))
```

**Rationale:**
- **Mechanical EUR exposure is real** (EUR/USD + EUR/GBP both buy EUR)
- **BUT phase determines risk** (Phase E confirmed vs Phase C unconfirmed)
- **6% limit applies to weighted exposure** (can have 12% raw EUR if all Phase E)

---

### **AC #5: Directional Limit Validation - REMOVE & REPLACE**

**Current AC #5 (REMOVE THIS ENTIRELY):**
```
5. Directional limit validation (8% max directional):
   - Check: total_long_exposure <= 8% AND total_short_exposure <= 8%
   - Prevents over-correlated long or short portfolios
```

**New AC #5 (REPLACE WITH THIS):**
```
5. Campaign count limit validation (max 3 concurrent campaigns):
   - Track active campaigns per currency pair (not per currency)
   - Campaign = positions in same currency pair across Phase C/D/E
   - Limit: Maximum 3 concurrent campaigns at any time
   - Reject new campaign if would exceed 3 active campaigns
   - Campaign ends when: all positions closed OR phase invalidated

   Example:
   - Campaign 1: EUR/USD (Phase C ‚Üí D ‚Üí E) = 1 campaign
   - Campaign 2: GBP/USD (Phase C ‚Üí D ‚Üí E) = 1 campaign
   - Campaign 3: AUD/USD (Phase C ‚Üí D) = 1 campaign
   - TOTAL: 3 campaigns (AT LIMIT)
   - Attempting EUR/GBP new campaign ‚Üí REJECTED (exceeds 3 campaign limit)

   Rationale:
   - Prevents portfolio complexity (too many active campaigns to manage)
   - Allows multiple campaigns in same direction (long EUR, long GBP, long AUD = OK)
   - Focuses on CAMPAIGN STRUCTURE, not directional correlation
```

**Implementation:**
```python
def validate_campaign_count_limit(
    current_campaigns: list[ForexCurrencyCampaign],
    new_position_symbol: str,
    max_campaigns: int = 3
) -> tuple[bool, Optional[str]]:
    """
    Validate campaign count limit.

    A campaign is defined as:
    - Same currency pair (EUR/USD, GBP/USD, etc.)
    - At least one active position (status = OPEN)
    - Phase C, D, or E (accumulation/markup cycle)
    """
    # Check if new position starts a new campaign
    existing_campaign = any(
        camp.symbol == new_position_symbol
        for camp in current_campaigns
    )

    if existing_campaign:
        return True, None  # Adding to existing campaign - OK

    # Count active campaigns
    active_count = len([
        camp for camp in current_campaigns
        if camp.status == "ACTIVE"
    ])

    if active_count >= max_campaigns:
        return False, (
            f"REJECTED: Maximum {max_campaigns} concurrent campaigns exceeded. "
            f"Active campaigns: {active_count}. "
            f"New position {new_position_symbol} would start campaign #{active_count + 1}. "
            f"Consider closing existing campaign to free capacity."
        )

    return True, None
```

---

### **AC #7: Correlation Matrix - REMOVE ENTIRELY**

**Current AC #7 (REMOVE THIS):**
```
7. Correlation matrix for major currencies:
   - EUR vs USD: -1.00 (perfectly inverse by definition)
   - EUR vs GBP: +0.70 (positively correlated, both European currencies)
   - USD vs JPY: -0.40 (moderately inverse)
   - Use correlation data to warn about correlated positions
```

**Replacement: NONE**

**Rationale:**
- Statistical correlation is IRRELEVANT for Wyckoff campaign analysis
- EUR/GBP 70% correlation doesn't mean EUR Phase E = GBP Phase E
- Volume and phase analysis already capture professional activity
- Correlation warnings create false risk signals

**Remove These Functions:**
- `get_currency_correlation()`
- `detect_correlated_exposure()`
- `CURRENCY_CORRELATIONS` constant

---

### **AC #8: Currency Group Detection - REVISE (Advisory Only)**

**Current AC #8:**
```
8. Currency group detection:
   - Major currencies: USD, EUR, GBP, JPY, CHF
   - Commodity currencies: AUD, NZD, CAD (correlated with commodities)
   - Warn if concentrated exposure in correlated currency group
```

**Updated AC #8:**
```
8. Currency group detection (ADVISORY ONLY - no rejections):
   - Track currency groups for informational purposes
   - Groups: majors (USD, EUR, GBP, JPY, CHF), commodity (AUD, NZD, CAD), emerging (MXN, BRL, TRY, ZAR)
   - Calculate group exposure: sum of absolute currency exposures in group
   - Warn if group exposure > 10% (informational only, does NOT reject)
   - Group warnings are ADVISORY - trader discretion to manage

   Example:
   - AUD: +3%, NZD: +2%, CAD: +1.5% = 6.5% commodity group exposure
   - Advisory message: "INFO: Commodity currency group exposure at 6.5% (informational)"
   - Position is APPROVED (group limit is advisory, not enforced)
```

**Rationale:**
- Currency groups are useful context, not risk limits
- AUD Phase E + NZD Phase C = different risk profiles despite both being commodity currencies
- Informational warnings help trader awareness without blocking valid campaigns

---

### **NEW AC #11: Phase Integration with Campaign Tracking**

**Add This New Acceptance Criterion:**
```
11. Phase-based risk weighting integration:
    - Each ForexPosition must track current_phase (A, B, C, D, E, or None)
    - Phase data sourced from phase detector module (Story 4.x)
    - Apply phase weights when calculating currency exposure:
      * Phase E: 0.5x weight (confirmed campaign)
      * Phase D: 0.75x weight (progressing campaign)
      * Phase C/B/A/None: 1.0x weight (unconfirmed campaign)
    - Phase-weighted exposure used for 6% currency limit validation
    - Raw exposure still tracked for reporting purposes

    Example:
    Position: EUR/USD long, 2% risk, Phase E
    - Raw EUR exposure: +2%
    - Weighted EUR exposure: +2% √ó 0.5 = +1% (used for limit validation)

    Position: EUR/GBP long, 2% risk, Phase C
    - Raw EUR exposure: +2%
    - Weighted EUR exposure: +2% √ó 1.0 = +2% (used for limit validation)

    Combined weighted EUR exposure: 1% + 2% = 3% (well under 6% limit)
```

**Implementation:**
```python
@dataclass
class ForexPosition:
    """Forex position with Wyckoff phase tracking."""
    symbol: str
    direction: Literal["LONG", "SHORT"]
    position_risk_pct: Decimal
    current_phase: Optional[Literal["A", "B", "C", "D", "E"]] = None
    # ... other fields

    @property
    def phase_weighted_risk(self) -> Decimal:
        """Calculate phase-weighted risk for currency exposure."""
        weight = get_phase_weight(self.current_phase)
        return self.position_risk_pct * weight
```

---

## Updated Data Models

### **ForexCurrencyExposure - REVISE**

**Current (AC #6):**
```python
@dataclass
class ForexCurrencyExposure:
    currency_exposure: dict[str, Decimal]  # {"EUR": 2.5, "USD": -6.0}
    total_long_exposure: Decimal
    total_short_exposure: Decimal
    max_currency_exposure: tuple[str, Decimal]
    currencies_at_limit: list[str]
    directional_limit_warning: Optional[str] = None  # REMOVE THIS
```

**Updated:**
```python
@dataclass
class ForexCurrencyExposure:
    """Currency exposure tracking with phase-weighted risk."""

    # Raw exposure (for reporting)
    currency_exposure_raw: dict[str, Decimal]  # {"EUR": 2.5, "USD": -6.0}

    # Phase-weighted exposure (for limit validation)
    currency_exposure_weighted: dict[str, Decimal]  # {"EUR": 1.5, "USD": -4.0}

    # Phase breakdown per currency
    phase_breakdown: dict[str, dict[str, Decimal]]  # {"EUR": {"E": 1.0, "C": 1.5}}

    # Max currency (by weighted exposure)
    max_currency_exposure: tuple[str, Decimal]  # ("USD", -4.0) - weighted

    # Currencies approaching limit (weighted >= 5.0%)
    currencies_at_limit: list[str]

    # Campaign tracking
    active_campaigns: list[str]  # ["EUR/USD", "GBP/USD"]
    campaign_count: int
    campaign_limit_warning: Optional[str] = None  # If >= 3 campaigns

    created_at: datetime = None

    def __post_init__(self):
        if self.created_at is None:
            self.created_at = datetime.utcnow()

        # Calculate max currency from WEIGHTED exposure
        if self.currency_exposure_weighted:
            self.max_currency_exposure = max(
                self.currency_exposure_weighted.items(),
                key=lambda x: abs(x[1])
            )
        else:
            self.max_currency_exposure = ("NONE", Decimal("0"))

        # Detect currencies at limit (5% weighted = 83% of 6% limit)
        self.currencies_at_limit = [
            currency
            for currency, exposure in self.currency_exposure_weighted.items()
            if abs(exposure) >= Decimal("5.0")
        ]

        # Campaign limit warning (3 campaigns = at limit)
        if self.campaign_count >= 3:
            self.campaign_limit_warning = (
                f"WARNING: {self.campaign_count} concurrent campaigns active "
                f"(limit: 3). Consider closing campaign before opening new positions."
            )
```

---

## Task Changes Summary

### **Tasks to REMOVE:**

- **Task 5:** ~~Implement directional limit validation~~ ‚Üí DELETE ENTIRELY
- **Task 7:** ~~Implement correlation matrix~~ ‚Üí DELETE ENTIRELY
- All unit tests related to:
  - 8% directional limit validation
  - EUR/GBP correlation warnings
  - `get_currency_correlation()` function
  - `detect_correlated_exposure()` function

### **Tasks to REVISE:**

- **Task 3: Currency limit validation**
  - ADD phase-weighted exposure calculation
  - ADD `get_phase_weight()` helper function
  - ADD phase breakdown tracking

- **Task 6: ForexCurrencyExposure data model**
  - ADD `currency_exposure_raw` field
  - ADD `currency_exposure_weighted` field
  - ADD `phase_breakdown` field
  - ADD `active_campaigns` and `campaign_count` fields
  - REMOVE `total_long_exposure` / `total_short_exposure`
  - REMOVE `directional_limit_warning`

- **Task 8: Currency group detection**
  - CHANGE from enforced limit to advisory warnings only
  - UPDATE messaging: "INFO" instead of "WARNING"
  - REMOVE rejection logic for group limits

- **Task 9: Campaign integration**
  - ADD campaign counting logic
  - ADD phase tracking per position
  - ADD phase-weighted exposure to validation

### **Tasks to ADD:**

- **NEW Task 5: Campaign count limit validation**
  - Implement `validate_campaign_count_limit()` function
  - Track active campaigns per currency pair
  - Enforce max 3 concurrent campaigns
  - Unit tests for campaign counting

- **NEW Task 7: Phase-weighted exposure calculation**
  - Implement `get_phase_weight()` function
  - Implement `calculate_phase_weighted_exposure()` function
  - Unit tests for phase weighting
  - Integration tests with phase detector module

---

## Updated Testing Requirements

### **Remove These Tests:**
- ‚ùå Directional limit validation (8% long/short)
- ‚ùå EUR/GBP correlation warnings
- ‚ùå Correlation matrix lookup
- ‚ùå `detect_correlated_exposure()` tests

### **Add These Tests:**

**Phase-Weighted Exposure:**
```python
def test_phase_e_weighted_exposure():
    """Phase E positions count as 50% risk for currency limits."""
    positions = [
        ForexPosition(symbol="EUR/USD", direction="LONG",
                     position_risk_pct=Decimal("2.0"), current_phase="E")
    ]
    exposure = calculate_currency_exposure(positions)

    assert exposure["EUR"]["raw"] == Decimal("2.0")
    assert exposure["EUR"]["weighted"] == Decimal("1.0")  # 2.0 √ó 0.5

def test_mixed_phase_exposure():
    """Mixed phases combine with appropriate weights."""
    positions = [
        ForexPosition(symbol="EUR/USD", direction="LONG",
                     position_risk_pct=Decimal("2.0"), current_phase="E"),  # 2 √ó 0.5 = 1
        ForexPosition(symbol="EUR/GBP", direction="LONG",
                     position_risk_pct=Decimal("2.0"), current_phase="C"),  # 2 √ó 1.0 = 2
    ]
    exposure = calculate_currency_exposure(positions)

    assert exposure["EUR"]["raw"] == Decimal("4.0")
    assert exposure["EUR"]["weighted"] == Decimal("3.0")  # 1 + 2

def test_phase_weighted_limit_validation():
    """6% limit applies to weighted exposure, not raw."""
    current_positions = [
        ForexPosition(symbol="EUR/USD", direction="LONG",
                     position_risk_pct=Decimal("4.0"), current_phase="E"),  # 4 √ó 0.5 = 2 weighted
    ]
    new_position = ForexPosition(symbol="EUR/GBP", direction="LONG",
                                position_risk_pct=Decimal("4.0"), current_phase="E")  # 4 √ó 0.5 = 2 weighted

    # Raw exposure: 4 + 4 = 8% (would FAIL without phase weighting)
    # Weighted exposure: 2 + 2 = 4% (PASSES with phase weighting)
    is_valid, error = validate_currency_limit("EUR", current_positions, new_position)

    assert is_valid == True  # Should pass (4% weighted < 6%)
```

**Campaign Count Limit:**
```python
def test_campaign_count_limit():
    """Reject new campaign when 3 campaigns active."""
    campaigns = [
        ForexCurrencyCampaign(symbol="EUR/USD", status="ACTIVE"),
        ForexCurrencyCampaign(symbol="GBP/USD", status="ACTIVE"),
        ForexCurrencyCampaign(symbol="AUD/USD", status="ACTIVE"),
    ]

    is_valid, error = validate_campaign_count_limit(
        campaigns, new_position_symbol="USD/JPY", max_campaigns=3
    )

    assert is_valid == False
    assert "Maximum 3 concurrent campaigns exceeded" in error

def test_adding_to_existing_campaign():
    """Allow adding to existing campaign (doesn't increase count)."""
    campaigns = [
        ForexCurrencyCampaign(symbol="EUR/USD", status="ACTIVE"),
        ForexCurrencyCampaign(symbol="GBP/USD", status="ACTIVE"),
    ]

    # Adding another EUR/USD position (same campaign)
    is_valid, error = validate_campaign_count_limit(
        campaigns, new_position_symbol="EUR/USD", max_campaigns=3
    )

    assert is_valid == True  # Adding to existing campaign - OK
```

---

## Integration with Existing Stories

### **Story 7.4-FX (Forex Campaign Risk Tracking):**

Story 7.4-FX must track:
- **Campaign phase** (A, B, C, D, E) - ALREADY IMPLEMENTED (verify)
- **Campaign symbol** (EUR/USD, GBP/USD, etc.)
- **Campaign status** (ACTIVE, CLOSED)

Story 7.5-FX will consume:
- `ForexCurrencyCampaign.current_phase` ‚Üí for phase-weighted exposure
- `ForexCurrencyCampaign.symbol` ‚Üí for campaign counting
- `ForexCurrencyCampaign.status` ‚Üí for active campaign counting

### **Story 4.x (Phase Detection):**

Phase detector must provide:
- Current phase for each forex pair (A, B, C, D, E, or None)
- Phase confidence level (optional, for future enhancement)

Story 7.5-FX integration:
- Query phase detector for new position's symbol
- Use detected phase for `ForexPosition.current_phase`
- Apply phase weight for currency exposure calculation

---

## Rejection Messaging Updates

### **Currency Limit Rejection - REVISE**

**Current:**
```
REJECTED: USD exposure would reach -7.0% (limit: ¬±6.0%)
Current USD short: -6.0%, new position: -1.0%
```

**Updated (Phase-Weighted):**
```
REJECTED: USD phase-weighted exposure would reach -6.5% (limit: ¬±6.0%)

Raw USD exposure: -8.0%
Phase-weighted exposure: -6.5%

Current USD short positions:
- EUR/USD long @ 1.0850 (2.0% raw, 1.0% weighted - Phase E)
- GBP/USD long @ 1.2650 (2.0% raw, 2.0% weighted - Phase C)
- AUD/USD long @ 0.6650 (2.0% raw, 2.0% weighted - Phase C)

New position: EUR/GBP long (1.5% raw, 1.5% weighted - Phase C)

Suggestion: Close GBP/USD (Phase C) to free 2.0% weighted USD exposure, OR wait for AUD/USD to reach Phase E (would reduce weighted exposure by 1.0%)
```

### **Campaign Count Rejection - NEW**

```
REJECTED: Maximum 3 concurrent campaigns exceeded

Active campaigns:
1. EUR/USD (Phase E - 6.0% risk across 3 positions)
2. GBP/USD (Phase D - 3.0% risk across 2 positions)
3. AUD/USD (Phase C - 1.0% risk, 1 position)

New position EUR/GBP would start campaign #4

Suggestion: Close AUD/USD campaign (Phase C, 1 position) to free campaign capacity, OR add to existing EUR/USD campaign if setup presents
```

---

## Deliverables Update

### **REMOVE:**
- ‚ùå Directional limit validation (8% max long/short)
- ‚ùå Correlation matrix implementation
- ‚ùå `get_currency_correlation()` function
- ‚ùå `detect_correlated_exposure()` function
- ‚ùå Correlation-based warnings

### **REVISE:**
- üîß Currency exposure calculation (add phase weighting)
- üîß `ForexCurrencyExposure` data model (add phase breakdown, remove directional fields)
- üîß Currency group detection (advisory only, no rejections)
- üîß Rejection messaging (include phase-weighted exposure)

### **ADD:**
- ‚úÖ Phase-weighted exposure calculation
- ‚úÖ `get_phase_weight()` helper function
- ‚úÖ Campaign count limit validation (max 3 campaigns)
- ‚úÖ Campaign tracking integration with Story 7.4-FX
- ‚úÖ Phase integration with phase detector module

---

## Updated Test Count

**Original Story 7.5-FX:**
- Unit tests: 30+ tests
- Integration tests: Multi-currency scenarios

**Revised Story 7.5-FX:**
- Unit tests: **25 tests** (removed 10 directional/correlation tests, added 5 phase-weighting tests)
  - Currency exposure calculation: 8 tests (including phase-weighted)
  - Currency limit validation: 6 tests (including phase scenarios)
  - Campaign count validation: 4 tests
  - Phase weighting: 4 tests
  - Currency group detection: 3 tests (advisory only)
- Integration tests: **6 tests**
  - Multi-currency phase-weighted scenarios: 3 tests
  - Campaign count limit scenarios: 2 tests
  - End-to-end with phase detector: 1 test

---

## Story Point Estimate Revision

**Original Estimate:** 8 story points

**Revised Estimate:** **6 story points**

**Reasoning:**
- **-3 points:** Removed directional limit validation (AC #5) and correlation matrix (AC #7)
- **+1 point:** Added phase-weighted exposure calculation and campaign count limit

**Complexity remains MODERATE** (phase weighting adds some complexity, but removing correlation matrix simplifies)

---

## Definition of Done Updates

### **Remove:**
- ‚ùå Directional limits enforced (8% max long/short)
- ‚ùå Correlation detection working (EUR/GBP warning)

### **Add:**
- ‚úÖ Phase-weighted exposure calculation accurate
- ‚úÖ Campaign count limits enforced (max 3 campaigns)
- ‚úÖ Phase integration with phase detector module working
- ‚úÖ Phase breakdown reporting in ForexCurrencyExposure

### **Keep:**
- ‚úÖ Currency exposure calculation accurate (EUR/USD long ‚Üí +EUR, -USD)
- ‚úÖ Currency limits enforced (6% max per currency, phase-weighted)
- ‚úÖ Currency group concentration detection working (advisory only)
- ‚úÖ Campaign integration working (validates currency limits)
- ‚úÖ Rejection messages clear and actionable
- ‚úÖ Code passes mypy --strict
- ‚úÖ Code passes flake8
- ‚úÖ Unit tests passing (25+ tests, 90%+ coverage)
- ‚úÖ Integration tests passing (6 tests)
- ‚úÖ Code reviewed by Wyckoff team ‚úÖ **COMPLETED** (this review)
- ‚úÖ Merged to main branch

---

## Wyckoff Team Sign-Off

### **Richard (Wyckoff Mentor):**

> "These revisions bring Story 7.5-FX into alignment with authentic Wyckoff campaign methodology. Phase-weighted exposure correctly recognizes that Phase E confirmed campaigns are lower risk than Phase C speculative tests. The campaign count limit (max 3) prevents portfolio complexity without artificially capping directional exposure. The removal of the correlation matrix eliminates statistical noise that contradicts structural analysis. **APPROVED for development with these changes.**"

### **Victoria (Volume Specialist):**

> "Removing the 8% directional limit is CRITICAL. When multiple currencies show climactic SOS volume simultaneously, that's broad professional accumulation - you SHOULD be long all of them. The phase weighting correctly reflects that Phase E campaigns (confirmed by volume) are less risky than Phase C campaigns (awaiting volume confirmation). **APPROVED.**"

### **Rachel (Risk Manager):**

> "The phase-weighted exposure calculation is the right approach. EUR/USD in Phase E (confirmed markup) mechanically shares EUR exposure with EUR/GBP in Phase C (unconfirmed test), but the RISK is different. Weighting Phase E at 50% acknowledges the structural validation. The campaign count limit (3 max) provides portfolio complexity management without blocking valid setups. Rejection messaging is excellent and now includes phase context for informed decisions. **APPROVED.**"

---

## Action Items for Bob (Scrum Master)

1. **Update Story 7.5-FX markdown file:**
   - Revise AC #3 (currency limit validation) to include phase weighting
   - Remove AC #5 (directional limit validation) entirely
   - Replace with NEW AC #5 (campaign count limit validation)
   - Remove AC #7 (correlation matrix) entirely
   - Revise AC #8 (currency groups) to advisory-only
   - Add NEW AC #11 (phase integration)
   - Update AC #6 (ForexCurrencyExposure data model) per revisions above

2. **Update Task list:**
   - Remove Task 5 (directional limit)
   - Remove Task 7 (correlation matrix)
   - Revise Task 3 (currency validation - add phase weighting)
   - Revise Task 6 (data model updates)
   - Revise Task 8 (currency groups - advisory only)
   - Add NEW Task 5 (campaign count limit)
   - Add NEW Task 7 (phase-weighted exposure)

3. **Update Test requirements:**
   - Remove directional limit tests
   - Remove correlation matrix tests
   - Add phase-weighted exposure tests (see "Updated Testing Requirements" section)
   - Add campaign count limit tests

4. **Update Deliverables section:**
   - Remove correlation matrix deliverables
   - Add phase-weighted calculation deliverables
   - Update test counts (25 unit + 6 integration)

5. **Update story points:** 8 ‚Üí 6 points

6. **Update Notes section:**
   - Remove "Why 8% directional limit?" explanation
   - Add "Why phase-weighted exposure?" explanation
   - Add examples of phase weighting in practice

7. **Dependencies:**
   - Add explicit dependency on Story 4.x (phase detector) for phase data
   - Verify Story 7.4-FX tracks campaign phase (required for 7.5-FX)

---

## Questions for Team Discussion

1. **Phase Weighting Values:**
   - Proposed: Phase E = 0.5x, Phase D = 0.75x, Phase C/B/A = 1.0x
   - Should Phase D be weighted differently (currently 0.75x)?
   - Should Phase A/B have higher weighting than Phase C?

2. **Campaign Count Limit:**
   - Proposed: Max 3 concurrent campaigns
   - Is 3 the right limit, or should it be 2 or 4?
   - Should this be configurable per trader experience level?

3. **Phase Data Source:**
   - Story 4.x phase detector provides phase per currency pair
   - Should phase be stored on ForexPosition or queried real-time?
   - How to handle phase changes (EUR/USD transitions from D ‚Üí E)?

4. **Currency Group Advisory Warnings:**
   - Proposed: 10% commodity group threshold (advisory only)
   - Should threshold vary by group (majors vs emerging)?
   - Should advisory warnings be suppressible by trader preference?

---

## File Reference

**Story File:** `docs/stories/epic-7/7.5-FX.forex-currency-correlation-risk-limits.md`
**Related Story (Stocks):** `docs/stories/epic-7/7.5.correlated-risk-limits.md` (STOCKS ONLY - keep as-is)
**This Review Report:** `docs/stories/epic-7/7.5-FX.WYCKOFF-REVIEW-UPDATES.md`

---

**END OF REPORT**

*This report represents the consensus view of the Wyckoff trading team (Richard, Victoria, Rachel) on required changes to Story 7.5-FX to align with authentic Wyckoff methodology. All changes are designed to ensure the implementation reflects genuine campaign-based risk management rather than statistical correlation mechanics.*
