# Story 7.4-FX: Forex Campaign Risk Tracking (Currency Trends)

## Status
Done
**Ready for Review** *(Revised per Wyckoff team review 2025-11-17)*

**Priority:** ðŸ”´ CRITICAL
**Estimate:** 7 story points *(+1 for volume validation)*
**Dependencies:** Story 7.2-FX (Forex Position Sizing), Story 7.3-FX (Weekend Gap Risk - Enhanced)

**Epic:** Epic 7-FX - Forex Risk Management & Position Sizing
**Sprint:** Sprint 2 (Week 6)

**Note:** Story 7.3-FX has been enhanced (7 story points) with pattern/phase/volatility-aware weekend risk. This story integrates with the enhanced weekend calculations.

## Story

**As a** forex trader,
**I want** campaign risk tracked as currency trends (not stock accumulation ranges),
**so that** I can manage directional exposure within the 5% campaign limit while respecting currency market dynamics.

## Context

Stock and forex markets have fundamentally different campaign structures:

**Stock Campaigns (Story 7.4 Original):**
- Campaign = Single accumulation range (AAPL $140-150)
- Pattern: Spring â†’ ST â†’ SOS â†’ LPS (accumulation to markup)
- Campaign duration: Weeks to months (range-bound)
- Campaign completion: All positions in same range closed
- Tracking: By trading_range_id (single symbol, single range)

**Forex Currency Trend Campaigns:**
- Campaign = Directional currency trend (EUR strengthening, USD weakening)
- Patterns: Multiple springs/SOS across related pairs (EUR/USD, EUR/GBP, EUR/JPY)
- Campaign duration: Days to weeks (trending)
- Campaign completion: Trend reversal or all positions closed
- Tracking: By currency direction (EUR long, USD short)

**Example - EUR Strength Campaign:**

Campaign ID: `USD_SHORT_2024_03_15`
- EUR/USD spring @ 1.0850 (long EUR, short USD) - 1.5% risk
- EUR/GBP spring @ 0.8620 (long EUR, short GBP) - 1.5% risk
- EUR/JPY SOS @ 161.50 (long EUR, short JPY) - 1.0% risk
- Total campaign risk: 4.0% (all capitalize on EUR strength / USD weakness)

This is a **single currency trend campaign** tracking USD weakness exposure, not three separate campaigns.

**Contrast with Stock:**
- Stock campaign: All positions in same symbol/range (AAPL $140-150)
- Forex campaign: Multiple pairs sharing currency trend (all long EUR = EUR strength)

This story adapts Story 7.4's campaign tracking to handle forex currency trend campaigns.

## Acceptance Criteria

1. **Create forex campaign tracker module:** `backend/src/risk_management/forex_campaign_tracker.py`

2. **Currency trend campaign identification:**
   - Campaign identified by currency direction (not trading_range_id)
   - Campaign types: `USD_LONG`, `USD_SHORT`, `EUR_LONG`, `EUR_SHORT`, `GBP_LONG`, `GBP_SHORT`, etc.
   - Multiple pairs can share campaign if same currency direction
   - Example: EUR/USD long + EUR/GBP long + EUR/JPY long = single EUR_LONG campaign

3. **Campaign risk calculation (same 5% limit as stocks):**
   ```python
   def calculate_currency_campaign_risk(
       campaign_id: str,
       open_positions: list[ForexPosition]
   ) -> Decimal:
       """
       Sum risk across all positions in currency trend campaign.
       campaign_id format: "{CURRENCY}_{LONG|SHORT}_{YYYY_MM_DD}"
       """
       total_risk = Decimal("0")
       for position in open_positions:
           if position.campaign_id == campaign_id:
               total_risk += position.position_risk_pct
       return total_risk
   ```

4. **Currency exposure tracking:**
   - Track which currency is being traded in each position
   - EUR/USD long = long EUR + short USD
   - EUR/USD short = short EUR + long USD
   - Campaign tracks exposure to single currency direction
   - Example: `EUR_LONG` campaign includes all positions long EUR

5. **BMAD allocation for forex trends (volume-validated):**
   - First Entry: 25% (1st leg - unconfirmed trend) - exploratory positioning
   - Confirm Entry (SOS): 45% (multi-pair trend confirmation) - **primary entry** (largest allocation)
   - Addon Entry: 30% (trend continuation) - add-on positioning
   - **Rationale:** Forex trends have inverted risk vs stocks. In stocks, Spring (low volume test) = best risk/reward = largest position (40%). In forex, unconfirmed first leg = highest uncertainty = smallest position (25%). Largest position at CONFIRMATION when multiple pairs show high-volume SOS validating trend.
   - Total: 5% campaign risk limit (same as stocks)

6. **Currency trend completion detection:**
   - Campaign completes when:
     - All positions closed, OR
     - Currency trend reverses (detected by opposite direction SOS), OR
     - Maximum campaign duration exceeded (14 days default)
   - Trend reversal: If EUR_LONG campaign active and EUR/USD generates short SOS â†’ close campaign

7. **ForexCurrencyCampaign data model:**
   ```python
   @dataclass
   class ForexCurrencyCampaign:
       campaign_id: str  # "EUR_LONG_2024_03_15"
       currency: str  # "EUR", "USD", "GBP", etc.
       direction: str  # "LONG", "SHORT"
       total_risk_pct: Decimal
       available_capacity_pct: Decimal  # 5.0% - total_risk
       position_count: int
       positions: list[ForexPosition]
       started_at: datetime
       expected_completion: datetime  # 14 days from start
       status: str  # "ACTIVE", "COMPLETED", "REVERSED"
       created_at: datetime
   ```

8. **Multi-pair campaign validation:**
   - **Currency direction validation:** Validate all positions in campaign share same currency exposure
   - Reject adding EUR/USD short to EUR_LONG campaign (opposite direction)
   - Allow adding EUR/GBP long to EUR_LONG campaign (same direction)
   - Allow adding EUR/JPY long to EUR_LONG campaign (same direction)
   - **Volume validation:** Require volume confirmation for all multi-pair additions
     - FIRST entry: <0.8x avg volume (low volume test)
     - CONFIRM entry (SOS): â‰¥1.5x avg volume (high volume breakout)
     - ADDON entry: â‰¥1.2x avg volume (above-average continuation)
     - Reject additions with insufficient volume confirmation for entry type
     - Example: Cannot add EUR/JPY with 0.9x volume to EUR_LONG campaign as CONFIRM entry (requires 1.5x+)

9. **Campaign naming convention:**
   - Format: `{CURRENCY}_{DIRECTION}_{START_DATE}`
   - Examples:
     - `USD_SHORT_2024_03_15` (shorting USD across pairs)
     - `EUR_LONG_2024_03_20` (buying EUR across pairs)
     - `GBP_SHORT_2024_04_01` (selling GBP across pairs)
   - Start date ensures unique campaigns for same currency/direction

10. **Integration with Story 7.3-FX (Enhanced Weekend Gap Risk):**
    - Campaign risk calculation includes pattern/phase/volatility-aware weekend adjustment
    - Uses enhanced weekend calculation: `pattern_buffer Ã— phase_multiplier Ã— volatility_multiplier`
    - If Friday and campaign risk >4%, warn about weekend exposure with breakdown
    - Option to close entire campaign before Friday 5pm ET (selective, pattern-aware)
    - Example: EUR_LONG campaign with 3 positions â†’ pattern/phase-weighted weekend adjustment

## Tasks / Subtasks

### **Task 1: Create forex campaign tracker module** (AC: 1)

- [ ] Create file: `backend/src/risk_management/forex_campaign_tracker.py`
- [ ] Add imports:
  ```python
  from decimal import Decimal
  from dataclasses import dataclass
  from datetime import datetime, timedelta
  from typing import Optional
  from backend.src.risk_management.forex_position_sizer import ForexPosition
  ```

### **Task 2: Implement currency trend identification** (AC: 2, 4)

- [ ] Create currency extraction function:
  ```python
  def extract_currency_exposure(
      symbol: str,
      direction: str  # "LONG" or "SHORT"
  ) -> tuple[str, str]:
      """
      Extract which currency is being bought/sold.

      Args:
          symbol: "EUR/USD", "GBP/JPY", etc.
          direction: "LONG" or "SHORT"

      Returns:
          (bought_currency, sold_currency)

      Examples:
          EUR/USD LONG â†’ ("EUR", "USD") - buy EUR, sell USD
          EUR/USD SHORT â†’ ("USD", "EUR") - buy USD, sell EUR
          GBP/JPY LONG â†’ ("GBP", "JPY") - buy GBP, sell JPY
      """
      base, quote = symbol.split("/")

      if direction == "LONG":
          return base, quote  # Buy base, sell quote
      else:
          return quote, base  # Buy quote, sell base

  def get_campaign_id(
      currency: str,
      direction: str,
      start_date: datetime = None
  ) -> str:
      """Generate campaign ID for currency trend."""
      if start_date is None:
          start_date = datetime.utcnow()

      date_str = start_date.strftime("%Y_%m_%d")
      return f"{currency}_{direction}_{date_str}"
  ```

- [ ] Unit test: EUR/USD long â†’ ("EUR", "USD")
- [ ] Unit test: EUR/USD short â†’ ("USD", "EUR")
- [ ] Unit test: Campaign ID generation

### **Task 3: Implement campaign risk calculation** (AC: 3)

- [ ] Create campaign risk calculator:
  ```python
  def calculate_currency_campaign_risk(
      campaign_id: str,
      open_positions: list[ForexPosition]
  ) -> Decimal:
      """Calculate total risk for currency trend campaign."""
      total_risk = Decimal("0")

      for position in open_positions:
          if hasattr(position, 'campaign_id') and position.campaign_id == campaign_id:
              total_risk += position.position_risk_pct

      return total_risk.quantize(Decimal("0.01"))
  ```

- [ ] Unit test: 3 positions in EUR_LONG campaign (1.5% + 1.5% + 1.0%) = 4.0%
- [ ] Unit test: Empty campaign = 0%

### **Task 4: Implement BMAD allocation for trends** (AC: 5)

- [ ] Create BMAD allocation constants:
  ```python
  # Forex currency trend BMAD allocation (volume-validated for forex trends)
  # NOTE: Inverted from stock allocation - largest position at CONFIRMATION, not first entry
  FOREX_TREND_FIRST_ENTRY_ALLOC = Decimal("0.25")   # 25% - 1st leg (unconfirmed trend)
  FOREX_TREND_CONFIRM_ALLOC = Decimal("0.45")       # 45% - Trend confirmation (PRIMARY entry)
  FOREX_TREND_ADDON_ALLOC = Decimal("0.30")         # 30% - Trend continuation

  MAX_FOREX_CAMPAIGN_RISK = Decimal("5.0")  # 5% max per currency trend

  # Maximum risk per entry type
  MAX_FIRST_ENTRY_RISK = Decimal("1.25")   # 25% of 5% = 1.25%
  MAX_CONFIRM_RISK = Decimal("2.25")       # 45% of 5% = 2.25%
  MAX_ADDON_RISK = Decimal("1.50")         # 30% of 5% = 1.50%
  ```

- [ ] Create allocation validator:
  ```python
  def validate_forex_bmad_allocation(
      campaign: ForexCurrencyCampaign,
      new_entry_type: str,  # "FIRST", "CONFIRM", "ADDON"
      new_entry_risk: Decimal
  ) -> tuple[bool, Optional[str]]:
      """Validate BMAD allocation for forex trend entries."""

      # Calculate existing risk for this entry type
      entry_type_risk = Decimal("0")
      for position in campaign.positions:
          if position.entry_type == new_entry_type:
              entry_type_risk += position.position_risk_pct

      # Check entry type limits
      if new_entry_type == "FIRST":
          max_risk = MAX_FIRST_ENTRY_RISK
          allocation = "25%"
      elif new_entry_type == "CONFIRM":
          max_risk = MAX_CONFIRM_RISK
          allocation = "45%"
      elif new_entry_type == "ADDON":
          max_risk = MAX_ADDON_RISK
          allocation = "30%"
      else:
          return False, f"Invalid entry type: {new_entry_type}"

      if entry_type_risk + new_entry_risk > max_risk:
          return False, (
              f"{new_entry_type} allocation exceeded: "
              f"{entry_type_risk + new_entry_risk}% > {max_risk}% "
              f"(max {allocation} of campaign budget)"
          )

      return True, None
  ```

- [ ] Unit test: First entry 1.25% â†’ PASS (at limit)
- [ ] Unit test: First entry 1.26% â†’ REJECT (exceeds 25%)
- [ ] Unit test: Confirm entry 2.25% â†’ PASS (at limit)
- [ ] Unit test: Confirm entry 2.26% â†’ REJECT (exceeds 45%)
- [ ] Unit test: Addon entry 1.50% â†’ PASS (at limit)

### **Task 5: Create ForexCurrencyCampaign data model** (AC: 7)

- [ ] Implement data model:
  ```python
  @dataclass
  class ForexCurrencyCampaign:
      """Forex currency trend campaign tracking."""
      campaign_id: str  # "EUR_LONG_2024_03_15"
      currency: str  # "EUR", "USD", "GBP", "JPY", "CHF", "AUD", "NZD", "CAD"
      direction: str  # "LONG", "SHORT"
      total_risk_pct: Decimal
      available_capacity_pct: Decimal  # 5.0% - total_risk
      position_count: int
      positions: list[ForexPosition]
      started_at: datetime
      expected_completion: datetime  # 14 days from start (default)
      status: str  # "ACTIVE", "COMPLETED", "REVERSED"
      created_at: datetime = None

      def __post_init__(self):
          if self.created_at is None:
              self.created_at = datetime.utcnow()

          # Calculate available capacity
          self.available_capacity_pct = MAX_FOREX_CAMPAIGN_RISK - self.total_risk_pct

          # Set expected completion (14 days default)
          if self.expected_completion is None:
              self.expected_completion = self.started_at + timedelta(days=14)

      @property
      def is_expired(self) -> bool:
          """Check if campaign exceeded max duration."""
          return datetime.utcnow() > self.expected_completion

      @property
      def days_active(self) -> int:
          """Calculate campaign duration in days."""
          return (datetime.utcnow() - self.started_at).days
  ```

- [ ] Unit test: Create campaign, verify all fields populated
- [ ] Unit test: is_expired property
- [ ] Unit test: days_active calculation

### **Task 6: Implement currency trend completion detection** (AC: 6)

- [ ] Create completion detector:
  ```python
  def detect_trend_reversal(
      campaign: ForexCurrencyCampaign,
      new_signal_currency: str,
      new_signal_direction: str
  ) -> bool:
      """
      Detect if new signal reverses existing trend.

      Example: EUR_LONG campaign + new EUR short signal â†’ reversal
      """
      if new_signal_currency != campaign.currency:
          return False  # Different currency, not a reversal

      # Opposite direction = reversal
      if campaign.direction == "LONG" and new_signal_direction == "SHORT":
          return True
      if campaign.direction == "SHORT" and new_signal_direction == "LONG":
          return True

      return False

  def check_campaign_completion(
      campaign: ForexCurrencyCampaign
  ) -> tuple[bool, str]:
      """
      Check if currency trend campaign should complete.

      Returns: (is_complete, reason)
      """
      # All positions closed
      open_positions = [p for p in campaign.positions if p.status == "OPEN"]
      if len(open_positions) == 0:
          return True, "ALL_POSITIONS_CLOSED"

      # Maximum duration exceeded (14 days default)
      if campaign.is_expired:
          return True, "MAX_DURATION_EXCEEDED"

      # Campaign active
      return False, "ACTIVE"
  ```

- [ ] Unit test: All positions closed â†’ Complete
- [ ] Unit test: Positions open, <14 days â†’ Active
- [ ] Unit test: Positions open, >14 days â†’ Complete (expired)
- [ ] Unit test: EUR_LONG + EUR short signal â†’ Reversal detected

### **Task 7: Implement multi-pair validation** (AC: 8)

- [ ] Create currency direction validator:
  ```python
  def validate_position_matches_campaign(
      campaign: ForexCurrencyCampaign,
      new_position_symbol: str,
      new_position_direction: str
  ) -> tuple[bool, Optional[str]]:
      """
      Validate new position matches campaign currency direction.

      EUR_LONG campaign can include:
      - EUR/USD long (buy EUR, sell USD)
      - EUR/GBP long (buy EUR, sell GBP)
      - EUR/JPY long (buy EUR, sell JPY)

      EUR_LONG campaign CANNOT include:
      - EUR/USD short (sell EUR, buy USD) - opposite direction
      - GBP/USD long (buy GBP, sell USD) - different currency
      """
      bought_currency, sold_currency = extract_currency_exposure(
          new_position_symbol,
          new_position_direction
      )

      # Check if position matches campaign direction
      if campaign.direction == "LONG":
          # Campaign is long {currency}, new position must buy {currency}
          if bought_currency == campaign.currency:
              return True, None
          else:
              return False, (
                  f"Position mismatch: {campaign.campaign_id} is long {campaign.currency}, "
                  f"but {new_position_symbol} {new_position_direction} buys {bought_currency}"
              )

      else:  # SHORT
          # Campaign is short {currency}, new position must sell {currency}
          if sold_currency == campaign.currency:
              return True, None
          else:
              return False, (
                  f"Position mismatch: {campaign.campaign_id} is short {campaign.currency}, "
                  f"but {new_position_symbol} {new_position_direction} sells {sold_currency}"
              )
  ```

- [ ] Create volume validator for multi-pair additions:
  ```python
  def validate_volume_for_campaign_addition(
      campaign: ForexCurrencyCampaign,
      new_position: ForexPosition,
      new_position_volume_ratio: Decimal  # vs 20-bar average
  ) -> tuple[bool, Optional[str]]:
      """
      Validate new position has volume confirmation matching campaign trend.

      Volume requirements by entry type:
      - FIRST (Spring): <0.8x avg (low volume test)
      - CONFIRM (SOS): 1.5x+ avg (high volume breakout)
      - ADDON (Continuation): 1.2x+ avg (above-average volume)

      Args:
          campaign: Active forex currency campaign
          new_position: Position to add to campaign
          new_position_volume_ratio: Current bar volume / 20-bar avg volume

      Returns:
          (is_valid, error_message)

      Example:
          EUR_LONG campaign active, adding EUR/JPY with 0.9x volume as CONFIRM:
          â†’ REJECT (CONFIRM requires 1.5x+ volume for trend confirmation)
      """
      entry_type = new_position.entry_type

      # Volume requirements by entry type
      if entry_type == "FIRST":  # Spring entry
          if new_position_volume_ratio > Decimal("0.8"):
              return False, (
                  f"Spring entry volume too high for {new_position.symbol}: "
                  f"{new_position_volume_ratio}x avg (should be <0.8x for low volume test)"
              )

      elif entry_type == "CONFIRM":  # SOS entry
          if new_position_volume_ratio < Decimal("1.5"):
              return False, (
                  f"Insufficient volume for SOS entry in {new_position.symbol}: "
                  f"{new_position_volume_ratio}x avg (minimum 1.5x required for confirmation)"
              )

      elif entry_type == "ADDON":  # Continuation entry
          if new_position_volume_ratio < Decimal("1.2"):
              return False, (
                  f"Insufficient volume for continuation entry in {new_position.symbol}: "
                  f"{new_position_volume_ratio}x avg (minimum 1.2x required)"
              )

      return True, None
  ```

- [ ] Unit test: EUR_LONG + EUR/USD long â†’ PASS (currency direction)
- [ ] Unit test: EUR_LONG + EUR/GBP long â†’ PASS (currency direction)
- [ ] Unit test: EUR_LONG + EUR/USD short â†’ REJECT (currency direction)
- [ ] Unit test: EUR_LONG + GBP/USD long â†’ REJECT (different currency)
- [ ] Unit test: FIRST entry with 0.5x volume â†’ PASS (volume validation)
- [ ] Unit test: FIRST entry with 0.9x volume â†’ REJECT (volume validation - too high)
- [ ] Unit test: CONFIRM entry with 1.8x volume â†’ PASS (volume validation)
- [ ] Unit test: CONFIRM entry with 1.2x volume â†’ REJECT (volume validation - too low)
- [ ] Unit test: ADDON entry with 1.3x volume â†’ PASS (volume validation)
- [ ] Unit test: ADDON entry with 1.0x volume â†’ REJECT (volume validation - too low)

### **Task 8: Implement campaign naming** (AC: 9)

- [ ] Create campaign name parser:
  ```python
  def parse_campaign_id(campaign_id: str) -> tuple[str, str, datetime]:
      """
      Parse campaign ID into components.

      Args:
          campaign_id: "EUR_LONG_2024_03_15"

      Returns:
          (currency, direction, start_date)
      """
      parts = campaign_id.split("_")
      if len(parts) != 5:
          raise ValueError(f"Invalid campaign ID format: {campaign_id}")

      currency = parts[0]
      direction = parts[1]
      year = int(parts[2])
      month = int(parts[3])
      day = int(parts[4])

      start_date = datetime(year, month, day)

      return currency, direction, start_date

  def create_campaign_id(
      currency: str,
      direction: str,
      start_date: datetime = None
  ) -> str:
      """Create campaign ID from components."""
      if start_date is None:
          start_date = datetime.utcnow()

      return f"{currency}_{direction}_{start_date.strftime('%Y_%m_%d')}"
  ```

- [ ] Unit test: Parse "EUR_LONG_2024_03_15" â†’ ("EUR", "LONG", datetime(2024, 3, 15))
- [ ] Unit test: Create campaign ID from components
- [ ] Unit test: Reject invalid format "EUR_LONG" (missing date)

### **Task 9: Integrate with enhanced weekend gap risk** (AC: 10)

- [ ] Create weekend campaign risk calculator:
  ```python
  def calculate_campaign_weekend_risk(
      campaign: ForexCurrencyCampaign,
      current_time: datetime = None
  ) -> tuple[Decimal, Optional[str]]:
      """
      Calculate campaign risk including pattern/phase/volatility-aware weekend adjustment.

      Uses Story 7.3-FX enhanced weekend risk logic (pattern/phase/volatility-weighted).
      """
      from backend.src.risk_management.forex_portfolio_heat import (
          calculate_weekend_adjustment_volatility_aware,  # Enhanced version
          is_friday_close_approaching,
          is_weekend
      )

      base_risk = campaign.total_risk_pct
      is_weekend_hold = is_friday_close_approaching(current_time) or is_weekend(current_time)

      # Use enhanced weekend adjustment (pattern/phase/volatility-aware)
      weekend_adj = calculate_weekend_adjustment_volatility_aware(
          campaign.positions,  # Pass full position list for pattern/phase/volatility
          current_time
      )

      total_risk = base_risk + weekend_adj

      warning = None
      if is_friday_close_approaching(current_time) and total_risk > Decimal("4.0"):
          # Enhanced warning with pattern/phase breakdown
          warning = (
              f"WARNING: {campaign.campaign_id} holding {campaign.position_count} "
              f"positions into weekend ({base_risk}% base â†’ {total_risk}% adjusted). "
              f"Weekend adjustment: {weekend_adj}% (pattern/phase/volatility-weighted). "
              f"Consider closing campaign before Friday 5pm ET."
          )

      return total_risk, warning
  ```

- [ ] Unit test: Weekday, 3 positions â†’ No adjustment
- [ ] Unit test: Friday, 3 Spring positions Phase D â†’ Pattern-weighted adjustment (0.9%)
- [ ] Unit test: Friday, mixed patterns/phases â†’ Enhanced adjustment calculation
- [ ] Unit test: Friday, 4.5% base risk â†’ Warning with pattern/phase breakdown

### **Task 10: Create campaign management functions** (AC: 3, 6, 8)

- [ ] Create campaign operations:
  ```python
  def create_forex_campaign(
      currency: str,
      direction: str,
      first_position: ForexPosition,
      start_date: datetime = None
  ) -> ForexCurrencyCampaign:
      """Create new currency trend campaign."""
      if start_date is None:
          start_date = datetime.utcnow()

      campaign_id = create_campaign_id(currency, direction, start_date)

      return ForexCurrencyCampaign(
          campaign_id=campaign_id,
          currency=currency,
          direction=direction,
          total_risk_pct=first_position.position_risk_pct,
          available_capacity_pct=MAX_FOREX_CAMPAIGN_RISK - first_position.position_risk_pct,
          position_count=1,
          positions=[first_position],
          started_at=start_date,
          expected_completion=start_date + timedelta(days=14),
          status="ACTIVE"
      )

  def add_position_to_campaign(
      campaign: ForexCurrencyCampaign,
      new_position: ForexPosition,
      volume_ratio: Decimal  # NEW PARAMETER: Current volume / 20-bar avg
  ) -> tuple[bool, Optional[str]]:
      """Add position to existing campaign with validation."""

      # Validate position matches campaign (currency direction)
      is_valid, error_msg = validate_position_matches_campaign(
          campaign,
          new_position.symbol,
          new_position.direction
      )
      if not is_valid:
          return False, error_msg

      # NEW: Volume validation for multi-pair additions
      is_valid, error_msg = validate_volume_for_campaign_addition(
          campaign,
          new_position,
          volume_ratio
      )
      if not is_valid:
          return False, error_msg

      # Validate campaign risk limit
      new_total_risk = campaign.total_risk_pct + new_position.position_risk_pct
      if new_total_risk > MAX_FOREX_CAMPAIGN_RISK:
          return False, (
              f"Campaign risk limit exceeded: {new_total_risk}% > {MAX_FOREX_CAMPAIGN_RISK}% "
              f"(current: {campaign.total_risk_pct}%, new: {new_position.position_risk_pct}%)"
          )

      # Add position
      campaign.positions.append(new_position)
      campaign.total_risk_pct = new_total_risk
      campaign.available_capacity_pct = MAX_FOREX_CAMPAIGN_RISK - new_total_risk
      campaign.position_count += 1

      return True, None

  def close_campaign(
      campaign: ForexCurrencyCampaign,
      reason: str
  ) -> None:
      """Mark campaign as completed."""
      campaign.status = "COMPLETED"
      logger.info(
          "forex_campaign_completed",
          campaign_id=campaign.campaign_id,
          reason=reason,
          final_risk=str(campaign.total_risk_pct),
          positions_count=campaign.position_count,
          duration_days=campaign.days_active
      )
  ```

- [ ] Unit test: Create campaign with first position
- [ ] Unit test: Add valid position to campaign (currency direction + volume validated)
- [ ] Unit test: Reject position exceeding 5% limit
- [ ] Unit test: Reject position with insufficient volume (CONFIRM entry with 1.0x volume)
- [ ] Unit test: Reject position with wrong currency direction
- [ ] Unit test: Close campaign

## Deliverables

- âœ… `backend/src/risk_management/forex_campaign_tracker.py` - Forex currency trend campaign tracker
- âœ… `ForexCurrencyCampaign` data model with currency direction tracking
- âœ… Currency exposure extraction and validation
- âœ… BMAD allocation for forex trends (25% / 45% / 30%) - volume-validated
- âœ… Multi-pair campaign support (EUR/USD + EUR/GBP + EUR/JPY in single campaign)
- âœ… Multi-pair volume validation (volume confirmation required per pair)
- âœ… Trend reversal detection
- âœ… Weekend gap risk integration
- âœ… Unit tests: 30+ tests covering campaign creation, validation, completion, volume validation
- âœ… Integration tests: Multi-pair campaign scenarios with volume confirmation

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Currency exposure extraction accurate (EUR/USD long â†’ long EUR, short USD)
- [ ] Campaign risk calculation correct (sum positions in same trend)
- [ ] BMAD allocation enforced for trend entries (25%/45%/30%)
- [ ] Multi-pair currency direction validation working (same currency trend only)
- [ ] Multi-pair volume validation working (volume requirements by entry type)
- [ ] Trend reversal detection accurate
- [ ] Weekend gap risk integration working
- [ ] Campaign naming convention implemented
- [ ] Code passes mypy --strict
- [ ] Code passes flake8
- [ ] Unit tests passing (30+ tests, 90%+ coverage)
- [ ] Integration tests passing (multi-pair scenarios with volume validation)
- [ ] Code reviewed by Wyckoff team
- [ ] Merged to main branch

## Notes

**Currency Trend vs Stock Accumulation:**

| Aspect | Stock Accumulation | Forex Currency Trend |
|--------|-------------------|---------------------|
| Campaign Scope | Single symbol, single range | Multiple pairs, same currency |
| Example | AAPL $140-150 range | EUR strength (EUR/USD, EUR/GBP, EUR/JPY) |
| Duration | Weeks to months | Days to weeks |
| Patterns | Spring â†’ ST â†’ SOS â†’ LPS | Multiple springs/SOS in different pairs |
| Completion | All positions closed | Trend reversal or time limit |
| Tracking | trading_range_id | currency + direction |

**Currency Trend Campaign Examples:**

**EUR_LONG Campaign (EUR Strength):**
- EUR/USD long @ 1.0850 (buy EUR, sell USD) - 1.5% risk
- EUR/GBP long @ 0.8620 (buy EUR, sell GBP) - 1.5% risk
- EUR/JPY long @ 161.50 (buy EUR, sell JPY) - 1.0% risk
- Total: 4.0% campaign risk (all positions profit from EUR appreciation)

**USD_SHORT Campaign (USD Weakness - same as EUR_LONG example):**
- EUR/USD long @ 1.0850 (short USD) - 1.5% risk
- GBP/USD long @ 1.2650 (short USD) - 1.5% risk
- AUD/USD long @ 0.6650 (short USD) - 1.0% risk
- Total: 4.0% campaign risk (all positions profit from USD depreciation)

**GBP_SHORT Campaign (GBP Weakness):**
- GBP/USD short @ 1.2650 (short GBP) - 1.5% risk
- EUR/GBP long @ 0.8620 (short GBP) - 1.5% risk
- GBP/JPY short @ 187.50 (short GBP) - 1.0% risk
- Total: 4.0% campaign risk (all positions profit from GBP depreciation)

**Campaign Validation Rules:**

| Campaign | Valid Additions | Invalid Additions |
|----------|----------------|-------------------|
| EUR_LONG | EUR/USD long, EUR/GBP long, EUR/JPY long | EUR/USD short, GBP/USD long, USD/JPY short |
| USD_SHORT | EUR/USD long, GBP/USD long, AUD/USD long | EUR/USD short, USD/JPY long, USD/CHF long |
| GBP_SHORT | GBP/USD short, EUR/GBP long, GBP/JPY short | GBP/USD long, EUR/GBP short, AUD/GBP short |

**Trend Reversal Detection:**

| Campaign | Reversal Signal | Action |
|----------|----------------|--------|
| EUR_LONG (active) | EUR/USD short SOS | Close campaign, start EUR_SHORT |
| USD_SHORT (active) | EUR/USD short SOS (buy USD) | Close campaign, start USD_LONG |
| GBP_SHORT (active) | GBP/USD long SOS | Close campaign, start GBP_LONG |

**Wyckoff Team Review (Rachel - Risk Specialist):**

> "Forex currency trend campaigns require different mental model than stock accumulation. A stock campaign is confined to one symbol and one range. A forex campaign tracks directional exposure across multiple pairs sharing the same underlying currency. The EUR_LONG example (EUR/USD + EUR/GBP + EUR/JPY) represents a single bet on EUR strength, not three independent positions. The 5% campaign limit correctly constrains this directional risk."

**Victoria (Volume Specialist) - Currency Trend Dynamics:**

> "Currency trends are macro-driven (central bank policy, economic data) not accumulation-driven like stocks. The Springâ†’SOS sequence still applies, but you might see springs in EUR/USD, EUR/GBP, and EUR/JPY simultaneously when EUR strengthens broadly. These are all one campaign because they're the same macro thesis: EUR appreciation. The 14-day campaign duration reflects forex trend lifecycles - much faster than stock accumulation (weeks vs months)."

**Richard (Wyckoff Methodology) - Adaptation Notes:**

> "Wyckoff didn't trade forex, but his principles adapt. The 'campaign' concept maps to currency trends: professional operators (central banks, sovereign wealth funds, large institutions) drive trends through coordinated buying/selling across multiple pairs. Our Spring/SOS framework detects these trends early. The multi-pair tracking is essential - you're not trading EUR/USD vs EUR/GBP independently, you're trading the EUR trend itself."

---

## Revision History

**2025-11-17 - Wyckoff Team Review Revisions:**

**Critical Changes Applied:**
1. **BMAD Allocation Updated (Victoria - Volume Specialist):**
   - Changed from 40%/35%/25% â†’ **25%/45%/30%**
   - Rationale: Forex trends have inverted risk vs stocks. Largest position should be at CONFIRMATION (SOS across multiple pairs), not first unconfirmed entry.
   - Updated: AC #5, Task 4 (constants, validator, unit tests), Deliverables, Definition of Done

2. **Volume Validation Added (Victoria - Volume Specialist):**
   - New function: `validate_volume_for_campaign_addition()`
   - Volume requirements: FIRST <0.8x, CONFIRM â‰¥1.5x, ADDON â‰¥1.2x
   - Prevents adding pairs without volume confirmation (e.g., low-volume EUR/JPY to EUR_LONG campaign)
   - Updated: AC #8, Task 7 (new function + 6 tests), Task 10 (`add_position_to_campaign()` signature + 3 tests), Deliverables, Definition of Done

**Optional Enhancements Deferred:**
- Correlation Risk Multiplier (15% adjustment) - defer to Story 7.5
- Campaign Heat Visualization - defer to separate story
- Trend Strength Scoring - defer to future enhancement

**Story Points:** 6 â†’ 7 (volume validation complexity)

**Review Report:** [docs/stories/epic-7/7.4-FX-review-report.md](7.4-FX-review-report.md)

---

**Story Created:** 2025-11-14
**Last Updated:** 2025-11-17
**Status:** Ready for Review (Revised per Wyckoff team feedback)
