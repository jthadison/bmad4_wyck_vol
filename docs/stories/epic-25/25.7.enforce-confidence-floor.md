# Story 25.7: Enforce 70% Confidence Floor Before Signal Emission

## Status
Done

## Story
**As a** developer,
**I want** a confidence floor check that rejects any signal with confidence below 70% before it reaches the broker or the API response,
**So that** FR3's minimum 70% confidence requirement is enforced for all signals, not just documented.

## INVEST Checklist
| Criteria | Status | Notes |
|----------|--------|-------|
| Independent | ⚠️ | Depends on 25.1 and 25.2 — pipeline must be producing signals before floor can be tested |
| Negotiable | ✅ | Floor location within emission path flexible |
| Valuable | ✅ | FR3 is a stated product requirement; unenforced it allows low-quality signals to reach the broker |
| Estimable | ✅ | Single guard in signal emission path, well-scoped |
| Small | ✅ | 2 points — one guard + one test per AC |
| Testable | ✅ | Confidence values are numeric; pass/fail boundaries are exact |

## Story Points
2

## Priority
P1 Critical

## Type
Bug Fix

## Dependencies
Story 25.1 — pipeline must produce signals before the floor can be tested
Story 25.2 — portfolio context must be wired before signals reach the emission path

## Background

FR3 requires a minimum 70% signal confidence. However, SOS signals detected during the ASIAN session receive a -25 penalty applied to a hardcoded base of 85, yielding 60% confidence. No guard exists to reject signals below 70% before they are returned from the API or forwarded to the broker.

Additionally, the fallback confidence value in `backend/src/orchestrator/orchestrator_facade.py:247` is hardcoded to 75 when no `volume_ratio` is available. 75 passes the floor but is arbitrary — there is no data supporting it. A signal with unknown volume should be treated as having insufficient evidence, not assigned a passing confidence by default.

This story adds a single confidence floor check in the signal emission path:
- Rejects any signal below 70%
- Logs the rejection with the actual confidence value and the component(s) that caused it to fall below the floor
- Ensures the check is applied after all penalties are computed (not before session or phase penalties are applied)
- Replaces the arbitrary fallback of 75 with either a rejection or a confidence derived from available data

## Acceptance Criteria

### AC1: Signal Below 70% Rejected at Emission
```gherkin
Given an SOS signal where the computed confidence after all penalties is 60
When signal emission is attempted
Then the signal is rejected before being returned from the API or forwarded to the broker
And a log entry is written at WARNING level containing the actual confidence value (60)
```

### AC2: Signal at Exactly 70% Passes
```gherkin
Given a signal where the computed confidence after all penalties is exactly 70
When signal emission is attempted
Then the signal is not rejected by the confidence floor check
And is returned or forwarded normally
```

### AC3: Rejection Log Includes Confidence Breakdown
```gherkin
Given a rejected signal with confidence = 60
When the rejection log entry is written
Then it includes: pattern_type, computed_confidence (60), and which component(s) contributed to the low score
And the message is specific enough for a developer to trace the penalty chain
```

### AC4: Floor Applied After All Penalties
```gherkin
Given an SOS signal that starts with base confidence = 85 and receives a session penalty of -25
When the confidence floor check runs
Then it evaluates the post-penalty confidence of 60 (not the pre-penalty base of 85)
And the signal is rejected
```

### AC5: Arbitrary Fallback Confidence Removed
```gherkin
Given a pattern where volume_ratio is not available
When confidence is computed
Then the system does not default to 75 as a passing confidence
And either the signal is rejected due to insufficient confidence evidence
Or the confidence is derived from the available non-volume data with a comment explaining the derivation
And no literal value of 75 appears as a hardcoded fallback in the confidence computation
```

## Tasks / Subtasks

- [ ] **Task 1**: Read the confidence calculation and emission path
  - [ ] Read `backend/src/orchestrator/orchestrator_facade.py` lines 237–256 — confidence calculation
  - [ ] Read lines 247 — confirm hardcoded fallback of 75
  - [ ] Read `backend/src/pattern_engine/detectors/sos_detector.py` line 567 — session penalty (-25)
  - [ ] Identify exact location in emission path where floor check should be inserted

- [ ] **Task 2**: Add confidence floor guard
  - [ ] Define `CONFIDENCE_FLOOR = 70` as a named constant (not a literal)
  - [ ] Insert guard check in signal emission path: `if signal.confidence < CONFIDENCE_FLOOR: reject`
  - [ ] Confirm guard is placed after all penalties are applied

- [ ] **Task 3**: Improve rejection log message
  - [ ] Include `pattern_type`, `computed_confidence`, and penalty breakdown in the log
  - [ ] Log at WARNING level

- [ ] **Task 4**: Remove arbitrary fallback confidence
  - [ ] Read all code paths that set confidence when volume_ratio is unavailable
  - [ ] Replace hardcoded 75 fallback with either: explicit rejection, or confidence from non-volume signals with a documented basis
  - [ ] Add a comment explaining the chosen approach

- [ ] **Task 5**: Write unit tests
  - [ ] Test: confidence=60 → rejected, log contains "60"
  - [ ] Test: confidence=70 → not rejected
  - [ ] Test: confidence=69 → rejected
  - [ ] Test: post-penalty check — base=85, penalty=-25, floor checked at 60 (rejected)
  - [ ] Test: no volume_ratio → signal rejected or confidence derived from data (not defaulted to 75)

- [ ] **Task 6**: Run quality gates
  - [ ] `ruff check` + `ruff format`
  - [ ] `mypy src/`
  - [ ] `pytest tests/ -x --cov`

## Dev Notes

### Key Files to Modify
- `backend/src/orchestrator/orchestrator_facade.py` — add confidence floor guard in signal emission path and remove arbitrary fallback at line 247

### Key Files to Reference (read-only)
- `backend/src/orchestrator/orchestrator_facade.py` lines 237–256 — confidence calculation section
- `backend/src/pattern_engine/detectors/sos_detector.py` line 567 — session penalty that causes SOS ASIAN to drop to 60

### Approach
Read the confidence calculation section and the emission path in full before making any change. Identify the exact line where the signal is returned or forwarded. Insert the guard immediately before that line. Use a named constant for 70 — do not use a literal. For the fallback confidence issue: if no principled derivation exists for volume-absent signals, the correct choice is rejection, not an arbitrary passing value.

## Testing

### Test File Location
`backend/tests/unit/orchestrator/test_confidence_floor.py`

### Testing Framework
pytest 8.0+ with pytest-asyncio

### Test Requirements
1. Parametrized test: confidence values [50, 60, 69, 70, 71, 85, 100] → expected REJECTED/PASSED
2. Unit test: rejection log for confidence=60 contains pattern_type and computed_confidence
3. Unit test: base=85 + penalty=-25 → floor checked at 60, not 85 (penalty applied first)
4. Unit test: no volume_ratio → signal does not receive hardcoded 75 confidence
5. 90%+ coverage on modified confidence and emission code paths

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|

## Review
- William (Wyckoff Mentor) — Verify the 70% confidence floor aligns with Wyckoff strategy requirements and that the floor does not inadvertently reject valid low-volatility signals
- Victoria (Volume Analyst) — Verify volume contribution to confidence is computed before the floor check and that removing the arbitrary fallback does not hide volume data issues
