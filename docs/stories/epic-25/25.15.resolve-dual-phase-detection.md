# Story 25.15: Resolve Dual Phase Detection Systems

## Status
Done

## Story
**As a** developer,
**I want** a single authoritative phase detection entry point and the removal of the legacy phase detector files,
**So that** 25.8 (phase validator) and the orchestrator pipeline both use the same, confirmed-complete classifier without ambiguity about which system is active.

## INVEST Checklist
| Criteria | Status | Notes |
|----------|--------|-------|
| Independent | ✅ | Cleanup story; no cross-story dependencies to start |
| Negotiable | ✅ | Deletion vs. deprecation decided: delete outright |
| Valuable | ✅ | Dual systems cause confusion and risk; 25.8 cannot safely rely on the classifier until this is resolved |
| Estimable | ✅ | Bounded to reading, confirming completeness, deleting legacy files, updating imports |
| Small | ✅ | 3 points — read + confirm + delete + fix imports |
| Testable | ✅ | All existing tests pass after deletion; no import errors |

## Story Points
3

## Priority
P0 Critical

## Type
Cleanup / Bug Fix

## Dependencies
None

## Background

Two parallel phase detection systems exist in the codebase:

**Legacy system**:
- `backend/src/pattern_engine/phase_detector.py`
- `backend/src/pattern_engine/phase_detector_v2.py`

**New system** (Epic 22 modularization):
- `backend/src/pattern_engine/phase_detection/phase_classifier.py` (facade)
- `backend/src/pattern_engine/phase_detection/event_detectors.py`
- `backend/src/pattern_engine/phase_detection/types.py`

The new system's `event_detectors.py` docstring was flagged in the Live Signal Readiness Assessment as reading "not yet complete." This must be verified before 25.8 (Phase Validator) is implemented, because 25.8 depends on `PhaseResult` objects produced by the classifier. If the classifier is incomplete, 25.8 tests will pass against a non-functional system.

**Decision**: Delete legacy files outright. No deprecation facades.

## Acceptance Criteria

### AC1: event_detectors.py Completeness Confirmed
```gherkin
Given the current state of backend/src/pattern_engine/phase_detection/event_detectors.py
When a developer reads the file in full
Then all public methods are implemented (no NotImplementedError, no pass-only bodies)
And if any method is incomplete, a separate task is created to complete it before this story closes
```

### AC2: Legacy Files Deleted
```gherkin
Given the legacy files phase_detector.py and phase_detector_v2.py exist
When this story is complete
Then both files are deleted from the repository
And no import of PhaseDetector, PhaseDetectorV2, or their module paths exists in any source file
```

### AC3: All Imports Updated
```gherkin
Given any file that previously imported from phase_detector or phase_detector_v2
When this story is complete
Then all such imports are updated to import from phase_detection.phase_classifier or phase_detection.types
And no ImportError is raised on application startup
```

### AC4: All Tests Pass After Deletion
```gherkin
Given the full test suite
When pytest is run after the legacy files are deleted
Then all previously passing tests continue to pass
And no test imports from the deleted modules
```

### AC5: Single Entry Point Documented
```gherkin
Given a developer looking for the phase detection entry point
When they read the phase_detection package __init__.py
Then they find a clear export of the authoritative classifier class
And a comment or docstring indicates this is the single entry point for phase detection
```

## Tasks / Subtasks

- [ ] **Task 1**: Read and assess all five files
  - [ ] Read `backend/src/pattern_engine/phase_detector.py` — document its public API
  - [ ] Read `backend/src/pattern_engine/phase_detector_v2.py` — document its public API
  - [ ] Read `backend/src/pattern_engine/phase_detection/phase_classifier.py` — confirm it covers the legacy API
  - [ ] Read `backend/src/pattern_engine/phase_detection/event_detectors.py` — confirm ALL methods are fully implemented (not stubs)
  - [ ] Read `backend/src/pattern_engine/phase_detection/types.py` — confirm PhaseResult and WyckoffPhase enum are complete

- [ ] **Task 2**: If event_detectors.py has incomplete methods
  - [ ] Complete each incomplete method (implement or raise NotImplementedError with explicit TODO tracking)
  - [ ] Run existing phase detection tests to confirm correct behavior
  - [ ] If scope exceeds 1–2 methods, flag to PO before continuing — story may need to be split

- [ ] **Task 3**: Find all import sites of legacy modules
  - [ ] Search codebase for `from.*phase_detector import` and `import.*phase_detector`
  - [ ] List every file that imports from the legacy modules
  - [ ] Update each import to use the new `phase_detection` package

- [ ] **Task 4**: Delete legacy files
  - [ ] Delete `backend/src/pattern_engine/phase_detector.py`
  - [ ] Delete `backend/src/pattern_engine/phase_detector_v2.py`
  - [ ] Run `pytest` immediately after deletion to catch any missed import sites

- [ ] **Task 5**: Update `__init__.py`
  - [ ] Update `backend/src/pattern_engine/phase_detection/__init__.py` to clearly export the classifier and types
  - [ ] Add a one-line comment marking this as the single authoritative entry point

- [ ] **Task 6**: Run quality gates
  - [ ] `ruff check` + `ruff format`
  - [ ] `mypy src/`
  - [ ] `pytest tests/ -x --cov`
  - [ ] Confirm zero import errors on `uvicorn src.api.main:app --reload` startup

## Dev Notes

### Key Files to Modify
- `backend/src/pattern_engine/phase_detection/__init__.py` — export authoritative classifier
- Any file importing from legacy phase_detector modules — update imports
- Delete: `backend/src/pattern_engine/phase_detector.py`
- Delete: `backend/src/pattern_engine/phase_detector_v2.py`

### Key Files to Reference (read-only)
- `backend/src/pattern_engine/phase_detection/event_detectors.py` — completeness verification (primary concern)
- `backend/src/pattern_engine/phase_detection/phase_classifier.py` — new facade
- `backend/src/pattern_engine/phase_detection/types.py` — PhaseResult and WyckoffPhase

### Approach
Read all five files before touching any code. The critical question is whether `event_detectors.py` is genuinely complete. If it has stub methods, complete them first before deleting the legacy files (the legacy code may still be referenced). Once confirmed complete, delete the legacy files and fix imports one file at a time, running pytest after each change. Do not batch all import updates — catch failures early.

## Testing

### Test File Location
Existing test files (no new test file required — this story validates via existing tests passing)

### Testing Framework
pytest 8.0+ with pytest-asyncio

### Test Requirements
1. All tests that were passing before this story continue to pass after deletion
2. No `ImportError` on startup
3. `grep` for legacy module names in source files returns zero results
4. `mypy src/` passes with no new errors introduced

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|

## Review
- Philip (Phase Identifier) — Verify the new classifier produces equivalent PhaseResult objects to the legacy detector for the same input bars
- William (Wyckoff Mentor) — Confirm phase transition logic in event_detectors.py matches classical Wyckoff rules before legacy is removed
