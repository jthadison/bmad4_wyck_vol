# Story 25.2: Fix Portfolio Context Wiring in Risk Assessment

## Status
Done

## Story
**As a** developer,
**I want** the portfolio context to be stored in the pipeline context after it is computed,
**So that** the RiskManagerAdapter can access portfolio data and perform real position sizing instead of rejecting every signal.

## INVEST Checklist
| Criteria | Status | Notes |
|----------|--------|-------|
| Independent | ✅ | No dependencies on other Epic 25 stories |
| Negotiable | ✅ | Context key name flexible |
| Valuable | ✅ | Every signal currently rejected — this fix unblocks risk validation |
| Estimable | ✅ | Single missing line of code, clearly identified |
| Small | ✅ | 2 points, one-line fix plus tests |
| Testable | ✅ | Portfolio heat value in output validates fix |

## Story Points
2

## Priority
P0 Critical

## Type
Bug Fix

## Dependencies
None

## Background

In `backend/src/orchestrator/orchestrator_facade.py` around line 754, the call `portfolio_context = await self._portfolio_monitor.build_context()` stores the result in a local variable. The immediately following line `context.set("portfolio_context", portfolio_context)` is missing entirely.

As a result, `_RiskManagerAdapter.apply_sizing()` always finds `portfolio_context is None` and logs "REJECTING signal — cannot validate risk without portfolio/range context" for every signal, regardless of pattern quality or volume confirmation. This means zero signals ever pass the risk stage.

The fix is a single missing line. This story also adds the validation that the correct portfolio heat value flows through to the signal output.

## Acceptance Criteria

### AC1: Portfolio Context Stored in Pipeline Context
```gherkin
Given a pipeline run where build_context() returns a valid PortfolioContext object
When the orchestrator facade executes the portfolio context build step
Then portfolio_context is stored via context.set("portfolio_context", portfolio_context)
And the stored value is accessible downstream via context.get("portfolio_context")
```

### AC2: Risk Validation Passes with Valid Context
```gherkin
Given a valid portfolio context is now stored in the pipeline context
When RiskManagerAdapter.apply_sizing() is called
Then the signal is not rejected with the "missing context" reason
And position sizing is calculated using the real portfolio data
```

### AC3: Empty Portfolio Context Fails Explicitly
```gherkin
Given the database is unavailable and PortfolioMonitor returns an empty/None context
When apply_sizing() is called
Then risk validation fails with a clear, explicit error message
And the failure reason is logged — not silently swallowed
```

### AC4: Portfolio Heat Reflects Real Open Positions
```gherkin
Given 3 open positions each carrying 1% risk (total heat = 3%)
When a new signal is validated through the risk stage
Then the portfolio_heat value in the signal output is 3%
And is not 0% (the value returned when context was missing)
```

## Tasks / Subtasks

- [ ] **Task 1**: Read and confirm the bug
  - [ ] Read `backend/src/orchestrator/orchestrator_facade.py` lines 748–765
  - [ ] Confirm `portfolio_context` is computed but not stored in `context`
  - [ ] Confirm `_RiskManagerAdapter.apply_sizing()` reads from `context.get("portfolio_context")`

- [ ] **Task 2**: Add the missing context.set() call
  - [ ] Add `context.set("portfolio_context", portfolio_context)` immediately after `build_context()` resolves
  - [ ] Confirm the context key matches what `_RiskManagerAdapter` reads

- [ ] **Task 3**: Verify None-context handling
  - [ ] Read `_RiskManagerAdapter.apply_sizing()` to confirm explicit error path exists when context is None
  - [ ] Add explicit error log if None path is silent

- [ ] **Task 4**: Write tests
  - [ ] Unit test: context.set called with correct key after build_context()
  - [ ] Unit test: apply_sizing() returns result (not rejection) given mocked non-None context
  - [ ] Unit test: apply_sizing() logs explicit error when context is None
  - [ ] Integration test: 3 mock positions → portfolio_heat=3% in signal output

- [ ] **Task 5**: Run quality gates
  - [ ] `ruff check` + `ruff format`
  - [ ] `mypy src/`
  - [ ] `pytest tests/ -x --cov`

## Dev Notes

### Key Files to Modify
- `backend/src/orchestrator/orchestrator_facade.py` — add `context.set("portfolio_context", portfolio_context)` after `build_context()` call (approximately line 755)

### Key Files to Reference (read-only)
- `backend/src/orchestrator/orchestrator_facade.py` (lines 750–760) — exact location of the bug
- `backend/src/risk_management/portfolio_heat_tracker.py` — PortfolioContext structure

### Approach
Read the exact lines surrounding the bug before making any change. Add the single missing `context.set()` line. Do not restructure the surrounding logic. After the fix, run existing tests to confirm no regressions. Then write the new tests listed above.

## Testing

### Test File Location
`backend/tests/unit/orchestrator/test_orchestrator_facade.py`

### Testing Framework
pytest 8.0+ with pytest-asyncio

### Test Requirements
1. Unit test confirms `context.set("portfolio_context", ...)` is called after `build_context()`
2. Unit test confirms `apply_sizing()` does not reject when context is a valid mock object
3. Unit test confirms explicit error log when context is None
4. Integration test with 3 mocked positions confirms portfolio_heat = 3% in signal

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|

## Review
- Rachel (Risk Manager) — Verify position sizing correctness using the now-available portfolio context
- Conrad (Campaign Manager) — Verify campaign context is also available in the pipeline context and not affected by this change
