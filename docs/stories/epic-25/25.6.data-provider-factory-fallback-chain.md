# Story 25.6: Data Provider Factory with Fallback Chain

## Status
Done

## Story
**As a** developer,
**I want** a centralized data provider factory that selects providers based on configuration and implements a fallback chain,
**So that** the system does not depend on a single hardcoded provider and can degrade gracefully when Alpaca is unavailable.

## INVEST Checklist
| Criteria | Status | Notes |
|----------|--------|-------|
| Independent | ⚠️ | Depends on 25.5 (ingest must work to validate factory end-to-end) |
| Negotiable | ✅ | Factory pattern and fallback strategy flexible |
| Valuable | ✅ | Three hardcoded providers in three separate files creates maintenance risk and silent failures |
| Estimable | ✅ | Scope bounded to factory creation and three call-site refactors |
| Small | ⚠️ | 5 points — factory + fail-fast + 3 call sites + tests |
| Testable | ✅ | Each AC has a specific testable outcome |

## Story Points
5

## Priority
P0 Critical

## Type
Feature

## Dependencies
Story 25.5 — data ingestion must work to validate the provider factory end-to-end

## Background

Market data providers are hardcoded in three separate places:
- `backend/src/api/main.py` hardcodes `AlpacaAdapter`
- `backend/src/api/routes/backtest/utils.py` hardcodes `PolygonAdapter`
- `backend/src/api/routes/scanner.py` hardcodes `YahooAdapter`

No `DataProviderFactory` exists. This means changing providers requires editing three files, provider selection cannot be driven by configuration, and there is no graceful fallback when a provider is down.

Additionally, Polygon and Yahoo adapters raise `NotImplementedError` for all real-time methods (`connect`, `subscribe`, `on_bar_received`). Only Alpaca can stream live data. The system currently does not enforce this — it is possible to configure Polygon as the live provider and receive a runtime error mid-session rather than a startup failure.

The silent synthetic data fallback (present in at least one code path) must be removed. When all providers fail for historical data, the correct behavior is an explicit error, not silently returning fabricated bars that would corrupt pattern detection.

## Acceptance Criteria

### AC1: Factory Creates Correct Provider from Configuration
```gherkin
Given DEFAULT_PROVIDER=polygon set in the environment configuration
When MarketDataProviderFactory.get_historical_provider() is called
Then a PolygonAdapter instance is returned
And no other adapter is instantiated
```

### AC2: Historical Fallback Chain Works
```gherkin
Given Polygon fails with a rate limit error (HTTP 429)
When historical data is requested through the factory
Then the factory automatically retries using YahooAdapter as the fallback
And the result from Yahoo is returned to the caller
And a WARNING is logged noting the Polygon failure and Yahoo fallback
```

### AC3: Historical Fallback Never Returns Synthetic Data
```gherkin
Given both Polygon and Yahoo fail when historical data is requested
When the factory exhausts all fallback providers
Then an explicit DataProviderError exception is raised with a message listing which providers were tried
And no synthetic or placeholder OHLCV bars are returned
```

### AC4: Startup Fails Fast When Alpaca Unavailable in Live Mode
```gherkin
Given AUTO_EXECUTE_ORDERS=true in the environment configuration
And ALPACA_API_KEY or ALPACA_SECRET_KEY is not set or invalid
When the API server starts
Then startup fails immediately before accepting connections
And the error message lists exactly which Alpaca credentials are missing
And the message instructs the operator how to set them
```

### AC5: Provider Selection Centralized — No Direct Instantiation Outside Factory
```gherkin
Given the refactored codebase
When a search is performed for AlpacaAdapter(), PolygonAdapter(), or YahooAdapter() outside of factory.py
Then no direct instantiation is found in main.py, backtest/utils.py, or scanner.py
And all provider selection routes through MarketDataProviderFactory
```

### AC6: Real-Time Streaming Only Available via Alpaca
```gherkin
Given code that calls MarketDataProviderFactory.get_streaming_provider()
When Alpaca keys are not configured
Then a ConfigurationError is raised immediately
And the error message lists the required environment variable names (ALPACA_API_KEY, ALPACA_SECRET_KEY)
```

## Tasks / Subtasks

- [ ] **Task 1**: Read all three hardcoded call sites
  - [ ] Read `backend/src/api/main.py` — find AlpacaAdapter instantiation
  - [ ] Read `backend/src/api/routes/backtest/utils.py` — find PolygonAdapter instantiation
  - [ ] Read `backend/src/api/routes/scanner.py` — find YahooAdapter instantiation

- [ ] **Task 2**: Read existing adapter interfaces
  - [ ] Read `backend/src/market_data/adapters/polygon_adapter.py`
  - [ ] Read `backend/src/market_data/adapters/alpaca_adapter.py`
  - [ ] Read `backend/src/market_data/adapters/yahoo_adapter.py`
  - [ ] Read `backend/src/config.py` — find existing provider config keys

- [ ] **Task 3**: Create MarketDataProviderFactory
  - [ ] Create `backend/src/market_data/factory.py`
  - [ ] Implement `get_historical_provider() -> BaseDataAdapter` with config-driven selection
  - [ ] Implement `get_streaming_provider() -> BaseDataAdapter` with Alpaca-only enforcement
  - [ ] Implement `fetch_historical_with_fallback(symbol, timeframe, start, end)` with Polygon → Yahoo → error chain

- [ ] **Task 4**: Remove synthetic data fallback
  - [ ] Search codebase for synthetic data generation or placeholder bar creation
  - [ ] Replace with explicit error raises
  - [ ] Document each removal in commit message

- [ ] **Task 5**: Add startup fail-fast for Alpaca
  - [ ] Add startup check in `main.py`: if AUTO_EXECUTE_ORDERS=true, verify Alpaca credentials
  - [ ] Raise startup error with actionable message if credentials missing

- [ ] **Task 6**: Refactor call sites to use factory
  - [ ] Replace `AlpacaAdapter()` in `main.py` with `MarketDataProviderFactory.get_streaming_provider()`
  - [ ] Replace `PolygonAdapter()` in `backtest/utils.py` with `MarketDataProviderFactory.get_historical_provider()`
  - [ ] Replace `YahooAdapter()` in `scanner.py` with `MarketDataProviderFactory.get_historical_provider()`

- [ ] **Task 7**: Write tests
  - [ ] Unit test: DEFAULT_PROVIDER=polygon → PolygonAdapter returned
  - [ ] Unit test: Polygon fails → Yahoo fallback used → result returned
  - [ ] Unit test: both fail → DataProviderError raised, no synthetic data
  - [ ] Unit test: AUTO_EXECUTE_ORDERS=true + no Alpaca keys → startup error
  - [ ] Unit test: get_streaming_provider() without Alpaca keys → ConfigurationError

- [ ] **Task 8**: Run quality gates
  - [ ] `ruff check` + `ruff format`
  - [ ] `mypy src/`
  - [ ] `pytest tests/ -x --cov`

## Dev Notes

### Key Files to Modify
- `backend/src/market_data/factory.py` — new file, centralized factory
- `backend/src/api/main.py` — remove hardcoded AlpacaAdapter, use factory + add startup check
- `backend/src/api/routes/backtest/utils.py` — remove hardcoded PolygonAdapter, use factory
- `backend/src/api/routes/scanner.py` — remove hardcoded YahooAdapter, use factory

### Key Files to Reference (read-only)
- `backend/src/market_data/adapters/polygon_adapter.py`
- `backend/src/market_data/adapters/alpaca_adapter.py`
- `backend/src/market_data/adapters/yahoo_adapter.py`
- `backend/src/config.py` — existing config structure for adding new keys

### Approach
Read all three hardcoded call sites first. Read the adapter interfaces to understand the shared base class or protocol. Create the factory as a single class with two public methods: `get_historical_provider()` and `get_streaming_provider()`. The fallback chain lives in a private method. Refactor the three call sites last, one at a time, running tests after each change. Do not change adapter internal logic — the factory only selects and instantiates adapters.

## Testing

### Test File Location
`backend/tests/unit/market_data/test_provider_factory.py`

### Testing Framework
pytest 8.0+ with pytest-asyncio

### Test Requirements
1. Parametrized test: each DEFAULT_PROVIDER value → expected adapter type returned
2. Unit test: Polygon error → Yahoo fallback → result returned (mock both adapters)
3. Unit test: both adapters fail → DataProviderError raised
4. Unit test: synthetic data path removed — assert no placeholder bars in any error path
5. Unit test: startup check raises with correct message when Alpaca keys missing
6. 90%+ coverage on factory.py

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|

## Review
- Wayne (Entry Analyst) — Verify data quality from each provider does not affect entry price accuracy
- Conrad (Campaign Manager) — Verify provider selection does not affect campaign state or introduce data inconsistency between live and historical feeds
