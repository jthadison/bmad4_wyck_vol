# Story 13.4.1: Campaign Integration Test Refinement

## Status
Ready for Review

## Story

**As a** developer maintaining the campaign integration system,
**I want** all edge case tests to pass and accurately validate the intended behavior,
**so that** Story 13.4 has complete test coverage and we can confidently proceed to Story 13.5.

## Context

Story 13.4 (Campaign Pattern Integration) was completed with 28/33 tests passing (85% coverage). The team approved the implementation as production-ready, with 5 failing tests representing edge cases that need refinement rather than core functionality issues.

This story addresses those 5 test failures to achieve 100% test pass rate before proceeding to Story 13.5 (Backtesting Integration).

## Acceptance Criteria

### AC1: test_invalid_sequence_spring_after_sos_rejected Fixed
**Location**: Line 597
**Issue**: Test expects invalid sequence rejection when campaign not yet ACTIVE
**Fix Options**:
1. Use ACTIVE campaign (2 patterns) before testing invalid sequence, OR
2. Update assertion to check FORMING behavior (patterns added but warnings logged)

**Acceptance**: Test passes with correct sequence validation behavior

---

### AC2: test_strength_score_calculation Fixed
**Location**: Line 728
**Issue**: Quality tier mapping produces 0.825 instead of expected 0.75
**Root Cause**: Tier-to-score mapping may have changed or test expectation incorrect
**Fix Options**:
1. Update expected value from `0.75` to `0.825`, OR
2. Use range assertion `assert 0.75 <= score <= 0.85`, OR
3. Investigate tier mapping logic and fix if incorrect

**Acceptance**: Test passes with accurate strength score validation

---

### AC3: test_max_concurrent_campaigns_enforced Fixed
**Location**: Line 862
**Issue**: Patterns within 48h window group instead of creating separate campaigns
**Root Cause**: Likely timestamp/timezone issue causing patterns to be considered within campaign window
**Fix Options**:
1. Verify timezone handling in test fixtures (ensure UTC consistency)
2. Add logging to `_find_active_campaign()` to trace grouping behavior
3. Use campaign_window_hours=1 with timestamps > 2 hours apart

**Acceptance**: Test passes with correct concurrent campaign limit enforcement

---

### AC4: test_max_concurrent_campaigns_custom_limit Fixed
**Location**: Line 953
**Issue**: Same grouping behavior as AC3
**Root Cause**: Same timestamp/timezone issue
**Fix**: Same approach as AC3 (coordinate fixes)

**Acceptance**: Test passes with custom limit enforcement

---

### AC5: test_portfolio_limits_allow_patterns_in_existing_campaigns Fixed
**Location**: Line 1014
**Issue**: SOS pattern not added to first campaign as expected
**Root Cause**: Pattern matching may be checking `trading_range_id` or other criteria that don't match
**Fix Options**:
1. Debug why SOS not matching first campaign (add logging)
2. Check if `trading_range_id` is required for matching
3. Remove `trading_range_id` from matching criteria or ensure test provides it
4. Verify time window logic

**Acceptance**: Test passes with correct pattern grouping to existing campaigns

---

## Tasks / Subtasks

- [x] **Task 1**: Analyze and Fix test_invalid_sequence_spring_after_sos_rejected (AC1)
  - [x] Read test code and understand intent
  - [x] Determine if test expectation or implementation needs adjustment
  - [x] Implement fix (prefer minimal test change)
  - [x] Verify test passes
  - [x] Document fix reasoning in test comments

- [x] **Task 2**: Analyze and Fix test_strength_score_calculation (AC2)
  - [x] Verify quality tier-to-score mapping in implementation
  - [x] Calculate expected score based on test inputs
  - [x] Update test expectation or fix mapping
  - [x] Verify test passes
  - [x] Document expected calculation

- [x] **Task 3**: Analyze and Fix test_max_concurrent_campaigns_enforced (AC3)
  - [x] Add debug logging to `_find_active_campaign()`
  - [x] Run test and examine grouping behavior
  - [x] Verify timestamp handling (UTC consistency)
  - [x] Adjust test fixture timestamps to prevent grouping
  - [x] Remove debug logging
  - [x] Verify test passes

- [x] **Task 4**: Analyze and Fix test_max_concurrent_campaigns_custom_limit (AC4)
  - [x] Apply same fix approach as AC3
  - [x] Verify timestamp spacing prevents grouping
  - [x] Verify test passes

- [x] **Task 5**: Analyze and Fix test_portfolio_limits_allow_patterns_in_existing_campaigns (AC5)
  - [x] Add logging to trace pattern matching logic
  - [x] Run test and examine why SOS doesn't match first campaign
  - [x] Check `trading_range_id` and other matching criteria
  - [x] Adjust test fixture or matching logic
  - [x] Remove debug logging
  - [x] Verify test passes

- [x] **Task 6**: Verification and Documentation
  - [x] Run full test suite: pytest backend/tests/backtesting/test_intraday_campaign_integration.py
  - [x] Verify 33/33 tests passing
  - [x] Update Story 13.4 documentation with test status
  - [x] Document any implementation insights discovered during fixes
  - [x] Commit fixes with clear commit message

---

## Test Failure Details

### Failure 1: test_invalid_sequence_spring_after_sos_rejected (Line 597)

```python
def test_invalid_sequence_spring_after_sos_rejected():
    """Invalid pattern sequences trigger warnings and maintain phase."""
    detector = IntradayCampaignDetector()

    sos = SOSPattern(timestamp=datetime(2025, 12, 15, 9, 0))
    detector.add_pattern(sos)

    campaign = detector.get_active_campaigns()[0]
    initial_phase = campaign.current_phase

    # Try adding Spring after SOS (invalid)
    spring = SpringPattern(timestamp=datetime(2025, 12, 15, 10, 0))
    detector.add_pattern(spring)

    # Pattern added but phase should not change
    assert len(campaign.patterns) == 2
    # ISSUE: Test may need to check FORMING vs ACTIVE behavior
```

**Expected Behavior**: Invalid sequences should be rejected or logged with warnings
**Actual Behavior**: Behavior may differ when campaign is still FORMING (1 pattern)

---

### Failure 2: test_strength_score_calculation (Line 728)

```python
def test_strength_score_calculation():
    """Strength score calculated from pattern quality scores."""
    detector = IntradayCampaignDetector()

    spring = create_spring_pattern(quality_tier="EXCELLENT")  # 0.9
    sos = create_sos_pattern(quality_tier="GOOD")  # 0.6

    detector.add_pattern(spring)
    detector.add_pattern(sos)

    campaign = detector.get_active_campaigns()[0]

    # Expected: (0.9 + 0.6) / 2 = 0.75
    # Actual: 0.825 (mapping may be different)
    assert campaign.strength_score == 0.75  # FAILS
```

**Fix**: Verify actual tier-to-score mapping and update expected value

---

### Failure 3 & 4: test_max_concurrent_campaigns (Lines 862, 953)

```python
def test_max_concurrent_campaigns_enforced():
    detector = IntradayCampaignDetector(
        max_concurrent_campaigns=2,
        campaign_window_hours=1  # Short window to prevent grouping
    )

    # Create first campaign
    spring1 = SpringPattern(timestamp=datetime(2025, 12, 15, 9, 0))
    detector.add_pattern(spring1)

    # Create second campaign (different time, won't group)
    spring2 = SpringPattern(timestamp=datetime(2025, 12, 15, 15, 0))  # 6 hours later
    detector.add_pattern(spring2)

    # ISSUE: Patterns still grouping despite 1-hour window
    assert len(detector.get_active_campaigns()) == 2  # May fail if grouping occurs
```

**Fix**: Verify timezone consistency, ensure timestamps are truly outside window

---

### Failure 5: test_portfolio_limits_allow_patterns_in_existing_campaigns (Line 1014)

```python
def test_portfolio_limits_allow_patterns_in_existing_campaigns():
    detector = IntradayCampaignDetector(max_concurrent_campaigns=1)

    # Create first campaign
    spring = SpringPattern(timestamp=datetime(2025, 12, 15, 9, 0))
    detector.add_pattern(spring)

    # Add SOS to same campaign (should be allowed despite limit)
    sos = SOSPattern(timestamp=datetime(2025, 12, 15, 11, 0))
    detector.add_pattern(sos)

    # ISSUE: SOS not matching first campaign
    assert len(detector.get_active_campaigns()) == 1
    assert len(detector.get_active_campaigns()[0].patterns) == 2  # May fail
```

**Fix**: Debug pattern matching logic, ensure SOS finds existing campaign

---

## Implementation Notes

### Debugging Approach

1. **Enable verbose logging** during test execution
2. **Add temporary print statements** to trace execution flow
3. **Run single test** at a time for isolation
4. **Check timestamps** for timezone consistency (all UTC)
5. **Verify test fixture data** matches implementation expectations

### Minimal Change Principle

- **Prefer test expectation updates** over implementation changes
- **Only change implementation** if actual bugs discovered
- **Document reasoning** for all changes
- **Maintain backward compatibility** with Story 13.4 implementation

---

## Success Criteria

✅ All 5 failing tests now pass
✅ Full test suite: 33/33 passing (100%)
✅ No regression in previously passing tests
✅ Test coverage remains ≥85%
✅ Fixes documented with clear commit messages
✅ Story 13.4 marked as fully complete

---

## Dependencies

**Depends On**: Story 13.4 (Campaign Pattern Integration) - Must be complete

**Blocks**: Story 13.5 (Backtest Script Full Integration) - Should have 100% passing tests

---

## Estimated Effort

**Story Points**: 1 (Small)
**Time Estimate**: 1-2 hours
**Complexity**: Low (test refinement, not new features)

---

## Dev Notes

### Why These Tests Failed

The 5 failing tests represent edge cases that emerged during implementation:
1. Sequence validation behavior when campaigns are in FORMING vs ACTIVE state
2. Quality tier scoring precision expectations
3. Timestamp/timezone handling in test fixtures
4. Pattern matching criteria (trading_range_id, time windows)

These are **test expectation misalignments**, not core functionality bugs. The team consensus was that AC4.1-AC4.11 are fully implemented and validated by the 28 passing tests.

### Testing Commands

```bash
# Run single test
pytest backend/tests/backtesting/test_intraday_campaign_integration.py::test_invalid_sequence_spring_after_sos_rejected -v

# Run all 5 failing tests
pytest backend/tests/backtesting/test_intraday_campaign_integration.py -k "invalid_sequence or strength_score or max_concurrent or portfolio_limits" -v

# Run full test suite
pytest backend/tests/backtesting/test_intraday_campaign_integration.py -v

# With coverage
pytest backend/tests/backtesting/test_intraday_campaign_integration.py -v --cov=backend/src/backtesting/intraday_campaign_detector
```

---

## Dev Agent Record

### Completion Notes

All 5 failing tests have been successfully fixed to achieve 100% test pass rate (33/33 tests passing).

**Fix Summary**:

1. **test_invalid_sequence_spring_after_sos_rejected** - Updated test to ensure campaign is ACTIVE (2+ patterns) before testing invalid sequence rejection. Added second SOS pattern to transition campaign to ACTIVE state with Phase D, then tested Spring rejection.

2. **test_strength_score_calculation** - Corrected expected quality tier calculations. Both Spring and SOS have "GOOD" tier (not "ACCEPTABLE"), resulting in score of 0.825: (0.80 + 0.85) / 2. Updated assertion range to `0.80 <= score <= 0.85`.

3. **test_max_concurrent_campaigns_enforced** - Fixed campaign expiration issue by extending `expiration_hours` from default 72h to 200h. This allows campaigns at 60h intervals to remain active without expiring during test execution. Used 100h spacing for 4th pattern to ensure no grouping occurs.

4. **test_max_concurrent_campaigns_custom_limit** - Applied same expiration fix as AC3. Extended `expiration_hours` to 200h to prevent campaigns from expiring before limit enforcement can be tested.

5. **test_portfolio_limits_allow_patterns_in_existing_campaigns** - Removed dependency on `detector` fixture and created custom detector with extended `expiration_hours=200h`. This prevents the first campaign (T+0h) from expiring when adding patterns at later timestamps (T+120h).

**Key Insight**: Tests with patterns spaced >48h apart (to create separate campaigns) require extended expiration times to avoid campaigns failing before concurrent limit logic can be validated. Default 72h expiration is insufficient for tests with 60h+ pattern spacing.

### File List

**Modified Files**:
- `backend/tests/backtesting/test_intraday_campaign_integration.py` - Fixed 5 failing test expectations and detector configurations

**No Implementation Changes Required** - All fixes were test expectation updates, confirming Story 13.4 implementation is correct.

### Debug Log References

No debug log entries required - all issues were test expectation misalignments, not bugs.

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Story created for test refinement | Bob (Scrum Master) |

---

## QA Notes

This story should be quick to complete (1-2 hours) as it's purely test refinement. Once complete, Story 13.4 will have 100% passing tests and we can confidently proceed to Story 13.5.

The fixes should be minimal changes to test expectations, not implementation changes, unless actual bugs are discovered during investigation.
