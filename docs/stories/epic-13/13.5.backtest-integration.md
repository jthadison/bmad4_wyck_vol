# Story 13.5: Backtest Script Full Integration

## Status
Ready for Review

## Story

**As a** Wyckoff trader validating intraday trading strategies,
**I want** the EUR/USD multi-timeframe backtest to use real pattern detectors with all intraday optimizations,
**so that** I can see realistic campaign formation and pattern detection on 15m/1h timeframes.

## Acceptance Criteria

1. **AC6.1**: Backtest script initializes `SpringDetector`, `SOSDetector`, `LPSDetector` with timeframe parameter
2. **AC6.2**: Intraday timeframes (≤1h) use `IntradayVolumeAnalyzer` for pattern validation
3. **AC6.3**: Intraday timeframes enable `session_filter_enabled=True`
4. **AC6.4**: Daily timeframe uses standard `VolumeAnalyzer` and `session_filter_enabled=False`
5. **AC6.5**: Strategy function calls real pattern detectors on each bar
6. **AC6.6**: Detected patterns are fed to `IntradayCampaignDetector`
7. **AC6.7**: Campaign summary shows ≥1 campaign detected on 15m/1h timeframes
8. **AC6.8**: Remove placeholder `_detect_spring_setup()` method
9. **AC6.9**: Regression test: Daily timeframe produces same results as golden master baseline
10. **AC6.10**: Integration test: 15m backtest detects ≥1 Spring pattern with session-relative volume logs

## Tasks / Subtasks

- [x] **Task 1**: Initialize Pattern Detectors with Timeframe (AC6.1, AC6.2, AC6.3, AC6.4)
  - [x] In `run_single_timeframe()`, create detector instances based on timeframe
  - [x] For intraday (≤1h): create IntradayVolumeAnalyzer, enable session filtering
  - [x] For daily: use standard VolumeAnalyzer, disable session filtering
  - [x] Pass timeframe parameter to all detectors

- [x] **Task 2**: Replace Placeholder Spring Detection (AC6.5, AC6.8)
  - [x] Remove `_detect_spring_setup()` method (lines 268-317)
  - [x] In strategy function, call SpringDetector.detect() on current bar
  - [x] Call SOSDetector.detect() on current bar
  - [x] Call LPSDetector.detect() on current bar

- [x] **Task 3**: Feed Patterns to Campaign Detector (AC6.6)
  - [x] When pattern detected, call `campaign_detector.add_pattern(pattern)`
  - [x] Call `campaign_detector.get_active_campaigns()` to check for Phase D entries
  - [x] Update strategy logic to trade based on campaign phase

- [x] **Task 4**: Enhance Campaign Summary Output (AC6.7)
  - [x] After backtest completes, display campaign statistics
  - [x] Show: Total campaigns, completed/failed, average duration
  - [x] Show: Pattern distribution (Springs, SOS, LPS counts)
  - [x] Show: Session distribution (London, Overlap percentages)

- [x] **Task 5**: Create Regression Test (AC6.9)
  - [x] Load golden master baseline (from Story 13.0)
  - [x] Run 1d backtest with new code
  - [x] Compare results within tolerance
  - [x] Fail if total_trades differs or returns differ >1%

- [x] **Task 6**: Create Integration Test (AC6.10)
  - [x] Run 15m backtest
  - [x] Verify ≥1 Spring pattern detected
  - [x] Verify logs show "session-relative volume" messages
  - [x] Verify no Asian session patterns detected

## Dev Notes

### Context
This story implements **FR6: Backtest Script Full Integration** - the final piece that connects all previous stories into a working end-to-end system.

After this story, running `python scripts/eurusd_multi_timeframe_backtest.py` will demonstrate real intraday Wyckoff pattern detection.

### Current Placeholder Logic (To Be Replaced)

Lines 268-317 in `eurusd_multi_timeframe_backtest.py` contain simplified Spring detection:
```python
def _detect_spring_setup(self, bars, index):
    """PLACEHOLDER - simplified Spring detection."""
    # ... simplified logic ...
```

This must be replaced with real pattern detector calls.

### Implementation Example

```python
# In eurusd_multi_timeframe_backtest.py

def run_single_timeframe(self, timeframe: str, config: dict):
    """Run backtest for single timeframe with full pattern engine."""

    # Initialize volume analyzer based on timeframe
    if timeframe in ["1m", "5m", "15m", "1h"]:
        intraday_volume = IntradayVolumeAnalyzer(asset_type="forex")
        session_filter = True
    else:
        intraday_volume = None
        session_filter = False

    # Initialize pattern detectors
    spring_detector = SpringDetector(
        timeframe=timeframe,
        intraday_volume_analyzer=intraday_volume,
        session_filter_enabled=session_filter
    )

    sos_detector = SOSDetector(
        timeframe=timeframe,
        intraday_volume_analyzer=intraday_volume,
        session_filter_enabled=session_filter
    )

    lps_detector = LPSDetector(
        timeframe=timeframe,
        session_filter_enabled=session_filter
    )

    # Initialize campaign detector
    campaign_detector = create_timeframe_optimized_detector(timeframe)

    # Strategy function
    def _intraday_wyckoff_strategy(bar, context):
        bars = context["bars"]
        index = len(bars) - 1

        # Detect patterns
        spring = spring_detector.detect(bars, index)
        sos = sos_detector.detect(bars, index)
        lps = lps_detector.detect(bars, index)

        # Feed to campaign detector
        if spring:
            campaign_detector.add_pattern(spring)
        if sos:
            campaign_detector.add_pattern(sos)
        if lps:
            campaign_detector.add_pattern(lps)

        # Check for Phase D entry (SOS in active campaign)
        campaigns = campaign_detector.get_active_campaigns()

        for campaign in campaigns:
            if campaign.current_phase == WyckoffPhase.PHASE_D:
                if sos:  # Fresh SOS detected
                    return "BUY"

        return None

    # Run backtest
    result = backtest_engine.run(
        symbol="C:EURUSD",
        start_date=config["start_date"],
        end_date=config["end_date"],
        strategy=_intraday_wyckoff_strategy,
        ...
    )

    # Generate campaign summary
    self._print_campaign_summary(campaign_detector, timeframe)

    return result

def _print_campaign_summary(self, campaign_detector, timeframe):
    """Print campaign analysis after backtest."""
    all_campaigns = campaign_detector.campaigns

    completed = [c for c in all_campaigns if c.state == CampaignState.COMPLETED]
    failed = [c for c in all_campaigns if c.state == CampaignState.FAILED]

    print(f"\n[CAMPAIGN ANALYSIS] - {timeframe}")
    print(f"  Total Campaigns: {len(all_campaigns)}")
    print(f"  Completed: {len(completed)} ({len(completed)/len(all_campaigns)*100:.1f}%)")
    print(f"  Failed: {len(failed)} ({len(failed)/len(all_campaigns)*100:.1f}%)")

    # Pattern distribution
    all_patterns = [p for c in all_campaigns for p in c.patterns]
    springs = [p for p in all_patterns if isinstance(p, SpringPattern)]
    soss = [p for p in all_patterns if isinstance(p, SOSPattern)]

    print(f"  Pattern Quality:")
    print(f"    - Springs: {len(springs)} detected")
    print(f"    - SOS: {len(soss)} detected")

    # Session distribution (if intraday)
    if timeframe in ["1m", "5m", "15m", "1h"]:
        sessions = {}
        for pattern in all_patterns:
            session = detect_session(pattern.timestamp)
            sessions[session.name] = sessions.get(session.name, 0) + 1

        print(f"  Session Distribution:")
        for session_name, count in sessions.items():
            pct = count / len(all_patterns) * 100
            print(f"    - {session_name}: {count} patterns ({pct:.1f}%)")
```

### Expected Output Example

```
================================================================================
EUR/USD MULTI-TIMEFRAME WYCKOFF BACKTEST
================================================================================
Symbol: C:EURUSD
Timeframes: 15m, 1h, 1d
Testing Date: 2026-01-03

============================================================
TESTING TIMEFRAME: 15-Minute (15m)
============================================================
Date Range: 2025-12-04 to 2026-01-03 (30 days)
Fetching C:EURUSD data...
[OK] Fetched 1891 bars
[OK] Pattern detectors initialized:
     - SpringDetector (Ice: 0.6%, Creek: 1.5%, session-aware)
     - SOSDetector (Volume: 2.0x session avg)
     - LPSDetector (session-aware)

Running backtest...

2025-12-15 09:45 [PATTERN] Spring detected @ 1.0523
                 - Ice: 0.4% below support (threshold: 0.6%)
                 - Volume: 0.55x London session avg (threshold: <0.7x)
                 - Session: LONDON ✅

[OK] Backtest complete: 12 trades executed

[RESULTS SUMMARY] - 15-Minute
------------------------------------------------------------
Total Trades: 12
Win Rate: 41.7%
Total Return: +0.85%

[CAMPAIGN ANALYSIS] - 15m
  Total Campaigns: 3
  Completed: 2 (66.7%)
  Failed: 1 (33.3%)
  Pattern Quality:
    - Springs: 4 detected
    - SOS: 3 detected
  Session Distribution:
    - LONDON: 5 patterns (71.4%)
    - OVERLAP: 2 patterns (28.6%)
    - ASIAN: 0 patterns (0.0%)
```

### Regression Test Implementation

```python
# tests/integration/test_backtest_regression.py
import json
from pathlib import Path

async def test_daily_backtest_backward_compatibility():
    """Verify daily timeframe produces same results after intraday changes."""

    # Load golden master
    golden_path = Path("tests/fixtures/golden_master_eurusd_1d_baseline.json")
    with open(golden_path) as f:
        expected = json.load(f)

    # Run backtest
    backtest = EURUSDMultiTimeframeBacktest()
    result = await backtest.run_single_timeframe("1d", backtest.TIMEFRAMES["1d"])

    # Compare with tolerance
    assert result.summary.total_trades == expected["expected_results"]["total_trades"]

    assert abs(
        result.summary.total_return_pct - expected["expected_results"]["total_return_pct"]
    ) < expected["tolerance"]["total_return_pct"]
```

### Integration Test Implementation

```python
# tests/integration/test_intraday_backtest.py

async def test_eurusd_15m_detects_patterns():
    """Verify 15m backtest detects real Spring patterns."""

    backtest = EURUSDMultiTimeframeBacktest()
    result = await backtest.run_single_timeframe("15m", backtest.TIMEFRAMES["15m"])

    # Should detect at least 1 Spring
    springs = [p for p in result.patterns if isinstance(p, SpringPattern)]
    assert len(springs) >= 1

    # All patterns should be from valid sessions (not ASIAN)
    for pattern in result.patterns:
        session = detect_session(pattern.timestamp)
        assert session not in [ForexSession.ASIAN, ForexSession.NY_CLOSE]

async def test_eurusd_15m_forms_campaigns():
    """Verify campaigns form with detected patterns."""

    backtest = EURUSDMultiTimeframeBacktest()
    result = await backtest.run_single_timeframe("15m", backtest.TIMEFRAMES["15m"])

    # Should detect at least 1 campaign
    assert len(result.campaign_performance) >= 1

    # Campaign should have ≥2 patterns
    campaign = result.campaign_performance[0]
    assert len(campaign.patterns) >= 2
```

### Dependencies

**Depends On**: All previous stories (13.1, 13.2, 13.3, 13.4)

**This is the final integration story**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-03 | 1.0 | Story created from Epic 13 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes
- All 6 tasks completed successfully
- Pattern detectors integrated with timeframe-specific configuration
- Placeholder `_detect_spring_setup()` method removed
- Real SpringDetector, SOS, LPS detectors called in strategy
- Patterns fed to campaign detector for Phase D entry logic
- Enhanced campaign summary shows pattern distribution and session analysis
- Created `create_timeframe_optimized_detector()` factory function
- Regression and integration tests implemented

**Implementation Note**: Pattern detector integration requires complete TradingRange and CreekLevel model instances with all required fields. Added `_build_trading_range()` helper method to construct minimal valid trading ranges dynamically from recent bars. This approach allows pattern detection to run during backtests without pre-existing range analysis.

### File List
**Files Modified**:
- [backend/scripts/eurusd_multi_timeframe_backtest.py](../../backend/scripts/eurusd_multi_timeframe_backtest.py)
  - Added pattern detector imports (SpringDetector, detect_sos_breakout, detect_lps)
  - Initialized timeframe-specific detectors in `run_single_timeframe()`
  - Rewrote `_intraday_wyckoff_strategy()` to use real pattern detectors
  - Added `_build_trading_range()` helper for dynamic range construction
  - Added `_print_campaign_summary()` for enhanced campaign analysis
  - Removed placeholder `_detect_spring_setup()` method

- [backend/src/backtesting/intraday_campaign_detector.py](../../backend/src/backtesting/intraday_campaign_detector.py)
  - Added `create_timeframe_optimized_detector()` factory function
  - Intraday config: 48h windows, 72h expiration, max 3 campaigns
  - Daily config: 240h windows, 360h expiration, max 5 campaigns

**Files Created**:
- [backend/tests/integration/test_backtest_regression.py](../../backend/tests/integration/test_backtest_regression.py)
  - Regression test for daily timeframe backward compatibility
  - Golden master baseline comparison with tolerance
  - Detector configuration validation test

- [backend/tests/integration/test_intraday_backtest_integration.py](../../backend/tests/integration/test_intraday_backtest_integration.py)
  - 15m pattern detection validation test
  - Session distribution test (no ASIAN patterns)
  - Campaign formation test
  - Pattern variety test (Springs, SOS, LPS)

### Change Log
| Date | Version | Change | Author |
|------|---------|--------|--------|
| 2026-01-07 | 1.1 | Story implementation completed | James (Dev Agent) |

## QA Results
[To be filled by QA agent]
