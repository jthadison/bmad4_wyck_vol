# Story 8.3.1: Forex Volume Validation Adjustments

## Status
Done

## Story
**As a** volume validator (Victoria),
**I want** to adjust volume validation thresholds for forex tick volume,
**so that** Wyckoff volume analysis works reliably with tick volume instead of actual volume.

## Context
**Parent Story:** 8.3 - Volume Validation Stage

Forex markets are decentralized OTC markets with no consolidated volume tape. Brokers provide "tick volume" (number of price changes per time period) instead of actual traded volume. Tick volume is a **proxy indicator** that measures market activity, not institutional dollar flow.

**Key Differences:**
- **Stocks:** Actual volume from consolidated tape shows institutional accumulation/distribution
- **Forex:** Tick volume shows retail/institutional ACTIVITY level, not dollar volume
- **Implication:** Tick volume is more volatile and requires wider tolerance bands

## Acceptance Criteria
1. Volume validator accepts `volume_source` parameter ("ACTUAL", "TICK", "ESTIMATED")
2. Forex-specific thresholds implemented:
   - Spring: < 85% average tick volume (vs 70% for stocks)
   - Test: < 60% average tick volume (vs 50% for stocks)
   - SOS: > 180% average tick volume (vs 150% for stocks)
   - UTAD: > 250% average tick volume (vs 200% for stocks)
3. Session-aware volume baselines (compare to London avg, not daily avg)
4. News event filtering (reject patterns during NFP/FOMC tick spikes)
5. Broker-relative percentiles (not absolute tick counts)
6. Unit tests: forex tick volume patterns validate correctly
7. Integration test: EUR/USD spring with low tick volume passes validation
8. Logging: volume validator logs volume_source and thresholds used
9. Documentation: explain tick volume limitations and interpretation
10. Backward compatibility: stocks continue using existing thresholds

## Tasks / Subtasks

- [ ] Update VolumeValidator to accept volume_source parameter (AC: 1, 10)
  - [ ] Modify `VolumeValidator.__init__()`:
    - Add parameter: `asset_class: Literal["STOCK", "FOREX", "CRYPTO"] = "STOCK"`
    - Set thresholds based on asset_class in constructor
  - [ ] Define threshold constants:
    ```python
    # Stock thresholds (original)
    STOCK_SPRING_MAX_RATIO = 0.70
    STOCK_TEST_MAX_RATIO = 0.50
    STOCK_SOS_MIN_RATIO = 1.50
    STOCK_UTAD_MIN_RATIO = 2.00

    # Forex tick volume thresholds (NEW)
    FOREX_SPRING_MAX_RATIO = 0.85  # Wider tolerance
    FOREX_TEST_MAX_RATIO = 0.60
    FOREX_SOS_MIN_RATIO = 1.80
    FOREX_UTAD_MIN_RATIO = 2.50
    ```
  - [ ] Update validation methods to use asset-class-specific thresholds:
    ```python
    def validate_spring_volume(self, pattern: Pattern, volume_analysis: VolumeAnalysis) -> ValidationResult:
        if self.asset_class == "FOREX":
            max_ratio = self.FOREX_SPRING_MAX_RATIO
        else:
            max_ratio = self.STOCK_SPRING_MAX_RATIO

        if volume_analysis.volume_ratio < max_ratio:
            return ValidationResult(status="PASS", ...)
    ```

- [ ] Implement session-aware volume baselines for forex (AC: 3)
  - [ ] Add method: `_get_session_average_volume(symbol: str, forex_session: ForexSession, lookback_bars: int = 20) -> Decimal`
    - If forex_session == ASIAN:
      - Calculate avg volume for last 20 bars during Asian session hours (0:00-8:00 UTC)
    - If forex_session == LONDON:
      - Calculate avg volume for last 20 bars during London session hours (8:00-17:00 UTC)
    - If forex_session == NY or OVERLAP:
      - Calculate avg volume for last 20 bars during NY session hours (13:00-22:00 UTC)
    - Return session-specific average
  - [ ] Update volume_ratio calculation:
    ```python
    # OLD (stocks): Compare to daily average
    daily_avg_volume = calculate_average_volume(last_20_bars)
    volume_ratio = current_bar_volume / daily_avg_volume

    # NEW (forex): Compare to SESSION average
    if asset_class == "FOREX":
        session_avg_volume = _get_session_average_volume(symbol, forex_session)
        volume_ratio = current_bar_volume / session_avg_volume
    ```
  - [ ] Rationale: Asian session avg volume = 500 ticks, London avg = 1500 ticks. A 300-tick spring bar is 60% of Asian avg (PASS), but only 20% of London avg (FAIL with daily baseline).

- [ ] Implement news event filtering for forex (AC: 4)
  - [ ] Add method: `async def _check_news_event_tick_spike(pattern: Pattern, market_context: MarketContext) -> bool`
    - If market_context.asset_class != "FOREX": return False (stocks don't need this check)
    - If market_context.news_event is None: return False (no news event)
    - Check if pattern bar timestamp within ±1 hour of high-impact news event:
      ```python
      if market_context.news_event.impact_level == "HIGH":
          event_time = market_context.news_event.event_date
          pattern_time = pattern.bar_timestamp

          time_diff = abs((pattern_time - event_time).total_seconds() / 3600)

          if time_diff < 1.0:  # Within 1 hour of event
              return True  # Tick spike likely news-driven
      ```
    - Return True if pattern bar is within news event window
  - [ ] Integrate into validation:
    ```python
    if await self._check_news_event_tick_spike(pattern, context.market_context):
        return ValidationResult(
            status="FAIL",
            stage="Volume",
            reason=f"Pattern bar occurred during {context.market_context.news_event.event_type} event. Tick volume spike is news-driven, not institutional Wyckoff activity.",
            metadata={"news_event": context.market_context.news_event.event_type}
        )
    ```
  - [ ] Rationale: NFP release causes 500-1000% tick volume spike within 1 minute. This is retail/algo panic, not Wyckoff climactic volume.

- [ ] Implement broker-relative percentile calculations (AC: 5)
  - [ ] Add method: `_calculate_volume_percentile(current_volume: Decimal, historical_volumes: List[Decimal]) -> int`
    - Sort historical_volumes in ascending order
    - Find position of current_volume in sorted list
    - Calculate percentile: `(position / len(historical_volumes)) * 100`
    - Return percentile (0-100)
  - [ ] Update validation logic to use percentiles:
    ```python
    # Instead of: "Spring volume < 70% of average"
    # Use: "Spring volume at 25th percentile of last 100 bars"

    historical_volumes = fetch_last_100_bar_volumes(symbol)
    spring_volume_percentile = _calculate_volume_percentile(spring_bar_volume, historical_volumes)

    if spring_volume_percentile < 30:  # Below 30th percentile
        return ValidationResult(status="PASS", reason=f"Spring tick volume at {spring_volume_percentile}th percentile indicates reduced activity (Wyckoff test for supply).")
    ```
  - [ ] Rationale: Broker A reports 347 ticks for EUR/USD bar, Broker B reports 521 ticks for SAME bar. Absolute values meaningless. Percentile within broker's own data is comparable.

- [ ] Add session-based volume adjustment factors (AC: 3)
  - [ ] Define adjustment factors by session:
    ```python
    # Asian session: Reduce expectations (low liquidity)
    ASIAN_SPRING_MAX_RATIO = 0.60  # Stricter than normal 0.85
    ASIAN_SOS_MIN_RATIO = 2.00     # Higher than normal 1.80

    # London/NY/Overlap: Normal expectations
    # (use standard forex thresholds)
    ```
  - [ ] Apply session adjustments:
    ```python
    if forex_session == ForexSession.ASIAN:
        # Asian session springs need VERY low tick volume to be reliable
        max_ratio = self.ASIAN_SPRING_MAX_RATIO

        if volume_analysis.volume_ratio > max_ratio:
            return ValidationResult(
                status="FAIL",
                reason=f"Asian session spring requires < 60% tick volume (got {volume_analysis.volume_ratio:.0%}). Low liquidity sessions produce less reliable Wyckoff patterns."
            )
    ```
  - [ ] Rationale: Asian session (7pm-4am EST) has 50-70% lower tick volume than London. Patterns during low-liquidity sessions are less reliable per Wyckoff principle of "sufficient volume for meaningful accumulation/distribution."

- [ ] Add tick volume interpretation metadata (AC: 9)
  - [ ] Update ValidationResult to include tick volume context:
    ```python
    metadata={
        "volume_source": "TICK",
        "volume_interpretation": "Tick volume measures activity (price changes), not dollar flow. Lower tick volume indicates reduced retail/institutional activity, not necessarily institutional absorption.",
        "session": "LONDON",
        "session_avg_volume": 1500,
        "current_volume": 800,
        "volume_percentile": 28,
        "threshold_used": 0.85,
        "baseline_type": "session_average"  # vs "daily_average"
    }
    ```
  - [ ] Add to log output:
    ```python
    logger.info(
        "forex_volume_validation",
        symbol=symbol,
        pattern_type=pattern.pattern_type,
        volume_source="TICK",
        tick_volume=current_volume,
        session=forex_session,
        session_avg=session_avg_volume,
        percentile=volume_percentile,
        threshold=max_ratio,
        result=status
    )
    ```

- [ ] Write unit tests for forex volume validation (AC: 6)
  - [ ] Test: `test_forex_spring_low_tick_volume_passes()`
    - Setup: EUR/USD spring with tick volume = 600 (avg = 1000)
    - Ratio: 60% (below 85% threshold)
    - Expected: PASS
  - [ ] Test: `test_forex_spring_high_tick_volume_fails()`
    - Setup: EUR/USD spring with tick volume = 1200 (avg = 1000)
    - Ratio: 120% (above 85% threshold)
    - Expected: FAIL
  - [ ] Test: `test_stock_spring_uses_original_thresholds()`
    - Setup: AAPL spring with volume = 80% of average
    - Forex would PASS (< 85%), stock should FAIL (> 70%)
    - Expected: FAIL (stock thresholds still apply)
  - [ ] Test: `test_forex_sos_requires_higher_tick_volume()`
    - Setup: EUR/USD SOS with tick volume = 1600 (avg = 1000)
    - Ratio: 160% (below 180% forex threshold, but above 150% stock threshold)
    - Expected: FAIL (forex needs > 180%)
  - [ ] Test: `test_news_event_tick_spike_rejected()`
    - Setup: EUR/USD spring during NFP release (tick volume = 5000, avg = 1000)
    - News event: NFP, impact=HIGH, within 1 hour of pattern bar
    - Expected: FAIL with reason "news-driven tick spike"
  - [ ] Test: `test_asian_session_requires_stricter_thresholds()`
    - Setup: EUR/USD spring during Asian session, tick volume = 70% of session avg
    - Asian threshold: 60%, normal forex: 85%
    - Expected: FAIL (Asian session stricter)
  - [ ] Test: `test_session_average_baseline_used_for_forex()`
    - Setup: EUR/USD spring during London session
    - Daily avg: 1000 ticks, London session avg: 1500 ticks, spring bar: 900 ticks
    - With daily baseline: 90% (would FAIL with 85% threshold)
    - With session baseline: 60% (PASS with 85% threshold)
    - Expected: PASS (uses session baseline)

- [ ] Write integration test with real forex data (AC: 7)
  - [ ] Test: `test_eur_usd_spring_low_tick_volume_integration()`
    - Setup: Load 100 bars EUR/USD tick volume data
    - Simulate spring pattern during London session
    - Spring bar: 700 ticks, London session avg: 1400 ticks
    - Ratio: 50% (well below 85% threshold)
    - Execute: Full validation chain
    - Assert: Volume validation PASS
    - Assert: Metadata includes volume_source="TICK", session="LONDON"
  - [ ] Test: `test_gbp_jpy_spring_during_nfp_rejected()`
    - Setup: GBP/JPY spring pattern occurring at 8:30am EST (NFP release time)
    - Tick volume: 8000 (avg: 1200, ratio: 667%)
    - Market context includes NFP event
    - Execute: Volume validation
    - Assert: FAIL with reason "news-driven tick spike"

- [ ] Add documentation for tick volume interpretation (AC: 9)
  - [ ] Create `docs/volume-analysis/tick-volume-guide.md`:
    - Explain tick volume vs actual volume
    - Clarify what tick volume measures (activity, not dollar flow)
    - Document threshold adjustments for forex
    - Provide examples of tick volume patterns
    - Explain session-aware baselines
    - List limitations (broker variability, news spike noise)
  - [ ] Add docstrings to VolumeValidator methods:
    ```python
    """
    Validate spring volume for forex tick volume.

    Tick volume measures ACTIVITY (price changes per time period), not
    institutional dollar flow. Lower tick volume indicates reduced retail/algo
    participation, which suggests selling pressure is exhausted (Wyckoff test
    for supply).

    Forex threshold (85%) is wider than stocks (70%) because tick volume is
    more volatile and subject to news-driven spikes.

    Args:
        pattern: Detected spring pattern
        volume_analysis: Tick volume metrics
        forex_session: Current forex trading session

    Returns:
        ValidationResult with PASS if tick volume < 85% of session average
    """
    ```

- [ ] Update Story 8.3 main file to reference 8.3.1 (AC: 10)
  - [ ] Add note to Story 8.3:
    ```markdown
    ## Forex Support
    See **Story 8.3.1: Forex Volume Validation Adjustments** for tick volume
    handling, session-aware baselines, and forex-specific thresholds.

    Story 8.3 implements the base volume validation logic for stocks (actual volume).
    Story 8.3.1 extends this with forex-specific adjustments (tick volume).
    ```

## Dev Notes

### Tick Volume Fundamentals (Victoria's Analysis)

**What Tick Volume Measures:**
- Number of price changes (ticks) in a time period
- Reflects market ACTIVITY level
- Includes both retail and institutional participants
- Does NOT measure dollar volume or contract size

**What Tick Volume Does NOT Measure:**
- Institutional accumulation/distribution (dollar flow)
- Order size (1,000 lot order = 1 tick, 0.01 lot order = 1 tick)
- Market depth or liquidity

**Why Tick Volume Still Works for Wyckoff:**
- ✅ Relative comparisons valid (high vs low activity)
- ✅ Panic/climax detection (ultra-high tick volume)
- ✅ Divergence patterns (rising price + falling tick volume)
- ✅ Test confirmation (lower tick volume on spring test)

**What We Lose with Tick Volume:**
- ❌ Cannot see TRUE institutional absorption
- ❌ Cannot measure accumulation MAGNITUDE (dollar volume)
- ❌ Cannot compare across brokers (each broker different tick count)

### Session Volume Characteristics

| Session | Hours (UTC) | Avg Tick Volume | Characteristics |
|---------|-------------|-----------------|-----------------|
| **Asian** | 0:00-8:00 | 50-70% of daily | Low liquidity, ranging, less reliable patterns |
| **London** | 8:00-17:00 | 120-140% of daily | High liquidity, trending, best for Wyckoff |
| **NY** | 13:00-22:00 | 140-160% of daily | Highest liquidity, trend continuation |
| **Overlap** | 13:00-17:00 | 180-200% of daily | Peak activity, most reliable volume signals |

### Threshold Rationale

| Pattern Event | Stock (Actual Volume) | Forex (Tick Volume) | Reason for Difference |
|---------------|-----------------------|---------------------|------------------------|
| **Spring** | < 70% avg | < 85% avg | Tick volume more volatile, news spikes common |
| **Test** | < 50% avg | < 60% avg | Same reasoning as spring |
| **SOS** | > 150% avg | > 180% avg | Climactic tick volume needs to be more extreme to filter noise |
| **UTAD** | > 200% avg | > 250% avg | Distribution climax must show clear exhaustion above news noise |

### News Event Impact on Tick Volume

**High-Impact Forex Events:**
- NFP (Non-Farm Payroll): First Friday of month, 8:30am EST
- FOMC (Fed Rate Decision): 8 meetings/year, 2:00pm EST
- ECB Rate Decision: 8 meetings/year, 7:45am EST
- CPI/GDP/Unemployment: Monthly releases

**Tick Volume Spike During News:**
- Normal: 1,000 ticks/5min bar
- During NFP: 5,000-10,000 ticks/5min bar (500-1000% spike!)
- This is NOT Wyckoff climactic volume - it's noise

**Solution:** Reject any pattern bar within ±1 hour of high-impact event.

### Broker Variability

Different forex brokers report different tick volumes for the same time period:

| Broker | EUR/USD 5min Bar (8:00-8:05 UTC) |
|--------|-----------------------------------|
| Broker A | 347 ticks |
| Broker B | 521 ticks |
| Broker C | 412 ticks |

**Why?** Each broker has different:
- Client base (retail vs institutional flow)
- Liquidity providers
- Quote frequency

**Solution:** Use percentile rankings WITHIN broker's own historical data, not absolute tick counts.

## Testing

### Unit Test Requirements
- Forex spring with low tick volume (< 85%) → PASS
- Forex spring with high tick volume (> 85%) → FAIL
- Stock spring still uses 70% threshold (backward compatibility)
- Forex SOS requires > 180% tick volume
- News event tick spike (NFP) → FAIL
- Asian session uses stricter 60% threshold
- Session average baseline used (not daily average)

### Integration Test Requirements
- EUR/USD spring with real tick volume data → validates correctly
- GBP/JPY spring during NFP → rejected
- Stock AAPL spring → still uses actual volume thresholds

## Functional Requirements

**FR12: Volume Requirements** [Extended for Forex]
> Original: "Springs show low volume (<70% avg), SOS shows climactic volume (>150% avg)"
>
> Extended: "Forex springs show low tick volume (<85% avg session baseline), SOS shows climactic tick volume (>180% avg session baseline). Tick volume compared to session average (Asian/London/NY), not daily average. News-driven tick spikes filtered."

**NFR: Data Quality**
> Forex tick volume varies by broker. System uses broker-relative percentiles, not absolute tick counts, to ensure cross-broker compatibility.

## Dependencies

- **Story 8.3:** Base VolumeValidator implementation (parent)
- **Story 8.7:** ForexNewsCalendarService for news event filtering
- **Story 8.10:** ForexSession detection for session-aware baselines

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-01 | 1.0 | Initial story creation for forex tick volume validation | Victoria (Volume Specialist) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
