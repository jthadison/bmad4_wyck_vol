# Story 18.6.1: Volume Validator Base Classes and Registry

## Status
Ready for Review

## Story

**As a** developer extending volume validation,
**I want** base classes and a strategy registry for volume validators,
**So that** new pattern validators can be added without modifying existing code.

## Background

This is Part 1 of splitting `volume_validator.py` (950 lines). This story creates the foundation for the strategy pattern.

**Reference:** CF-006 from Critical Foundation Refactoring document.

## Acceptance Criteria

1. **AC1**: `VolumeValidationStrategy` abstract base class created with clear interface
2. **AC2**: `VolumeStrategyRegistry` class with register/get pattern
3. **AC3**: Shared validation helpers extracted (metadata building, logging)
4. **AC4**: 95%+ test coverage on new modules
5. **AC5**: No changes to existing volume_validator.py behavior yet

## Tasks

- [x] Create `backend/src/signal_generator/validators/volume/` package
- [x] Create `base.py` with `VolumeValidationStrategy` ABC
- [x] Create `registry.py` with `VolumeStrategyRegistry`
- [x] Create shared helpers for metadata building and logging
- [x] Add comprehensive unit tests

## Dev Notes

### Files to Create

| File | Lines | Purpose |
|------|-------|---------|
| `volume/__init__.py` | ~10 | Package init |
| `volume/base.py` | ~100 | Abstract base class |
| `volume/registry.py` | ~50 | Strategy registry |
| `volume/helpers.py` | ~80 | Shared helpers |

### Key Interface

```python
class VolumeValidationStrategy(ABC):
    @property
    @abstractmethod
    def pattern_type(self) -> str: ...

    @property
    @abstractmethod
    def volume_threshold(self) -> Decimal: ...

    @abstractmethod
    def validate(self, context: ValidationContext) -> ValidationResult: ...
```

## Story Points: 3

## Dependencies
- None

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created | Bob (Scrum Master) |
| 2026-01-15 | 1.1 | Implementation completed | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
claude-opus-4-5-20251101

### File List

| File | Action | Description |
|------|--------|-------------|
| `backend/src/signal_generator/validators/volume/__init__.py` | Created | Package init with exports |
| `backend/src/signal_generator/validators/volume/base.py` | Created | VolumeValidationStrategy ABC |
| `backend/src/signal_generator/validators/volume/registry.py` | Created | VolumeStrategyRegistry class |
| `backend/src/signal_generator/validators/volume/helpers.py` | Created | ValidationMetadataBuilder and helper functions |
| `backend/tests/unit/signal_generator/validators/volume/__init__.py` | Created | Test package init |
| `backend/tests/unit/signal_generator/validators/volume/test_base.py` | Created | Tests for VolumeValidationStrategy ABC |
| `backend/tests/unit/signal_generator/validators/volume/test_registry.py` | Created | Tests for VolumeStrategyRegistry |
| `backend/tests/unit/signal_generator/validators/volume/test_helpers.py` | Created | Tests for helper functions |

### Completion Notes

- **AC1 (VolumeValidationStrategy ABC)**: Created with `pattern_type`, `volume_threshold_type`, `default_stock_threshold`, `default_forex_threshold` properties and `validate()` method. Includes helper methods for logging and result creation.
- **AC2 (VolumeStrategyRegistry)**: Implemented with `register()`, `get()`, `has()`, `get_all()`, `clear()`, and `count()` methods. Supports case-insensitive pattern lookup.
- **AC3 (Shared helpers)**: Created `ValidationMetadataBuilder` with fluent interface, `calculate_volume_percentile()`, `interpret_volume_percentile()`, and `build_failure_reason()` functions.
- **AC4 (Test coverage)**: Achieved 99% coverage (138 statements, 2 missed) with 60 comprehensive unit tests.
- **AC5 (No regression)**: All 45 existing volume_validator tests pass unchanged.

### Debug Log References
None - no issues encountered during implementation.
