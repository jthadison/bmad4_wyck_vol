# Story 18.8.3: Spring Risk Analyzer

## Status
Ready for Review

## Story

**As a** developer analyzing Spring pattern risk,
**I want** the risk analysis logic extracted to its own module,
**So that** risk calculations are independently testable.

## Background

This is Part 3 of splitting `spring_detector.py`. Extracts `analyze_spring_risk_profile()` (161 lines).

**Reference:** CF-001 from Critical Foundation Refactoring document.

## Acceptance Criteria

1. **AC1**: `SpringRiskAnalyzer` class created (~150 lines)
2. **AC2**: `analyze()` method returning `SpringRiskProfile`
3. **AC3**: Stop loss calculation with buffer
4. **AC4**: Target calculation based on Ice level
5. **AC5**: Position sizing recommendation
6. **AC6**: 95%+ test coverage

## Tasks

- [x] Create `spring/risk_analyzer.py`
- [x] Implement `SpringRiskAnalyzer` class
- [x] Implement stop loss calculation
- [x] Implement target calculation
- [x] Implement position size recommendation
- [x] Add unit tests

## Dev Notes

### Files to Create

| File | Lines | Purpose |
|------|-------|---------|
| `spring/risk_analyzer.py` | ~150 | Risk analysis |

### Risk Calculation

```python
def analyze(self, candidate, trading_range) -> SpringRiskProfile:
    # Stop below Spring low with buffer
    stop_loss = candidate.bar.low - buffer
    # Target at Ice level
    target = trading_range.ice_level
    # R:R calculation
    rr_ratio = (target - entry) / (entry - stop_loss)
```

## Story Points: 3

## Dependencies
- Story 18.8.1 (package and models)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File | Action | Purpose |
|------|--------|---------|
| `backend/src/pattern_engine/detectors/spring/risk_analyzer.py` | Created | SpringRiskAnalyzer class with stop loss, target, R:R calculation |
| `backend/src/pattern_engine/detectors/spring/__init__.py` | Modified | Added exports for SpringRiskAnalyzer, RiskConfig, DEFAULT_RISK_CONFIG |
| `backend/tests/unit/pattern_engine/detectors/spring/test_risk_analyzer.py` | Created | Unit tests (37 tests, 100% coverage) |

### Debug Log References
- None required

### Completion Notes
- Created `SpringRiskAnalyzer` class (~150 lines) (AC1)
- Implemented `analyze()` method returning `SpringRiskProfile` (AC2)
- Implemented stop loss calculation: Spring low - 2% buffer with FR17 validation (AC3)
- Implemented target calculation using Ice level from TradingRange (AC4)
- Implemented position sizing recommendation (FULL/REDUCED/SKIP based on R:R) (AC5)
- Achieved 100% test coverage with 37 unit tests (AC6 - exceeds 95% requirement)
- All linting (ruff) and type checking (mypy) passes
- All 120 spring package tests pass (no regressions)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created | Bob (Scrum Master) |
| 2026-01-15 | 1.1 | Implementation complete | James (Dev Agent) |
