# Story 18.7.2: Risk and Return Calculators

## Status
Ready for Review

## Story

**As a** developer analyzing backtest performance,
**I want** risk and return calculators as separate modules,
**So that** each metric type is independently testable.

## Background

This is Part 2 of splitting `metrics.py`. Extracts risk metrics (Sharpe, Sortino, Calmar) and return calculations.

**Reference:** CF-005 from Critical Foundation Refactoring document.

## Acceptance Criteria

1. **AC1**: `RiskCalculator` class extracted (~150 lines)
2. **AC2**: Sharpe ratio calculation is O(n)
3. **AC3**: Sortino ratio calculation is O(n)
4. **AC4**: `ReturnCalculator` class extracted (~150 lines)
5. **AC5**: Monthly/annual return calculations
6. **AC6**: Consistent Decimal precision handling
7. **AC7**: 95%+ test coverage

## Tasks

- [x] Create `risk_calculator.py` with O(n) implementations
- [x] Implement `calculate_sharpe_ratio()`
- [x] Implement `calculate_sortino_ratio()`
- [x] Implement `calculate_calmar_ratio()`
- [x] Create `return_calculator.py`
- [x] Implement monthly and annual return calculations
- [x] Add unit tests

## Dev Notes

### Files to Create

| File | Lines | Purpose |
|------|-------|---------|
| `metrics/risk_calculator.py` | ~150 | Risk metrics |
| `metrics/return_calculator.py` | ~150 | Return metrics |

### O(n) Risk Calculation

```python
def calculate_sharpe_ratio(self, returns: List[Decimal], ...) -> Decimal:
    # Single pass for mean
    mean_return = sum(returns) / len(returns)
    # Single pass for variance
    variance = sum((r - mean_return) ** 2 for r in returns) / len(returns)
    # O(n) total, not O(nÂ²)
```

## Story Points: 3

## Dependencies
- Story 18.7.1 (base models)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created | Bob (Scrum Master) |
| 2026-01-15 | 1.1 | Implementation complete | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List

| File | Action | Lines | Purpose |
|------|--------|-------|---------|
| `backend/src/backtesting/metrics_core/risk_calculator.py` | Created | 253 | RiskCalculator with Sharpe, Sortino, Calmar ratios |
| `backend/src/backtesting/metrics_core/return_calculator.py` | Created | 239 | ReturnCalculator with total/CAGR/monthly/annual returns |
| `backend/src/backtesting/metrics_core/__init__.py` | Modified | 58 | Added exports for new calculators and dataclasses |
| `backend/tests/backtesting/metrics_core/test_risk_calculator.py` | Created | 281 | Unit tests for RiskCalculator (28 tests) |
| `backend/tests/backtesting/metrics_core/test_return_calculator.py` | Created | 312 | Unit tests for ReturnCalculator (33 tests) |

### Completion Notes

- **AC1**: `RiskCalculator` class created with 253 lines (3 main methods + utility)
- **AC2**: Sharpe ratio uses O(n) algorithm - two sequential passes for mean then variance
- **AC3**: Sortino ratio uses O(n) algorithm - single pass for downside deviation
- **AC4**: `ReturnCalculator` class created with 239 lines (6 methods)
- **AC5**: Monthly returns (`MonthlyReturn` dataclass) and annual returns (`AnnualReturn` dataclass) implemented
- **AC6**: All calculations use `Decimal` type with consistent quantization (0.0001 for percentages)
- **AC7**: Test coverage 95%+ for both new modules (61 new tests total)

### Debug Log References
None - implementation completed without issues.
