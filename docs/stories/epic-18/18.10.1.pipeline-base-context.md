# Story 18.10.1: Pipeline Base Class and Context

## Status
Ready for Review

## Story

**As a** developer building pipeline stages,
**I want** a base class and context builder,
**So that** all stages follow consistent patterns.

## Background

This is Part 1 of splitting master_orchestrator.py. Creates pipeline infrastructure.

**Reference:** CF-003 from Critical Foundation Refactoring document.

## Acceptance Criteria

1. **AC1**: `stages/` package created under `orchestrator/`
2. **AC2**: `PipelineStage` abstract base class with timing and error handling
3. **AC3**: `PipelineContext` for passing data between stages
4. **AC4**: `PipelineResult` model for stage outputs
5. **AC5**: 95%+ test coverage

## Tasks

- [x] Create `backend/src/orchestrator/stages/` package
- [x] Create `__init__.py` with public exports
- [x] Create `base.py` with `PipelineStage` ABC
- [x] Create `pipeline/context.py` with context builder
- [x] Create `pipeline/result.py` with result models
- [x] Add unit tests

## Dev Notes

### Files to Create

| File | Lines | Purpose |
|------|-------|---------|
| `stages/__init__.py` | ~20 | Package exports |
| `stages/base.py` | ~80 | Pipeline stage ABC |
| `pipeline/context.py` | ~100 | Context builder |
| `pipeline/result.py` | ~50 | Result models |

### Pipeline Stage Base

```python
from abc import ABC, abstractmethod
from typing import Generic, TypeVar

TInput = TypeVar('TInput')
TOutput = TypeVar('TOutput')

class PipelineStage(ABC, Generic[TInput, TOutput]):
    """Base class for pipeline stages."""

    @property
    @abstractmethod
    def name(self) -> str:
        """Stage name for logging."""
        pass

    @abstractmethod
    async def execute(self, input: TInput, context: PipelineContext) -> TOutput:
        """Execute stage logic."""
        pass

    async def run(self, input: TInput, context: PipelineContext) -> TOutput:
        """Run stage with timing and error handling."""
        with context.timer(self.name):
            try:
                return await self.execute(input, context)
            except Exception as e:
                context.add_error(self.name, e)
                raise
```

## Story Points: 3

## Dependencies
- Story 18.1 (validation logic extraction)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File | Action | Description |
|------|--------|-------------|
| `backend/src/orchestrator/stages/__init__.py` | Created | Package exports for stages |
| `backend/src/orchestrator/stages/base.py` | Created | PipelineStage ABC with generics |
| `backend/src/orchestrator/pipeline/__init__.py` | Created | Package exports for pipeline |
| `backend/src/orchestrator/pipeline/context.py` | Created | PipelineContext and builder |
| `backend/src/orchestrator/pipeline/result.py` | Created | PipelineResult generic model |
| `backend/tests/unit/orchestrator/stages/__init__.py` | Created | Test package |
| `backend/tests/unit/orchestrator/stages/test_base.py` | Created | PipelineStage tests |
| `backend/tests/unit/orchestrator/pipeline/__init__.py` | Created | Test package |
| `backend/tests/unit/orchestrator/pipeline/test_context.py` | Created | Context/builder tests |
| `backend/tests/unit/orchestrator/pipeline/test_result.py` | Created | PipelineResult tests |

### Completion Notes
- Implemented generic PipelineStage[TInput, TOutput] for type-safe pipelines
- PipelineContext provides fluent builder, timer context manager, error tracking
- PipelineResult with factory methods (ok/fail) and generic output type
- 100% test coverage achieved (47 tests passing)
- Pre-existing test failure in test_campaign_integration.py unrelated to this story

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created | Bob (Scrum Master) |
| 2026-01-15 | 1.1 | Implementation complete | James (Dev Agent) |
