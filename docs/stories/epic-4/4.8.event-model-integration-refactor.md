# Story 4.8: Event Model Integration Refactor

**Epic:** 4 - Wyckoff Phase Detection System
**Status:** Draft
**Priority:** High
**Created:** 2025-10-31
**Estimated Effort:** 4-6 hours

---

## Problem Statement

During Story 4.7 integration, a model incompatibility was discovered between the event detection modules (Stories 4.1-4.3) and phase classification (Story 4.4). This creates integration challenges and requires workarounds.

### Current Issues

1. **Missing bar_index in Event Models:**
   - SellingClimax, AutomaticRally, SecondaryTest models don't store `bar_index`
   - phase_classifier expects `sc["bar"]["index"]` which doesn't exist
   - Information is lost during model serialization (model_dump())

2. **Duplicate PhaseEvents Models:**
   - `phase_events.py`: Uses attributes `sc`, `ar`, `st_list`
   - `phase_classification.py`: Uses `selling_climax`, `automatic_rally`, `secondary_tests`
   - Creates confusion and requires adapter logic

3. **OHLCVBar Missing Index:**
   - OHLCVBar model doesn't include bar index/position
   - Index only exists as loop counter during detection
   - Makes it hard to reference specific bars in sequence

### Impact

- **Technical Debt:** Story 4.7 uses adapter pattern as workaround
- **Test Complexity:** Tests must work around missing index data
- **Integration Friction:** Each new integration requires adapter logic
- **Maintainability:** Two sources of truth for event structures

---

## Story Overview

Refactor event detection and classification models to eliminate integration incompatibilities and establish single source of truth for event structures.

### Goals

1. **Add bar_index to event models:** SellingClimax, AutomaticRally, SecondaryTest
2. **Consolidate PhaseEvents models:** Single canonical PhaseEvents
3. **Update phase_classifier:** Use event.bar_index instead of bar["index"]
4. **Remove adapter pattern:** Clean up Story 4.7 workarounds
5. **Comprehensive regression testing:** Ensure all Stories 4.1-4.7 still work

---

## Acceptance Criteria

### Event Model Updates (AC 1-6)

**AC 1:** SellingClimax model includes `bar_index: int` field
- GIVEN a SellingClimax is detected
- WHEN accessing bar_index
- THEN it returns the index where SC occurred

**AC 2:** AutomaticRally model includes `bar_index: int` field
- GIVEN an AutomaticRally is detected
- WHEN accessing bar_index
- THEN it returns the index where AR peak occurred

**AC 3:** SecondaryTest model includes `bar_index: int` field
- GIVEN a SecondaryTest is detected
- WHEN accessing bar_index
- THEN it returns the index where ST occurred

**AC 4:** Event detectors populate bar_index during detection
- GIVEN detect_selling_climax() finds SC at index 20
- WHEN SellingClimax is created
- THEN bar_index = 20

**AC 5:** Event model serialization preserves bar_index
- GIVEN a SellingClimax with bar_index=20
- WHEN sc.model_dump() is called
- THEN result contains {"bar_index": 20}

**AC 6:** Backward compatibility maintained
- GIVEN existing code using event models
- WHEN models updated with bar_index
- THEN existing code continues to work

### PhaseEvents Consolidation (AC 7-12)

**AC 7:** Single PhaseEvents model in phase_classification.py
- GIVEN PhaseEvents import
- WHEN from src.models.phase_classification import PhaseEvents
- THEN it's the only PhaseEvents model used project-wide

**AC 8:** phase_events.py deprecated
- GIVEN phase_events.py exists
- WHEN reviewing codebase
- THEN it's marked deprecated with migration path documented

**AC 9:** Consistent attribute naming
- GIVEN PhaseEvents model
- WHEN accessing attributes
- THEN uses: selling_climax, automatic_rally, secondary_tests (not sc/ar/st_list)

**AC 10:** All imports updated
- GIVEN grep for PhaseEvents imports
- WHEN searching codebase
- THEN all import from phase_classification (not phase_events)

**AC 11:** PhaseDetector uses canonical PhaseEvents
- GIVEN PhaseDetector.detect_phase()
- WHEN creating PhaseEvents
- THEN uses phase_classification.PhaseEvents

**AC 12:** Tests use canonical PhaseEvents
- GIVEN all test files
- WHEN importing PhaseEvents
- THEN import from phase_classification

### phase_classifier Updates (AC 13-18)

**AC 13:** phase_classifier uses event.bar_index
- GIVEN classify_phase_a(events)
- WHEN accessing SC index
- THEN uses sc["bar_index"] not sc["bar"]["index"]

**AC 14:** AR index accessed correctly
- GIVEN classify_phase_a(events)
- WHEN accessing AR index
- THEN uses ar["bar_index"]

**AC 15:** ST index accessed correctly
- GIVEN classify_phase_b(events)
- WHEN accessing ST indices
- THEN uses st["bar_index"] for each ST

**AC 16:** Duration calculations work
- GIVEN Phase A with SC at index 20, AR at index 25
- WHEN calculating phase duration
- THEN duration = 25 - 20 = 5 bars

**AC 17:** phase_start_index calculation correct
- GIVEN PhaseInfo.phase_start_bar_index
- WHEN phase classified
- THEN uses event.bar_index as source

**AC 18:** No bar["index"] references remain
- GIVEN grep for 'bar\["index"\]' in phase_classifier.py
- WHEN searching
- THEN 0 results found

### Adapter Removal (AC 19-21)

**AC 19:** Story 4.7 adapter pattern removed
- GIVEN phase_detector_v2.py
- WHEN reviewing code
- THEN no _enrich_events_with_indices() or similar adapters exist

**AC 20:** PhaseDetector directly uses events
- GIVEN PhaseDetector._detect_all_events()
- WHEN creating PhaseEvents
- THEN passes event objects directly to classify_phase (no enrichment)

**AC 21:** Clean event pipeline
- GIVEN event detection → classification → PhaseInfo creation
- WHEN data flows through pipeline
- THEN no transformation/adapter layers exist

### Regression Testing (AC 22-30)

**AC 22:** Story 4.1 tests pass
- GIVEN pytest tests/unit/pattern_engine/test_phase_detector.py (SC tests)
- WHEN running
- THEN all SC detection tests pass

**AC 23:** Story 4.2 tests pass
- GIVEN AR detection tests
- WHEN running
- THEN all AR detection tests pass

**AC 24:** Story 4.3 tests pass
- GIVEN ST detection tests
- WHEN running
- THEN all ST detection tests pass

**AC 25:** Story 4.4 tests pass
- GIVEN phase_classifier tests
- WHEN running
- THEN all phase classification tests pass

**AC 26:** Story 4.5 tests pass
- GIVEN confidence scoring tests
- WHEN running
- THEN all confidence tests pass

**AC 27:** Story 4.6 tests pass
- GIVEN phase progression validator tests
- WHEN running
- THEN all progression tests pass

**AC 28:** Story 4.7 tests pass
- GIVEN PhaseDetector v2 tests
- WHEN running tests/unit/pattern_engine/test_phase_detector_v2.py
- THEN 22/22 tests pass (currently 4/22 due to integration issues)

**AC 29:** Integration tests pass
- GIVEN integration test suite
- WHEN running
- THEN all Epic 4 integration tests pass

**AC 30:** No breaking changes
- GIVEN existing public APIs
- WHEN refactor complete
- THEN all public APIs remain unchanged

---

## Tasks

### Phase 1: Event Model Updates (4 hours)

**Task 1:** Update SellingClimax model (30 min)
- Add `bar_index: int` field to model
- Update detect_selling_climax() to populate bar_index
- Update tests to verify bar_index included
- Run Story 4.1 regression tests

**Task 2:** Update AutomaticRally model (30 min)
- Add `bar_index: int` field to model
- Update detect_automatic_rally() to populate bar_index
- Update tests to verify bar_index included
- Run Story 4.2 regression tests

**Task 3:** Update SecondaryTest model (30 min)
- Add `bar_index: int` field to model
- Update detect_secondary_test() to populate bar_index
- Update tests to verify bar_index included
- Run Story 4.3 regression tests

**Task 4:** Verify model serialization (15 min)
- Test SellingClimax.model_dump() includes bar_index
- Test AutomaticRally.model_dump() includes bar_index
- Test SecondaryTest.model_dump() includes bar_index
- Verify JSON serialization works

### Phase 2: PhaseEvents Consolidation (1.5 hours)

**Task 5:** Audit PhaseEvents usage (15 min)
- grep for all PhaseEvents imports
- Document which files use which version
- Create migration checklist

**Task 6:** Deprecate phase_events.py (15 min)
- Add deprecation warning to phase_events.py
- Add migration docstring
- Update module docstring with deprecation notice

**Task 7:** Update all imports to phase_classification.PhaseEvents (30 min)
- Update VSA helpers
- Update position sizing
- Update PhaseDetector
- Update all test files
- Verify no phase_events.py imports remain

**Task 8:** Update PhaseDetector event creation (15 min)
- Ensure uses phase_classification.PhaseEvents
- Verify attribute names: selling_climax, automatic_rally, secondary_tests
- Update any adapter logic

**Task 9:** Test PhaseEvents consolidation (15 min)
- Run unit tests
- Verify no import errors
- Verify attribute access works

### Phase 3: phase_classifier Refactor (1.5 hours)

**Task 10:** Update classify_phase_a() (20 min)
- Change sc["bar"]["index"] → sc["bar_index"]
- Change ar["bar"]["index"] → ar["bar_index"]
- Update duration calculations
- Test with real events

**Task 11:** Update classify_phase_b() (20 min)
- Change st["bar"]["index"] → st["bar_index"] for all STs
- Update ST progression analysis
- Update duration calculations
- Test with real events

**Task 12:** Update classify_phase_c/d/e() (15 min)
- Update spring["bar_index"] access (when Epic 5 ready)
- Update sos["bar_index"] access (when Epic 5 ready)
- Add placeholder comments for Epic 5

**Task 13:** Remove all bar["index"] references (15 min)
- Search and replace remaining references
- Verify no KeyError: 'index' possible
- Code review for edge cases

**Task 14:** Update phase_start_index calculation (15 min)
- Update PhaseInfo creation in PhaseDetector
- Use event.bar_index directly
- Remove any index calculation workarounds

**Task 15:** Test phase_classifier updates (15 min)
- Run Story 4.4 tests
- Run Story 4.7 tests
- Verify phase classification works end-to-end

### Phase 4: Adapter Removal (30 min)

**Task 16:** Remove adapter pattern from PhaseDetector (15 min)
- Remove _enrich_events_with_indices() if exists
- Remove any index injection logic
- Clean up _create_phase_info() method
- Simplify event pipeline

**Task 17:** Verify clean pipeline (15 min)
- Review event flow: detect → classify → PhaseInfo
- Ensure no transformations/adapters
- Code review for simplicity
- Document clean architecture

### Phase 5: Comprehensive Testing (1.5 hours)

**Task 18:** Run all Epic 4 unit tests (30 min)
- pytest tests/unit/pattern_engine/ -v
- Verify all Stories 4.1-4.7 tests pass
- Fix any regressions

**Task 19:** Run integration tests (20 min)
- pytest tests/integration/pattern_engine/ -v
- Verify end-to-end workflows
- Test with real market data if available

**Task 20:** Run Story 4.7 full test suite (20 min)
- pytest tests/unit/pattern_engine/test_phase_detector_v2.py -v
- Target: 22/22 tests passing
- pytest tests/unit/analysis/test_vsa_helpers.py -v
- pytest tests/unit/risk/test_wyckoff_position_sizing.py -v
- Target: 79/79 total tests passing

**Task 21:** Performance regression check (10 min)
- Run performance tests
- Verify <100ms for 500 bars still met
- Verify caching still works

**Task 22:** Create regression test matrix (10 min)
- Document test coverage
- Create checklist for future changes
- Update CI/CD if needed

---

## Files Modified

### Event Models
- `backend/src/models/selling_climax.py` - Add bar_index
- `backend/src/models/automatic_rally.py` - Add bar_index
- `backend/src/models/secondary_test.py` - Add bar_index

### Event Detectors
- `backend/src/pattern_engine/phase_detector.py` - Populate bar_index

### Phase Classification
- `backend/src/pattern_engine/phase_classifier.py` - Use bar_index not bar["index"]
- `backend/src/models/phase_events.py` - Deprecation notice

### Integration
- `backend/src/pattern_engine/phase_detector_v2.py` - Remove adapter, use bar_index
- `backend/src/models/phase_info.py` - Already uses phase_classification
- `backend/src/analysis/vsa_helpers.py` - Already uses phase_classification
- `backend/src/risk/wyckoff_position_sizing.py` - Already uses phase_classification

### Tests (All Stories 4.1-4.7)
- Update assertions to use bar_index
- Verify model serialization
- Add regression tests

---

## Testing Strategy

### Unit Tests
- **Event Models:** Verify bar_index field exists and serializes
- **Event Detectors:** Verify bar_index populated correctly
- **phase_classifier:** Verify uses bar_index not bar["index"]
- **PhaseDetector:** Verify clean pipeline, no adapters

### Integration Tests
- **End-to-End:** SC detection → AR detection → ST detection → Phase classification → PhaseInfo
- **Real Data:** Test with AAPL March 2020 data
- **Edge Cases:** Missing events, partial phases, invalidations

### Regression Tests
- **All Stories 4.1-4.7:** Full test suites must pass
- **Performance:** <100ms target maintained
- **Backward Compatibility:** Existing code works

---

## Definition of Done

- [ ] All event models (SC, AR, ST) have bar_index field
- [ ] All event detectors populate bar_index
- [ ] Single PhaseEvents model (phase_classification.py)
- [ ] phase_events.py deprecated with migration docs
- [ ] phase_classifier uses event.bar_index everywhere
- [ ] No bar["index"] references remain
- [ ] Adapter pattern removed from PhaseDetector
- [ ] All Stories 4.1-4.7 tests pass (79/79 Story 4.7 tests)
- [ ] Integration tests pass
- [ ] Performance regression checks pass
- [ ] Code review completed
- [ ] Documentation updated

---

## Technical Debt Resolved

This story resolves the following technical debt:
1. ❌ Adapter pattern in Story 4.7 PhaseDetector
2. ❌ Duplicate PhaseEvents models
3. ❌ Missing bar_index in event models
4. ❌ Fragile bar["index"] access in phase_classifier
5. ❌ Model serialization losing index information

---

## Dependencies

**Blocked By:** Story 4.7 (must complete adapter pattern first)
**Blocks:** None (quality improvement, not feature blocker)
**Related:** Stories 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7

---

## Notes

### Why Not Do This in Story 4.7?

Story 4.7 discovered the issue during integration. Rather than expand scope significantly (from 3 weeks to 4+ weeks), we:
1. Implemented adapter pattern as temporary solution
2. Created this follow-up story for proper fix
3. Allowed Phase 2 of Story 4.7 to proceed

This is good engineering practice: discover, workaround, document, schedule proper fix.

### Migration Path

For code using old phase_events.py PhaseEvents:
```python
# OLD (deprecated):
from src.models.phase_events import PhaseEvents
events = PhaseEvents(sc=sc, ar=ar, st_list=[st1, st2])

# NEW (canonical):
from src.models.phase_classification import PhaseEvents
events = PhaseEvents(
    selling_climax=sc.model_dump(),
    automatic_rally=ar.model_dump(),
    secondary_tests=[st1.model_dump(), st2.model_dump()]
)
```

### Future Improvements

After this refactor, consider:
- Add `bar_index` to OHLCVBar model itself (optional metadata)
- Create EventBase base class for SC/AR/ST common fields
- Type-safe event access (not dict-based)

---

**Status:** Ready for Development after Story 4.7 Phase 2 complete
