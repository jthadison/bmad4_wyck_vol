# Story 22.13: Add Deprecation Warnings for Legacy APIs

## Status
Ready for Development

## Story
**As a** developer,
**I want** deprecation warnings on legacy APIs,
**So that** I know to migrate to new implementations.

## INVEST Checklist
| Criteria | Status | Notes |
|----------|--------|-------|
| Independent | ✅ | Depends on 22.7c, 22.8, 22.9 |
| Negotiable | ✅ | Warning format flexible |
| Valuable | ✅ | Guides migration |
| Estimable | ✅ | Clear scope |
| Small | ✅ | 2 points, warnings only |
| Testable | ✅ | Warnings testable |

## Story Points
2

## Priority
Low

## Type
Code Quality

## Dependencies
- **22.7c** (Phase Detector Deprecation) - Phase detector warnings
- **22.8** (Split Backtest Routes) - Backtest route structure
- **22.9** (Split Campaign Routes) - Campaign route structure

## Background

After refactoring, legacy APIs should have deprecation warnings to guide developers toward new implementations. This ensures:
- Clear migration path
- No silent API changes
- Planned removal timeline

## Acceptance Criteria

### AC1: Deprecation Warning Format
```gherkin
Given any deprecated API
When a deprecation warning is raised
Then it follows the format:
  "{old_name} is deprecated. Use {new_import} instead. Will be removed in {version}."
```

### AC2: Warnings Appear in Logs
```gherkin
Given test runs with deprecated imports
When tests execute
Then deprecation warnings appear in test output
And warnings are visible but don't fail tests
```

### AC3: All Legacy Facades Have Warnings
```gherkin
Given the following legacy modules:
  - pattern_engine/phase_detector.py
  - pattern_engine/phase_detector_v2.py
  - models/backtest.py (original)
When any public function/class is used
Then a DeprecationWarning is raised
```

### AC4: Deprecation Timeline Documented
```gherkin
Given deprecation warnings
When I review the warning messages
Then each includes removal version (v0.3.0)
And the timeline is consistent across all warnings
```

### AC5: Tests Verify Warnings
```gherkin
Given deprecation test suite
When I run pytest
Then tests verify warnings are raised
And tests verify warning message content
```

## Tasks / Subtasks

- [ ] Review All Legacy APIs
  - [ ] List all deprecated imports/functions
  - [ ] Determine warning severity (DeprecationWarning)
  - [ ] Document removal timeline

- [ ] Add Warnings to Phase Detectors
  - [ ] Verify 22.7c warnings in place
  - [ ] Add any missing warnings
  - [ ] Test warning output

- [ ] Add Warnings to Models
  - [ ] Add warning to models/backtest.py imports
  - [ ] Guide to models/backtest/ package
  - [ ] Test warning output

- [ ] Add Warnings to Routes (if applicable)
  - [ ] Review if route facades need warnings
  - [ ] Add internal deprecation markers

- [ ] Create Deprecation Test Suite
  - [ ] Create `backend/tests/unit/test_deprecation_warnings.py`
  - [ ] Test all deprecated imports
  - [ ] Verify warning messages
  - [ ] Verify removal version mentioned

- [ ] Document Deprecation Policy
  - [ ] Add deprecation policy to CONTRIBUTING.md or similar
  - [ ] Document standard warning format
  - [ ] Document removal process

## Dev Notes

### Standard Deprecation Warning Pattern

```python
import warnings
from functools import wraps

# Module-level warning on import
def _emit_module_deprecation_warning():
    warnings.warn(
        "The 'pattern_engine.phase_detector' module is deprecated. "
        "Use 'pattern_engine.phase_detection' instead. "
        "This module will be removed in v0.3.0.",
        DeprecationWarning,
        stacklevel=2
    )

_emit_module_deprecation_warning()


# Function-level decorator
def deprecated(message: str, removal_version: str = "v0.3.0"):
    """Decorator to mark functions as deprecated."""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            warnings.warn(
                f"{func.__name__} is deprecated. {message} "
                f"Will be removed in {removal_version}.",
                DeprecationWarning,
                stacklevel=2
            )
            return func(*args, **kwargs)
        return wrapper
    return decorator


# Usage example
@deprecated("Use PhaseDetector.detect_phase() instead")
def detect_phase(ohlcv):
    pass


# Class-level warning in __init__
class OldPhaseDetector:
    def __init__(self):
        warnings.warn(
            "OldPhaseDetector is deprecated. "
            "Use pattern_engine.phase_detection.PhaseDetector instead. "
            "Will be removed in v0.3.0.",
            DeprecationWarning,
            stacklevel=2
        )
```

### Deprecation Test Suite

```python
# backend/tests/unit/test_deprecation_warnings.py
"""
Tests for deprecation warnings across refactored modules.

Ensures all legacy APIs emit proper deprecation warnings
with correct migration guidance.
"""

import pytest
import warnings


class TestPhaseDetectorDeprecation:
    """Tests for phase_detector.py deprecation."""

    def test_module_import_warns(self):
        with warnings.catch_warnings(record=True) as w:
            warnings.simplefilter("always")

            from src.pattern_engine import phase_detector  # noqa: F401

            assert len(w) >= 1
            assert issubclass(w[0].category, DeprecationWarning)
            assert "deprecated" in str(w[0].message).lower()
            assert "phase_detection" in str(w[0].message)
            assert "v0.3.0" in str(w[0].message)

    def test_class_instantiation_warns(self):
        with warnings.catch_warnings(record=True) as w:
            warnings.simplefilter("always")

            from src.pattern_engine.phase_detector import PhaseDetector
            _ = PhaseDetector()

            warning_msgs = [str(warning.message) for warning in w]
            assert any("PhaseDetector" in msg for msg in warning_msgs)


class TestPhaseDetectorV2Deprecation:
    """Tests for phase_detector_v2.py deprecation."""

    def test_module_import_warns(self):
        with warnings.catch_warnings(record=True) as w:
            warnings.simplefilter("always")

            from src.pattern_engine import phase_detector_v2  # noqa: F401

            assert len(w) >= 1
            assert issubclass(w[0].category, DeprecationWarning)


class TestBacktestModelsDeprecation:
    """Tests for models/backtest.py deprecation (if applicable)."""

    def test_direct_import_suggests_package(self):
        # This test verifies documentation/comments guide users
        # to the new package structure
        from src.models import backtest

        # Check module docstring mentions new structure
        assert "backtest/" in backtest.__doc__ or "package" in backtest.__doc__.lower()


class TestDeprecationMessageFormat:
    """Tests that all deprecation messages follow standard format."""

    def test_all_warnings_include_removal_version(self):
        """All deprecation warnings must include removal version."""
        deprecated_modules = [
            "src.pattern_engine.phase_detector",
            "src.pattern_engine.phase_detector_v2",
        ]

        for module_name in deprecated_modules:
            with warnings.catch_warnings(record=True) as w:
                warnings.simplefilter("always")

                try:
                    __import__(module_name)
                except ImportError:
                    continue  # Module doesn't exist yet

                for warning in w:
                    if issubclass(warning.category, DeprecationWarning):
                        msg = str(warning.message)
                        assert "v0.3.0" in msg or "removed" in msg.lower(), \
                            f"Warning missing removal version: {msg}"

    def test_all_warnings_include_alternative(self):
        """All deprecation warnings must include what to use instead."""
        deprecated_modules = [
            "src.pattern_engine.phase_detector",
        ]

        for module_name in deprecated_modules:
            with warnings.catch_warnings(record=True) as w:
                warnings.simplefilter("always")

                try:
                    __import__(module_name)
                except ImportError:
                    continue

                for warning in w:
                    if issubclass(warning.category, DeprecationWarning):
                        msg = str(warning.message)
                        assert "Use" in msg or "use" in msg, \
                            f"Warning missing alternative: {msg}"
```

### Deprecation Inventory

| Module | Status | Warning Added | Removal Version |
|--------|--------|---------------|-----------------|
| `phase_detector.py` | Deprecated | 22.7c | v0.3.0 |
| `phase_detector_v2.py` | Deprecated | 22.7c | v0.3.0 |
| `models/backtest.py` | Re-export only | This story | N/A (keeps working) |

### File Locations
- Deprecation tests: `backend/tests/unit/test_deprecation_warnings.py`
- Deprecated modules: Various (see inventory)

## Testing

### Test Requirements
1. All deprecated modules emit warnings
2. Warning messages follow standard format
3. Removal version included
4. Alternative provided in message

### Verification
```bash
# Run deprecation tests
cd backend
poetry run pytest tests/unit/test_deprecation_warnings.py -v

# Check warnings appear in regular test run
poetry run pytest --tb=short 2>&1 | grep -i "deprecat"
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 1.0 | Initial story creation | PO Agent |

## Dev Agent Record

### Implementation Summary (2026-02-01)

**Branch**: `feature/story-22.13-deprecation-warnings`

#### Completed Tasks

1. **Created comprehensive deprecation test suite** (`backend/tests/unit/test_deprecation_warnings.py`)
   - 20 tests covering all deprecation warning acceptance criteria
   - Tests for phase_detector, phase_detector_v2, backtest_engine, engine_enhanced
   - Verifies warning format, removal version, migration alternatives
   - Tests that warnings appear but don't fail tests

2. **Enhanced existing deprecation warnings**
   - Updated `backtest_engine.py` and `engine_enhanced.py` to include v0.3.0 removal version
   - Aligned all warnings with standard format: `"{old_name} is deprecated. Use {new_import} instead. Will be removed in v0.3.0."`

3. **Documented deprecation policy**
   - Added "Deprecation Policy (Story 22.13)" section to `docs/architecture/migration-guide-epic22.md`
   - Documented standard warning format, implementation patterns, timeline, and checklist

#### Files Changed
- `backend/tests/unit/test_deprecation_warnings.py` (NEW - 460 lines)
- `backend/src/backtesting/backtest_engine.py` (warning message updated)
- `backend/src/backtesting/engine_enhanced.py` (warning message updated)
- `docs/architecture/migration-guide-epic22.md` (deprecation policy section added)

#### Test Results
```
tests/unit/test_deprecation_warnings.py: 20 passed
tests/unit/pattern_engine/test_phase_detector_deprecation.py: 16 passed
```

#### Deprecation Inventory (Current)
| Module | Warning Format | v0.3.0 Removal | Tests |
|--------|---------------|----------------|-------|
| `pattern_engine.phase_detector` | ✅ | ✅ | ✅ |
| `pattern_engine.phase_detector_v2` | ✅ | ✅ | ✅ |
| `backtesting.backtest_engine` | ✅ | ✅ | ✅ |
| `backtesting.engine_enhanced` | ✅ | ✅ | ✅ |

## QA Results
_To be populated by QA agent_
