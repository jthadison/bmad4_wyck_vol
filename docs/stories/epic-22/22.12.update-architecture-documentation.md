# Story 22.12: Update Architecture Documentation

## Status
Complete

## Story
**As a** developer,
**I want** architecture documentation updated to reflect refactoring,
**So that** new team members understand the current system structure.

## INVEST Checklist
| Criteria | Status | Notes |
|----------|--------|-------|
| Independent | ✅ | Depends on Phase 3 & 4 completion |
| Negotiable | ✅ | Documentation scope flexible |
| Valuable | ✅ | Critical for onboarding |
| Estimable | ✅ | Clear documentation scope |
| Small | ✅ | 3 points, documentation only |
| Testable | ✅ | Documentation review |

## Story Points
3

## Priority
Medium

## Type
Documentation

## Dependencies
- All Phase 3 stories (22.4, 22.5, 22.6, 22.7a-c, 22.8, 22.9)
- All Phase 4 stories (22.10, 22.11)

## Background

After completing the refactoring work in Epic 22, documentation needs to reflect:
- New module structure
- New package locations
- Dependency diagrams
- Migration guides for deprecated APIs

## Acceptance Criteria

### AC1: Module Structure Documentation
```gherkin
Given the architecture documentation
When I review module-structure.md
Then it includes:
  - New campaign_management/ package
  - New risk_management/ package (heat tracker)
  - New cache/ package
  - New phase_detection/ package
  - New backtest/ and campaigns/ API route packages
  - New backtest/ and campaign_* model modules
```

### AC2: Dependency Diagrams Updated
```gherkin
Given the architecture diagrams
When I review component relationships
Then diagrams show:
  - CampaignStateManager dependencies
  - PortfolioHeatTracker dependencies
  - ValidationCache dependencies
  - PhaseDetector package structure
```

### AC3: Migration Notes
```gherkin
Given deprecated APIs
When I review migration documentation
Then each deprecated module has:
  - What is deprecated
  - What to use instead
  - Example code migration
  - Removal timeline
```

### AC4: CLAUDE.md Updated
```gherkin
Given the CLAUDE.md file
When I review its contents
Then it includes:
  - Updated backend directory structure
  - New package descriptions
  - Updated file locations
```

### AC5: README Updates
```gherkin
Given project README files
When I review them
Then they reference correct file locations
And any code examples use current imports
```

## Tasks / Subtasks

- [x] Update Module Structure Documentation
  - [x] Update `docs/architecture/module-structure.md`
  - [x] Add campaign_management package section
  - [x] Add risk_management package section
  - [x] Add cache package section
  - [x] Add phase_detection package section
  - [x] Update API routes section
  - [x] Update models section

- [x] Create/Update Architecture Diagrams
  - [x] Create campaign management component diagram
  - [x] Create phase detection component diagram
  - [x] Update overall system architecture diagram
  - [x] Add dependency arrows

- [x] Write Migration Guide
  - [x] Create `docs/architecture/migration-guide-epic22.md`
  - [x] Document phase_detector migration
  - [x] Document backtest.py model migration
  - [x] Document campaigns.py route migration
  - [x] Include code examples

- [x] Update CLAUDE.md
  - [x] Update backend directory structure section
  - [x] Add new package descriptions
  - [x] Update key file locations
  - [x] Update command references if needed

- [x] Review and Update READMEs
  - [x] Review backend/README.md (no changes needed - no README present)
  - [x] Update import examples (in migration guide)
  - [x] Update file references (in module-structure.md)

## Dev Notes

### Module Structure Updates

```markdown
# Module Structure (updated for Epic 22)

## Backend Package Structure

### Campaign Management (`backend/src/campaign_management/`)
New package for campaign lifecycle management.

- `campaign_state_manager.py` - State machine for campaign transitions
  - `CampaignStateManager` class
  - `StateTransitionError` exception
  - Valid state transitions

### Risk Management (`backend/src/risk_management/`)
Extended with portfolio heat tracking.

- `portfolio_heat_tracker.py` - Portfolio heat monitoring
  - `PortfolioHeatTracker` class
  - `HeatAlertState` enum
  - `HeatThresholds` dataclass

### Cache (`backend/src/cache/`)
New package for caching utilities.

- `validation_cache.py` - LRU cache with TTL
  - `ValidationCache` generic class
  - Thread-safe operations
  - Cache metrics

### Phase Detection (`backend/src/pattern_engine/phase_detection/`)
Consolidated phase detection package.

- `types.py` - Type definitions
- `event_detectors.py` - SC, AR, ST detection
- `phase_classifier.py` - Phase classification
- `confidence_scorer.py` - Confidence scoring
- `detector.py` - Main PhaseDetector class

### API Routes
Split into focused modules.

```
api/routes/
├── backtest/
│   ├── __init__.py
│   ├── preview.py
│   ├── full.py
│   ├── walk_forward.py
│   └── regression.py
└── campaigns/
    ├── __init__.py
    ├── lifecycle.py
    ├── analytics.py
    └── management.py
```

### Models
Organized into packages.

```
models/
├── backtest/
│   ├── __init__.py
│   ├── config.py
│   ├── results.py
│   ├── metrics.py
│   ├── walk_forward.py
│   └── regression.py
├── campaign_core.py
├── campaign_risk.py
├── campaign_performance.py
└── campaign_volume.py
```
```

### Migration Guide Template

```markdown
# Epic 22 Migration Guide

## Phase Detection Migration

### Before (Deprecated)
```python
from pattern_engine.phase_detector import PhaseDetector, detect_phase
from pattern_engine.phase_detector_v2 import PhaseDetectorV2

detector = PhaseDetector()
result = detect_phase(ohlcv_data)
```

### After (Recommended)
```python
from pattern_engine.phase_detection import PhaseDetector

detector = PhaseDetector()
result = detector.detect_phase(ohlcv_data)
```

### Deprecation Timeline
- v0.2.0: Deprecation warnings added
- v0.3.0: Old modules removed

## Backtest Models Migration

### Before
```python
from models.backtest import BacktestConfig, BacktestResult
```

### After (Both work)
```python
# Option 1: Package import (unchanged)
from models.backtest import BacktestConfig, BacktestResult

# Option 2: Submodule import (preferred for new code)
from models.backtest.config import BacktestConfig
from models.backtest.results import BacktestResult
```
```

### CLAUDE.md Updates

```markdown
### Backend (`backend/src/`)

- **campaign_management/** - Campaign state machine and lifecycle
- **pattern_engine/** - Wyckoff pattern detection
  - **phase_detection/** - Unified phase detection package
  - **detectors/** - Pattern-specific detectors
- **risk_management/** - Position sizing, heat tracking
- **cache/** - Caching utilities (validation cache)
- **api/** - FastAPI REST API + WebSocket
  - **routes/backtest/** - Backtest endpoint modules
  - **routes/campaigns/** - Campaign endpoint modules
- **models/** - Pydantic/SQLAlchemy models
  - **backtest/** - Backtest model package
  - **campaign_*.py** - Decomposed campaign models
```

### File Locations
- Architecture docs: `docs/architecture/`
- Migration guide: `docs/architecture/migration-guide-epic22.md`
- CLAUDE.md: `CLAUDE.md` (root)

## Testing

### Verification
1. All file paths in docs are valid
2. Code examples compile
3. Import statements work
4. Diagrams match actual structure

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 1.0 | Initial story creation | PO Agent |

## Dev Agent Record

### Implementation Summary

**Date**: 2026-02-01
**Agent**: Claude Code

### Files Created/Modified

1. **docs/architecture/module-structure.md** (Created)
   - Comprehensive module structure documentation for all Epic 22 packages
   - Includes campaign_management, cache, phase_detection, API routes, models
   - Contains dependency diagram showing layer relationships
   - Documents all classes/functions with descriptions

2. **docs/architecture/migration-guide-epic22.md** (Created)
   - Migration guide for deprecated APIs
   - Phase detection migration (phase_detector → phase_detection)
   - Backtest models migration
   - Campaign/backtest API routes migration
   - Portfolio heat tracker and validation cache migration
   - Deprecation timeline (v0.2.0 warnings, v0.3.0 removal)
   - Code examples for before/after patterns
   - FAQ section

3. **CLAUDE.md** (Updated)
   - Updated backend directory structure with new packages
   - Added cache/, campaign_management/, phase_detection/ descriptions
   - Added API route subpackages (backtest/, campaigns/)
   - Added model subpackages (backtest/, campaign_*.py)
   - Added recent development focus for Epic 22
   - Added key documentation references

4. **docs/stories/epic-22/22.12.update-architecture-documentation.md** (Updated)
   - Marked status as Complete
   - Checked off all tasks/subtasks

### Acceptance Criteria Verification

| AC | Status | Notes |
|----|--------|-------|
| AC1: Module Structure | ✅ | All packages documented in module-structure.md |
| AC2: Dependency Diagrams | ✅ | ASCII diagram added showing layer dependencies |
| AC3: Migration Notes | ✅ | migration-guide-epic22.md with code examples |
| AC4: CLAUDE.md Updated | ✅ | Backend structure and packages updated |
| AC5: README Updates | ✅ | No backend README exists; examples in migration guide |

## QA Results
_To be populated by QA agent_
