# Story 5.2: Spring Volume Validation (Non-Negotiable)

## Status
Done
DONE - **IMPLEMENTED IN STORY 5.1** - MERGED/ARCHIVED

**Rationale:** Story 5.1 already implements FR12 volume validation as a core requirement. The volume validation logic (<0.7x threshold) is implemented in [spring_detector.py:230-239](../../../backend/src/pattern_engine/detectors/spring_detector.py#L230-L239) as a non-negotiable binary rejection during spring detection. This story is marked as complete and merged into Story 5.1.

**Team Review:** Confirmed by team review on 2025-11-03 that Story 5.2 tasks duplicate existing Story 5.1 implementation. See [SCRUM-MASTER-UPDATE-REPORT.md](SCRUM-MASTER-UPDATE-REPORT.md#story-52-spring-volume-validation--merge-into-51) for details.

**Original Status:** Draft

## Story

**As a** spring detector,
**I want** to enforce strict volume validation rejecting springs with volume >=0.7x average,
**so that** high-volume breakdowns are never confused with springs (FR12).

## Acceptance Criteria

1. Volume check before any other validation: `if volume_ratio >= 0.7: return REJECT`
2. Rejection logged: "SPRING INVALID: Volume {volume_ratio}x >= 0.7x threshold (HIGH VOLUME = BREAKDOWN, NOT SPRING)"
3. No confidence degradation: this is binary pass/fail, not scored
4. Ideal volume range: 0.3x - 0.5x (low public interest)
5. Volume <0.3x: extremely bullish (ultra-low volume spring)
6. FR12 compliance: rejection reason includes specific threshold violated
7. Unit test: 0.69x volume passes, 0.70x volume rejects
8. Unit test: 0.71x volume with perfect other characteristics still rejected
9. Integration test: historical high-volume breakdowns correctly rejected
10. Logging: all volume rejections logged to audit trail

## Tasks / Subtasks

- [ ] **Task 1: Create Spring volume validation module** (AC: 1, 2, 3, 6)
  - [ ] Create file: `backend/src/pattern_engine/validators/spring_volume_validator.py`
  - [ ] Import required dependencies: Decimal, Tuple, structlog, OHLCVBar
  - [ ] Initialize structlog logger for structured logging
  - [ ] Create `SpringVolumeValidator` class
  - [ ] Define class constant: `VOLUME_REJECTION_THRESHOLD = Decimal("0.7")` (FR12)
  - [ ] Define class constant: `IDEAL_VOLUME_MIN = Decimal("0.3")` (AC 4)
  - [ ] Define class constant: `IDEAL_VOLUME_MAX = Decimal("0.5")` (AC 4)
  - [ ] Define class constant: `ULTRA_LOW_VOLUME_THRESHOLD = Decimal("0.3")` (AC 5)

- [ ] **Task 2: Implement core volume validation function** (AC: 1, 2, 3)
  - [ ] Create function: `validate_spring_volume(bar, volume_ratio, correlation_id) -> Tuple[bool, str | None]`
  - [ ] Add comprehensive docstring explaining FR12 enforcement
  - [ ] Implement AC 1: Volume check BEFORE any other validation
  - [ ] Implement AC 2: Specific rejection message format
  - [ ] Implement AC 3: Binary pass/fail (no confidence degradation)
  - [ ] Implement AC 10: Log rejection to audit trail with structured logging
  - [ ] Return `(True, None)` if volume passes
  - [ ] Return `(False, rejection_reason)` if volume >= 0.7x

- [ ] **Task 3: Implement volume quality classification** (AC: 4, 5)
  - [ ] Create function: `classify_volume_quality(volume_ratio) -> str`
  - [ ] Classify "ultra_low" for volume < 0.3x (AC 5)
  - [ ] Classify "ideal" for volume 0.3x-0.5x (AC 4)
  - [ ] Classify "acceptable" for volume 0.5x-0.69x
  - [ ] Classify "invalid" for volume >= 0.7x
  - [ ] Add docstring explaining quality levels and scoring implications

- [ ] **Task 4: Implement FR12 compliance logging** (AC: 6, 10)
  - [ ] Create function: `log_volume_audit(bar, volume_ratio, is_valid, rejection_reason, correlation_id)`
  - [ ] Log successful validations at INFO level with quality classification
  - [ ] Log rejections at WARNING level with FR12 compliance marker (AC 6)
  - [ ] Include specific threshold violated in rejection logs
  - [ ] Include correlation_id for distributed tracing
  - [ ] Bind symbol, timestamp, volume_ratio to logger context

- [ ] **Task 5: Create exception for edge cases** (AC: all)
  - [ ] Define custom exception: `SpringVolumeValidationError`
  - [ ] Validate bar parameter is OHLCVBar instance
  - [ ] Validate volume_ratio is Decimal type
  - [ ] Validate volume_ratio >= 0 (no negative values)
  - [ ] Raise exception for invalid inputs with descriptive messages

- [ ] **Task 6: Write unit test for volume threshold boundary** (AC: 7)
  - [ ] Create test file: `backend/tests/unit/pattern_engine/validators/test_spring_volume_validator.py`
  - [ ] Import pytest, Decimal, OHLCVBar, SpringVolumeValidator
  - [ ] Create pytest fixture for validator instance
  - [ ] Create pytest fixture for mock OHLCVBar
  - [ ] Test AC 7: 0.69x passes, 0.70x rejects
  - [ ] Verify rejection message format matches AC 2

- [ ] **Task 7: Write unit test for perfect characteristics rejection** (AC: 8)
  - [ ] Create mock bar with perfect spring characteristics
  - [ ] Test AC 8: Volume 0.71x rejects despite perfect other characteristics
  - [ ] Verify binary rejection (AC 3 - no confidence degradation)
  - [ ] Verify rejection message includes "BREAKDOWN"

- [ ] **Task 8: Write unit tests for volume quality classification** (AC: 4, 5)
  - [ ] Test AC 5: Ultra-low volume (<0.3x) classified as "ultra_low"
  - [ ] Test AC 4: Ideal volume (0.3x-0.5x) classified as "ideal"
  - [ ] Test acceptable volume (0.5x-0.69x) classified as "acceptable"
  - [ ] Test invalid volume (>=0.7x) classified as "invalid"
  - [ ] Verify all passing volumes return (True, None)

- [ ] **Task 9: Write unit test for FR12 logging compliance** (AC: 6, 10)
  - [ ] Test AC 6: Rejection reason includes specific threshold violated
  - [ ] Test AC 10: All rejections logged to audit trail
  - [ ] Use caplog fixture to verify structured logging
  - [ ] Verify WARNING level for rejections
  - [ ] Verify FR12 compliance marker in log records
  - [ ] Test multiple rejection scenarios logged correctly

- [ ] **Task 10: Write integration test with historical breakdown data** (AC: 9)
  - [ ] Create test file: `backend/tests/integration/pattern_engine/test_spring_volume_integration.py`
  - [ ] Create fixture file: `backend/tests/fixtures/high_volume_breakdowns.json`
  - [ ] Include real market breakdown examples (AAPL, TSLA, SPY)
  - [ ] Test AC 9: Historical high-volume breakdowns correctly rejected
  - [ ] Verify all high-volume penetrations return (False, rejection_reason)
  - [ ] Verify rejection messages match FR12 format

- [ ] **Task 11: Create helper function for volume validation summary** (AC: all)
  - [ ] Create function: `get_volume_validation_summary(volume_ratio) -> dict`
  - [ ] Return dict with: is_valid, quality, rejection_reason, threshold, distance_from_threshold
  - [ ] Include ideal_min and ideal_max thresholds in summary
  - [ ] Used by Story 5.1 for detailed logging
  - [ ] Used by Story 5.4 for confidence scoring calculation

- [ ] **Task 12: Add integration with VolumeAnalyzer from Epic 2** (AC: all)
  - [ ] Import VolumeAnalyzer from Story 2.5
  - [ ] Create wrapper function: `validate_spring_bar_volume(bar, bars_context, correlation_id)`
  - [ ] Integrate with VolumeAnalyzer to calculate volume_ratio
  - [ ] Use 20-bar rolling average for volume_ratio calculation (FR2)
  - [ ] Validate against spring thresholds and return result

- [ ] **Task 13: Add type hints and docstrings for all functions** (AC: all)
  - [ ] Use comprehensive type hints: Tuple, List, Dict, Decimal
  - [ ] Add module-level docstring explaining FR12 enforcement
  - [ ] Document all parameters, returns, and exceptions
  - [ ] Include usage examples in docstrings
  - [ ] Document integration with Story 2.1, 5.1, 5.4

- [ ] **Task 14: Write parametrized tests for volume range coverage** (AC: all)
  - [ ] Use pytest.mark.parametrize for comprehensive coverage
  - [ ] Test ultra-low volume: 0.1x, 0.2x, 0.29x
  - [ ] Test ideal volume: 0.3x, 0.4x, 0.5x
  - [ ] Test acceptable volume: 0.51x, 0.6x, 0.69x
  - [ ] Test rejection threshold: 0.70x, 0.71x
  - [ ] Test high volume breakdowns: 0.8x, 1.0x, 1.5x
  - [ ] Verify expected_valid and expected_quality for each test case

## Dev Notes

### Previous Story Context

**NOTE:** Story 5.1 has not been created yet. Story 5.2 is being created first per user request. Story 5.1 (Spring Pattern Detection Logic) will implement the overall spring detection function that will call this volume validator FIRST before checking other characteristics.

**Epic 2 Completion (Volume Spread Analysis Engine):**
[Source: Epic 2 Stories 2.1, 2.5]
- Story 2.1: `calculate_volume_ratio()` returns volume / 20-bar average (FR2)
- Story 2.5: `VolumeAnalyzer` provides unified volume analysis interface
- **Story 5.2 integration:** Use VolumeAnalyzer to get volume_ratio for validation
- Volume ratio calculation uses 20-bar rolling average (FR2 requirement)

**Epic 4 Completion (Phase Identification System):**
[Source: Epic 4, Story 4.4]
- Phase C validation: Springs only valid in Phase C (FR15)
- **Story 5.2 note:** This story focuses on volume validation only; phase validation is Story 5.1's responsibility

**Key Wyckoff Principle:**
[Source: PRD FR12]
- FR12: "Springs occur on LOW volume (<0.7x). High volume = breakdown, not spring."
- This is NON-NEGOTIABLE: volume >=0.7x = immediate rejection
- No confidence degradation - binary pass/fail validation

### Tech Stack & Dependencies

**Languages & Frameworks:**
[Source: [architecture/3-tech-stack.md](../../../docs/architecture/3-tech-stack.md#31-technology-stack-table)]
- Python 3.11+ (backend language)
- Pydantic 2.5+ (data models: OHLCVBar validation)
- pytest 8.0+ (testing framework)
- structlog 24.1+ (structured logging for FR12 audit trail)

**Module Locations:**
[Source: [architecture/10-unified-project-structure.md](../../../docs/architecture/10-unified-project-structure.md)]
- New Module: `backend/src/pattern_engine/validators/spring_volume_validator.py` (create new)
- Integration: Import from `backend/src/pattern_engine/volume_analyzer.py` (Story 2.5)
- Data Model: Import `OHLCVBar` from `backend/src/models/ohlcv.py`
- Unit Tests: `backend/tests/unit/pattern_engine/validators/test_spring_volume_validator.py` (create new)
- Integration Tests: `backend/tests/integration/pattern_engine/test_spring_volume_integration.py` (create new)
- Fixtures: `backend/tests/fixtures/high_volume_breakdowns.json` (create new)

**Dependencies on Existing Code:**
- `backend/src/models/ohlcv.py`: OHLCVBar model (Epic 1, Story 1.5)
- `backend/src/pattern_engine/volume_analyzer.py`: VolumeAnalyzer class (Epic 2, Story 2.5)
- Pydantic BaseModel for data validation
- structlog for structured logging with correlation IDs
- datetime.timezone for UTC timestamp handling
- decimal.Decimal for precise volume ratio calculations

### Data Models

**OHLCVBar Model:**
[Source: [architecture/4-data-models.md](../../../docs/architecture/4-data-models.md#41-ohlcvbar-candlestick-data)]

Key fields for Story 5.2:
- `volume_ratio`: Decimal - Pre-calculated by VolumeAnalyzer (Epic 2), used for validation
- `timestamp`: datetime (UTC) - For logging and audit trail
- `symbol`: str - For correlation in logs
- All price fields use Decimal for precision

### Algorithm Details

**Volume Validation Algorithm:**
[Source: Epic 5 AC 1-6, FR12]

```
Input: bar (OHLCVBar), volume_ratio (Decimal)

STEP 1: Validate Inputs
  - Verify bar is OHLCVBar instance
  - Verify volume_ratio is Decimal
  - Verify volume_ratio >= 0

STEP 2: Volume Threshold Check (AC 1 - FIRST check)
  IF volume_ratio >= 0.7:
    - Create rejection message (AC 2)
    - Log rejection with FR12 compliance marker (AC 6, 10)
    - Return (False, rejection_message)

STEP 3: Volume Passed (AC 3 - binary, no confidence degradation)
  - Log successful validation (AC 10)
  - Classify quality: ultra_low, ideal, or acceptable (AC 4, 5)
  - Return (True, None)

Output: (is_valid: bool, rejection_reason: str | None)
```

**Volume Quality Classification (AC 4, 5):**

- **Ultra-low** (<0.3x): Extremely bullish, ultra-low volume spring (AC 5)
- **Ideal** (0.3x-0.5x): Low public interest, classic spring profile (AC 4)
- **Acceptable** (0.5x-0.69x): Passes validation but not ideal
- **Invalid** (>=0.7x): REJECTION - high volume breakdown

### Wyckoff Context

**Spring Volume Principle:**
[Source: Wyckoff methodology and Epic 5 FR12]

> "A Spring is a downside penetration of support (Creek level) that quickly reverses. The KEY characteristic is LOW VOLUME. High volume on the penetration indicates aggressive selling (supply overwhelming demand) = BREAKDOWN. Low volume indicates lack of selling pressure = TEST of support (demand absorbing supply)."

**Volume Thresholds Explained:**

- **Ultra-Low Volume (<0.3x) - AC 5:** "Extremely bullish. Volume less than 30% of average shows almost NO public participation. This is 'smart money' testing support with minimal supply response. Very strong spring signal."

- **Ideal Volume (0.3x-0.5x) - AC 4:** "Classic spring volume profile. Public interest is low (30-50% of average volume). Professionals are testing support, public is not participating. This is the textbook spring volume signature."

- **Invalid Volume (>=0.7x) - FR12:** "HIGH VOLUME = BREAKDOWN, NOT SPRING. Volume 70%+ of average indicates significant selling pressure. This is supply overwhelming demand. The penetration below Creek is a true breakdown, not a test. MUST be rejected immediately per FR12."

**Why FR12 is Non-Negotiable:**

Trading high-volume penetrations as springs leads to:
1. Entering on breakdowns (losing trades)
2. Stop losses triggered immediately
3. False signals degrading system performance
4. Capital losses from misidentified patterns

Therefore, volume >=0.7x is BINARY REJECTION. No confidence degradation, no exceptions.

### Coding Standards

**Naming Conventions:**
[Source: [architecture/15-coding-standards.md](../../../docs/architecture/15-coding-standards.md#152-naming-conventions)]
- Python Classes: PascalCase (e.g., `SpringVolumeValidator`)
- Python Functions: snake_case (e.g., `validate_spring_volume`, `classify_volume_quality`)
- Constants: UPPER_SNAKE_CASE (e.g., `VOLUME_REJECTION_THRESHOLD`, `IDEAL_VOLUME_MIN`)

**Type Safety:**
[Source: [architecture/15-coding-standards.md](../../../docs/architecture/15-coding-standards.md#151-critical-fullstack-rules)]
- ✅ Use Decimal for financial calculations: `volume_ratio: Decimal`
- ✅ Use type hints: `def validate_spring_volume(...) -> Tuple[bool, str | None]`
- ✅ Use Pydantic models: `bar: OHLCVBar`
- ❌ DON'T use float for volume ratios (precision loss)

### Error Handling & Logging

**Logging Strategy (AC 6, 10):**
[Source: [architecture/3-tech-stack.md](../../../docs/architecture/3-tech-stack.md) - structlog]

```python
import structlog

logger = structlog.get_logger(__name__)

# Successful validation (info level)
logger.info(
    "spring_volume_validation_passed",
    symbol=bar.symbol,
    volume_ratio=str(volume_ratio),
    quality=quality,
    threshold=str(self.VOLUME_REJECTION_THRESHOLD)
)

# Rejection (warning level) - AC 10
logger.warning(
    "spring_volume_validation_failed",
    symbol=bar.symbol,
    volume_ratio=str(volume_ratio),
    threshold_violated=str(self.VOLUME_REJECTION_THRESHOLD),
    rejection_reason=rejection_reason,
    fr12_compliance="ENFORCED"  # AC 6: FR12 compliance marker
)
```

### Integration Notes

**Story 2.1 & 2.5 Dependencies (Volume Analysis):**
- Story 2.1 provides `calculate_volume_ratio()` using 20-bar average (FR2)
- Story 2.5 provides VolumeAnalyzer unified interface
- SpringVolumeValidator receives pre-calculated volume_ratio from VolumeAnalyzer

**Story 5.1 Dependencies (Spring Pattern Detection):**
- Story 5.1 will implement overall spring detection function
- **CRITICAL:** Story 5.1 MUST call SpringVolumeValidator FIRST (AC 1)
- Validation order: Volume → Penetration → Recovery → Phase
- If volume fails: immediate rejection, skip remaining checks

**Story 5.4 Dependencies (Spring Confidence Scoring):**
- Story 5.4 will use volume quality classification for confidence scoring
- SpringVolumeValidator provides `classify_volume_quality()` for Story 5.4
- Volume quality impacts confidence score (ultra_low=30pts, ideal=25pts, acceptable=15pts)

## Testing

### Test File Locations
[Source: [architecture/10-unified-project-structure.md](../../../docs/architecture/10-unified-project-structure.md)]
- Unit Tests: `backend/tests/unit/pattern_engine/validators/test_spring_volume_validator.py` (create new)
- Integration Tests: `backend/tests/integration/pattern_engine/test_spring_volume_integration.py` (create new)
- Fixtures: `backend/tests/fixtures/high_volume_breakdowns.json` (create new)

### Testing Framework
[Source: [architecture/3-tech-stack.md](../../../docs/architecture/3-tech-stack.md)]
- pytest 8.0+ for all Python testing
- pytest.mark.parametrize for comprehensive volume range testing
- pytest fixtures for mock OHLCVBar instances
- caplog fixture for verifying structured logging (AC 10)

### Test Coverage Requirements
- Unit test: Volume threshold boundary (AC 7) - 0.69x passes, 0.70x rejects
- Unit test: High volume rejection despite perfect characteristics (AC 8)
- Unit test: Ultra-low volume classification (AC 5)
- Unit test: Ideal volume range classification (AC 4)
- Unit test: FR12 logging compliance (AC 6, 10)
- Integration test: Historical breakdown rejection (AC 9)
- Parametrized test: Comprehensive volume range coverage
- Coverage goal: >95% for spring_volume_validator.py

### Testing Standards
[Source: [architecture/12-testing-strategy.md](../../../docs/architecture/12-testing-strategy.md)]
- Unit tests: Test validation logic with synthetic volume ratios
- Integration tests: Test with historical breakdown data
- Parametrized tests: Use pytest.mark.parametrize for volume range testing
- Assertion messages: Clear failure messages explaining which threshold failed
- Logging verification: Verify FR12 compliance markers in structured logs

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story creation with comprehensive volume validation, FR12 compliance logging, and integration with Epic 2 VolumeAnalyzer | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_This section will be populated by the development agent during implementation_

### Completion Notes List
_This section will be populated by the development agent during implementation_

### File List
_This section will be populated by the development agent during implementation_

## QA Results
_This section will be populated by the QA agent after story completion_
