# Story 12.6: Backtest Metrics and Reporting

## Status
Ready for Development

## Sprint Assignment

**Sprint 3** - Production Readiness

- Dependencies: Story 12.1 (Backtesting Engine)
- Parallel with: Stories 12.9, 12.7, 12.8
- Required by: Story 12.10 (Final Integration)

## Story
**As a** trader,
**I want** comprehensive backtest reports with equity curve and trade statistics,
**so that** I can evaluate system performance objectively.

## Acceptance Criteria
1. Equity curve: daily portfolio value plotted over time
2. Metrics: Total return %, CAGR, Sharpe ratio, Max drawdown, Win rate, Avg R, Profit factor
3. Trade list: all executed trades with entry/exit dates, P&L, R-multiple
4. Pattern breakdown: performance stats per pattern type
5. Monthly returns: heatmap showing return by month
6. Drawdown analysis: longest drawdown period, recovery time
7. Risk metrics: portfolio heat over time, max concurrent positions
8. Export: HTML report, PDF, CSV trade list
9. Component: `BacktestReport.tsx` for web display
10. API: GET /api/backtest/results/{id}

## Tasks / Subtasks

- [ ] **Task 1: Extend Backend Data Models for Comprehensive Reporting** (AC: 2, 3, 4, 5, 6, 7)
  - [ ] Subtask 1.1: Open `backend/src/models/backtest.py` (created in Story 12.1)
  - [ ] Subtask 1.2: Create `PatternPerformance` Pydantic model:
    - `pattern_type`: Literal["SPRING", "UTAD", "SOS", "LPS", "SC", "AR", "ST"]
    - `total_trades`: int (number of trades for this pattern type)
    - `winning_trades`: int
    - `losing_trades`: int
    - `win_rate`: Decimal (calculated: winning_trades / total_trades)
    - `avg_r_multiple`: Decimal (average R-multiple for this pattern)
    - `profit_factor`: Decimal (gross_profit / abs(gross_loss))
    - `total_pnl`: Decimal (sum of all P&L for this pattern)
    - `avg_trade_duration_hours`: Decimal
    - `best_trade_r`: Decimal (largest R-multiple winner)
    - `worst_trade_r`: Decimal (largest R-multiple loser)
  - [ ] Subtask 1.3: Create `MonthlyReturn` Pydantic model:
    - `year`: int (e.g., 2023)
    - `month`: int (1-12)
    - `month_label`: str (e.g., "Jan 2023")
    - `return_pct`: Decimal (percentage return for this month)
    - `trade_count`: int (number of trades closed in this month)
    - `winning_trades`: int
    - `losing_trades`: int
  - [ ] Subtask 1.4: Create `DrawdownPeriod` Pydantic model:
    - `drawdown_id`: UUID
    - `peak_date`: date (date of equity peak before drawdown)
    - `trough_date`: date (date of lowest equity in drawdown)
    - `recovery_date`: Optional[date] (date equity recovered to peak, None if not recovered)
    - `peak_value`: Decimal (portfolio value at peak)
    - `trough_value`: Decimal (portfolio value at trough)
    - `drawdown_pct`: Decimal ((peak - trough) / peak * 100)
    - `duration_days`: int (days from peak to trough)
    - `recovery_duration_days`: Optional[int] (days from trough to recovery)
    - `total_duration_days`: Optional[int] (peak to recovery, None if not recovered)
  - [ ] Subtask 1.5: Create `RiskMetrics` Pydantic model:
    - `max_concurrent_positions`: int (highest number of positions held simultaneously)
    - `avg_concurrent_positions`: Decimal
    - `max_portfolio_heat`: Decimal (highest portfolio heat % reached)
    - `avg_portfolio_heat`: Decimal
    - `max_position_size_pct`: Decimal (largest single position as % of portfolio)
    - `avg_position_size_pct`: Decimal
    - `max_capital_deployed_pct`: Decimal (highest % of capital in use)
    - `avg_capital_deployed_pct`: Decimal
  - [ ] Subtask 1.5a: **Create `CampaignPerformance` Pydantic model for Wyckoff campaign tracking**:
    - `campaign_id`: UUID (unique identifier for this campaign)
    - `campaign_type`: Literal["ACCUMULATION", "DISTRIBUTION"] (Wyckoff campaign type)
    - `symbol`: str (ticker where campaign occurred)
    - `start_date`: date (campaign start - PS or BC event)
    - `end_date`: Optional[date] (campaign end - Jump/Decline or current date if incomplete)
    - `status`: Literal["COMPLETED", "FAILED", "IN_PROGRESS"] (campaign outcome)
    - `total_patterns_detected`: int (number of Wyckoff patterns detected in campaign)
    - `patterns_traded`: int (patterns that resulted in trades)
    - `completion_stage`: str (highest phase reached: "Phase A", "Phase B", ..., "Markup/Markdown")
    - `avg_markup_return`: Optional[Decimal] (for ACCUMULATION campaigns that reached Markup)
    - `avg_markdown_return`: Optional[Decimal] (for DISTRIBUTION campaigns that reached Markdown)
    - `campaign_duration_days`: int (days from start to end/current)
    - `total_campaign_pnl`: Decimal (sum of P&L from all trades in this campaign)
    - `pattern_sequence`: List[str] (ordered list of patterns: ["PS", "SC", "AR", "SPRING", "SOS", "LPS", "JUMP"])
    - `failure_reason`: Optional[str] (if status=FAILED, why? "failed at LPS", "no SOS confirmation")
    - `risk_reward_realized`: Optional[Decimal] (actual R-multiple for full campaign)
    - `phases_completed`: List[str] (phases successfully completed: ["A", "B", "C", "D"])
  - [ ] Subtask 1.6: Extend `BacktestResult` model (add new fields):
    - `pattern_performance`: List[PatternPerformance] (performance breakdown by pattern type)
    - `monthly_returns`: List[MonthlyReturn] (monthly return heatmap data)
    - `drawdown_periods`: List[DrawdownPeriod] (all drawdown periods, sorted by severity)
    - `risk_metrics`: RiskMetrics (portfolio risk statistics)
    - `largest_winner`: Optional[BacktestTrade] (trade with highest P&L)
    - `largest_loser`: Optional[BacktestTrade] (trade with lowest P&L)
    - `longest_winning_streak`: int (consecutive winning trades)
    - `longest_losing_streak`: int (consecutive losing trades)
    - **Wyckoff Campaign Fields:**
    - `campaign_performance`: List[CampaignPerformance] (performance by complete Wyckoff campaigns)
    - `total_campaigns_detected`: int (total Accumulation + Distribution campaigns identified)
    - `completed_campaigns`: int (campaigns that reached Markup/Markdown)
    - `failed_campaigns`: int (campaigns that failed before completion)
    - `campaign_completion_rate`: Decimal (completed / total campaigns %)
    - `avg_campaign_duration_days`: Decimal (average days per campaign)
  - [ ] Subtask 1.7: Add Decimal precision validators [Source: architecture/15-coding-standards.md]
  - [ ] Subtask 1.8: Add UTC timestamp validators for all date fields
  - [ ] Subtask 1.9: Unit test all new models with Pydantic validation (pytest)
  - [ ] Subtask 1.10: Run `pydantic-to-typescript` to generate TypeScript types for frontend

- [ ] **Task 2: Backend - Enhanced Metrics Calculator** (AC: 2, 4, 5, 6, 7)
  - [ ] Subtask 2.1: Open `backend/src/backtesting/metrics.py` (created in Story 12.1)
  - [ ] Subtask 2.2: Extend `MetricsCalculator` class with new calculation methods
  - [ ] Subtask 2.3: Implement `calculate_pattern_performance(trades: List[BacktestTrade]) -> List[PatternPerformance]`:
    - Group trades by `pattern_type` field
    - For each pattern type, calculate: total_trades, winning_trades, losing_trades, win_rate, avg_r_multiple, profit_factor, total_pnl, avg_trade_duration
    - Calculate best_trade_r (max r_multiple) and worst_trade_r (min r_multiple)
    - Return list of PatternPerformance objects sorted by total_pnl descending
  - [ ] Subtask 2.4: Implement `calculate_monthly_returns(equity_curve: List[EquityCurvePoint], trades: List[BacktestTrade]) -> List[MonthlyReturn]`:
    - Extract year-month from equity_curve timestamps
    - For each month, calculate return: (end_value - start_value) / start_value * 100
    - Count trades closed in that month (based on exit_timestamp)
    - Generate month_label: "Jan 2023", "Feb 2023", etc.
    - Return list of MonthlyReturn objects sorted chronologically
  - [ ] Subtask 2.5: Implement `calculate_drawdown_periods(equity_curve: List[EquityCurvePoint]) -> List[DrawdownPeriod]`:
    - Track running peak portfolio value
    - Identify all periods where value drops below peak (drawdowns)
    - For each drawdown: record peak_date, trough_date, peak_value, trough_value, duration_days
    - Detect recovery_date when portfolio value returns to peak
    - Calculate recovery_duration_days and total_duration_days
    - Sort by drawdown_pct descending (worst drawdowns first)
    - Return list of DrawdownPeriod objects
  - [ ] Subtask 2.6: Implement `calculate_risk_metrics(equity_curve: List[EquityCurvePoint], trades: List[BacktestTrade]) -> RiskMetrics`:
    - Calculate max_concurrent_positions: track open positions at each equity curve point
    - Calculate avg_concurrent_positions: mean of concurrent positions over time
    - Calculate max_portfolio_heat: track portfolio heat at each point (sum of risk across open positions)
    - Calculate avg_portfolio_heat: mean portfolio heat over time
    - Calculate position sizing metrics: max_position_size_pct, avg_position_size_pct
    - Calculate capital deployment: max_capital_deployed_pct, avg_capital_deployed_pct
    - Return RiskMetrics object
  - [ ] Subtask 2.7: Implement `calculate_trade_streaks(trades: List[BacktestTrade]) -> Tuple[int, int]`:
    - Sort trades chronologically by exit_timestamp
    - Track consecutive winning trades (longest_winning_streak)
    - Track consecutive losing trades (longest_losing_streak)
    - Return (longest_winning_streak, longest_losing_streak)
  - [ ] Subtask 2.8: Implement `identify_extreme_trades(trades: List[BacktestTrade]) -> Tuple[Optional[BacktestTrade], Optional[BacktestTrade]]`:
    - Find largest_winner: trade with max(pnl)
    - Find largest_loser: trade with min(pnl)
    - Return (largest_winner, largest_loser)
  - [ ] Subtask 2.9: **Implement `calculate_campaign_performance(trades: List[BacktestTrade], campaigns: List[Campaign]) -> List[CampaignPerformance]`**:
    - Group trades by campaign_id (from trade metadata or pattern context)
    - For each campaign, calculate:
      - total_patterns_detected: count patterns in campaign
      - patterns_traded: count patterns that resulted in trades
      - completion_stage: highest phase reached
      - avg_markup_return (for ACCUMULATION) or avg_markdown_return (for DISTRIBUTION)
      - total_campaign_pnl: sum of all trade P&L in campaign
      - pattern_sequence: ordered list of patterns detected
      - status: COMPLETED (reached Markup/Markdown), FAILED (stopped before completion), IN_PROGRESS
      - failure_reason: if FAILED, identify why (e.g., "failed at LPS", "no SOS after Spring")
      - risk_reward_realized: actual R-multiple for full campaign (campaign_pnl / initial_risk)
      - phases_completed: list of phases successfully completed
    - Calculate aggregate metrics:
      - total_campaigns_detected
      - completed_campaigns (status=COMPLETED)
      - failed_campaigns (status=FAILED)
      - campaign_completion_rate: completed / total * 100
      - avg_campaign_duration_days
    - Return list of CampaignPerformance objects sorted by total_campaign_pnl descending
  - [ ] Subtask 2.10: Update `calculate_metrics()` method to call all new calculation functions
  - [ ] Subtask 2.11: Update BacktestResult construction to include all new fields including campaign_performance
  - [ ] Subtask 2.11: Use type hints and docstrings [Source: architecture/15-coding-standards.md]
  - [ ] Subtask 2.12: Add structlog logging for calculation progress [Source: architecture/3-tech-stack.md]

- [ ] **Task 3: Backend - HTML Report Generator** (AC: 8)
  - [ ] Subtask 3.1: Create `ReportGenerator` class in `backend/src/backtesting/report_generator.py`
  - [ ] Subtask 3.2: Install Jinja2 templating engine (add to `backend/pyproject.toml`)
  - [ ] Subtask 3.3: Create HTML template: `backend/src/backtesting/templates/backtest_report.html`
  - [ ] Subtask 3.4: Template sections:
    - Header: symbol, date range, initial capital
    - Summary metrics table: Total return, CAGR, Sharpe ratio, Max drawdown, Win rate, Avg R, Profit factor
    - Equity curve chart (using Chart.js or Plotly.js embedded)
    - Monthly returns heatmap table
    - Drawdown analysis table (top 5 worst drawdowns)
    - Pattern performance table (breakdown by pattern type)
    - Risk metrics summary
    - Trade list table (all trades with entry/exit, P&L, R-multiple)
    - Footer: generated timestamp, system version
  - [ ] Subtask 3.5: Implement `generate_html_report(backtest_result: BacktestResult) -> str`:
    - Load Jinja2 template
    - Prepare data: convert Decimal to float for charting, format dates
    - Render template with backtest_result data
    - Return HTML string
  - [ ] Subtask 3.6: Add CSS styling for professional appearance (embedded in template)
  - [ ] Subtask 3.7: Unit test: verify HTML generation with mock BacktestResult (pytest)

- [ ] **Task 4: Backend - PDF Export** (AC: 8)
  - [ ] Subtask 4.1: Install WeasyPrint library for HTML-to-PDF conversion (add to `backend/pyproject.toml`)
  - [ ] Subtask 4.2: Extend `ReportGenerator` class
  - [ ] Subtask 4.3: Implement `generate_pdf_report(backtest_result: BacktestResult) -> bytes`:
    - Generate HTML using `generate_html_report()`
    - Convert HTML to PDF using WeasyPrint
    - Return PDF as bytes
  - [ ] Subtask 4.4: Add PDF-specific CSS for print media (page breaks, sizing)
  - [ ] Subtask 4.5: Unit test: verify PDF generation produces valid PDF (pytest)

- [ ] **Task 5: Backend - CSV Trade List Export** (AC: 8)
  - [ ] Subtask 5.1: Extend `ReportGenerator` class
  - [ ] Subtask 5.2: Implement `generate_csv_trade_list(trades: List[BacktestTrade]) -> str`:
    - Define CSV columns: trade_id, symbol, pattern_type, entry_date, entry_price, exit_date, exit_price, quantity, pnl, commission, slippage, r_multiple
    - Use Python csv module or pandas to_csv()
    - Format dates as ISO 8601, Decimals as strings with 2-8 decimal places
    - Return CSV string
  - [ ] Subtask 5.3: Unit test: verify CSV format with mock trades (pytest)

- [ ] **Task 6: Backend - Report API Endpoints** (AC: 8, 10)
  - [ ] Subtask 6.1: Open `backend/src/api/routes/backtest.py` (created in Story 12.1)
  - [ ] Subtask 6.2: Create `GET /api/v1/backtest/results/{backtest_run_id}` endpoint (if not already exists from 12.1)
  - [ ] Subtask 6.3: Response: full BacktestResult with all new reporting fields
  - [ ] Subtask 6.4: Create `GET /api/v1/backtest/results/{backtest_run_id}/report/html` endpoint:
    - Retrieve BacktestResult from repository
    - Generate HTML report using ReportGenerator
    - Return HTML with Content-Type: text/html
  - [ ] Subtask 6.5: Create `GET /api/v1/backtest/results/{backtest_run_id}/report/pdf` endpoint:
    - Retrieve BacktestResult from repository
    - Generate PDF report using ReportGenerator
    - Return PDF with Content-Type: application/pdf, Content-Disposition: attachment
  - [ ] Subtask 6.6: Create `GET /api/v1/backtest/results/{backtest_run_id}/trades/csv` endpoint:
    - Retrieve BacktestResult from repository
    - Generate CSV trade list using ReportGenerator
    - Return CSV with Content-Type: text/csv, Content-Disposition: attachment
  - [ ] Subtask 6.7: Add query parameter `?format=summary` to main results endpoint for lightweight response (exclude equity_curve, trades arrays)
  - [ ] Subtask 6.8: Unit tests: test all endpoints with mock BacktestRepository (pytest)
  - [ ] Subtask 6.9: Integration test: run backtest, retrieve report in all formats via API (pytest)

- [ ] **Task 7: Frontend - Backtest Report Vue Component** (AC: 1, 2, 3, 4, 5, 6, 7, 9)
  - [ ] Subtask 7.1: Create `BacktestReport.vue` component in `frontend/src/components/backtest/BacktestReport.vue`
  - [ ] Subtask 7.2: Component structure: use PrimeVue Panel, Tabs, DataTable, Chart components
  - [ ] Subtask 7.3: Props: `backtest_result_id: string` (UUID of backtest to display)
  - [ ] Subtask 7.4: Use Composition API with setup() function
  - [ ] Subtask 7.5: Create composable `useBacktestReport.ts` for data fetching and state management
  - [ ] Subtask 7.6: Fetch BacktestResult from API: `GET /api/v1/backtest/results/{id}`
  - [ ] Subtask 7.7: Store result in reactive ref, handle loading and error states
  - [ ] Subtask 7.8: Create tab structure:
    - Tab 1: Summary (metrics cards, equity curve chart)
    - Tab 2: Trade List (DataTable with all trades)
    - Tab 3: Pattern Performance (table + bar chart)
    - Tab 4: Monthly Returns (heatmap table)
    - Tab 5: Drawdown Analysis (table + drawdown chart)
    - Tab 6: Risk Metrics (summary cards)

- [ ] **Task 8: Frontend - Equity Curve Chart Component** (AC: 1)
  - [ ] Subtask 8.1: Create `EquityCurveChart.vue` in `frontend/src/components/backtest/EquityCurveChart.vue`
  - [ ] Subtask 8.2: Props: `equity_curve: EquityCurvePoint[]`
  - [ ] Subtask 8.3: Use Lightweight Charts library (from tech stack) [Source: architecture/3-tech-stack.md]
  - [ ] Subtask 8.4: Create line chart:
    - X-axis: timestamp (dates)
    - Y-axis: portfolio_value (Decimal, converted to number for charting)
    - Line color: gradient (green for gains, red for losses)
  - [ ] Subtask 8.5: Add tooltip showing: date, portfolio value, daily return %, cumulative return %
  - [ ] Subtask 8.6: Add horizontal line for initial capital (baseline)
  - [ ] Subtask 8.7: Highlight drawdown periods with shaded areas
  - [ ] Subtask 8.8: Responsive sizing for different screen sizes
  - [ ] Subtask 8.9: Unit test: mount component with mock data (Vitest)

- [ ] **Task 9: Frontend - Summary Metrics Cards** (AC: 2)
  - [ ] Subtask 9.1: Create `MetricsCard.vue` component in `frontend/src/components/backtest/MetricsCard.vue`
  - [ ] Subtask 9.2: Props: `label: string`, `value: string | number`, `change_indicator: 'positive' | 'negative' | 'neutral'`
  - [ ] Subtask 9.3: Display metric with large value, smaller label
  - [ ] Subtask 9.4: Color coding: green for positive, red for negative, gray for neutral
  - [ ] Subtask 9.5: Use PrimeVue Card component for styling
  - [ ] Subtask 9.6: In BacktestReport.vue, create grid of MetricsCard components:
    - Total Return % (positive/negative based on value)
    - CAGR % (positive/negative)
    - Sharpe Ratio (positive if >1, neutral if 0-1, negative if <0)
    - Max Drawdown % (always negative indicator)
    - Win Rate % (positive if >50%, neutral if 40-50%, negative if <40%)
    - Avg R-Multiple (positive if >1, neutral if 0-1, negative if <0)
    - Profit Factor (positive if >1.5, neutral if 1-1.5, negative if <1)
    - Total Trades (neutral)
  - [ ] Subtask 9.7: Format numbers: percentages with 2 decimals, ratios with 2 decimals
  - [ ] Subtask 9.8: Use big.js for safe Decimal-to-number conversion [Source: architecture/15-coding-standards.md]

- [ ] **Task 10: Frontend - Trade List DataTable** (AC: 3)
  - [ ] Subtask 10.1: In BacktestReport.vue, add PrimeVue DataTable for trades
  - [ ] Subtask 10.2: Columns: Pattern Type, Symbol, Entry Date, Entry Price, Exit Date, Exit Price, Quantity, P&L, Commission, Slippage, R-Multiple
  - [ ] Subtask 10.3: Enable sorting on all columns
  - [ ] Subtask 10.4: Enable filtering: pattern type (multi-select), date range
  - [ ] Subtask 10.5: Enable pagination: 20 trades per page
  - [ ] Subtask 10.6: Color coding: green row for winning trades (pnl > 0), red row for losing trades (pnl < 0)
  - [ ] Subtask 10.7: Format P&L as currency: $1,234.56
  - [ ] Subtask 10.8: Format R-Multiple with 2 decimals: 2.45R
  - [ ] Subtask 10.9: Add export button: download trade list as CSV (using backend endpoint)
  - [ ] Subtask 10.10: Responsive table: horizontal scroll on mobile

- [ ] **Task 11: Frontend - Pattern Performance Table and Chart** (AC: 4)
  - [ ] Subtask 11.1: Create `PatternPerformanceTable.vue` in `frontend/src/components/backtest/PatternPerformanceTable.vue`
  - [ ] Subtask 11.2: Props: `pattern_performance: PatternPerformance[]`
  - [ ] Subtask 11.3: Use PrimeVue DataTable
  - [ ] Subtask 11.4: Columns: Pattern Type, Total Trades, Win Rate %, Avg R-Multiple, Profit Factor, Total P&L, Best Trade, Worst Trade
  - [ ] Subtask 11.5: Sort by Total P&L descending by default
  - [ ] Subtask 11.6: Color coding: green for positive P&L rows, red for negative P&L rows
  - [ ] Subtask 11.7: Create `PatternPerformanceChart.vue` for visual representation
  - [ ] Subtask 11.8: Use Chart.js or similar for bar chart [Source: architecture/3-tech-stack.md suggests PrimeVue includes charts]
  - [ ] Subtask 11.9: Bar chart: X-axis = pattern types, Y-axis = Total P&L
  - [ ] Subtask 11.10: Color bars: green for positive, red for negative

- [ ] **Task 12: Frontend - Monthly Returns Heatmap** (AC: 5)
  - [ ] Subtask 12.1: Create `MonthlyReturnsHeatmap.vue` in `frontend/src/components/backtest/MonthlyReturnsHeatmap.vue`
  - [ ] Subtask 12.2: Props: `monthly_returns: MonthlyReturn[]`
  - [ ] Subtask 12.3: Create HTML table structure:
    - Rows: years (e.g., 2020, 2021, 2022, 2023, 2024)
    - Columns: months (Jan, Feb, Mar, ..., Dec)
    - Cells: return_pct value
  - [ ] Subtask 12.4: Color coding: gradient from red (negative) to white (zero) to green (positive)
  - [ ] Subtask 12.5: Use color scale: -10% = dark red, 0% = white, +10% = dark green, scale linearly
  - [ ] Subtask 12.6: Display return % in each cell with 2 decimals
  - [ ] Subtask 12.7: Add tooltip on hover: month label, return %, trade count
  - [ ] Subtask 12.8: Add row summary: total annual return % for each year

- [ ] **Task 13: Frontend - Drawdown Analysis Components** (AC: 6)
  - [ ] Subtask 13.1: Create `DrawdownTable.vue` in `frontend/src/components/backtest/DrawdownTable.vue`
  - [ ] Subtask 13.2: Props: `drawdown_periods: DrawdownPeriod[]`
  - [ ] Subtask 13.3: Use PrimeVue DataTable
  - [ ] Subtask 13.4: Columns: Peak Date, Trough Date, Recovery Date, Drawdown %, Duration (days), Recovery Time (days), Status
  - [ ] Subtask 13.5: Status column: "Recovered" or "Not Recovered" based on recovery_date
  - [ ] Subtask 13.6: Color coding: darker red for larger drawdowns
  - [ ] Subtask 13.7: Sort by Drawdown % descending by default (worst drawdowns first)
  - [ ] Subtask 13.8: Show top 10 drawdowns only (most significant)
  - [ ] Subtask 13.9: Create `DrawdownChart.vue` for underwater equity chart
  - [ ] Subtask 13.10: Line chart showing drawdown % over time (Y-axis: 0% to -max_drawdown%, X-axis: dates)
  - [ ] Subtask 13.11: Shade drawdown areas in red gradient

- [ ] **Task 14: Frontend - Risk Metrics Display** (AC: 7)
  - [ ] Subtask 14.1: In BacktestReport.vue, create Risk Metrics section
  - [ ] Subtask 14.2: Display using MetricsCard components:
    - Max Concurrent Positions
    - Avg Concurrent Positions
    - Max Portfolio Heat %
    - Avg Portfolio Heat %
    - Max Position Size %
    - Avg Position Size %
    - Max Capital Deployed %
    - Avg Capital Deployed %
  - [ ] Subtask 14.3: Color coding: red if max portfolio heat > 10% (risk limit exceeded), yellow if 8-10%, green if <8%
  - [ ] Subtask 14.4: Add explanation tooltips for each metric

- [ ] **Task 15: Frontend - Report Export Actions** (AC: 8)
  - [ ] Subtask 15.1: In BacktestReport.vue, add toolbar with export buttons
  - [ ] Subtask 15.2: Button: "Export HTML Report"
    - Click → fetch `GET /api/v1/backtest/results/{id}/report/html`
    - Open HTML in new browser tab
  - [ ] Subtask 15.3: Button: "Export PDF Report"
    - Click → fetch `GET /api/v1/backtest/results/{id}/report/pdf`
    - Download PDF file with filename: `backtest-{symbol}-{date}.pdf`
  - [ ] Subtask 15.4: Button: "Export Trade List CSV"
    - Click → fetch `GET /api/v1/backtest/results/{id}/trades/csv`
    - Download CSV file with filename: `trades-{symbol}-{date}.csv`
  - [ ] Subtask 15.5: Use browser download API for file downloads
  - [ ] Subtask 15.6: Show loading spinner during export operations
  - [ ] Subtask 15.7: Show success/error toast notifications using PrimeVue Toast

- [ ] **Task 16: Frontend - Backtest Report View (Route)** (AC: 9)
  - [ ] Subtask 16.1: Create `BacktestView.vue` in `frontend/src/views/BacktestView.vue`
  - [ ] Subtask 16.2: Route: `/backtest/:backtest_run_id`
  - [ ] Subtask 16.3: Use BacktestReport component with backtest_run_id from route params
  - [ ] Subtask 16.4: Add breadcrumb navigation: Dashboard > Backtests > [Symbol - Date]
  - [ ] Subtask 16.5: Add back button to return to backtest list
  - [ ] Subtask 16.6: Handle loading state: show skeleton loaders while fetching data
  - [ ] Subtask 16.7: Handle error state: show error message if backtest not found (404)
  - [ ] Subtask 16.8: Add to Vue Router configuration in `frontend/src/router/index.ts`

- [ ] **Task 17: Frontend - Backtest List View** (AC: 10)
  - [ ] Subtask 17.1: Create `BacktestListView.vue` in `frontend/src/views/BacktestListView.vue`
  - [ ] Subtask 17.2: Route: `/backtests`
  - [ ] Subtask 17.3: Fetch backtest results list: `GET /api/v1/backtest/results` with pagination
  - [ ] Subtask 17.4: Display using PrimeVue DataTable
  - [ ] Subtask 17.5: Columns: Symbol, Date Range, Total Return %, Win Rate %, Avg R, Max Drawdown %, Created At, Actions
  - [ ] Subtask 17.6: Actions column: "View Report" button (navigate to /backtest/{id})
  - [ ] Subtask 17.7: Enable sorting and filtering on all columns
  - [ ] Subtask 17.8: Enable pagination: 20 results per page
  - [ ] Subtask 17.9: Add "Run New Backtest" button (navigate to backtest configuration page - future story)
  - [ ] Subtask 17.10: Add to Vue Router configuration

- [ ] **Task 18: Frontend - API Client Methods** (AC: 10)
  - [ ] Subtask 18.1: Open `frontend/src/services/api.ts` (API client service)
  - [ ] Subtask 18.2: Add method `getBacktestResult(backtest_run_id: string): Promise<BacktestResult>`
  - [ ] Subtask 18.3: Add method `getBacktestResults(limit: number, offset: number, symbol?: string): Promise<PaginatedResponse<BacktestResult>>`
  - [ ] Subtask 18.4: Add method `getBacktestReportHtml(backtest_run_id: string): Promise<string>`
  - [ ] Subtask 18.5: Add method `getBacktestReportPdf(backtest_run_id: string): Promise<Blob>`
  - [ ] Subtask 18.6: Add method `getBacktestTradesCsv(backtest_run_id: string): Promise<Blob>`
  - [ ] Subtask 18.7: Handle Decimal-to-BigNumber conversion for financial values [Source: architecture/15-coding-standards.md]
  - [ ] Subtask 18.8: Handle errors: 404 not found, 500 server error
  - [ ] Subtask 18.9: Use axios with proper error handling and TypeScript types

- [ ] **Task 19: Frontend - Composables for State Management** (AC: 9)
  - [ ] Subtask 19.1: Create `useBacktestReport.ts` in `frontend/src/composables/useBacktestReport.ts`
  - [ ] Subtask 19.2: Composable state: backtest_result (ref), loading (ref), error (ref)
  - [ ] Subtask 19.3: Method: `fetchBacktestResult(backtest_run_id: string)` - calls API, updates state
  - [ ] Subtask 19.4: Method: `exportHtml()` - triggers HTML report download
  - [ ] Subtask 19.5: Method: `exportPdf()` - triggers PDF download
  - [ ] Subtask 19.6: Method: `exportCsv()` - triggers CSV download
  - [ ] Subtask 19.7: Use Vue 3 Composition API reactivity
  - [ ] Subtask 19.8: Handle loading and error states gracefully
  - [ ] Subtask 19.9: Return composable interface: { backtest_result, loading, error, fetchBacktestResult, exportHtml, exportPdf, exportCsv }

- [ ] **Task 20: Backend - Unit Tests for Metrics Calculation** (AC: 2, 4, 5, 6, 7)
  - [ ] Subtask 20.1: Create `backend/tests/unit/test_metrics_calculator.py`
  - [ ] Subtask 20.2: Test `calculate_pattern_performance()`:
    - Create mock trades with various pattern types (SPRING, UTAD, SOS)
    - Verify correct grouping by pattern_type
    - Verify win_rate, avg_r_multiple, profit_factor calculations
    - Test edge case: pattern with zero trades
  - [ ] Subtask 20.3: Test `calculate_monthly_returns()`:
    - Create mock equity curve spanning multiple months
    - Verify correct monthly return calculations
    - Test edge case: month with no trades
    - Verify month_label formatting
  - [ ] Subtask 20.4: Test `calculate_drawdown_periods()`:
    - Create mock equity curve with known drawdowns
    - Verify correct identification of peak, trough, recovery dates
    - Verify drawdown_pct calculation
    - Test edge case: no drawdown (always increasing equity)
    - Test edge case: drawdown with no recovery (ends in drawdown)
  - [ ] Subtask 20.5: Test `calculate_risk_metrics()`:
    - Create mock equity curve and trades with varying position counts
    - Verify max_concurrent_positions calculation
    - Verify portfolio heat calculations
    - Test edge case: no positions ever (all cash)
  - [ ] Subtask 20.6: Test `calculate_trade_streaks()`:
    - Create trades: W W W L L W W W W L (W=winner, L=loser)
    - Verify longest_winning_streak = 4, longest_losing_streak = 2
    - Test edge case: all winning trades
    - Test edge case: all losing trades
  - [ ] Subtask 20.7: Test `identify_extreme_trades()`:
    - Create trades with known P&L values
    - Verify correct identification of largest winner and loser
  - [ ] Subtask 20.8: Use pytest fixtures and factory-boy for test data generation
  - [ ] Subtask 20.9: Follow pytest patterns [Source: architecture/12-testing-strategy.md]

- [ ] **Task 21: Backend - Unit Tests for Report Generation** (AC: 8)
  - [ ] Subtask 21.1: Create `backend/tests/unit/test_report_generator.py`
  - [ ] Subtask 21.2: Test `generate_html_report()`:
    - Create mock BacktestResult with all fields populated
    - Generate HTML report
    - Verify HTML contains expected sections: summary, equity curve, trade list, etc.
    - Verify HTML is valid (no unclosed tags)
    - Use BeautifulSoup for HTML parsing and validation
  - [ ] Subtask 21.3: Test `generate_pdf_report()`:
    - Generate PDF from mock BacktestResult
    - Verify PDF is valid (can be opened with PDF reader)
    - Verify PDF contains multiple pages
    - Use PyPDF2 or similar for PDF validation
  - [ ] Subtask 21.4: Test `generate_csv_trade_list()`:
    - Generate CSV from mock trades
    - Verify CSV format: correct headers, correct number of rows
    - Verify Decimal values formatted correctly
    - Parse CSV and validate data integrity

- [ ] **Task 22: Backend - Integration Tests for Report API** (AC: 8, 10)
  - [ ] Subtask 22.1: Create `backend/tests/integration/test_backtest_report_api.py`
  - [ ] Subtask 22.2: Test `GET /api/v1/backtest/results/{id}`:
    - Run full backtest (or use stored backtest result)
    - Fetch result via API
    - Verify response structure matches BacktestResult schema
    - Verify all new reporting fields present: pattern_performance, monthly_returns, drawdown_periods, risk_metrics
  - [ ] Subtask 22.3: Test `GET /api/v1/backtest/results/{id}/report/html`:
    - Fetch HTML report
    - Verify Content-Type: text/html
    - Verify HTML contains data from backtest
  - [ ] Subtask 22.4: Test `GET /api/v1/backtest/results/{id}/report/pdf`:
    - Fetch PDF report
    - Verify Content-Type: application/pdf
    - Verify Content-Disposition header for download
    - Verify PDF is valid
  - [ ] Subtask 22.5: Test `GET /api/v1/backtest/results/{id}/trades/csv`:
    - Fetch CSV trade list
    - Verify Content-Type: text/csv
    - Verify CSV is valid and parseable
  - [ ] Subtask 22.6: Test error cases: 404 for non-existent backtest_run_id
  - [ ] Subtask 22.7: Use pytest with FastAPI TestClient

- [ ] **Task 23: Frontend - Component Unit Tests** (AC: 9)
  - [ ] Subtask 23.1: Create `frontend/tests/components/backtest/BacktestReport.spec.ts`
  - [ ] Subtask 23.2: Test BacktestReport.vue:
    - Mount component with mock backtest_result_id
    - Mock API call to return mock BacktestResult
    - Verify component renders all tabs
    - Verify summary metrics displayed
    - Use Vitest + Vue Testing Library
  - [ ] Subtask 23.3: Test EquityCurveChart.vue:
    - Mount with mock equity_curve data
    - Verify chart renders (Lightweight Charts instance created)
    - Verify tooltip functionality
  - [ ] Subtask 23.4: Test MetricsCard.vue:
    - Mount with various props
    - Verify correct color coding for positive/negative/neutral
    - Verify number formatting
  - [ ] Subtask 23.5: Test PatternPerformanceTable.vue:
    - Mount with mock pattern_performance data
    - Verify table renders with correct columns
    - Verify sorting functionality
  - [ ] Subtask 23.6: Test MonthlyReturnsHeatmap.vue:
    - Mount with mock monthly_returns data
    - Verify heatmap table structure
    - Verify color coding gradient
  - [ ] Subtask 23.7: Follow Vitest patterns [Source: architecture/12-testing-strategy.md]

- [ ] **Task 24: Frontend - E2E Test for Backtest Report Workflow** (AC: 1-10)
  - [ ] Subtask 24.1: Create `frontend/tests/e2e/backtest-report.spec.ts`
  - [ ] Subtask 24.2: Use Playwright for E2E testing [Source: architecture/3-tech-stack.md]
  - [ ] Subtask 24.3: Test scenario: View backtest report
    - Navigate to /backtests (backtest list)
    - Click "View Report" on a backtest
    - Verify navigation to /backtest/{id}
    - Verify all report tabs load
    - Verify equity curve chart renders
    - Verify trade list table displays trades
  - [ ] Subtask 24.4: Test scenario: Export reports
    - Click "Export HTML Report" button
    - Verify new tab opens with HTML report
    - Click "Export PDF Report" button
    - Verify PDF download initiated
    - Click "Export Trade List CSV" button
    - Verify CSV download initiated
  - [ ] Subtask 24.5: Test scenario: Navigate between tabs
    - Click each tab (Summary, Trades, Patterns, Monthly, Drawdown, Risk)
    - Verify content loads for each tab
  - [ ] Subtask 24.6: Take screenshots for visual regression testing
  - [ ] Subtask 24.7: Test error handling: navigate to non-existent backtest ID, verify error message

- [ ] **Task 25: Database Migration for Extended Reporting Fields** (AC: 2-7)
  - [ ] Subtask 25.1: Create Alembic migration: `{timestamp}_extend_backtest_reporting.py`
  - [ ] Subtask 25.2: Extend `backtest_results` table with new JSONB columns:
    - `pattern_performance`: JSONB (stores List[PatternPerformance])
    - `monthly_returns`: JSONB (stores List[MonthlyReturn])
    - `drawdown_periods`: JSONB (stores List[DrawdownPeriod])
    - `risk_metrics`: JSONB (stores RiskMetrics)
    - `largest_winner`: JSONB (stores BacktestTrade)
    - `largest_loser`: JSONB (stores BacktestTrade)
    - `longest_winning_streak`: INTEGER
    - `longest_losing_streak`: INTEGER
  - [ ] Subtask 25.3: Add indexes for common queries: idx_backtest_symbol_created, idx_backtest_return
  - [ ] Subtask 25.4: Run migration: `alembic upgrade head`
  - [ ] Subtask 25.5: Verify schema matches data models

- [ ] **Task 26: Backend - Update BacktestRepository for New Fields** (AC: 2-7)
  - [ ] Subtask 26.1: Open `backend/src/repositories/backtest_repository.py` (created in Story 12.1)
  - [ ] Subtask 26.2: Update `save_result()` method to serialize new fields to JSONB
  - [ ] Subtask 26.3: Update `get_result()` method to deserialize new JSONB fields to Pydantic models
  - [ ] Subtask 26.4: Update `list_results()` to include summary fields (total_return_pct, win_rate, avg_r_multiple) for list view
  - [ ] Subtask 26.5: Add query method `get_result_summary(backtest_run_id)` for lightweight responses (excludes equity_curve, trades arrays)
  - [ ] Subtask 26.6: Unit tests: verify save/retrieve with full extended BacktestResult

- [ ] **Task 27: Documentation** (AC: All)
  - [ ] Subtask 27.1: Create `backend/docs/backtest-reporting.md` guide:
    - Explain backtest report structure
    - Document metrics definitions (CAGR, Sharpe ratio, profit factor, etc.)
    - Explain pattern performance breakdown
    - Explain monthly returns heatmap interpretation
    - Explain drawdown analysis and recovery time
    - Explain risk metrics (portfolio heat, capital deployment)
  - [ ] Subtask 27.2: Document ReportGenerator API usage
  - [ ] Subtask 27.3: Provide example of generating HTML/PDF/CSV reports programmatically
  - [ ] Subtask 27.4: Document API endpoints for report retrieval
  - [ ] Subtask 27.5: Add docstrings to all classes and methods in report_generator.py
  - [ ] Subtask 27.6: Update main project README with link to backtest reporting docs
  - [ ] Subtask 27.7: Add inline code comments explaining complex calculations (Sharpe ratio, drawdown detection)

- [ ] **Task 28: Performance Optimization** (AC: 1, 2)
  - [ ] Subtask 28.1: Optimize equity curve chart rendering for large datasets (>1000 points):
    - Use data downsampling for display (LTTB algorithm or similar)
    - Full data still available for export
  - [ ] Subtask 28.2: Optimize report generation performance:
    - Cache generated HTML/PDF reports for 5 minutes
    - Use in-memory cache (Redis in production, dict in MVP)
  - [ ] Subtask 28.3: Optimize database queries:
    - Use `?format=summary` query param to avoid loading full equity_curve/trades for list view
    - Add database indexes for common filters (symbol, created_at, total_return)
  - [ ] Subtask 28.4: Lazy load report tabs on frontend:
    - Only fetch tab data when user clicks tab
    - Improves initial load time for large reports
  - [ ] Subtask 28.5: Measure and log report generation times

- [ ] **Task 29: Error Handling and Edge Cases** (AC: All)
  - [ ] Subtask 29.1: Handle backtest with zero trades:
    - Metrics: set win_rate = 0, avg_r = 0, profit_factor = undefined
    - Report: show "No trades executed" message
    - Pattern performance: empty list
  - [ ] Subtask 29.2: Handle backtest with single trade:
    - Streaks: longest_winning_streak = 1 or 0 depending on trade outcome
    - Statistical metrics: Sharpe ratio may be undefined (single data point)
  - [ ] Subtask 29.3: Handle missing data:
    - If pattern_type missing on trade, classify as "UNKNOWN"
    - If exit_timestamp missing, trade is "OPEN" (shouldn't happen in backtest, but handle gracefully)
  - [ ] Subtask 29.4: Handle division by zero:
    - Profit factor: if total losses = 0, set profit_factor = "Infinity" or use special value
    - Win rate: if total trades = 0, set to 0
  - [ ] Subtask 29.5: Handle report generation failures:
    - If HTML/PDF generation fails, return 500 error with message
    - Log error details for debugging
    - Graceful degradation: offer CSV export as fallback

- [ ] **Task 30: Integration with BacktestEngine** (AC: All)
  - [ ] Subtask 30.1: Open `backend/src/backtesting/engine.py` (created in Story 12.1)
  - [ ] Subtask 30.2: Ensure BacktestEngine calls extended MetricsCalculator after backtest completes
  - [ ] Subtask 30.3: Populate all new BacktestResult fields: pattern_performance, monthly_returns, drawdown_periods, risk_metrics, extreme trades, streaks
  - [ ] Subtask 30.4: Verify equity_curve is populated during event loop (one EquityCurvePoint per bar)
  - [ ] Subtask 30.5: Integration test: run full backtest, verify BacktestResult contains all reporting data

## Dev Notes

### Epic 12 Context

This story is part of Epic 12: Backtesting & Validation Framework. Story 12.6 delivers comprehensive reporting and visualization capabilities for backtest results, enabling traders to objectively evaluate system performance. This story depends on Story 12.1 (Custom Backtesting Engine Architecture) which provides the foundation: BacktestEngine, BacktestResult, BacktestMetrics, and BacktestTrade models.

**Dependencies:**
- Story 12.1 MUST be complete - provides BacktestEngine, core data models, API endpoints
- This story EXTENDS the BacktestResult model with additional reporting fields
- Frontend components integrate with backtest API endpoints from Story 12.1

### Previous Story Context

**Story 12.1 (Custom Backtesting Engine Architecture)** provides the foundation:
[Source: docs/stories/epic-12/12.1.custom-backtesting-engine-architecture.md]
- BacktestEngine class with `run_backtest()` method
- Core Pydantic models: BacktestConfig, BacktestResult, BacktestMetrics, BacktestTrade, EquityCurvePoint
- API endpoint: `POST /api/v1/backtest/run` - starts backtest
- API endpoint: `GET /api/v1/backtest/results/{id}` - retrieves result (basic version)
- BacktestRepository for database storage
- MetricsCalculator for basic metrics: total_return, CAGR, Sharpe, max_drawdown, win_rate, avg_r, profit_factor

**This story builds on 12.1 by:**
- EXTENDING data models with comprehensive reporting fields
- ENHANCING MetricsCalculator with pattern performance, monthly returns, drawdown analysis, risk metrics
- ADDING report generation capabilities (HTML, PDF, CSV)
- CREATING frontend components for rich data visualization

### Tech Stack - Reporting

[Source: docs/architecture/3-tech-stack.md]

**Backend Technologies:**
- FastAPI 0.109+ for REST API endpoints
- Pydantic 2.5+ for data models and TypeScript type generation
- Jinja2 for HTML templating
- WeasyPrint for HTML-to-PDF conversion
- pandas 2.2+ for data manipulation (monthly returns, drawdown analysis)
- PostgreSQL 15+ with JSONB for storing complex reporting structures
- pytest 8.0+ for backend testing

**Frontend Technologies:**
- Vue 3.4+ with Composition API for reactive components
- TypeScript 5.3+ for type-safe frontend
- PrimeVue 3.50+ for UI components (DataTable, Chart, Panel, Tabs)
- Lightweight Charts 4.1+ for equity curve visualization (TradingView-style)
- Chart.js or PrimeVue Charts for pattern performance bar charts
- Vite 5.0+ for build tooling
- Vitest 1.2+ for component unit tests
- Playwright 1.41+ for E2E tests

**Additional Libraries:**
- big.js for safe Decimal-to-number conversion on frontend [Source: architecture/15-coding-standards.md]
- axios (via httpx in api.ts) for HTTP client
- structlog 24.1+ for backend logging [Source: architecture/3-tech-stack.md]

### Data Models - Extended Reporting

[Source: docs/architecture/4-data-models.md, Story 12.1]

All models use `Decimal` for financial values and `datetime` with UTC timezone enforcement.

**New Pydantic Models** (added to `backend/src/models/backtest.py`):

```python
from decimal import Decimal
from datetime import datetime, date
from typing import List, Optional, Literal
from pydantic import BaseModel, Field
from uuid import UUID

class PatternPerformance(BaseModel):
    pattern_type: Literal["SPRING", "UTAD", "SOS", "LPS", "SC", "AR", "ST"]
    total_trades: int
    winning_trades: int
    losing_trades: int
    win_rate: Decimal = Field(..., decimal_places=4, max_digits=6)
    avg_r_multiple: Decimal = Field(..., decimal_places=4, max_digits=10)
    profit_factor: Decimal = Field(..., decimal_places=4, max_digits=10)
    total_pnl: Decimal = Field(..., decimal_places=2, max_digits=18)
    avg_trade_duration_hours: Decimal = Field(..., decimal_places=2, max_digits=10)
    best_trade_r: Decimal = Field(..., decimal_places=4, max_digits=10)
    worst_trade_r: Decimal = Field(..., decimal_places=4, max_digits=10)

class MonthlyReturn(BaseModel):
    year: int
    month: int  # 1-12
    month_label: str  # "Jan 2023"
    return_pct: Decimal = Field(..., decimal_places=2, max_digits=8)
    trade_count: int
    winning_trades: int
    losing_trades: int

class DrawdownPeriod(BaseModel):
    drawdown_id: UUID
    peak_date: date
    trough_date: date
    recovery_date: Optional[date] = None
    peak_value: Decimal = Field(..., decimal_places=2, max_digits=18)
    trough_value: Decimal = Field(..., decimal_places=2, max_digits=18)
    drawdown_pct: Decimal = Field(..., decimal_places=2, max_digits=6)
    duration_days: int
    recovery_duration_days: Optional[int] = None
    total_duration_days: Optional[int] = None

class RiskMetrics(BaseModel):
    max_concurrent_positions: int
    avg_concurrent_positions: Decimal = Field(..., decimal_places=2, max_digits=6)
    max_portfolio_heat: Decimal = Field(..., decimal_places=4, max_digits=6)
    avg_portfolio_heat: Decimal = Field(..., decimal_places=4, max_digits=6)
    max_position_size_pct: Decimal = Field(..., decimal_places=4, max_digits=6)
    avg_position_size_pct: Decimal = Field(..., decimal_places=4, max_digits=6)
    max_capital_deployed_pct: Decimal = Field(..., decimal_places=4, max_digits=6)
    avg_capital_deployed_pct: Decimal = Field(..., decimal_places=4, max_digits=6)

# Extended BacktestResult (from Story 12.1, add new fields)
class BacktestResult(BaseModel):
    # ... existing fields from Story 12.1 ...
    # NEW FIELDS:
    pattern_performance: List[PatternPerformance]
    monthly_returns: List[MonthlyReturn]
    drawdown_periods: List[DrawdownPeriod]
    risk_metrics: RiskMetrics
    largest_winner: Optional[BacktestTrade] = None
    largest_loser: Optional[BacktestTrade] = None
    longest_winning_streak: int
    longest_losing_streak: int
```

### File Locations

[Source: docs/architecture/10-unified-project-structure.md]

**Backend Files to Create/Modify:**

```
backend/
├── src/
│   ├── api/routes/
│   │   └── backtest.py                     # MODIFY: Add report endpoints
│   ├── models/
│   │   └── backtest.py                     # MODIFY: Add reporting models
│   ├── repositories/
│   │   └── backtest_repository.py          # MODIFY: Save/load extended fields
│   ├── backtesting/
│   │   ├── engine.py                       # MODIFY: Populate extended result fields
│   │   ├── metrics.py                      # MODIFY: Add advanced calculations
│   │   ├── report_generator.py             # CREATE: HTML/PDF/CSV generation
│   │   └── templates/
│   │       └── backtest_report.html        # CREATE: Jinja2 template
├── tests/
│   ├── unit/
│   │   ├── test_metrics_calculator.py      # CREATE: Test extended metrics
│   │   └── test_report_generator.py        # CREATE: Test report generation
│   └── integration/
│       └── test_backtest_report_api.py     # CREATE: Test report API
└── alembic/versions/
    └── {timestamp}_extend_backtest_reporting.py  # CREATE: Migration
```

**Frontend Files to Create:**

```
frontend/
├── src/
│   ├── components/backtest/                # CREATE: New folder
│   │   ├── BacktestReport.vue              # CREATE: Main report component
│   │   ├── EquityCurveChart.vue            # CREATE: Equity curve chart
│   │   ├── MetricsCard.vue                 # CREATE: Metric display card
│   │   ├── PatternPerformanceTable.vue     # CREATE: Pattern breakdown
│   │   ├── PatternPerformanceChart.vue     # CREATE: Pattern bar chart
│   │   ├── MonthlyReturnsHeatmap.vue       # CREATE: Heatmap table
│   │   ├── DrawdownTable.vue               # CREATE: Drawdown list
│   │   └── DrawdownChart.vue               # CREATE: Underwater equity chart
│   ├── composables/
│   │   └── useBacktestReport.ts            # CREATE: Backtest report composable
│   ├── services/
│   │   └── api.ts                          # MODIFY: Add backtest report methods
│   ├── types/                              # AUTO-GENERATED from Pydantic
│   │   ├── PatternPerformance.ts
│   │   ├── MonthlyReturn.ts
│   │   ├── DrawdownPeriod.ts
│   │   ├── RiskMetrics.ts
│   │   └── BacktestResult.ts (extended)
│   └── views/
│       ├── BacktestView.vue                # CREATE: Single backtest report view
│       └── BacktestListView.vue            # CREATE: Backtest results list
├── tests/
│   ├── components/backtest/
│   │   ├── BacktestReport.spec.ts          # CREATE: Component tests
│   │   ├── EquityCurveChart.spec.ts
│   │   └── MetricsCard.spec.ts
│   └── e2e/
│       └── backtest-report.spec.ts         # CREATE: E2E test
```

### API Endpoints - Reporting

[Source: docs/architecture/5-api-specification.md]

**New/Extended Endpoints:**

```
GET /api/v1/backtest/results/{backtest_run_id}
  - Returns: Full BacktestResult with all extended reporting fields
  - Query params: ?format=summary (excludes equity_curve, trades arrays)

GET /api/v1/backtest/results/{backtest_run_id}/report/html
  - Returns: HTML report (Content-Type: text/html)
  - Opens in browser for viewing

GET /api/v1/backtest/results/{backtest_run_id}/report/pdf
  - Returns: PDF report (Content-Type: application/pdf)
  - Content-Disposition: attachment (triggers download)

GET /api/v1/backtest/results/{backtest_run_id}/trades/csv
  - Returns: CSV trade list (Content-Type: text/csv)
  - Content-Disposition: attachment

GET /api/v1/backtest/results
  - Returns: Paginated list of backtest results (summary format)
  - Query params: limit, offset, symbol (optional filter)
```

### Reporting Components - Frontend

[Source: docs/architecture/6-components.md]

**BacktestReport.vue** - Main report component:
- Uses PrimeVue Tabs for multi-section layout
- Tabs: Summary, Trade List, Pattern Performance, Monthly Returns, Drawdown Analysis, Risk Metrics
- Fetches data via useBacktestReport composable
- Handles loading and error states

**EquityCurveChart.vue** - Equity curve visualization:
- Uses Lightweight Charts (TradingView-style) [Source: architecture/3-tech-stack.md]
- Line chart: X-axis = dates, Y-axis = portfolio value
- Highlights drawdown periods with shaded areas
- Tooltip shows: date, value, daily return, cumulative return

**MetricsCard.vue** - Reusable metric display:
- Props: label, value, change_indicator (positive/negative/neutral)
- Color coding: green/red/gray based on indicator
- Used for summary metrics grid

**PatternPerformanceTable.vue** - Pattern breakdown table:
- PrimeVue DataTable with sorting
- Columns: Pattern Type, Total Trades, Win Rate, Avg R, Profit Factor, Total P&L, Best/Worst Trades
- Color coding: green for positive P&L, red for negative

**MonthlyReturnsHeatmap.vue** - Monthly returns visualization:
- HTML table: Rows = years, Columns = months
- Color gradient: red (negative) → white (zero) → green (positive)
- Displays return % in each cell

**DrawdownTable.vue** - Drawdown periods list:
- PrimeVue DataTable sorted by severity
- Shows top 10 worst drawdowns
- Columns: Peak Date, Trough Date, Recovery Date, Drawdown %, Duration, Status

### Metrics Definitions

**CAGR (Compound Annual Growth Rate):**
- Formula: ((final_value / initial_capital) ^ (1 / years)) - 1
- Example: 100k → 150k over 2 years = ((150k/100k)^(1/2)) - 1 = 22.5% CAGR

**Sharpe Ratio:**
- Formula: (avg_daily_return - risk_free_rate) / std_dev * sqrt(252)
- Risk-free rate: typically 0% for simplicity or 2% annual (treasury rate)
- Annualized using sqrt(252) trading days
- Interpretation: >1 = good, >2 = very good, >3 = excellent

**Profit Factor:**
- Formula: sum(winning_pnl) / abs(sum(losing_pnl))
- Interpretation: >1 = profitable, >1.5 = good, >2 = excellent
- If no losses, profit factor = Infinity (handle as special case)

**Max Drawdown:**
- Largest peak-to-trough decline in portfolio value
- Formula: (peak_value - trough_value) / peak_value * 100
- Example: Peak 150k, Trough 120k → Drawdown = (150k-120k)/150k = 20%

**Portfolio Heat:**
- Sum of risk across all open positions
- Risk per position = (entry_price - stop_loss) * quantity / portfolio_value
- Example: 3 positions with 2% risk each = 6% portfolio heat
- Risk limit: 10% maximum (configurable)

### Report Generation - HTML/PDF

**HTML Template Structure:**
[Source: Jinja2 templating best practices]

```html
<!DOCTYPE html>
<html>
<head>
    <title>Backtest Report - {{ symbol }} - {{ start_date }} to {{ end_date }}</title>
    <style>
        /* Embedded CSS for styling */
        /* Chart.js or Plotly.js CDN for charts */
    </style>
</head>
<body>
    <h1>Backtest Report</h1>
    <section class="summary">
        <h2>Summary Metrics</h2>
        <div class="metrics-grid">
            <div>Total Return: {{ metrics.total_return_pct }}%</div>
            <div>CAGR: {{ metrics.cagr }}%</div>
            <!-- ... other metrics ... -->
        </div>
    </section>
    <section class="equity-curve">
        <h2>Equity Curve</h2>
        <canvas id="equityCurveChart"></canvas>
        <script>
            // Chart.js or Plotly.js code to render chart
            const data = {{ equity_curve | tojson }};
            // Render chart...
        </script>
    </section>
    <section class="trade-list">
        <h2>Trade List</h2>
        <table>
            <thead>
                <tr><th>Date</th><th>Symbol</th><th>Pattern</th><th>P&L</th><th>R</th></tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                <tr>
                    <td>{{ trade.entry_timestamp }}</td>
                    <td>{{ trade.symbol }}</td>
                    <td>{{ trade.pattern_type }}</td>
                    <td>${{ trade.pnl }}</td>
                    <td>{{ trade.r_multiple }}R</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    <!-- Additional sections: monthly returns, drawdowns, pattern performance -->
</body>
</html>
```

**PDF Generation:**
- Use WeasyPrint to convert HTML to PDF
- WeasyPrint renders HTML/CSS to PDF format
- Add print-specific CSS: `@media print { ... }` for page breaks, sizing
- Considerations: Charts must be embedded as images (not interactive JavaScript)

**CSV Export:**
- Use Python `csv` module or `pandas.to_csv()`
- Format: standard CSV with headers
- Decimal precision: 2-8 decimal places depending on field
- Date format: ISO 8601 (YYYY-MM-DD)

### Coding Standards

[Source: docs/architecture/15-coding-standards.md]

**Decimal Precision:**
- Use `Decimal` type in Python for ALL financial calculations
- NEVER use `float` for prices, P&L, returns
- Frontend: Use `big.js` library for Decimal-to-number conversion
- Example: `parseDecimal(value: string): Big { return new Big(value); }`

**Naming Conventions:**
- Python Classes: PascalCase (e.g., `ReportGenerator`, `PatternPerformance`)
- Python Functions: snake_case (e.g., `calculate_monthly_returns`, `generate_html_report`)
- Vue Components: PascalCase (e.g., `BacktestReport.vue`, `EquityCurveChart.vue`)
- Composables: camelCase with 'use' prefix (e.g., `useBacktestReport.ts`)
- API Routes: kebab-case (e.g., `/api/v1/backtest/results/{id}/report/html`)

**Type Safety:**
- Use strict type hints on all Python functions
- Use TypeScript interfaces for all frontend data structures
- Auto-generate TypeScript types from Pydantic models using `pydantic-to-typescript`

**API Client:**
- Use `apiClient` from `frontend/src/services/api.ts` for all API calls
- NEVER use direct `fetch()` calls [Source: architecture/15-coding-standards.md]

### Testing Strategy

[Source: docs/architecture/12-testing-strategy.md]

**Backend Unit Tests (pytest):**
- Location: `backend/tests/unit/`
- Coverage target: 90%+ (NFR8)
- Test: metrics calculations, report generation, edge cases
- Use pytest-mock for mocking BacktestResult data
- Use factory-boy for generating synthetic trades, equity curves

**Backend Integration Tests (pytest):**
- Location: `backend/tests/integration/`
- Test full API workflow: run backtest → retrieve result → generate reports
- Verify report formats (HTML valid, PDF valid, CSV parseable)
- Use FastAPI TestClient

**Frontend Component Tests (Vitest):**
- Location: `frontend/tests/components/`
- Test component rendering with mock data
- Test user interactions (tab switching, sorting, filtering)
- Use Vue Testing Library

**E2E Tests (Playwright):**
- Location: `frontend/tests/e2e/`
- Test full user workflow: navigate to backtest list → view report → export PDF
- Verify charts render, tables display data
- Screenshot tests for visual regression

### Performance Considerations

**Report Generation Performance:**
- HTML generation: <100ms for typical backtest (100 trades, 1000 equity points)
- PDF generation: <500ms (WeasyPrint conversion overhead)
- CSV generation: <50ms

**Frontend Rendering:**
- Equity curve with 1000+ points: use downsampling for display (LTTB algorithm)
- Lazy load tabs: only fetch data when tab clicked (reduces initial load time)
- Pagination for trade list: 20-50 trades per page

**Database Optimization:**
- Store complex structures (equity_curve, trades, pattern_performance) as JSONB
- Use `?format=summary` query param to exclude large arrays for list views
- Add indexes: idx_backtest_symbol_created, idx_backtest_return

**Caching:**
- Cache generated HTML/PDF reports for 5 minutes (in-memory or Redis)
- Cache key: backtest_run_id + format type
- Invalidate cache if backtest result updated (unlikely in read-only reporting)

### Error Handling

**Backend Errors:**
- 404 Not Found: backtest_run_id doesn't exist
- 500 Internal Server Error: report generation failed (log error, return message)
- Handle division by zero in metrics (profit_factor, win_rate)
- Handle empty trade lists (no trades executed)

**Frontend Errors:**
- Display error message if backtest not found (404)
- Display loading spinner during report generation
- Show toast notification on export success/failure
- Graceful degradation: if PDF fails, offer HTML or CSV as fallback

**Edge Cases:**
- Backtest with zero trades: show "No trades executed" message
- Backtest with single trade: handle streak calculations (streaks = 1 or 0)
- Backtest ending in drawdown: recovery_date = None (show "Not Recovered")
- Pattern with zero trades: exclude from pattern_performance list or show 0 values

### Dependencies

**Story 12.1 (Custom Backtesting Engine Architecture) MUST be complete:**
- Provides BacktestEngine, BacktestResult, BacktestMetrics, BacktestTrade
- Provides API endpoints: POST /backtest/run, GET /backtest/results/{id}
- Provides BacktestRepository for database storage

**This story extends Story 12.1:**
- Adds new fields to BacktestResult model
- Extends MetricsCalculator with advanced calculations
- Adds report generation capabilities (HTML, PDF, CSV)
- Creates frontend visualization components

### Notes for Developer

**Implementation Order:**
1. Extend backend data models (PatternPerformance, MonthlyReturn, DrawdownPeriod, RiskMetrics)
2. Enhance MetricsCalculator with advanced calculations
3. Update BacktestEngine to populate extended result fields
4. Create ReportGenerator for HTML/PDF/CSV export
5. Add report API endpoints
6. Update BacktestRepository for new fields
7. Database migration for extended schema
8. Generate TypeScript types from Pydantic models
9. Create frontend components (BacktestReport, charts, tables)
10. Create composables for data fetching
11. Add views and routes
12. Write comprehensive tests (unit, integration, E2E)
13. Documentation

**Key Considerations:**
- Maintain backwards compatibility: existing BacktestResult records may not have new fields (handle gracefully)
- Use JSONB for complex nested structures (efficient storage, flexible schema)
- Auto-generate TypeScript types to maintain frontend/backend type contract
- Use PrimeVue components for consistent UI (DataTable, Chart, Panel, Tabs)
- Use Lightweight Charts for financial-style equity curve
- Follow Decimal precision standards: NEVER use float for financial values

**Testing Approach:**
- Unit test each metrics calculation function independently
- Integration test full backtest → report generation → API retrieval flow
- Component test each Vue component with mock data
- E2E test complete user workflow from list view to export

**Documentation:**
- Explain what each metric means (CAGR, Sharpe, profit factor)
- Provide interpretation guidelines (what's a good Sharpe ratio?)
- Document API endpoints with OpenAPI/Swagger
- Add inline comments for complex calculations

### Wyckoff Campaign Performance Tracking (CRITICAL)

The enhanced BacktestResult model now includes **campaign-level performance tracking** to analyze complete Wyckoff Accumulation and Distribution campaigns, not just isolated pattern trades:

**Why Campaign-Level Tracking Matters**:

- **Patterns are part of campaigns** - A Spring pattern in isolation means little; it's part of an Accumulation campaign
- **Campaign completion rates** - How often do Accumulation campaigns successfully reach Markup phase?
- **Sequential validation** - Did the campaign follow proper Wyckoff sequence (PS → SC → AR → Spring → SOS → LPS → Jump)?
- **Campaign profitability** - What's the total P&L for a complete campaign vs individual pattern trades?
- **Failure analysis** - Where do campaigns typically fail? (Phase C Spring fails? LPS fails? No Jump?)

**CampaignPerformance Model Fields**:

- `campaign_id`: Links all patterns/trades belonging to same Accumulation/Distribution
- `campaign_type`: ACCUMULATION (bullish) or DISTRIBUTION (bearish)
- `status`: COMPLETED (reached Markup/Markdown), FAILED (stopped early), IN_PROGRESS
- `completion_stage`: Highest phase reached ("Phase C", "Phase D", "Markup", etc.)
- `pattern_sequence`: Ordered list showing campaign evolution ["PS", "SC", "AR", "SPRING", "SOS", "LPS", "JUMP"]
- `total_campaign_pnl`: Sum of all trade P&L within this campaign (multiple patterns)
- `avg_markup_return`: For ACCUMULATION campaigns that completed, average return during Markup phase
- `failure_reason`: If FAILED, explain why ("failed at LPS", "no SOS after Spring", "stopped at Phase C")
- `phases_completed`: List of phases successfully completed ["A", "B", "C", "D"]

**Campaign-Level Metrics**:

- `total_campaigns_detected`: How many Accumulation + Distribution campaigns identified in backtest
- `completed_campaigns`: How many reached Markup/Markdown (successful campaigns)
- `failed_campaigns`: How many stopped before completion
- `campaign_completion_rate`: % of campaigns that completed successfully
- `avg_campaign_duration_days`: Average time from PS to Jump/Decline

**Implementation Notes**:

- Trades must include `campaign_id` metadata to group them by campaign
- Campaign detection requires identifying PS/BC (campaign start) and Jump/Decline (campaign end) events
- A campaign is COMPLETED only if it reaches Markup (Accumulation) or Markdown (Distribution) phase
- A campaign FAILS if pattern sequence breaks (e.g., Spring without subsequent SOS)
- Calculate campaign P&L by summing all trades within campaign (Spring trade + SOS trade + LPS trade = total campaign P&L)
- Track pattern sequence to validate proper Wyckoff progression

**Reporting Display**:

- Add "Campaign Performance" tab in BacktestReport.vue
- DataTable showing all campaigns with columns: Campaign Type, Status, Duration, Patterns Detected, Total P&L, Completion Stage
- Color coding: Green for COMPLETED, Red for FAILED, Yellow for IN_PROGRESS
- Chart showing campaign completion rate by type (Accumulation vs Distribution)
- Detailed campaign view showing pattern sequence and phase progression
- Failure analysis: aggregate failure reasons across all failed campaigns

**Analysis Value**:

- **System validation**: Does the system correctly identify and trade complete campaigns?
- **Completion rate**: 60%+ campaign completion rate indicates good campaign detection
- **Failure points**: If campaigns consistently fail at same point (e.g., LPS), improve LPS detection logic
- **Campaign profitability**: Compare single-pattern P&L vs full-campaign P&L to see value of campaign approach
- **Duration analysis**: Typical Accumulation lasts 60-90 days; validate actual vs expected durations

## Testing

### Testing Framework
[Source: docs/architecture/12-testing-strategy.md]

**Backend Testing:**
- pytest 8.0+ for all backend unit and integration tests
- pytest-mock for mocking BacktestResult, trades, equity curves
- factory-boy for generating synthetic test data
- FastAPI TestClient for API endpoint tests

**Frontend Testing:**
- Vitest 1.2+ for Vue component unit tests [Source: architecture/3-tech-stack.md]
- Vue Testing Library for component interaction testing
- Playwright 1.41+ for E2E tests [Source: architecture/3-tech-stack.md]

### Test Coverage Requirements
[Source: NFR8 from PRD]

- Target: 90%+ test coverage
- Cover all metrics calculation functions
- Cover all report generation functions (HTML, PDF, CSV)
- Cover all API endpoints
- Cover all Vue components
- Cover edge cases: zero trades, single trade, no drawdowns, etc.

### Unit Test Requirements

**Backend Metrics Calculation:**
- Test `calculate_pattern_performance()`: verify grouping, aggregation, edge cases
- Test `calculate_monthly_returns()`: verify correct monthly aggregation
- Test `calculate_drawdown_periods()`: verify peak/trough/recovery detection
- Test `calculate_risk_metrics()`: verify concurrent position tracking, portfolio heat
- Test `calculate_trade_streaks()`: verify consecutive win/loss counting
- Test `identify_extreme_trades()`: verify largest winner/loser identification

**Backend Report Generation:**
- Test `generate_html_report()`: verify HTML structure, data presence, validity
- Test `generate_pdf_report()`: verify PDF generation, validity
- Test `generate_csv_trade_list()`: verify CSV format, data integrity

**Frontend Components:**
- Test BacktestReport.vue: verify rendering, tab switching, data display
- Test EquityCurveChart.vue: verify chart creation, tooltip
- Test MetricsCard.vue: verify color coding, number formatting
- Test PatternPerformanceTable.vue: verify table rendering, sorting
- Test MonthlyReturnsHeatmap.vue: verify heatmap structure, color coding

### Integration Test Requirements

**Backend API Integration:**
- Test full flow: run backtest → retrieve result with extended fields → generate HTML → generate PDF → generate CSV
- Verify API responses match expected schemas
- Verify report formats are valid (HTML parseable, PDF openable, CSV parseable)

**Frontend E2E:**
- Navigate to /backtests → view report → export PDF
- Verify all tabs load correctly
- Verify charts render
- Verify tables display data
- Verify export actions trigger downloads

### Test Data and Fixtures

**Mock BacktestResult:**
- Use factory-boy to generate BacktestResult with all fields populated
- Include: 50+ trades, 500+ equity points, multiple pattern types, multiple months
- Include edge cases: drawdowns with recovery, drawdowns without recovery

**Synthetic Equity Curve:**
- Generate realistic equity curve with peaks, troughs, recoveries
- Include at least 3 drawdown periods for testing

**Synthetic Trades:**
- Generate trades across multiple pattern types: SPRING, UTAD, SOS
- Include winning and losing trades
- Include trades spanning multiple months

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation with comprehensive backtest reporting details | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_This section will be populated by the QA agent after story completion._
