# Story 12.8: Paper Trading Mode

## Status
Ready for Development

## Sprint Assignment

**Sprint 3** - Production Readiness

- Dependencies: Story 12.1 (Backtesting Engine)
- Parallel with: Stories 12.6, 12.9, 12.7
- Required by: Story 12.10 (Final Integration)

## Story
**As a** trader,
**I want** a paper trading mode that simulates live trading without real capital (NFR19),
**so that** I can validate the system in real-time before going live.

## Acceptance Criteria
1. Paper trading toggle: switch in settings enables paper mode
2. Mock broker: simulates order fills without actual broker connection
3. Realistic fills: uses live market data, applies slippage/commission
4. Position tracking: maintains virtual positions, calculates P&L
5. Risk limits enforced: same risk checks as live mode
6. Signal generation: identical to live (uses real-time data)
7. Dashboard indication: "PAPER TRADING MODE" banner always visible
8. Performance tracking: paper trading results stored separately from live
9. Duration requirement: 3-month paper trading before live deployment
10. Comparison: paper vs backtest performance should be similar (validation)

## Tasks / Subtasks

- [ ] **Task 1: Create Paper Trading Data Models** (AC: 4, 8)
  - [ ] Subtask 1.1: Create Pydantic model `PaperTradingConfig` in `backend/src/models/paper_trading.py`:
    - `enabled`: bool (toggle paper trading mode on/off)
    - `starting_capital`: Decimal (virtual capital to start with, default: $100,000)
    - `commission_per_share`: Decimal (default: 0.005 from Story 12.5)
    - `slippage_percentage`: Decimal (default: 0.02% for liquid stocks from Story 12.5)
    - `use_realistic_fills`: bool (default: True, applies slippage/commission)
    - `created_at`: datetime (UTC)
  - [ ] Subtask 1.2: Create Pydantic model `PaperPosition` in `backend/src/models/paper_trading.py`:
    - `id`: UUID (unique identifier)
    - `signal_id`: UUID (reference to Signal that generated this position)
    - `symbol`: str (ticker)
    - `entry_time`: datetime (UTC, when position opened)
    - `entry_price`: Decimal (virtual fill price)
    - `quantity`: Decimal (shares)
    - `stop_loss`: Decimal
    - `target_1`: Decimal
    - `target_2`: Decimal
    - `current_price`: Decimal (latest market price)
    - `unrealized_pnl`: Decimal (mark-to-market P&L)
    - `status`: Literal["OPEN", "STOPPED", "TARGET_1_HIT", "TARGET_2_HIT", "CLOSED"]
    - `commission_paid`: Decimal (total commissions for entry)
    - `slippage_cost`: Decimal (total slippage for entry)
    - `created_at`: datetime (UTC)
    - `updated_at`: datetime (UTC)
  - [ ] Subtask 1.3: Create Pydantic model `PaperTrade` in `backend/src/models/paper_trading.py`:
    - `id`: UUID
    - `position_id`: UUID (reference to PaperPosition)
    - `signal_id`: UUID (reference to Signal)
    - `symbol`: str
    - `entry_time`: datetime (UTC)
    - `entry_price`: Decimal
    - `exit_time`: datetime (UTC)
    - `exit_price`: Decimal
    - `quantity`: Decimal
    - `realized_pnl`: Decimal (actual P&L after exit)
    - `r_multiple_achieved`: Decimal (actual R vs planned R)
    - `commission_total`: Decimal (entry + exit commissions)
    - `slippage_total`: Decimal (entry + exit slippage)
    - `exit_reason`: Literal["STOP_LOSS", "TARGET_1", "TARGET_2", "MANUAL", "EXPIRED"]
    - `created_at`: datetime (UTC)
  - [ ] Subtask 1.4: Create Pydantic model `PaperAccount` in `backend/src/models/paper_trading.py`:
    - `id`: UUID (unique identifier, single account for system)
    - `starting_capital`: Decimal (initial virtual capital)
    - `current_capital`: Decimal (cash available)
    - `equity`: Decimal (cash + unrealized P&L of open positions)
    - `total_realized_pnl`: Decimal (sum of all closed trades)
    - `total_unrealized_pnl`: Decimal (sum of open position P&L)
    - `total_commission_paid`: Decimal
    - `total_slippage_cost`: Decimal
    - `total_trades`: int
    - `winning_trades`: int
    - `losing_trades`: int
    - `win_rate`: Decimal
    - `average_r_multiple`: Decimal
    - `max_drawdown`: Decimal
    - `current_heat`: Decimal (% of capital at risk in open positions)
    - `paper_trading_start_date`: datetime | None (UTC, when paper trading first enabled)
    - `created_at`: datetime (UTC)
    - `updated_at`: datetime (UTC)
  - [ ] Subtask 1.5: Add Decimal precision validators [Source: architecture/15-coding-standards.md#Decimal-Precision]
  - [ ] Subtask 1.6: Add UTC timestamp validators [Source: architecture/4-data-models.md#OHLCVBar]
  - [ ] Subtask 1.7: Unit test all models with Pydantic validation (pytest)
  - [ ] Subtask 1.8: Run `pydantic-to-typescript` to generate TypeScript types

- [ ] **Task 2: Mock Broker Adapter** (AC: 2, 3)
  - [ ] Subtask 2.1: Create class `PaperBrokerAdapter` in `backend/src/brokers/paper_broker_adapter.py`
  - [ ] Subtask 2.2: Implement `place_order(signal: Signal) -> PaperPosition`:
    - Fetch latest market price for symbol (from Market Data Service)
    - Calculate fill price with slippage: `fill_price = market_price * (1 + slippage_percentage / 100)` for LONG
    - Calculate commission: `quantity * commission_per_share`
    - Create PaperPosition with fill_price, commission, slippage
    - Update PaperAccount: reduce current_capital by `(quantity * fill_price + commission)`
    - Return PaperPosition
  - [ ] Subtask 2.3: Implement `close_position(position_id: UUID, exit_reason: str) -> PaperTrade`:
    - Fetch current market price
    - Calculate exit fill price with slippage
    - Calculate exit commission
    - Calculate realized P&L: `(exit_price - entry_price) * quantity - commission_total - slippage_total`
    - Calculate R-multiple achieved
    - Create PaperTrade record
    - Update PaperAccount
    - Return PaperTrade
  - [ ] Subtask 2.4: Implement `get_positions() -> List[PaperPosition]`
  - [ ] Subtask 2.5: Implement `get_account() -> PaperAccount`
  - [ ] Subtask 2.6: Add logging for all paper trades [Source: architecture/3-tech-stack.md#structlog]
  - [ ] Subtask 2.7: Unit tests: verify fill price calculation, commission, slippage, P&L (pytest)

- [ ] **Task 3: Paper Trading Service** (AC: 2, 3, 4, 5)
  - [ ] Subtask 3.1: Create `PaperTradingService` class in `backend/src/trading/paper_trading_service.py`
  - [ ] Subtask 3.2: Dependency injection: PaperBrokerAdapter, MarketDataService, RiskManagementService
  - [ ] Subtask 3.3: Implement `execute_signal(signal: Signal) -> PaperPosition`:
    - Validate signal meets risk limits (via RiskManagementService)
    - Check portfolio heat: current_heat + new risk <= 10% (FR18)
    - If risk checks pass, call PaperBrokerAdapter.place_order(signal)
    - Store PaperPosition
    - Update PaperAccount
    - Return PaperPosition
  - [ ] Subtask 3.4: Implement `update_positions() -> None` (background task, runs every bar):
    - Fetch all open PaperPositions
    - For each position, fetch latest market price
    - Check if stop loss hit: if `current_price <= stop_loss`, close position
    - Check if target hit: if `current_price >= target_1/2`, close position (partial or full)
    - Update `current_price` and `unrealized_pnl`
  - [ ] Subtask 3.5: Implement `calculate_performance_metrics() -> Dict` (win_rate, avg_r, max_drawdown, etc.)
  - [ ] Subtask 3.6: Implement `compare_to_backtest(backtest_result: BacktestResult) -> Dict`
  - [ ] Subtask 3.7: Unit tests: verify risk checks, position updates, stop/target fills (pytest)

- [ ] **Task 4: Paper Trading Repositories** (AC: 4, 8)
  - [ ] Subtask 4.1: Create `PaperAccountRepository` in `backend/src/repositories/paper_account_repository.py`
  - [ ] Subtask 4.2: Implement `get_account() -> Optional[PaperAccount]` (singleton)
  - [ ] Subtask 4.3: Implement `update_account(account: PaperAccount) -> None`
  - [ ] Subtask 4.4: Create `PaperPositionRepository` in `backend/src/repositories/paper_position_repository.py`
  - [ ] Subtask 4.5: Implement `save_position()`, `get_position()`, `list_open_positions()`, `update_position()`
  - [ ] Subtask 4.6: Create `PaperTradeRepository` in `backend/src/repositories/paper_trade_repository.py`
  - [ ] Subtask 4.7: Implement `save_trade()`, `get_trade()`, `list_trades(limit, offset)`
  - [ ] Subtask 4.8: Unit tests: verify save/retrieve, pagination (pytest)

- [ ] **Task 5: Database Migration** (AC: 4, 8)
  - [ ] Subtask 5.1: Create Alembic migration: `{timestamp}_add_paper_trading_tables.py`
  - [ ] Subtask 5.2: Create `paper_accounts` table (columns: id, starting_capital, current_capital, equity, total_realized_pnl, total_unrealized_pnl, total_commission_paid, total_slippage_cost, total_trades, winning_trades, losing_trades, win_rate, average_r_multiple, max_drawdown, current_heat, paper_trading_start_date, created_at, updated_at)
  - [ ] Subtask 5.3: Create `paper_positions` table (columns: id, signal_id, symbol, entry_time, entry_price, quantity, stop_loss, target_1, target_2, current_price, unrealized_pnl, status, commission_paid, slippage_cost, created_at, updated_at)
  - [ ] Subtask 5.4: Create `paper_trades` table (columns: id, position_id, signal_id, symbol, entry_time, entry_price, exit_time, exit_price, quantity, realized_pnl, r_multiple_achieved, commission_total, slippage_total, exit_reason, created_at)
  - [ ] Subtask 5.5: Add indexes and foreign key constraints
  - [ ] Subtask 5.6: Run migration: `alembic upgrade head`

- [ ] **Task 6: Integration with Signal Generation** (AC: 6)
  - [ ] Subtask 6.1: Update `SignalGenerator` to check if paper trading enabled
  - [ ] Subtask 6.2: If enabled, execute signal via PaperTradingService.execute_signal()
  - [ ] Subtask 6.3: Store paper_position_id in Signal model
  - [ ] Subtask 6.4: Log whether signal executed in paper or live mode
  - [ ] Subtask 6.5: Unit tests: verify paper trading signal execution (pytest)

- [ ] **Task 7: Background Task for Position Updates** (AC: 4)
  - [ ] Subtask 7.1: Create background task `update_paper_positions_task` in `backend/src/tasks/paper_trading_tasks.py`
  - [ ] Subtask 7.2: Schedule task to run every bar (hook into Market Data Service BarIngested event)
  - [ ] Subtask 7.3: Call PaperTradingService.update_positions()
  - [ ] Subtask 7.4: Add logging for position updates (stop hits, target hits)
  - [ ] Subtask 7.5: Integration test: simulate bar ingestion, verify positions updated (pytest)

- [ ] **Task 8: API Endpoints** (AC: 1, 8, 10)
  - [ ] Subtask 8.1: Create API routes in `backend/src/api/routes/paper_trading.py`:
    - `POST /api/v1/paper-trading/enable` (enable paper trading, create account)
    - `POST /api/v1/paper-trading/disable` (disable, close all positions)
    - `GET /api/v1/paper-trading/account` (get current account)
    - `GET /api/v1/paper-trading/positions` (list open positions)
    - `GET /api/v1/paper-trading/trades?limit=50&offset=0` (paginated trades)
    - `GET /api/v1/paper-trading/report` (comprehensive report with comparison)
    - `POST /api/v1/paper-trading/reset` (reset account, archive data)
    - `GET /api/v1/paper-trading/live-eligibility` (check 3-month duration)
  - [ ] Subtask 8.2: Unit tests: test endpoints with mock service (pytest)
  - [ ] Subtask 8.3: Integration test: enable paper trading, generate signal, verify position created (pytest)

- [ ] **Task 9: Frontend Paper Trading Toggle** (AC: 1, 7)
  - [ ] Subtask 9.1: Create `PaperTradingToggle.vue` in `frontend/src/components/settings/`
  - [ ] Subtask 9.2: Add PrimeVue InputSwitch component
  - [ ] Subtask 9.3: Fetch current status on mount: `GET /api/v1/paper-trading/account`
  - [ ] Subtask 9.4: On toggle: call `POST /api/v1/paper-trading/enable` or `disable`
  - [ ] Subtask 9.5: Show confirmation dialog before disabling
  - [ ] Subtask 9.6: Update Pinia store with mode status
  - [ ] Subtask 9.7: Style with clear labels and tooltip
  - [ ] Subtask 9.8: Unit tests: test toggle interaction (Vitest)

- [ ] **Task 10: Dashboard Paper Trading Banner** (AC: 7)
  - [ ] Subtask 10.1: Update `DashboardView.vue` in `frontend/src/views/`
  - [ ] Subtask 10.2: Add banner at top: "‚ö†Ô∏è PAPER TRADING MODE - No real capital at risk"
  - [ ] Subtask 10.3: Fetch mode status from Pinia store
  - [ ] Subtask 10.4: Show yellow/orange banner if paper mode enabled (non-dismissible, fixed position)
  - [ ] Subtask 10.5: Hide or show green "Live Trading" indicator if disabled
  - [ ] Subtask 10.6: Style with Tailwind CSS for visibility
  - [ ] Subtask 10.7: Unit tests: test banner visibility (Vitest)

- [ ] **Task 11: Paper Trading Dashboard** (AC: 4, 8, 10)
  - [ ] Subtask 11.1: Create `PaperTradingDashboard.vue` in `frontend/src/components/paper-trading/`
  - [ ] Subtask 11.2: Fetch and display account metrics: starting_capital, current_capital, equity, total_realized_pnl, win_rate, avg_r, max_drawdown, current_heat
  - [ ] Subtask 11.3: Fetch and display open positions in PrimeVue DataTable (columns: Symbol, Entry Time, Entry Price, Current Price, Unrealized P&L, Stop, Targets, Status)
  - [ ] Subtask 11.4: Fetch and display recent trades in DataTable (columns: Symbol, Entry/Exit Times, Entry/Exit Prices, Realized P&L, R-Multiple, Exit Reason)
  - [ ] Subtask 11.5: Add pagination for trades
  - [ ] Subtask 11.6: Display backtest comparison if available (side-by-side metrics with deltas)
  - [ ] Subtask 11.7: Add "Reset Account" button with confirmation
  - [ ] Subtask 11.8: Style with Tailwind CSS and PrimeVue
  - [ ] Subtask 11.9: Unit tests: test rendering, API calls (Vitest)

- [ ] **Task 12: Real-Time Updates via WebSocket** (AC: 4, 6)
  - [ ] Subtask 12.1: Add WebSocket message types in `backend/src/api/websocket.py`:
    - `paper_position_opened` (data: PaperPosition minimal)
    - `paper_position_updated` (data: unrealized_pnl, current_price updates)
    - `paper_trade_closed` (data: PaperTrade full)
  - [ ] Subtask 12.2: Emit messages when positions created, updated, closed
  - [ ] Subtask 12.3: Update frontend `useWebSocket.ts` to handle new message types
  - [ ] Subtask 12.4: Update Pinia store on WebSocket messages
  - [ ] Subtask 12.5: Display real-time updates in dashboard
  - [ ] Subtask 12.6: Unit tests: mock WebSocket messages, verify store updates (Vitest)

- [ ] **Task 13: Paper Trading Configuration UI** (AC: 1, 3)
  - [ ] Subtask 13.1: Create `PaperTradingSettings.vue` in `frontend/src/components/settings/`
  - [ ] Subtask 13.2: Add form fields: Starting Capital, Commission per Share, Slippage %, Use Realistic Fills
  - [ ] Subtask 13.3: Validate inputs (capital > 0, commission >= 0, slippage >= 0)
  - [ ] Subtask 13.4: On save, call `POST /api/v1/paper-trading/enable`
  - [ ] Subtask 13.5: Add "Restore Defaults" button
  - [ ] Subtask 13.6: Style with PrimeVue and Tailwind CSS
  - [ ] Subtask 13.7: Unit tests: test form validation, save (Vitest)

- [ ] **Task 14: 3-Month Duration Tracking** (AC: 9)
  - [ ] Subtask 14.1: Set `paper_trading_start_date` when paper trading first enabled
  - [ ] Subtask 14.2: Calculate duration: current_date - paper_trading_start_date
  - [ ] Subtask 14.3: Implement `validate_live_trading_eligibility() -> Dict`:
    - Check duration >= 90 days
    - Check minimum trade count (20+ trades)
    - Check performance metrics (win_rate > 50%, avg_r > 1.5R)
    - Return eligibility status
  - [ ] Subtask 14.4: Create API endpoint `GET /api/v1/paper-trading/live-eligibility`
  - [ ] Subtask 14.5: Display in dashboard: days completed (X / 90), progress bar, eligibility status
  - [ ] Subtask 14.6: Disable "Switch to Live" button if not eligible with tooltip
  - [ ] Subtask 14.7: Unit tests: test eligibility validation (pytest)

- [ ] **Task 15: Comparison to Backtest** (AC: 10)
  - [ ] Subtask 15.1: Implement `compare_to_backtest(backtest_id: UUID) -> Dict`
  - [ ] Subtask 15.2: Fetch BacktestResult from database (Story 12.6)
  - [ ] Subtask 15.3: Compare metrics: win_rate, avg_r, max_drawdown, sharpe_ratio
  - [ ] Subtask 15.4: Calculate deltas, flag deviations > 10%
  - [ ] Subtask 15.5: Update API endpoint to accept `compare_to_backtest_id` query param
  - [ ] Subtask 15.6: Display comparison in dashboard with color-coded deltas
  - [ ] Subtask 15.7: Unit tests: test comparison calculation (pytest)

- [ ] **Task 16: Risk Limit Enforcement** (AC: 5)
  - [ ] Subtask 16.1: Integrate with RiskManagementService (Epic 7)
  - [ ] Subtask 16.2: Validate before executing signal:
    - Per-trade risk <= 2% (FR18)
    - Per-campaign risk <= 5% (FR18)
    - Portfolio heat <= 10% (FR18)
  - [ ] Subtask 16.3: Reject signal if limits exceeded (same as live mode)
  - [ ] Subtask 16.4: Log rejection in audit trail
  - [ ] Subtask 16.5: Unit tests: verify risk limits enforced (pytest)

- [ ] **Task 17: Unit Testing** (AC: 2, 3, 4)
  - [ ] Subtask 17.1: Create `backend/tests/unit/test_paper_broker_adapter.py`
  - [ ] Subtask 17.2: Test fill price with slippage: LONG market $100, slippage 0.02% ‚Üí fill $100.02
  - [ ] Subtask 17.3: Test commission: 100 shares * $0.005 = $0.50
  - [ ] Subtask 17.4: Test P&L: entry $100, exit $105, 100 shares, commission $1, slippage $0.50 ‚Üí P&L $498.50
  - [ ] Subtask 17.5: Create `backend/tests/unit/test_paper_trading_service.py`
  - [ ] Subtask 17.6: Test risk limits, stop/target fills, position updates
  - [ ] Subtask 17.7: Mock MarketDataService, RiskManagementService
  - [ ] Subtask 17.8: Follow pytest patterns [Source: architecture/12-testing-strategy.md]

- [ ] **Task 18: Integration Testing** (AC: 4, 6, 10)
  - [ ] Subtask 18.1: Create `backend/tests/integration/test_paper_trading_integration.py`
  - [ ] Subtask 18.2: Test full flow: enable ‚Üí generate signal ‚Üí execute ‚Üí update ‚Üí close
  - [ ] Subtask 18.3: Test comparison to backtest with real BacktestEngine
  - [ ] Subtask 18.4: Test 3-month eligibility validation
  - [ ] Subtask 18.5: Mark as `@pytest.mark.slow`

- [ ] **Task 19: Error Handling** (AC: 3, 4)
  - [ ] Subtask 19.1: Handle missing market data (log warning, skip update, retry)
  - [ ] Subtask 19.2: Handle negative account balance (disable mode, alert user)
  - [ ] Subtask 19.3: Handle stale positions (>30 days, flag for review)
  - [ ] Subtask 19.4: Validate PaperTradingConfig on enable
  - [ ] Subtask 19.5: Unit tests: test error scenarios (pytest)

- [ ] **Task 20: Logging and Observability** (AC: all)
  - [ ] Subtask 20.1: Add structlog logging [Source: architecture/3-tech-stack.md#structlog]:
    - Paper trading enabled/disabled
    - Trade executions (signal_id, symbol, entry_price, quantity)
    - Position updates (stop hit, target hit)
    - Trade closures (exit_reason, pnl, r_multiple)
    - Risk rejections
  - [ ] Subtask 20.2: Log levels: INFO (executions, updates), WARNING (risk limits, missing data), ERROR (failures)
  - [ ] Subtask 20.3: Include context: signal_id, position_id, symbol, account_equity
  - [ ] Subtask 20.4: Log to file: `backend/logs/paper_trading_{date}.log`

- [ ] **Task 21: Documentation** (AC: all)
  - [ ] Subtask 21.1: Create `backend/docs/paper-trading.md`:
    - Purpose of paper trading
    - How to enable/disable
    - Fill simulation (slippage, commission)
    - 3-month duration requirement
    - Comparison to backtest
  - [ ] Subtask 21.2: Document PaperTradingConfig parameters
  - [ ] Subtask 21.3: Document API endpoints
  - [ ] Subtask 21.4: Add docstrings to classes/methods
  - [ ] Subtask 21.5: Update README with link to paper trading docs

- [ ] **Task 22: Pinia Store for State** (AC: 4, 8)
  - [ ] Subtask 22.1: Create `usePaperTradingStore` in `frontend/src/stores/paperTradingStore.ts`
  - [ ] Subtask 22.2: State: enabled, account, openPositions, recentTrades, config
  - [ ] Subtask 22.3: Actions: enablePaperTrading, disablePaperTrading, fetchAccount, fetchPositions, fetchTrades, resetAccount
  - [ ] Subtask 22.4: Getters: isEnabled, totalUnrealizedPnL, currentEquity, winRate
  - [ ] Subtask 22.5: Unit tests: test store actions, getters (Vitest)

## Dev Notes

### Previous Story Context

**Story 12.1 (Custom Backtesting Engine)** provides foundation [Source: docs/stories/epic-12/12.1.custom-backtesting-engine-architecture.md]:
- Event-driven backtesting framework that paper trading mirrors
- BacktestEngine provides pattern for simulating trades

**Story 12.5 (Commission and Slippage Modeling)** defines trading costs:
- Commission: $0.005/share (Interactive Brokers)
- Slippage: 0.02% for liquid stocks, 0.05% for less liquid
- Fill simulation: market orders at next bar open + slippage
- These exact models reused in paper trading

**Story 12.6 (Backtest Metrics)** defines performance metrics:
- Win rate, Avg R, Profit factor, Max drawdown, Sharpe ratio
- Same metrics calculated for paper trading
- Comparison feature (AC 10) compares paper vs backtest

### Epic Context

Part of Epic 12: Backtesting & Validation Framework. Delivers **paper trading mode** for real-time validation before risking capital (NFR19).

### Paper Trading vs Backtesting

**Key Differences:**
- Backtesting: historical data, knows future, fast
- Paper trading: live data, real-time, realistic

**Why Both Needed:**
- Backtest validates strategy on history
- Paper trading validates implementation on live data
- Discrepancies reveal look-ahead bias, bugs, or overfitting

**NFR19: 3-Month Requirement:**
- Various market conditions (bull, bear, sideways)
- Statistical significance (20+ trades)
- Observe live behavior (slippage, latency, data quality)

### File Locations [Source: architecture/10-unified-project-structure.md]

**Backend:**
- Service: `backend/src/trading/paper_trading_service.py`
- Broker adapter: `backend/src/brokers/paper_broker_adapter.py`
- Models: `backend/src/models/paper_trading.py`
- API routes: `backend/src/api/routes/paper_trading.py`
- Repositories: `backend/src/repositories/paper_account_repository.py`, `paper_position_repository.py`, `paper_trade_repository.py`
- Tasks: `backend/src/tasks/paper_trading_tasks.py`

**Frontend:**
- Dashboard: `frontend/src/components/paper-trading/PaperTradingDashboard.vue`
- Toggle: `frontend/src/components/settings/PaperTradingToggle.vue`
- Settings: `frontend/src/components/settings/PaperTradingSettings.vue`
- Store: `frontend/src/stores/paperTradingStore.ts`

**Testing:**
- Unit: `backend/tests/unit/test_paper_trading_service.py`, `test_paper_broker_adapter.py`
- Integration: `backend/tests/integration/test_paper_trading_integration.py`

**Database:**
- Tables: `paper_accounts`, `paper_positions`, `paper_trades` (Alembic migration)

### Tech Stack [Source: architecture/3-tech-stack.md]

- Python 3.11+, FastAPI 0.109+, Pydantic 2.5+, SQLAlchemy 2.0+, PostgreSQL 15+
- Vue 3.4+, PrimeVue 3.50+, Pinia 2.1+, Tailwind CSS 3.4+, Vite 5.0+
- pytest 8.0+, Vitest 1.2+, structlog 24.1+
- WebSocket for real-time updates

### Key Implementation Details

**Fill Simulation (AC 3):**
```python
fill_price = market_price * (1 + slippage_pct / 100)  # LONG
commission = quantity * commission_per_share
realized_pnl = (exit_price - entry_price) * quantity - commission_total - slippage_total
```

**Risk Limits (AC 5):**
- Per-trade: <= 2% equity
- Per-campaign: <= 5% equity
- Portfolio heat: <= 10% equity
- Same validation as live mode via RiskManagementService

**Comparison to Backtest (AC 10):**
- Compare: win_rate, avg_r, max_drawdown, sharpe_ratio
- Warning if delta > 10%
- Error if delta > 20%
- Reveals look-ahead bias, bugs, overfitting

**3-Month Duration (AC 9):**
- Eligibility criteria: 90+ days, 20+ trades, win_rate > 50%, avg_r > 1.5R
- Progress tracking in dashboard
- "Switch to Live" disabled until eligible

**Dashboard Banner (AC 7):**
- Yellow/orange warning banner
- Text: "‚ö†Ô∏è PAPER TRADING MODE - No real capital at risk"
- Fixed position, non-dismissible, always visible

## Testing

### Testing Framework [Source: architecture/12-testing-strategy.md]
- pytest 8.0+ for backend
- Vitest 1.2+ for frontend
- Target 90%+ coverage (NFR8)

### Unit Tests
- Fill price with slippage: market $100, slippage 0.02% ‚Üí $100.02
- Commission: 100 shares * $0.005 = $0.50
- P&L: entry $100, exit $105, 100 shares ‚Üí $498.50 (after costs)
- Risk limits: 2% per-trade, 10% portfolio heat
- Stop/target fills with price movements

### Integration Tests
- Full flow: enable ‚Üí signal ‚Üí execute ‚Üí update ‚Üí close
- Backtest comparison with real BacktestEngine
- 3-month eligibility validation
- Mark as `@pytest.mark.slow`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation for paper trading mode | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

### Review Date: 2025-12-29

### Reviewed By: Quinn (Test Architect)

### Executive Summary

Story 12.8 demonstrates **excellent backend implementation quality** with comprehensive data models, well-architected services, and strong unit test coverage. However, **critical import errors** were discovered and fixed during review, and **frontend implementation is completely missing** (~40% of story scope). Gate status: **CONCERNS** - backend is production-ready after fixes, but frontend and integration tests required before Done.

### Code Quality Assessment

**Overall Rating: B+ (85/100) for implemented backend components**

**Strengths:**
- **Exceptional Data Modeling**: Pydantic models with comprehensive field validation, decimal precision handling (8 places), and UTC timestamp enforcement
- **Clean Architecture**: Clear separation of concerns across layers (models ‚Üí repositories ‚Üí services ‚Üí API)
- **Financial Accuracy**: Correct slippage and commission calculations with proper decimal arithmetic to prevent rounding errors
- **Risk Management**: Proper enforcement of FR18 requirements (2% per-trade, 10% portfolio heat limits)
- **Type Safety**: Comprehensive type hints throughout, leveraging Python 3.11+ union syntax
- **Observability**: Excellent structlog integration with contextual logging at all layers
- **Test Quality**: Unit tests are thorough, well-organized, and cover edge cases effectively

**Weaknesses:**
- Import errors indicate insufficient pre-review testing
- Inconsistent datetime handling (mixing `datetime.now()` and `datetime.now(UTC)`)
- Multiple TODO comments in production code
- Missing integration with actual market data service (mocked/placeholder)

### Refactoring Performed

During this comprehensive review, I identified and **fixed critical import errors** that would have prevented the application from starting:

- **File**: [backend/src/api/routes/paper_trading.py:20](backend/src/api/routes/paper_trading.py#L20)
  - **Change**: Fixed import statement from `src.api.deps` to `src.api.dependencies`
  - **Why**: Module `src.api.deps` does not exist in the codebase, causing ModuleNotFoundError
  - **How**: Changed to correct module name that contains `get_db` dependency function
  - **Impact**: Application can now start without import errors

- **File**: [backend/src/repositories/paper_account_repository.py:18](backend/src/repositories/paper_account_repository.py#L18)
  - **Change**: Fixed ORM import from `src.repositories.models` to `src.repositories.paper_trading_orm`
  - **Why**: Inconsistent with other repositories and PaperAccountDB doesn't exist in models.py
  - **How**: Standardized to use `paper_trading_orm` module like position and trade repositories
  - **Impact**: Prevents runtime ImportError when repository is instantiated

### Compliance Check

- **Coding Standards**: ‚úì PASS
  - Decimal precision: ‚úì (8 decimal places per architecture/coding-standards.md)
  - UTC timestamps: ‚ö† PARTIAL (some inconsistencies found - see DATETIME-001)
  - Type hints: ‚úì (comprehensive throughout)
  - Docstrings: ‚úì (all public methods documented)
  - Structlog usage: ‚úì (proper contextual logging)

- **Project Structure**: ‚úì PASS
  - Files in correct locations per architecture/unified-project-structure.md
  - Clear layer separation (models, repositories, services, API routes)
  - Proper dependency injection pattern used

- **Testing Strategy**: ‚ö† PARTIAL
  - Unit tests: ‚úì (excellent coverage for models and broker adapter)
  - Integration tests: ‚úó (Task 18 - MISSING, required)
  - Test organization: ‚úì (follows pytest conventions)
  - Target 90% coverage: ‚ö† (~85% for implemented components)

- **All ACs Met**: ‚úó PARTIAL (4/10 complete, 4 partial, 2 not started)
  - AC 2, 3, 5, 9: ‚úì Complete
  - AC 4, 6, 8, 10: ‚ö† Backend done, frontend/integration missing
  - AC 1, 7: ‚úó Not implemented (frontend)

### Requirements Traceability Matrix

| AC | Requirement | Status | Implementation | Test Coverage |
|---|---|---|---|---|
| 1 | Paper trading toggle | ‚ùå NOT_IMPL | Frontend missing | None |
| 2 | Mock broker | ‚úÖ COMPLETE | paper_broker_adapter.py | Comprehensive |
| 3 | Realistic fills | ‚úÖ COMPLETE | place_order(), close_position() | Excellent |
| 4 | Position tracking | ‚ö†Ô∏è PARTIAL | Service + Repos complete | Models only |
| 5 | Risk limits enforced | ‚úÖ COMPLETE | execute_signal() lines 73-110 | None (logic verified) |
| 6 | Signal generation | ‚ö†Ô∏è PARTIAL | Integration points exist | None |
| 7 | Dashboard indication | ‚ùå NOT_IMPL | Frontend missing | None |
| 8 | Performance tracking | ‚ö†Ô∏è PARTIAL | calculate_performance_metrics() | None |
| 9 | Duration requirement | ‚úÖ COMPLETE | validate_live_trading_eligibility() | None |
| 10 | Comparison | ‚ö†Ô∏è PARTIAL | compare_to_backtest() | None |

**Legend**: ‚úÖ Complete | ‚ö†Ô∏è Partial | ‚ùå Not Implemented

**Test Mapping (Given-When-Then)**:
- **Given** a trading signal with 100 shares at $150, 0.02% slippage
  - **When** order is placed
  - **Then** fill price is $150.03 (tested: test_long_entry_with_slippage)

- **Given** a position with 100 shares, $0.005 commission/share
  - **When** position is opened and closed
  - **Then** total commission is $1.00 (tested: test_total_commission)

- **Given** a profitable trade exiting at $155 (entered $150)
  - **When** P&L is calculated
  - **Then** realized P&L accounts for slippage and commission (tested: test_profitable_trade_pnl)

- **Given** portfolio heat is 8% and new trade adds 3%
  - **When** signal is executed
  - **Then** trade is rejected (FR18 10% limit) (implemented but not tested)

### Security Review

**Status**: ‚úÖ PASS

- **Financial Calculations**: Proper use of `Decimal` type prevents floating-point precision errors
- **Input Validation**: Pydantic models enforce constraints (positive prices, valid statuses, bounded percentages)
- **SQL Injection**: Protected by SQLAlchemy ORM with parameterized queries
- **Data Integrity**: Foreign key constraints and indexes properly defined in migration
- **Risk Controls**: FR18 limits enforced (2% per-trade, 10% portfolio heat)

**No security vulnerabilities identified.**

### Performance Considerations

**Status**: ‚ö†Ô∏è CONCERNS

**Issues Identified:**
1. **Position Update Loop** (paper_trading_service.py:159-193)
   - Iterates all open positions synchronously
   - **Impact**: O(n) database queries where n = number of open positions
   - **Recommendation**: Implement batch processing with single SELECT query

2. **No Caching Strategy**
   - Market data lookups not cached
   - **Impact**: Potential for repeated API calls for same symbol/timeframe
   - **Recommendation**: Add Redis caching layer or in-memory LRU cache

3. **Drawdown Calculation**
   - TODO comment indicates incomplete implementation (line 458)
   - **Impact**: max_drawdown metric not accurately tracked
   - **Recommendation**: Implement proper equity curve tracking

**Not blocking for current load, but should be addressed before scale testing.**

### Improvements Checklist

**Completed During Review:**
- [x] Fixed critical import error in paper_trading.py (src.api.deps ‚Üí src.api.dependencies)
- [x] Fixed inconsistent ORM imports in paper_account_repository.py
- [x] Comprehensive requirements traceability analysis
- [x] Full code quality review across all layers

**Requires Development Team:**
- [ ] Implement frontend components (Tasks 9-13) - **P0 BLOCKER**
- [ ] Create integration tests (Task 18) - **P0 BLOCKER**
- [ ] Fix database migration down_revision reference (20251229_210055)
- [ ] Standardize datetime handling to `datetime.now(timezone.utc)` throughout
- [ ] Implement background task for position updates (Task 7)
- [ ] Complete TODO: Max drawdown tracking (paper_trading_service.py:458)
- [ ] Complete TODO: Market data service integration (paper_trading_service.py:160)
- [ ] Complete TODO: Backtest comparison in API endpoint (paper_trading.py:406-410)
- [ ] Add unit tests for service layer risk validation
- [ ] Add unit tests for repository layer
- [ ] Consider performance optimizations (batch processing, caching)

### Files Modified During Review

**Files Changed by QA:**
1. `backend/src/api/routes/paper_trading.py` - Fixed import error (line 20)
2. `backend/src/repositories/paper_account_repository.py` - Fixed ORM import (line 18)

**Request to Dev**: Please update the File List in Dev Agent Record section to reflect these QA fixes.

### Non-Functional Requirements (NFR) Validation

**NFR19: 3-Month Paper Trading Requirement**
- ‚úÖ **PASS**: `validate_live_trading_eligibility()` correctly enforces:
  - Duration >= 90 days
  - Trade count >= 20
  - Win rate > 50%
  - Avg R-multiple > 1.5R
- Implementation: [paper_trading_service.py:309-359](backend/src/trading/paper_trading_service.py#L309-L359)

**FR18: Risk Management Requirements**
- ‚úÖ **PASS**: Risk limits properly enforced in `execute_signal()`:
  - Per-trade risk: 2.0% max (line 83)
  - Portfolio heat: 10.0% max (line 98)
- Rejection logic logs warnings with structured context
- Implementation: [paper_trading_service.py:73-110](backend/src/trading/paper_trading_service.py#L73-L110)

**NFR8: Test Coverage Target (90%)**
- ‚ö†Ô∏è **PARTIAL**: Estimated ~85% for implemented backend components
- Strong unit test coverage for models and broker adapter
- Missing integration tests reduces overall coverage
- Frontend untested (not implemented)

### Test Architecture Assessment

**Unit Tests**: ‚úÖ EXCELLENT (85% coverage estimate for backend)

**Strengths:**
- Comprehensive Pydantic validation tests (invalid inputs, edge cases)
- Thorough financial calculation tests (slippage, commission, P&L, R-multiples)
- Good fixture design with reusable test data
- Clear test naming following Given-When-Then pattern

**Test Files Reviewed:**
- `backend/tests/unit/test_paper_trading_models.py` (453 lines, 21 test methods)
- `backend/tests/unit/test_paper_broker_adapter.py` (356 lines, 14 test classes)

**Integration Tests**: ‚ùå MISSING (BLOCKER)

**Required per Task 18:**
- Full workflow: enable ‚Üí generate signal ‚Üí execute ‚Üí update ‚Üí close
- Backtest comparison with real BacktestEngine
- 3-month eligibility validation
- Mark as `@pytest.mark.slow`

**E2E Tests**: N/A (Frontend not implemented)

### Testability Evaluation

**Controllability**: ‚úÖ GOOD
- Clear interfaces with dependency injection
- Broker adapter allows easy mocking of market data
- Repository pattern enables database mocking

**Observability**: ‚úÖ EXCELLENT
- Comprehensive structlog logging at all critical points
- Clear error messages with actionable context
- Position state transitions logged

**Debuggability**: ‚úÖ GOOD
- Type hints throughout enable IDE support
- Clear variable names and function signatures
- Some improvement needed: add debug logging for risk calculations

### Technical Debt Identified

1. **TODO Comments in Production Code** (Severity: LOW)
   - Market data service integration (paper_trading_service.py:160)
   - Max drawdown calculation (paper_trading_service.py:458)
   - Backtest comparison (paper_trading.py:406-410)
   - **Action**: Complete or create follow-up stories

2. **ORM Model Organization** (Severity: LOW)
   - Models in `paper_trading_orm.py` with comment "will be merged into models.py"
   - **Action**: Either merge or remove misleading comment

3. **Datetime Handling Inconsistencies** (Severity: MEDIUM)
   - Mixing `datetime.now()` and `datetime.now(timezone.utc)`
   - **Action**: Standardize to `datetime.now(timezone.utc)` throughout

4. **Missing Retry Logic** (Severity: MEDIUM)
   - No retry strategy for market data fetch failures
   - **Action**: Add retry with exponential backoff

### Gate Status

**Gate**: CONCERNS ‚Üí [docs/qa/gates/12.8-paper-trading-mode.yml](docs/qa/gates/12.8-paper-trading-mode.yml)

**Quality Score**: 72/100
- Base: 100
- Deductions: -20 (2 HIGH issues), -15 (3 MEDIUM issues)
- Bonus: +7 (excellent backend quality)

**Risk Profile**: Not generated (optional for this review)
**NFR Assessment**: Passed (NFR19, FR18 validated)

### Recommended Status

**‚ùå Changes Required** - See checklist above

**Blocking Items (P0):**
1. Frontend implementation (Tasks 9-13) - **~40% of story scope**
2. Integration tests (Task 18) - **Required per story definition**

**High Priority (P1):**
3. Fix database migration reference
4. Standardize datetime handling
5. Background task implementation (Task 7)

**Story Owner Decision**: This story cannot be marked as "Done" until frontend and integration tests are complete. Backend implementation is production-ready after QA fixes.

### Summary for Stakeholders

üìä **Progress**: ~60% complete (backend done, frontend/integration missing)

‚úÖ **What's Working Well**:
- Rock-solid backend architecture with proper financial calculations
- Comprehensive unit test coverage for critical business logic
- Risk management properly enforced per requirements
- Database schema well-designed

‚ö†Ô∏è **What Needs Attention**:
- Import errors fixed by QA (were blocking)
- Frontend completely unimplemented
- Integration tests absent
- Several TODO items need resolution

üéØ **Next Steps**:
1. Complete frontend implementation (~16-20 hours estimated)
2. Add integration tests (~4-6 hours estimated)
3. Resolve technical debt items
4. Re-submit for QA review

**Timeline Impact**: Story will miss current sprint deadline. Recommend splitting frontend into separate story if time-critical.
