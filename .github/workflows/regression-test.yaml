name: Monthly Regression Test

# Story 12.7 Task 7: GitHub Actions Workflow for Scheduled Regression Tests
# Runs automated regression tests on the first Sunday of each month at 2 AM UTC

on:
  # Scheduled execution: First Sunday of each month at 2 AM UTC
  schedule:
    # Cron: minute hour day month weekday
    # 0 2 1-7 * 0 = 2 AM UTC on days 1-7 of month when day is Sunday
    - cron: '0 2 1-7 * 0'

  # Manual trigger for on-demand testing
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated list of symbols (default: standard 10)'
        required: false
        default: 'AAPL,MSFT,GOOGL,TSLA,NVDA,META,AMZN,SPY,QQQ,DIA'
      establish_baseline:
        description: 'Establish new baseline from results'
        required: false
        type: boolean
        default: false

# Permissions for committing results to repository
permissions:
  contents: write
  pull-requests: write

jobs:
  regression-test:
    name: Run Regression Test
    runs-on: ubuntu-latest

    # PostgreSQL service container for testing
    services:
      postgres:
        image: timescale/timescaledb:latest-pg15
        env:
          POSTGRES_USER: wyckoff_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: wyckoff_db_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U wyckoff_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version tracking

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached dependencies
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: |
          cd backend
          poetry install --no-interaction --no-root

      - name: Initialize database extensions
        run: |
          PGPASSWORD=test_password psql -h localhost -U wyckoff_user -d wyckoff_db_test -c "CREATE EXTENSION IF NOT EXISTS timescaledb;"
          PGPASSWORD=test_password psql -h localhost -U wyckoff_user -d wyckoff_db_test -c 'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'

      - name: Set up database
        env:
          DATABASE_URL: postgresql+psycopg://wyckoff_user:test_password@localhost:5432/wyckoff_db_test
        run: |
          cd backend
          poetry run alembic upgrade head

      - name: Run regression test
        id: regression
        env:
          DATABASE_URL: postgresql+psycopg://wyckoff_user:test_password@localhost:5432/wyckoff_db_test
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          cd backend

          # Build command with optional arguments
          CMD="poetry run python scripts/run_regression_test.py --output ../regression_result.json"

          if [[ "${{ github.event.inputs.symbols }}" != "" ]]; then
            CMD="$CMD --symbols ${{ github.event.inputs.symbols }}"
          fi

          if [[ "${{ github.event.inputs.establish_baseline }}" == "true" ]]; then
            CMD="$CMD --establish-baseline"
          fi

          # Run test and capture exit code
          set +e
          $CMD
          EXIT_CODE=$?
          set -e

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Exit codes: 0=PASS, 1=FAIL, 2=BASELINE_NOT_SET, 3=ERROR
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=PASS" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "status=FAIL" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "status=BASELINE_NOT_SET" >> $GITHUB_OUTPUT
          else
            echo "status=ERROR" >> $GITHUB_OUTPUT
          fi

          # Allow workflow to continue even if test fails
          exit 0

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-results-${{ github.run_number }}
          path: regression_result.json
          retention-days: 90

      - name: Parse test results
        id: parse
        if: always()
        run: |
          if [ -f regression_result.json ]; then
            TEST_ID=$(jq -r '.test_id' regression_result.json)
            VERSION=$(jq -r '.codebase_version' regression_result.json)
            STATUS=$(jq -r '.status' regression_result.json)
            REGRESSION_DETECTED=$(jq -r '.regression_detected' regression_result.json)

            echo "test_id=$TEST_ID" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "status=$STATUS" >> $GITHUB_OUTPUT
            echo "regression_detected=$REGRESSION_DETECTED" >> $GITHUB_OUTPUT

            # Format degraded metrics for notification
            DEGRADED=$(jq -r '.degraded_metrics | join(", ")' regression_result.json)
            echo "degraded_metrics=$DEGRADED" >> $GITHUB_OUTPUT
          fi

      - name: Commit test results to repository
        if: always() && steps.parse.outputs.test_id != ''
        run: |
          # Create results directory
          mkdir -p backend/tests/regression_results

          # Copy result with timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
          cp regression_result.json "backend/tests/regression_results/${TIMESTAMP}_${{ steps.parse.outputs.test_id }}.json"

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Add and commit
          git add backend/tests/regression_results/
          git commit -m "chore: regression test results - ${{ steps.parse.outputs.status }} ($TIMESTAMP)" || echo "No changes to commit"

          # Push to main branch
          git push origin HEAD:main || echo "Failed to push results"

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ§ª Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.parse.outputs.status }}" == "PASS" ]; then
            echo "### âœ… Test Status: PASS" >> $GITHUB_STEP_SUMMARY
            echo "No performance regression detected." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.parse.outputs.status }}" == "FAIL" ]; then
            echo "### âŒ Test Status: FAIL" >> $GITHUB_STEP_SUMMARY
            echo "**Performance regression detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Degraded Metrics:** ${{ steps.parse.outputs.degraded_metrics }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.parse.outputs.status }}" == "BASELINE_NOT_SET" ]; then
            echo "### âš ï¸ Test Status: BASELINE_NOT_SET" >> $GITHUB_STEP_SUMMARY
            echo "No baseline exists. Run with establish-baseline to create one." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Test Status: ERROR" >> $GITHUB_STEP_SUMMARY
            echo "Test execution failed with an error." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test ID:** \`${{ steps.parse.outputs.test_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.parse.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on regression failure
        if: steps.parse.outputs.regression_detected == 'true' && steps.parse.outputs.status == 'FAIL'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ Regression Test FAILED",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Regression Test FAILED"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Test ID:*\n`${{ steps.parse.outputs.test_id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n`${{ steps.parse.outputs.version }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n:x: FAIL"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Degraded Metrics:*\n${{ steps.parse.outputs.degraded_metrics }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Automated regression test detected performance degradation beyond acceptable thresholds."
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify on regression pass
        if: steps.parse.outputs.status == 'PASS'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… Regression Test PASSED",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… Regression Test PASSED"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Test ID:*\n`${{ steps.parse.outputs.test_id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n`${{ steps.parse.outputs.version }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n:white_check_mark: PASS"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Monthly regression test completed successfully with no performance degradation."
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
